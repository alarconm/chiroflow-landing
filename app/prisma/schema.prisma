// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant organization (practice)
model Organization {
  id        String   @id @default(cuid())
  name      String
  subdomain String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Enterprise/Parent Company fields (Epic 25)
  isEnterprise         Boolean @default(false) // Is this a multi-location enterprise?
  parentOrganizationId String? // For sub-organizations (future use)
  enterpriseSettings   Json    @default("{}") // Enterprise-level configuration

  // Primary contact
  primaryContactName  String?
  primaryContactEmail String?
  primaryContactPhone String?

  // Relations
  users      User[]
  auditLogs  AuditLog[]
  patients   Patient[]
  households Household[]

  // Multi-location relations (Epic 25)
  locations Location[]

  // Scheduling relations
  providers        Provider[]
  appointmentTypes AppointmentType[]
  rooms            Room[]
  resources        Resource[]
  appointments     Appointment[]
  recurringSeries  RecurringSeries[]
  scheduleBlocks   ScheduleBlock[]
  waitlistEntries  WaitlistEntry[]

  // Intake form relations
  formTemplates   FormTemplate[]
  formSubmissions FormSubmission[]
  formDeliveries  FormDelivery[]

  // Clinical/EHR relations
  encounters          Encounter[]
  treatmentPlans      TreatmentPlan[]
  noteTemplates       NoteTemplate[]
  assessmentTemplates AssessmentTemplate[]
  outcomeAssessments  OutcomeAssessment[]
  codeFavorites       CodeFavorite[]

  // Billing relations
  feeSchedules FeeSchedule[]
  charges      Charge[]
  payments     Payment[]
  claims       Claim[]

  // Communication relations
  messageTemplates MessageTemplate[]
  messages         Message[]
  messageThreads   MessageThread[]
  reminderRules    ReminderRule[]

  // Payment Processing relations (Epic 10)
  paymentProcessors      PaymentProcessor[]
  storedPaymentMethods   StoredPaymentMethod[]
  paymentTransactions    PaymentTransaction[]
  paymentPlans           PaymentPlan[]
  patientStatements      PatientStatement[]
  autoPayEnrollments     AutoPayEnrollment[]
  refunds                Refund[]
  processedWebhookEvents ProcessedWebhookEvent[]

  // Reporting & Analytics relations (Epic 15)
  dashboardWidgets   DashboardWidget[]
  savedReports       SavedReport[]
  reportSchedules    ReportSchedule[]
  kpiSnapshots       KPISnapshot[]
  reportExports      ReportExport[]
  reports            Report[]
  scheduleRunHistory ScheduleRunHistory[]

  // AI Scheduling relations (Epic 13)
  overbookingRecommendations OverbookingRecommendation[]
  schedulingGaps             SchedulingGap[]
  providerUtilizations       ProviderUtilization[]
  schedulingSuggestions      SchedulingSuggestion[]
  recallSequences            RecallSequence[]

  // AI Communication relations (Epic 12)
  chatSessions           ChatSession[]
  aiConversationContexts AIConversationContext[]
  recallCampaigns        RecallCampaign[]
  reactivationCampaigns  ReactivationCampaign[]
  patientFeedback        PatientFeedback[]

  // Clearinghouse relations (Epic 08)
  clearinghouseConfigs ClearinghouseConfig[]
  claimSubmissions     ClaimSubmission[]
  eligibilityChecks    EligibilityCheck[]
  claimStatusChecks    ClaimStatusCheck[]
  remittances          Remittance[]
  denials              Denial[]

  // AI Billing relations (Epic 09)
  claimScrubResults       ClaimScrubResult[]
  denialPredictions       DenialPrediction[]
  appealLetters           AppealLetter[]
  paymentMatchSuggestions PaymentMatchSuggestion[]
  underpaymentDetections  UnderpaymentDetection[]
  aiBillingJobs           AIBillingJob[]
  aiBillingAudits         AIBillingAudit[]

  // Patient Portal relations (Epic 14)
  portalUsers         PortalUser[]
  portalAccessLogs    PortalAccessLog[]
  secureMessages      SecureMessage[]
  portalDocuments     PortalDocument[]
  appointmentRequests AppointmentRequest[]

  // Inventory & POS relations (Epic 17)
  productCategories  ProductCategory[]
  products           Product[]
  inventoryItems     InventoryItem[]
  inventoryMovements InventoryMovement[]
  vendors            Vendor[]
  purchaseOrders     PurchaseOrder[]
  sales              Sale[]
  lowStockAlerts     LowStockAlert[]

  // AI Insights Agent relations (Epic 16)
  aiInsights           AIInsight[]
  churnPredictions     ChurnPrediction[]
  revenueOpportunities RevenueOpportunity[]
  nlQueryHistory       NLQueryHistory[]

  // AI Revenue Optimizer relations (Epic 35)
  revenueLeakages     RevenueLeakage[]
  feeScheduleAnalyses FeeScheduleAnalysis[]
  revenueGoals        RevenueGoal[]
  optimizationActions OptimizationAction[]

  // Marketing & Referrals relations (Epic 18)
  referralPrograms  ReferralProgram[]
  referrals         Referral[]
  leads             Lead[]
  nurtureSequences  NurtureSequence[]
  reviewRequests    ReviewRequest[]
  campaigns         Campaign[]
  landingPages      LandingPage[]
  marketingConsents MarketingConsent[]

  // Chiropractic Clinical Intelligence relations (Epic 19)
  techniques        Technique[]
  subluxations      Subluxation[]
  adjustments       Adjustment[]
  vertebralListings VertebralListing[]
  chiropracticExams ChiropracticExam[]

  // AI Posture & Movement Analysis relations (Epic 20)
  postureAssessments  PostureAssessment[]
  rangeOfMotions      RangeOfMotion[]
  functionalMovements FunctionalMovement[]

  // Telehealth & Virtual Care relations (Epic 21)
  telehealthSessions  TelehealthSession[]
  virtualWaitingRooms VirtualWaitingRoom[]
  telehealthConsents  TelehealthConsent[]
  sessionRecordings   SessionRecording[]

  // Remote Monitoring relations (US-222)
  remoteMonitoringSubmissions RemoteMonitoringSubmission[]
  remoteMonitoringAlerts      RemoteMonitoringAlert[]

  // Imaging & X-Ray Integration relations (Epic 22)
  imagingStudies ImagingStudy[]
  imagingReports ImagingReport[]

  // Patient Education & Home Care relations (Epic 23)
  exercisePrescriptions   ExercisePrescription[]
  prescribedArticles      PrescribedArticle[]
  homeCareInstructions    HomeCareInstruction[]
  patientExerciseProgress PatientExerciseProgress[]

  // Wearable & Device Integration relations (Epic 24)
  deviceConnections DeviceConnection[]
  activityData      ActivityData[]
  sleepData         SleepData[]
  postureData       PostureData[]
  heartRateData     HeartRateData[]
  activityGoals     ActivityGoal[]

  // Cross-Location Patient Access relations (Epic 25)
  crossLocationAccessLogs CrossLocationAccessLog[]
  patientLocationBalances PatientLocationBalance[]

  // Inter-Location Inventory relations (Epic 25 - US-254)
  inventoryTransfers InventoryTransfer[]

  // Security & Compliance relations (Epic 26)
  securityEvents  SecurityEvent[]
  userSessions    UserSession[]
  baaDocuments    BAADocument[]
  encryptionKeys  EncryptionKey[]
  securitySetting SecuritySetting?

  // Access Control Enhancement relations (US-262)
  accessRequests      AccessRequest[]
  emergencyAccessLogs EmergencyAccessLog[]
  permissionGrants    PermissionGrant[]
  roleInheritances    RoleInheritance[]

  // Mobile Applications relations (Epic 27)
  mobileDevices           MobileDevice[]
  mobileRefreshTokens     MobileRefreshToken[]
  mobileRateLimits        MobileRateLimit[]
  offlineSyncQueues       OfflineSyncQueue[]
  pushNotifications       PushNotification[]
  notificationPreferences NotificationPreference[]
  notificationLogs        NotificationLog[]

  // Mobile Patient Health relations (Epic 27 - US-269)
  painDiaryEntries PainDiaryEntry[]
  progressPhotos   ProgressPhoto[]
  patientGoals     PatientGoal[]

  // Offline Mode relations (US-270)
  offlineCaches    OfflineCache[]
  syncConflicts    SyncConflict[]
  deviceSyncStates DeviceSyncState[]

  // AI Receptionist Agent relations (Epic 30)
  aiReceptionistConversations AIReceptionistConversation[]
  aiReceptionistActions       AIReceptionistAction[]
  aiReceptionistEscalations   AIReceptionistEscalation[]
  aiKnowledgeBaseEntries      AIKnowledgeBase[]
  aiVoiceConfig               AIVoiceConfig?

  // AI Billing Agent relations (Epic 31)
  aiBillingTasks     AIBillingTask[]
  aiBillingDecisions AIBillingDecision[]
  aiAppeals          AIAppeal[]
  aiBillingRules     AIBillingRule[]
  aiBillingMetrics   AIBillingMetric[]

  // AI Documentation Agent relations (Epic 32)
  aiTranscriptions      AITranscription[]
  aiDraftNotes          AIDraftNote[]
  aiCodeSuggestions     AICodeSuggestion[]
  aiComplianceChecks    AIComplianceCheck[]
  providerPreferences   ProviderPreference[]
  textMacros            TextMacro[]
  aiTemplateSuggestions AITemplateSuggestion[]

  // AI Care Coordinator Agent relations (Epic 33)
  careGaps                CareGap[]
  careOutreach            CareOutreach[]
  patientEngagementScores PatientEngagementScore[]
  careJourneys            CareJourney[]
  careCoordinatorActions  CareCoordinatorAction[]

  // AI Quality Assurance Agent relations (Epic 36)
  qaAudits         QAAudit[]
  qaFindings       QAFinding[]
  qaMetrics        QAMetric[]
  complianceAlerts ComplianceAlert[]
  qaRules          QARule[]

  // AI Practice Growth Agent relations (Epic 37)
  growthLeads              GrowthLead[]
  growthCampaigns          GrowthCampaign[]
  referralOpportunities    ReferralOpportunity[]
  reputationMetrics        ReputationMetric[]
  reactivationOpportunities ReactivationOpportunity[]
  growthMetrics            GrowthMetric[]

  @@index([subdomain])
}

// User roles for RBAC
enum Role {
  OWNER // Full access, can delete organization
  ADMIN // Full access except organization deletion
  PROVIDER // Clinical access, can see all patients
  STAFF // Front desk, limited patient access
  BILLER // Billing and claims access only
}

// User account
model User {
  id           String    @id @default(cuid())
  email        String
  passwordHash String
  firstName    String
  lastName     String
  role         Role      @default(STAFF)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  auditLogs AuditLog[]
  provider  Provider? // If user is a clinical provider

  // Chiropractic Clinical Intelligence relations (Epic 19)
  subluxationHistoryEntries SubluxationHistory[]

  // Wearable & Device Integration relations (Epic 24)
  createdActivityGoals ActivityGoal[]

  // Multi-location relations (Epic 25)
  locationAssignments     LocationStaff[]
  crossLocationAccessLogs CrossLocationAccessLog[]

  // Inter-Location Inventory relations (Epic 25 - US-254)
  transfersRequested InventoryTransfer[] @relation("TransferRequestedBy")
  transfersApproved  InventoryTransfer[] @relation("TransferApprovedBy")
  transfersReceived  InventoryTransfer[] @relation("TransferReceivedBy")

  // Security & Compliance relations (Epic 26)
  mfaConfigurations MFAConfiguration[]
  securityEvents    SecurityEvent[]
  userSessions      UserSession[]

  // Access Control Enhancement relations (US-262)
  accessRequestsRequested AccessRequest[]      @relation("AccessRequestRequester")
  accessRequestsReviewed  AccessRequest[]      @relation("AccessRequestReviewer")
  emergencyAccessLogs     EmergencyAccessLog[]
  permissionGrants        PermissionGrant[]
  permissionsGranted      PermissionGrant[]    @relation("PermissionGranter")
  permissionsRevoked      PermissionGrant[]    @relation("PermissionRevoker")
  roleInheritancesCreated RoleInheritance[]

  // Mobile Applications relations (Epic 27)
  mobileDevices          MobileDevice[]
  mobileRefreshTokens    MobileRefreshToken[]
  pushNotifications      PushNotification[]
  notificationPreference NotificationPreference?
  notificationLogs       NotificationLog[]

  // Offline Mode relations (US-270)
  offlineCache     OfflineCache[]
  deviceSyncStates DeviceSyncState[]

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([email])
}

// Audit log for HIPAA compliance
model AuditLog {
  id         String   @id @default(cuid())
  action     String // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT, etc.
  entityType String // User, Patient, Appointment, etc.
  entityId   String? // ID of the affected entity
  changes    Json? // Before/after state for mutations
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  userId         String?
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================
// EPIC 02: PATIENT MANAGEMENT
// ============================================

// Patient status
enum PatientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
  DECEASED
}

// Gender options
enum Gender {
  MALE
  FEMALE
  NON_BINARY
  OTHER
  PREFER_NOT_TO_SAY
}

// Contact preference
enum ContactPreference {
  EMAIL
  PHONE
  SMS
  MAIL
}

// Insurance type
enum InsuranceType {
  PRIMARY
  SECONDARY
  TERTIARY
}

// Subscriber relationship to patient
enum SubscriberRelationship {
  SELF
  SPOUSE
  CHILD
  OTHER
}

// Family relationship type
enum FamilyRelationship {
  SPOUSE
  PARENT
  CHILD
  SIBLING
  GUARDIAN
  OTHER
}

// Document type
enum DocumentType {
  INSURANCE_CARD_FRONT
  INSURANCE_CARD_BACK
  PHOTO_ID
  CONSENT_FORM
  INTAKE_FORM
  CLINICAL_NOTE
  LAB_RESULT
  IMAGING
  REFERRAL
  OTHER
}

// Core Patient model
model Patient {
  id         String        @id @default(cuid())
  mrn        String // Medical Record Number (org-unique)
  status     PatientStatus @default(ACTIVE)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  archivedAt DateTime?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  demographics      PatientDemographics?
  contacts          PatientContact[]
  emergencyContacts EmergencyContact[]
  insurances        PatientInsurance[]
  documents         PatientDocument[]
  householdMembers  HouseholdMember[]
  mergeHistory      PatientMerge[]       @relation("MergedIntoPatient")
  mergedFrom        PatientMerge[]       @relation("SourcePatient")

  // Scheduling relations
  appointments    Appointment[]
  waitlistEntries WaitlistEntry[]

  // Intake form relations
  formSubmissions FormSubmission[]
  formDeliveries  FormDelivery[]

  // Clinical/EHR relations
  encounters         Encounter[]
  treatmentPlans     TreatmentPlan[]
  outcomeAssessments OutcomeAssessment[]

  // Billing relations
  charges  Charge[]
  payments Payment[]
  claims   Claim[]

  // Communication relations
  messages                Message[]
  messageThreads          MessageThread[]
  communicationPreference CommunicationPreference?

  // Payment Processing relations (Epic 10)
  storedPaymentMethods StoredPaymentMethod[]
  paymentTransactions  PaymentTransaction[]
  paymentPlans         PaymentPlan[]
  patientStatements    PatientStatement[]
  autoPayEnrollments   AutoPayEnrollment[]
  refunds              Refund[]

  // AI Scheduling relations (Epic 13)
  schedulingSuggestions SchedulingSuggestion[]
  recallEnrollments     RecallEnrollment[]

  // AI Communication relations (Epic 12)
  chatSessions                 ChatSession[]
  aiConversationContext        AIConversationContext?
  recallCampaignPatients       RecallCampaignPatient[]
  reactivationCampaignPatients ReactivationCampaignPatient[]
  patientFeedback              PatientFeedback[]

  // Clearinghouse relations (Epic 08)
  eligibilityChecks EligibilityCheck[]
  denials           Denial[]

  // AI Billing relations (Epic 09)
  paymentMatchSuggestions PaymentMatchSuggestion[]

  // Patient Portal relations (Epic 14)
  portalUser          PortalUser?
  secureMessages      SecureMessage[]
  portalDocuments     PortalDocument[]
  appointmentRequests AppointmentRequest[]

  // AI Insights relations (Epic 16)
  churnPrediction ChurnPrediction?

  // Marketing & Referrals relations (Epic 18)
  referralsMade     Referral[]         @relation("ReferrerPatient")
  referralsReceived Referral[]         @relation("RefereePatient")
  leadsConverted    Lead[]             @relation("LeadConversion")
  reviewRequests    ReviewRequest[]
  marketingConsents MarketingConsent[]

  // Chiropractic Clinical Intelligence relations (Epic 19)
  subluxations      Subluxation[]
  vertebralListings VertebralListing[]
  chiropracticExams ChiropracticExam[]

  // AI Posture & Movement Analysis relations (Epic 20)
  postureAssessments  PostureAssessment[]
  rangeOfMotions      RangeOfMotion[]
  functionalMovements FunctionalMovement[]

  // Telehealth & Virtual Care relations (Epic 21)
  virtualWaitingRooms VirtualWaitingRoom[]
  telehealthConsents  TelehealthConsent[]

  // Remote Monitoring relations (US-222)
  remoteMonitoringSubmissions RemoteMonitoringSubmission[]
  remoteMonitoringAlerts      RemoteMonitoringAlert[]

  // Imaging & X-Ray Integration relations (Epic 22)
  imagingStudies ImagingStudy[]

  // Patient Education & Home Care relations (Epic 23)
  exercisePrescriptions   ExercisePrescription[]
  prescribedArticles      PrescribedArticle[]
  homeCareInstructions    HomeCareInstruction[]
  patientExerciseProgress PatientExerciseProgress[]

  // Wearable & Device Integration relations (Epic 24)
  deviceConnections DeviceConnection[]
  activityData      ActivityData[]
  sleepData         SleepData[]
  postureData       PostureData[]
  heartRateData     HeartRateData[]
  activityGoals     ActivityGoal[]

  // Mobile Patient Health relations (Epic 27 - US-269)
  painDiaryEntries PainDiaryEntry[]
  progressPhotos   ProgressPhoto[]
  patientGoals     PatientGoal[]

  // Multi-Location Enterprise relations (Epic 25)
  homeLocationId                 String? // Patient's home/primary location
  homeLocation                   Location?                @relation("PatientHomeLocation", fields: [homeLocationId], references: [id])
  consentForCrossLocationSharing Boolean                  @default(false) // Explicit consent for cross-location access
  crossLocationConsentDate       DateTime? // When consent was given/updated
  crossLocationAccessLogs        CrossLocationAccessLog[]
  balanceByLocation              PatientLocationBalance[]

  // AI Receptionist relations (Epic 30)
  aiReceptionistConversations AIReceptionistConversation[]

  // AI Billing Agent relations (Epic 31)
  aiBillingTasks AIBillingTask[]

  // AI Care Coordinator Agent relations (Epic 33)
  careGaps                CareGap[]
  careOutreach            CareOutreach[]
  patientEngagementScores PatientEngagementScore[]
  careJourneys            CareJourney[]
  careCoordinatorActions  CareCoordinatorAction[]

  // AI Practice Growth Agent relations (Epic 37)
  referralOpportunities     ReferralOpportunity[]
  reactivationOpportunities ReactivationOpportunity[]

  @@unique([mrn, organizationId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@index([homeLocationId])
}

// Patient demographics (1:1 with Patient)
model PatientDemographics {
  id            String   @id @default(cuid())
  firstName     String
  middleName    String?
  lastName      String
  preferredName String?
  dateOfBirth   DateTime
  gender        Gender   @default(PREFER_NOT_TO_SAY)
  pronouns      String?
  ssn           String? // Encrypted, store last 4 for display
  ssnLast4      String? // Last 4 digits for display
  language      String   @default("en")
  ethnicity     String?
  race          String?
  maritalStatus String?
  occupation    String?
  employer      String?
  notes         String? // Internal notes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Search indexes for phonetic matching
  firstNameSoundex String? // Soundex code for first name
  lastNameSoundex  String? // Soundex code for last name

  @@index([firstName, lastName])
  @@index([dateOfBirth])
  @@index([firstNameSoundex])
  @@index([lastNameSoundex])
}

// Patient contact information (1:many - can have multiple addresses/phones)
model PatientContact {
  id                String            @id @default(cuid())
  isPrimary         Boolean           @default(false)
  contactPreference ContactPreference @default(PHONE)

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String  @default("US")

  // Phone
  homePhone   String?
  mobilePhone String?
  workPhone   String?

  // Email
  email String?

  // Opt-in preferences
  allowSms       Boolean @default(true)
  allowEmail     Boolean @default(true)
  allowVoicemail Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([email])
  @@index([mobilePhone])
}

// Emergency contacts
model EmergencyContact {
  id           String   @id @default(cuid())
  name         String
  relationship String
  phone        String
  altPhone     String?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

// Patient insurance information
model PatientInsurance {
  id       String        @id @default(cuid())
  type     InsuranceType @default(PRIMARY)
  isActive Boolean       @default(true)

  // Insurance company info
  payerName String
  payerId   String? // Payer ID for EDI
  planName  String?
  planType  String? // PPO, HMO, EPO, etc.

  // Policy details
  policyNumber String
  groupNumber  String?

  // Subscriber info (may be different from patient)
  subscriberRelationship SubscriberRelationship @default(SELF)
  subscriberId           String?
  subscriberFirstName    String?
  subscriberLastName     String?
  subscriberDob          DateTime?

  // Coverage dates
  effectiveDate   DateTime?
  terminationDate DateTime?

  // Benefits
  copay          Decimal? @db.Decimal(10, 2)
  deductible     Decimal? @db.Decimal(10, 2)
  deductibleMet  Decimal? @db.Decimal(10, 2)
  outOfPocketMax Decimal? @db.Decimal(10, 2)
  outOfPocketMet Decimal? @db.Decimal(10, 2)

  // Verification
  verifiedAt        DateTime?
  verifiedBy        String?
  verificationNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Link to InsurancePayer if in system
  insurancePayerId String?
  insurancePayer   InsurancePayer? @relation(fields: [insurancePayerId], references: [id])

  // Billing relations
  claims Claim[]

  // Clearinghouse relations (Epic 08)
  eligibilityChecks EligibilityCheck[]

  @@index([patientId])
  @@index([type])
  @@index([payerName])
  @@index([insurancePayerId])
}

// Patient documents
model PatientDocument {
  id          String       @id @default(cuid())
  type        DocumentType
  fileName    String
  fileSize    Int // Size in bytes
  mimeType    String
  storageKey  String // S3 key or local path
  description String?

  // Upload info
  uploadedById String
  uploadedAt   DateTime @default(now())

  // Access control
  isConfidential Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([type])
  @@index([uploadedAt])
}

// Household for family linking
model Household {
  id        String   @id @default(cuid())
  name      String? // Optional household name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  members HouseholdMember[]

  @@index([organizationId])
}

// Household membership (links patients to households)
model HouseholdMember {
  id            String             @id @default(cuid())
  relationship  FamilyRelationship
  isHeadOfHouse Boolean            @default(false)
  isGuarantor   Boolean            @default(false) // Responsible for billing
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  // Relations
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  householdId String
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([patientId, householdId])
  @@index([householdId])
  @@index([patientId])
}

// Patient merge tracking
model PatientMerge {
  id             String   @id @default(cuid())
  mergedAt       DateTime @default(now())
  mergedBy       String // User ID who performed merge
  reason         String? // Why merge was performed
  sourceSnapshot Json // Snapshot of source patient before merge
  fieldsKept     Json // Which fields were kept from source

  // Relations
  sourcePatientId String
  sourcePatient   Patient @relation("SourcePatient", fields: [sourcePatientId], references: [id])
  targetPatientId String
  targetPatient   Patient @relation("MergedIntoPatient", fields: [targetPatientId], references: [id])

  @@index([sourcePatientId])
  @@index([targetPatientId])
  @@index([mergedAt])
}

// ============================================
// EPIC 03: SCHEDULING ENGINE
// ============================================

// Appointment status workflow
enum AppointmentStatus {
  SCHEDULED // Booked but not confirmed
  CONFIRMED // Patient confirmed attendance
  CHECKED_IN // Patient arrived
  IN_PROGRESS // Currently being seen
  COMPLETED // Visit finished
  CANCELLED // Cancelled by patient or staff
  NO_SHOW // Patient didn't arrive
  RESCHEDULED // Moved to different time
}

// Recurring frequency
enum RecurringFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

// Schedule block types (non-patient time)
enum BlockType {
  LUNCH
  MEETING
  ADMIN
  PERSONAL
  BREAK
  TRAINING
  OTHER
}

// Waitlist priority
enum WaitlistPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Day of week for recurring schedules
enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// Provider profile (extends User for clinical staff)
model Provider {
  id            String   @id @default(cuid())
  title         String? // Dr., DC, etc.
  specialty     String? // Chiropractic, PT, etc.
  npiNumber     String? // National Provider Identifier
  licenseNumber String?
  color         String   @default("#3B82F6") // Calendar color
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  bio           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Link to user account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  schedules           ProviderSchedule[]
  exceptions          ProviderException[]
  appointments        Appointment[]
  scheduleBlocks      ScheduleBlock[]
  waitlistPreferences WaitlistEntry[]

  // Clinical/EHR relations
  encounters     Encounter[]
  treatmentPlans TreatmentPlan[]

  // Billing relations
  charges Charge[]

  // AI Scheduling relations (Epic 13)
  overbookingRecommendations OverbookingRecommendation[]
  schedulingGaps             SchedulingGap[]
  utilizations               ProviderUtilization[]
  schedulingSuggestions      SchedulingSuggestion[]

  // Chiropractic Clinical Intelligence relations (Epic 19)
  techniqueFavorites TechniqueFavorite[]

  // Remote Monitoring relations (US-222)
  remoteMonitoringAlerts RemoteMonitoringAlert[]

  // Imaging & X-Ray Integration relations (Epic 22)
  orderedImagingStudies ImagingStudy[]  @relation("OrderingProvider")
  imagingReports        ImagingReport[]

  // Patient Education & Home Care relations (Epic 23)
  exercisePrescriptions ExercisePrescription[]
  prescribedArticles    PrescribedArticle[]
  homeCareInstructions  HomeCareInstruction[]

  // AI Documentation Agent relations (Epic 32)
  providerPreferences ProviderPreference[]
  textMacros          TextMacro[]

  @@index([organizationId])
  @@index([isActive])
}

// Provider weekly recurring schedule
model ProviderSchedule {
  id        String    @id @default(cuid())
  dayOfWeek DayOfWeek
  startTime String // "09:00" format (24hr)
  endTime   String // "17:00" format (24hr)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([dayOfWeek])
}

// Provider one-off schedule exceptions
model ProviderException {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  isAvailable Boolean  @default(false) // false = off, true = custom hours
  startTime   String? // Override start time if available
  endTime     String? // Override end time if available
  reason      String? // Vacation, sick, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, date])
  @@index([date])
}

// Appointment types (New Patient, Follow-up, etc.)
model AppointmentType {
  id           String   @id @default(cuid())
  name         String // "New Patient Exam"
  code         String? // Short code "NPE"
  description  String?
  duration     Int // Duration in minutes
  color        String   @default("#10B981") // Display color
  requiresRoom Boolean  @default(true)
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  defaultPrice Decimal? @db.Decimal(10, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  appointments    Appointment[]
  waitlistEntries WaitlistEntry[]

  // Multi-location relations (Epic 25 - US-252)
  locationAvailability AppointmentTypeLocation[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([isActive])
}

// Location-specific availability for appointment types (Epic 25 - US-252)
model AppointmentTypeLocation {
  id        String  @id @default(cuid())
  isEnabled Boolean @default(true) // Whether this type is available at this location

  // Location-specific overrides
  durationOverride Int? // Override default duration for this location
  priceOverride    Decimal? @db.Decimal(10, 2) // Location-specific pricing

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appointmentTypeId String
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([appointmentTypeId, locationId])
  @@index([appointmentTypeId])
  @@index([locationId])
  @@index([isEnabled])
}

// Treatment rooms
model Room {
  id          String   @id @default(cuid())
  name        String // "Room 1", "Adjustment Bay A"
  description String?
  capacity    Int      @default(1)
  equipment   String[] // List of equipment in room
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  color       String   @default("#6366F1")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25 - US-252)
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  // Relations
  appointments Appointment[]

  @@index([organizationId])
  @@index([isActive])
  @@index([locationId])
}

// Shared resources (equipment that needs scheduling)
model Resource {
  id          String   @id @default(cuid())
  name        String // "X-Ray Machine", "TENS Unit"
  type        String? // Category
  description String?
  quantity    Int      @default(1) // How many available
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25 - US-252)
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  // Relations
  appointments AppointmentResource[]

  @@index([organizationId])
  @@index([isActive])
  @@index([locationId])
}

// Recurring appointment series
model RecurringSeries {
  id             String             @id @default(cuid())
  frequency      RecurringFrequency
  endDate        DateTime? // Series end date
  maxOccurrences Int? // Or max number of appointments
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  appointments Appointment[]

  @@index([organizationId])
}

// Core Appointment model
model Appointment {
  id             String            @id @default(cuid())
  startTime      DateTime
  endTime        DateTime
  status         AppointmentStatus @default(SCHEDULED)
  notes          String? // Staff notes
  patientNotes   String? // Patient-provided notes
  chiefComplaint String? // Reason for visit

  // Confirmation tracking
  confirmedAt DateTime?
  confirmedBy String? // User ID or "PATIENT"

  // Check-in tracking
  checkedInAt DateTime?
  checkedInBy String?

  // Completion tracking
  completedAt DateTime?
  completedBy String?

  // Cancellation tracking
  cancelledAt  DateTime?
  cancelledBy  String?
  cancelReason String?

  // Billing reference
  chargeAmount Decimal? @db.Decimal(10, 2)

  // Telehealth flag (Epic 21)
  isTelehealth Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  appointmentTypeId String
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [id])

  roomId String?
  room   Room?   @relation(fields: [roomId], references: [id])

  recurringSeriesId String?
  recurringSeries   RecurringSeries? @relation(fields: [recurringSeriesId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25)
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  // Relations
  resources AppointmentResource[]

  // Clinical/EHR relation
  encounter Encounter?

  // Communication relations
  messages Message[]

  // AI Scheduling relations (Epic 13)
  noShowPrediction NoShowPrediction?

  // Telehealth & Virtual Care relations (Epic 21)
  telehealthSession TelehealthSession?

  @@index([organizationId])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
  @@index([patientId])
  @@index([providerId])
  @@index([roomId])
  @@index([appointmentTypeId])
  @@index([recurringSeriesId])
  @@index([locationId])
  // Composite index for calendar queries
  @@index([organizationId, startTime, endTime])
  @@index([providerId, startTime, endTime])
  @@index([locationId, startTime, endTime])
}

// Join table for appointment resources
model AppointmentResource {
  id        String   @id @default(cuid())
  quantity  Int      @default(1)
  createdAt DateTime @default(now())

  // Relations
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, resourceId])
  @@index([resourceId])
}

// Schedule blocks (non-patient time)
model ScheduleBlock {
  id             String    @id @default(cuid())
  title          String // "Lunch", "Staff Meeting"
  blockType      BlockType
  startTime      DateTime
  endTime        DateTime
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // iCal RRULE format for complex recurrence
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Provider-specific or org-wide
  providerId String?
  provider   Provider? @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([startTime])
  @@index([endTime])
}

// Waitlist for patients wanting appointments
model WaitlistEntry {
  id       String           @id @default(cuid())
  priority WaitlistPriority @default(NORMAL)
  notes    String?

  // Time preferences
  preferredDays      DayOfWeek[] // Preferred days of week
  preferredTimeStart String? // Earliest acceptable time "09:00"
  preferredTimeEnd   String? // Latest acceptable time "17:00"

  // Status
  isActive    Boolean   @default(true)
  expiresAt   DateTime? // Auto-expire date
  scheduledAt DateTime? // When they were scheduled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  appointmentTypeId String
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [id])

  preferredProviderId String?
  preferredProvider   Provider? @relation(fields: [preferredProviderId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
  @@index([patientId])
  @@index([createdAt])
}

// ============================================
// EPIC 05: EHR & SOAP NOTES
// ============================================

// Encounter status workflow
enum EncounterStatus {
  SCHEDULED // Linked to appointment, not started
  IN_PROGRESS // Provider is charting
  COMPLETED // Chart complete, not signed
  SIGNED // Signed and locked
  AMENDED // Has addendums
}

// Encounter type
enum EncounterType {
  INITIAL_EVAL // First visit
  FOLLOW_UP // Regular visit
  RE_EVALUATION // Progress assessment
  DISCHARGE // Final visit
  MAINTENANCE // Wellness/maintenance
  ACUTE // Acute injury visit
  WORKERS_COMP // WC case
  PERSONAL_INJURY // PI case
}

// Diagnosis status
enum DiagnosisStatus {
  ACTIVE
  RESOLVED
  CHRONIC
  RECURRENT
}

// Treatment plan status
enum TreatmentPlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  DISCONTINUED
  EXPIRED
}

// Goal status
enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  PARTIALLY_ACHIEVED
  NOT_ACHIEVED
}

// Assessment type for outcome measures
enum AssessmentType {
  ODI // Oswestry Disability Index
  NDI // Neck Disability Index
  VAS_PAIN // Visual Analog Scale
  NPRS // Numeric Pain Rating Scale
  FABQ // Fear-Avoidance Beliefs
  DASH // Disabilities of Arm Shoulder Hand
  SF36 // Short Form 36
  CUSTOM // Custom questionnaire
}

// Clinical encounter (visit documentation container)
model Encounter {
  id             String          @id @default(cuid())
  encounterDate  DateTime        @default(now())
  status         EncounterStatus @default(IN_PROGRESS)
  encounterType  EncounterType   @default(FOLLOW_UP)
  chiefComplaint String?
  location       String? // Location of service

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  signedAt    DateTime?
  signedBy    String? // Provider user ID who signed

  // Visit metrics
  visitNumber Int? // Visit # in treatment plan

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  appointmentId String?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  treatmentPlanId String?
  treatmentPlan   TreatmentPlan? @relation(fields: [treatmentPlanId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25)
  locationId String?
  location_  Location? @relation(fields: [locationId], references: [id])

  // Relations
  soapNote     SOAPNote?
  diagnoses    Diagnosis[]
  procedures   Procedure[]
  assessments  OutcomeAssessment[]
  bodyDiagrams BodyDiagram[]
  addendums    NoteAddendum[]

  // Billing relations
  charges Charge[]
  claims  Claim[]

  // Chiropractic Clinical Intelligence relations (Epic 19)
  subluxations       Subluxation[]
  subluxationHistory SubluxationHistory[]
  adjustments        Adjustment[]
  vertebralListings  VertebralListing[]
  chiropracticExam   ChiropracticExam?

  // AI Posture & Movement Analysis relations (Epic 20)
  postureAssessments  PostureAssessment[]
  rangeOfMotions      RangeOfMotion[]
  functionalMovements FunctionalMovement[]

  // Remote Monitoring relations (US-222)
  remoteMonitoringSubmissions RemoteMonitoringSubmission[]

  // Imaging & X-Ray Integration relations (Epic 22)
  imagingStudies ImagingStudy[]

  // Patient Education & Home Care relations (Epic 23)
  exercisePrescriptions ExercisePrescription[]
  prescribedArticles    PrescribedArticle[]
  homeCareInstructions  HomeCareInstruction[]

  // AI Documentation Agent relations (Epic 32)
  aiTranscriptions      AITranscription[]
  aiDraftNotes          AIDraftNote[]
  aiCodeSuggestions     AICodeSuggestion[]
  aiComplianceChecks    AIComplianceCheck[]
  aiTemplateSuggestions AITemplateSuggestion[]

  @@index([organizationId])
  @@index([patientId])
  @@index([providerId])
  @@index([encounterDate])
  @@index([status])
  @@index([appointmentId])
  @@index([treatmentPlanId])
  @@index([locationId])
}

// SOAP Note (1:1 with Encounter)
model SOAPNote {
  id         String  @id @default(cuid())
  subjective String? @db.Text // S - Patient's complaints
  objective  String? @db.Text // O - Provider's findings
  assessment String? @db.Text // A - Provider's assessment
  plan       String? @db.Text // P - Treatment plan

  // Structured content (optional JSON for template-based entry)
  subjectiveJson Json?
  objectiveJson  Json?
  assessmentJson Json?
  planJson       Json?

  // Template used
  templateId String?
  template   NoteTemplate? @relation(fields: [templateId], references: [id])

  // Version tracking
  version  Int       @default(1)
  isLocked Boolean   @default(false)
  lockedAt DateTime?
  lockedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String    @unique
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // AI Documentation Agent relations (Epic 32)
  aiComplianceChecks AIComplianceCheck[]

  @@index([templateId])
}

// Addendum for locked notes
model NoteAddendum {
  id      String  @id @default(cuid())
  content String  @db.Text
  reason  String? // Why addendum was needed

  // Who added it
  addedBy   String
  addedAt   DateTime  @default(now())
  signedAt  DateTime?
  signature String? // Base64 or reference

  createdAt DateTime @default(now())

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([addedAt])
}

// Note template for SOAP notes
model NoteTemplate {
  id          String        @id @default(cuid())
  name        String // "Initial Evaluation", "Follow-up"
  description String?
  category    EncounterType // Which type of visit this is for

  // Template content (JSON structure)
  subjectiveTemplate Json? // Default S content
  objectiveTemplate  Json? // Default O content
  assessmentTemplate Json? // Default A content
  planTemplate       Json? // Default P content

  // Template macros/variables
  variables Json? // Available variables like {{patient.name}}

  isActive  Boolean @default(true)
  isSystem  Boolean @default(false) // System templates can't be deleted
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation (null = system template)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  soapNotes SOAPNote[]

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

// Diagnosis (ICD-10) on encounter
model Diagnosis {
  id          String          @id @default(cuid())
  icd10Code   String // ICD-10 code
  description String // Diagnosis description
  isPrimary   Boolean         @default(false)
  status      DiagnosisStatus @default(ACTIVE)

  // Clinical info
  onsetDate    DateTime?
  resolvedDate DateTime?
  notes        String?
  bodySite     String? // Left knee, cervical spine, etc.
  laterality   String? // Left, Right, Bilateral

  // Sequencing for claims
  sequence Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Patient Education & Home Care relations (Epic 23)
  exercisePrescriptions ExercisePrescription[]

  @@index([encounterId])
  @@index([icd10Code])
  @@index([status])
}

// Procedure (CPT) on encounter
model Procedure {
  id          String  @id @default(cuid())
  cptCode     String // CPT code
  description String // Procedure description
  units       Int     @default(1)
  modifier1   String? // Modifier 1 (e.g., 59, 25)
  modifier2   String?
  modifier3   String?
  modifier4   String?
  notes       String?

  // Pricing
  chargeAmount  Decimal? @db.Decimal(10, 2)
  allowedAmount Decimal? @db.Decimal(10, 2)

  // Rendering provider if different
  renderingProviderId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Linked diagnoses for this procedure (diagnosis pointers)
  diagnosisPointers Json? // Array of diagnosis sequence numbers

  @@index([encounterId])
  @@index([cptCode])
}

// Treatment plan (spans multiple visits)
model TreatmentPlan {
  id          String              @id @default(cuid())
  name        String // "Lumbar Rehabilitation Program"
  description String?
  status      TreatmentPlanStatus @default(DRAFT)

  // Duration
  startDate       DateTime  @default(now())
  endDate         DateTime?
  plannedVisits   Int? // Total visits planned
  completedVisits Int       @default(0)
  frequency       String? // "2x/week", "3x/week for 4 weeks"
  duration        String? // "6 weeks"

  // Clinical goals (summary)
  shortTermGoals String? @db.Text
  longTermGoals  String? @db.Text

  // Approval tracking
  approvedAt DateTime?
  approvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  goals      TreatmentGoal[]
  encounters Encounter[]

  // Imaging & X-Ray Integration relations (Epic 22)
  imagingReports ImagingReport[]

  // Patient Education & Home Care relations (Epic 23)
  exercisePrescriptions ExercisePrescription[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([startDate])
}

// Individual goals within treatment plan
model TreatmentGoal {
  id          String     @id @default(cuid())
  description String
  targetDate  DateTime?
  status      GoalStatus @default(NOT_STARTED)

  // Measurable criteria
  metric        String? // "Pain level", "Range of motion"
  baselineValue String? // Starting value
  targetValue   String? // Goal value
  currentValue  String? // Current progress
  unit          String? // "degrees", "1-10 scale"

  // Progress notes
  notes    String? @db.Text
  progress Int     @default(0) // 0-100 percentage

  achievedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  treatmentPlanId String
  treatmentPlan   TreatmentPlan @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)

  @@index([treatmentPlanId])
  @@index([status])
}

// Outcome assessment (standardized questionnaires)
model OutcomeAssessment {
  id             String         @id @default(cuid())
  assessmentType AssessmentType
  templateId     String? // Custom assessment template

  // Scoring
  rawScore       Decimal? @db.Decimal(10, 2)
  percentScore   Decimal? @db.Decimal(5, 2) // 0-100
  maxPossible    Decimal? @db.Decimal(10, 2)
  interpretation String? // "Minimal disability", "Moderate"

  // Raw answers
  answers Json? // Array of { questionId, answer, score }

  // Comparison
  previousScore Decimal? @db.Decimal(10, 2)
  changeScore   Decimal? @db.Decimal(10, 2)
  changePercent Decimal? @db.Decimal(5, 2)

  administeredAt DateTime  @default(now())
  completedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([patientId])
  @@index([assessmentType])
  @@index([administeredAt])
}

// Assessment template for custom questionnaires
model AssessmentTemplate {
  id             String         @id @default(cuid())
  name           String // "Modified Oswestry"
  assessmentType AssessmentType @default(CUSTOM)
  description    String?

  // Questions structure
  questions Json // Array of { id, text, type, options, scoring }

  // Scoring configuration
  scoringMethod  String? // "sum", "average", "weighted"
  maxScore       Decimal? @db.Decimal(10, 2)
  interpretation Json? // Ranges and their meanings

  isActive Boolean @default(true)
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation (null = system template)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([assessmentType])
  @@index([isActive])
}

// Body diagram markings
model BodyDiagram {
  id          String @id @default(cuid())
  diagramType String // "body_front", "body_back", "spine", "cervical"

  // Markings data
  markings Json // Array of { x, y, type, label, color }

  // Types: pain, tenderness, subluxation, adjustment, inflammation
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Chiropractic Clinical Intelligence relations (Epic 19)
  subluxations Subluxation[]

  @@index([encounterId])
  @@index([diagramType])
}

// ICD-10 Code lookup table (reference data)
model ICD10Code {
  id          String  @id @default(cuid())
  code        String  @unique
  description String
  category    String? // M54.5 -> M54
  chapter     String? // Musculoskeletal

  // Common in chiropractic
  isChiroCommon Boolean @default(false)

  // Searchable
  searchTerms String[] // Additional search terms

  @@index([code])
  @@index([description])
  @@index([isChiroCommon])
}

// CPT Code lookup table (reference data)
model CPTCode {
  id          String  @id @default(cuid())
  code        String  @unique
  description String
  shortDesc   String? // Short description
  category    String? // E/M, Chiro Manipulation, etc.

  // Time units
  timeMinutes Int?

  // Common in chiropractic
  isChiroCommon Boolean @default(false)

  // Relative value units (for pricing)
  rvuWork        Decimal? @db.Decimal(10, 4)
  rvuPractice    Decimal? @db.Decimal(10, 4)
  rvuMalpractice Decimal? @db.Decimal(10, 4)

  @@index([code])
  @@index([description])
  @@index([isChiroCommon])
}

// Organization code favorites
model CodeFavorite {
  id          String @id @default(cuid())
  codeType    String // "icd10" or "cpt"
  code        String
  description String
  sortOrder   Int    @default(0)

  createdAt DateTime @default(now())

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, codeType, code])
  @@index([organizationId])
  @@index([codeType])
}

// ============================================
// EPIC 04: DIGITAL INTAKE SYSTEM
// ============================================

// Form field types
enum FormFieldType {
  TEXT
  TEXTAREA
  SELECT
  RADIO
  CHECKBOX
  CHECKBOX_GROUP
  DATE
  TIME
  DATETIME
  PHONE
  EMAIL
  SSN
  NUMBER
  CURRENCY
  SIGNATURE
  FILE
  HEADING
  PARAGRAPH
  DIVIDER
}

// Form submission status
enum FormSubmissionStatus {
  DRAFT // Started but not submitted
  PENDING // Submitted, awaiting review
  COMPLETED // Reviewed and accepted
  REJECTED // Rejected, needs resubmission
  EXPIRED // Form link expired
}

// Form delivery method
enum FormDeliveryMethod {
  EMAIL
  SMS
  KIOSK
  PORTAL
  IN_PERSON
}

// Form template (reusable form structure)
model FormTemplate {
  id          String  @id @default(cuid())
  name        String // "New Patient Health History"
  description String?
  version     Int     @default(1)
  isActive    Boolean @default(true)
  isSystem    Boolean @default(false) // System templates can't be deleted
  isDraft     Boolean @default(true) // Draft until published

  // Auto-population config
  patientMapping Json? // Map fields to patient demographics

  // Expiration settings
  expiresInDays Int? // Form expires N days after sent

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  sections    FormSection[]
  fields      FormField[]
  submissions FormSubmission[]
  deliveries  FormDelivery[]

  @@index([organizationId])
  @@index([isActive])
  @@index([isSystem])
}

// Form section (grouping of fields)
model FormSection {
  id            String  @id @default(cuid())
  title         String // "Personal Information"
  description   String?
  order         Int     @default(0)
  isCollapsible Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  fields FormField[]

  @@index([templateId])
  @@index([order])
}

// Form field definition
model FormField {
  id          String        @id @default(cuid())
  fieldType   FormFieldType
  label       String // Display label
  name        String // Field name for data storage
  placeholder String?
  helpText    String?
  order       Int           @default(0)

  // Validation
  isRequired     Boolean  @default(false)
  minLength      Int?
  maxLength      Int?
  minValue       Decimal? @db.Decimal(10, 2)
  maxValue       Decimal? @db.Decimal(10, 2)
  pattern        String? // Regex pattern
  patternMessage String? // Custom error message

  // Select/Radio/Checkbox options
  options Json? // Array of { value, label }

  // Conditional display
  conditionalOn    String? // Field name to check
  conditionalValue String? // Value that must match
  conditionalOp    String? // equals, not_equals, contains, etc.

  // Patient mapping
  mapsToPatient String? // Demographics field this maps to

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  sectionId String?
  section   FormSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  responses FormResponse[]

  @@index([templateId])
  @@index([sectionId])
  @@index([order])
}

// Form submission (patient's filled form)
model FormSubmission {
  id          String               @id @default(cuid())
  status      FormSubmissionStatus @default(PENDING)
  accessToken String               @unique @default(cuid()) // Unique URL token

  // Submission source
  source    FormDeliveryMethod @default(PORTAL)
  ipAddress String?
  userAgent String?

  // Timestamps
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String? // User ID

  // Review notes
  staffNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id])

  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  // Form delivery that triggered this submission
  deliveryId String?
  delivery   FormDelivery? @relation(fields: [deliveryId], references: [id])

  // Linked appointment (if form was for specific visit)
  appointmentId String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  responses  FormResponse[]
  signatures ESignature[]

  @@index([organizationId])
  @@index([templateId])
  @@index([patientId])
  @@index([status])
  @@index([accessToken])
  @@index([submittedAt])
}

// Individual field response
model FormResponse {
  id        String  @id @default(cuid())
  value     String? // String representation of value
  valueJson Json? // Complex values (file metadata, arrays)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  fieldId String
  field   FormField @relation(fields: [fieldId], references: [id])

  @@unique([submissionId, fieldId])
  @@index([fieldId])
}

// Electronic signature
model ESignature {
  id            String   @id @default(cuid())
  signatureData String   @db.Text // Base64 encoded image
  signedAt      DateTime @default(now())

  // Legal compliance
  ipAddress   String?
  userAgent   String?
  consentText String? // Text shown before signing

  // Signer info (may differ from patient for guardians)
  signerName   String?
  signerEmail  String?
  relationship String? // "Self", "Parent", "Guardian"

  createdAt DateTime @default(now())

  // Relations
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([signedAt])
}

// Form delivery tracking
model FormDelivery {
  id     String             @id @default(cuid())
  method FormDeliveryMethod

  // Delivery details
  sentTo       String? // Email or phone number
  scheduledFor DateTime? // If scheduled for future
  sentAt       DateTime?
  openedAt     DateTime?
  completedAt  DateTime?

  // Status tracking
  sendStatus String? // pending, sent, failed, bounced
  sendError  String? // Error message if failed

  // Reminder tracking
  reminderSentAt DateTime?
  reminderCount  Int       @default(0)
  maxReminders   Int       @default(2)
  nextReminderAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Resulting submissions
  submissions FormSubmission[]

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([templateId])
  @@index([patientId])
  @@index([sentAt])
  @@index([completedAt])
}

// ============================================
// BILLING & CLAIMS MODELS
// ============================================

// Charge status enum
enum ChargeStatus {
  PENDING // Not yet billed
  BILLED // Included on a claim
  PAID // Payment received
  ADJUSTED // Written off or adjusted
  VOID // Voided/cancelled
}

// Payment method enum
enum PaymentMethod {
  CASH
  CHECK
  CREDIT_CARD
  DEBIT_CARD
  ACH
  INSURANCE
  OTHER
}

// Claim status enum
enum ClaimStatus {
  DRAFT // Being created
  READY // Ready for submission
  SUBMITTED // Sent to payer
  ACCEPTED // Acknowledged by payer
  REJECTED // Rejected by payer (fixable)
  PAID // Payment received
  DENIED // Denied by payer
  APPEALED // Appeal submitted
  VOID // Cancelled
}

// Place of service codes (common ones for chiropractic)
enum PlaceOfService {
  OFFICE // 11
  HOME // 12
  TELEHEALTH // 02
  URGENT_CARE // 20
  INPATIENT // 21
  OUTPATIENT // 22
  EMERGENCY // 23
  OTHER // 99
}

// Insurance Payer (the insurance companies)
model InsurancePayer {
  id                String  @id @default(cuid())
  name              String // Aetna, Blue Cross, etc.
  payerId           String? @unique // Payer ID for EDI (e.g., 60054)
  electronicPayerId String? // Electronic payer ID if different

  // Contact info
  address1 String?
  address2 String?
  city     String?
  state    String?
  zip      String?
  phone    String?
  fax      String?
  website  String?

  // Submission settings
  claimSubmissionMethod String  @default("electronic") // electronic, paper, portal
  acceptsEdi            Boolean @default(true)
  timelyFilingDays      Int     @default(90) // Days to submit claim

  // Notes
  notes String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientInsurances PatientInsurance[]
  claims            Claim[]

  // AI Billing Agent relations (Epic 31)
  aiBillingTasks AIBillingTask[]

  @@index([name])
  @@index([payerId])
}

// Fee Schedule (defines prices for CPT codes)
model FeeSchedule {
  id            String    @id @default(cuid())
  name          String // "Standard", "Cash Pay", "Medicare"
  description   String?
  isDefault     Boolean   @default(false)
  effectiveDate DateTime  @default(now())
  endDate       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  items FeeScheduleItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isDefault])
}

// Fee Schedule Item (individual CPT code pricing)
model FeeScheduleItem {
  id            String   @id @default(cuid())
  cptCode       String
  description   String? // Override description
  fee           Decimal  @db.Decimal(10, 2) // Billed amount
  allowedAmount Decimal? @db.Decimal(10, 2) // Expected reimbursement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  feeScheduleId String
  feeSchedule   FeeSchedule @relation(fields: [feeScheduleId], references: [id], onDelete: Cascade)

  @@unique([feeScheduleId, cptCode])
  @@index([cptCode])
}

// Charge (billable service/procedure)
model Charge {
  id          String   @id @default(cuid())
  chargeDate  DateTime @default(now())
  serviceDate DateTime // Date service was rendered

  // Procedure info
  cptCode     String
  description String
  modifiers   String[] // -25, -59, etc.
  units       Int      @default(1)

  // Diagnosis pointers (reference to encounter diagnoses)
  diagnosisPointers Int[] // 1, 2, 3, 4 - positions in claim
  icd10Codes        String[] // Actual codes for reference

  // Pricing
  fee         Decimal @db.Decimal(10, 2) // Billed amount
  adjustments Decimal @default(0) @db.Decimal(10, 2) // Write-offs
  payments    Decimal @default(0) @db.Decimal(10, 2) // Total payments received
  balance     Decimal @db.Decimal(10, 2) // Remaining balance

  // Status
  status     ChargeStatus @default(PENDING)
  voidReason String?
  voidedAt   DateTime?
  voidedBy   String?

  // Place of service
  placeOfService PlaceOfService @default(OFFICE)

  // Notes
  notes         String?
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  procedureId String? // Link to encounter procedure if applicable

  providerId String?
  provider   Provider? @relation(fields: [providerId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  paymentAllocations PaymentAllocation[]
  claimLines         ClaimLine[]

  // Clearinghouse relations (Epic 08)
  remittanceLineItems RemittanceLineItem[]

  // AI Billing relations (Epic 09)
  paymentMatchSuggestions PaymentMatchSuggestion[]
  underpayments           UnderpaymentDetection[]

  // AI Billing Agent relations (Epic 31)
  aiBillingTasks AIBillingTask[]

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([status])
  @@index([serviceDate])
  @@index([chargeDate])
}

// Payment (patient or insurance payment)
model Payment {
  id          String   @id @default(cuid())
  paymentDate DateTime @default(now())
  postedDate  DateTime @default(now())

  // Payment details
  amount          Decimal       @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  referenceNumber String? // Check number, transaction ID, etc.

  // Payer info
  payerType String  @default("patient") // patient, insurance, other
  payerName String? // Insurance company name if applicable

  // For insurance payments
  checkNumber String?
  checkDate   DateTime?
  eobDate     DateTime?

  // Unapplied amount (credit balance)
  unappliedAmount Decimal @default(0) @db.Decimal(10, 2)

  // Status
  isVoid     Boolean   @default(false)
  voidReason String?
  voidedAt   DateTime?
  voidedBy   String?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Applied to charges
  allocations PaymentAllocation[]

  // If from insurance claim
  claimId String?
  claim   Claim?  @relation(fields: [claimId], references: [id])

  // Link to payment transaction (Epic 10)
  paymentTransaction PaymentTransaction?

  @@index([organizationId])
  @@index([patientId])
  @@index([paymentDate])
  @@index([paymentMethod])
}

// Payment Allocation (how payment is applied to charges)
model PaymentAllocation {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(10, 2)
  allocatedAt DateTime @default(now())

  // Relations
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  chargeId String
  charge   Charge @relation(fields: [chargeId], references: [id])

  @@index([paymentId])
  @@index([chargeId])
}

// Insurance Claim
model Claim {
  id               String  @id @default(cuid())
  claimNumber      String? // Internal claim number
  payerClaimNumber String? // Payer-assigned claim number

  // Dates
  createdDate   DateTime  @default(now())
  submittedDate DateTime?
  acceptedDate  DateTime?
  paidDate      DateTime?

  // Status
  status        ClaimStatus @default(DRAFT)
  statusMessage String? // Rejection/denial reason

  // Claim totals
  totalCharges          Decimal @default(0) @db.Decimal(10, 2)
  totalAllowed          Decimal @default(0) @db.Decimal(10, 2)
  totalPaid             Decimal @default(0) @db.Decimal(10, 2)
  totalAdjusted         Decimal @default(0) @db.Decimal(10, 2)
  patientResponsibility Decimal @default(0) @db.Decimal(10, 2)

  // Claim type
  claimType       String  @default("professional") // professional, institutional
  isSecondary     Boolean @default(false)
  originalClaimId String? // If this is a corrected claim

  // Submission info
  submissionMethod String? // electronic, paper, portal
  batchId          String? // EDI batch identifier

  // Provider info (snapshot at time of claim)
  billingProviderId String?
  billingNpi        String?
  renderingNpi      String?
  facilityNpi       String?

  // Notes
  notes         String?
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  insurancePolicyId String?
  insurancePolicy   PatientInsurance? @relation(fields: [insurancePolicyId], references: [id])

  payerId String?
  payer   InsurancePayer? @relation(fields: [payerId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  claimLines ClaimLine[]
  payments   Payment[]
  claimNotes ClaimNote[]

  // Clearinghouse relations (Epic 08)
  submissions         ClaimSubmission[]
  statusChecks        ClaimStatusCheck[]
  remittanceLineItems RemittanceLineItem[]
  denials             Denial[]

  // AI Billing relations (Epic 09)
  scrubResults      ClaimScrubResult[]
  denialPredictions DenialPrediction[]
  underpayments     UnderpaymentDetection[]

  // AI Billing Agent relations (Epic 31)
  aiBillingTasks AIBillingTask[]
  aiAppeals      AIAppeal[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([submittedDate])
  @@index([payerId])
}

// Claim Line (individual service on a claim)
model ClaimLine {
  id         String @id @default(cuid())
  lineNumber Int // Sequence on claim

  // Service info
  serviceDateFrom DateTime
  serviceDateTo   DateTime
  placeOfService  PlaceOfService @default(OFFICE)

  // Procedure
  cptCode     String
  modifiers   String[]
  description String
  units       Int      @default(1)

  // Diagnosis pointers (1-4, reference to claim diagnoses)
  diagnosisPointers Int[]

  // Amounts
  chargedAmount  Decimal @db.Decimal(10, 2)
  allowedAmount  Decimal @default(0) @db.Decimal(10, 2)
  paidAmount     Decimal @default(0) @db.Decimal(10, 2)
  adjustedAmount Decimal @default(0) @db.Decimal(10, 2)
  patientAmount  Decimal @default(0) @db.Decimal(10, 2) // Copay/coinsurance

  // Adjudication
  adjudicationDate      DateTime?
  adjustmentReasonCodes String[] // CARC codes
  remarkCodes           String[] // RARC codes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  chargeId String?
  charge   Charge? @relation(fields: [chargeId], references: [id])

  @@index([claimId])
  @@index([chargeId])
}

// Claim Note (history/activity on claim)
model ClaimNote {
  id        String   @id @default(cuid())
  noteType  String // status_change, submission, rejection, appeal, etc.
  note      String
  createdAt DateTime @default(now())

  // Who made the note
  userId String?

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([createdAt])
}

// ============================================
// EPIC 10: PAYMENT PROCESSING
// ============================================

// Card type enum
enum CardType {
  CREDIT
  DEBIT
  HSA
  FSA
}

// Card brand enum
enum CardBrand {
  VISA
  MASTERCARD
  AMEX
  DISCOVER
  OTHER
}

// Payment transaction status
enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  VOIDED
}

// Payment plan status
enum PaymentPlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  DEFAULTED
  PAUSED
}

// Installment status
enum InstallmentStatus {
  SCHEDULED
  PENDING
  PAID
  FAILED
  SKIPPED
}

// Statement status
enum StatementStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
}

// Auto-pay frequency
enum AutoPayFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  ON_STATEMENT
}

// Payment processor type
enum PaymentProcessorType {
  STRIPE
  SQUARE
  AUTHORIZE_NET
  MOCK // For development/testing
}

// Payment processor configuration
model PaymentProcessor {
  id        String               @id @default(cuid())
  name      String // "Main Stripe Account", "Square Terminal"
  type      PaymentProcessorType
  isDefault Boolean              @default(false)
  isActive  Boolean              @default(true)

  // Encrypted credentials (NEVER store plain text)
  apiKeyEncrypted        String? // Encrypted API key
  secretKeyEncrypted     String? // Encrypted secret key
  webhookSecretEncrypted String? // Encrypted webhook secret

  // Public identifiable info (safe to store)
  publishableKey String? // Stripe publishable key (safe to expose)
  merchantId     String? // Square merchant ID
  accountId      String? // Processor account ID

  // Configuration
  testMode            Boolean @default(false) // Use sandbox/test environment
  supportedCardBrands Json    @default("[]") // ["VISA", "MASTERCARD", ...]
  settings            Json    @default("{}") // Additional processor-specific settings

  // Webhook configuration
  webhookEndpoint String? // Our endpoint URL for this processor
  webhookEvents   Json    @default("[]") // Subscribed events

  // Audit
  lastVerifiedAt DateTime? // Last successful API connection test
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transactions processed by this processor
  transactions PaymentTransaction[]
  refunds      Refund[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isActive])
  @@index([type])
}

// Stored payment method (tokenized card info - NEVER store raw card numbers)
model StoredPaymentMethod {
  id String @id @default(cuid())

  // Card identification (tokenized - from payment processor)
  paymentToken String // Stripe payment method ID or similar
  last4        String // Last 4 digits for display
  cardBrand    CardBrand
  cardType     CardType  @default(CREDIT)
  expiryMonth  Int // 1-12
  expiryYear   Int // 4-digit year

  // Cardholder info
  cardholderName String
  billingZip     String?

  // Settings
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)
  nickname  String? // "Personal Visa", "HSA Card"

  // Audit
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transactions made with this card
  transactions       PaymentTransaction[]
  autoPayEnrollments AutoPayEnrollment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([isActive])
}

// Payment transaction (actual card charges)
model PaymentTransaction {
  id String @id @default(cuid())

  // Transaction details
  amount   Decimal                  @db.Decimal(10, 2)
  currency String                   @default("USD")
  status   PaymentTransactionStatus @default(PENDING)

  // External processor info
  externalTransactionId String? // Stripe charge ID, Square payment ID, etc.
  processorResponse     Json? // Full response from processor

  // Error info (if failed)
  errorCode    String?
  errorMessage String?
  declineCode  String?

  // For refunds
  isRefund              Boolean              @default(false)
  originalTransactionId String?
  originalTransaction   PaymentTransaction?  @relation("RefundRelation", fields: [originalTransactionId], references: [id])
  refunds               PaymentTransaction[] @relation("RefundRelation")
  refundReason          String?

  // Timestamps
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  paymentMethodId String?
  paymentMethod   StoredPaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  // Payment processor used for this transaction
  paymentProcessorId String?
  paymentProcessor   PaymentProcessor? @relation(fields: [paymentProcessorId], references: [id])

  // Link to existing Payment model for allocation
  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id])

  // If part of a payment plan
  installmentId String?                 @unique
  installment   PaymentPlanInstallment? @relation(fields: [installmentId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Webhook events that affected this transaction
  webhookEvents ProcessedWebhookEvent[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@index([externalTransactionId])
  @@index([paymentProcessorId])
}

// Payment plan for installment payments
model PaymentPlan {
  id   String  @id @default(cuid())
  name String? // "6-Month Payment Plan"

  // Plan details
  totalAmount          Decimal          @db.Decimal(10, 2)
  downPayment          Decimal          @default(0) @db.Decimal(10, 2)
  numberOfInstallments Int
  installmentAmount    Decimal          @db.Decimal(10, 2)
  frequency            AutoPayFrequency @default(MONTHLY)

  // Interest/fees (optional)
  interestRate Decimal? @db.Decimal(5, 2) // Annual percentage
  setupFee     Decimal? @db.Decimal(10, 2)

  // Status
  status PaymentPlanStatus @default(ACTIVE)

  // Progress
  amountPaid       Decimal @default(0) @db.Decimal(10, 2)
  amountRemaining  Decimal @db.Decimal(10, 2)
  installmentsPaid Int     @default(0)

  // Schedule
  startDate   DateTime
  nextDueDate DateTime?
  endDate     DateTime?

  // Notes
  notes           String?
  termsAcceptedAt DateTime?

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  cancelledAt  DateTime?
  cancelReason String?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Installments
  installments PaymentPlanInstallment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([nextDueDate])
}

// Individual installment in a payment plan
model PaymentPlanInstallment {
  id                String @id @default(cuid())
  installmentNumber Int // 1, 2, 3, etc.

  // Amount
  amount Decimal @db.Decimal(10, 2)

  // Schedule
  dueDate DateTime

  // Status
  status     InstallmentStatus @default(SCHEDULED)
  paidAt     DateTime?
  paidAmount Decimal?          @db.Decimal(10, 2)

  // Retry tracking
  attemptCount  Int       @default(0)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  paymentPlanId String
  paymentPlan   PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  // Transaction that paid this installment
  transaction PaymentTransaction?

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

// Patient statement
model PatientStatement {
  id              String @id @default(cuid())
  statementNumber String // STM-2024-001

  // Period covered
  statementDate DateTime @default(now())
  periodStart   DateTime
  periodEnd     DateTime

  // Amounts
  previousBalance Decimal  @default(0) @db.Decimal(10, 2)
  newCharges      Decimal  @default(0) @db.Decimal(10, 2)
  payments        Decimal  @default(0) @db.Decimal(10, 2)
  adjustments     Decimal  @default(0) @db.Decimal(10, 2)
  totalDue        Decimal  @db.Decimal(10, 2)
  minimumDue      Decimal? @db.Decimal(10, 2)

  // Due date
  dueDate DateTime

  // Status
  status StatementStatus @default(DRAFT)

  // Content snapshot (for historical accuracy)
  chargeDetails  Json? // Array of charges included
  paymentDetails Json? // Array of payments in period

  // Delivery
  sentAt   DateTime?
  sentVia  String? // email, mail, portal
  sentTo   String? // Email or address
  viewedAt DateTime?

  // PDF storage
  pdfStorageKey String?

  // Notes
  notes            String?
  messageToPatient String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, statementNumber])
  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([statementDate])
  @@index([dueDate])
}

// Auto-pay enrollment
model AutoPayEnrollment {
  id String @id @default(cuid())

  // Settings
  frequency AutoPayFrequency @default(ON_STATEMENT)
  maxAmount Decimal?         @db.Decimal(10, 2) // Optional limit per charge

  // Schedule (for non-statement frequencies)
  dayOfWeek  Int? // 0-6 for weekly
  dayOfMonth Int? // 1-28 for monthly

  // Status
  isActive Boolean @default(true)

  // Next scheduled
  nextChargeDate DateTime?

  // Consent
  consentedAt  DateTime @default(now())
  consentIp    String?
  termsVersion String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  paymentMethodId String
  paymentMethod   StoredPaymentMethod @relation(fields: [paymentMethodId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([patientId, organizationId]) // One enrollment per patient per org
  @@index([organizationId])
  @@index([isActive])
  @@index([nextChargeDate])
}

// Refund tracking (extends PaymentTransaction for detailed tracking)
model Refund {
  id String @id @default(cuid())

  // Amount
  amount Decimal @db.Decimal(10, 2)

  // Reason
  reason         String
  reasonCategory String? // duplicate, patient_request, service_not_rendered, etc.

  // Status
  status PaymentTransactionStatus @default(PENDING)

  // Processor info
  processorRefundId String?

  // Original payment reference
  originalPaymentId     String
  originalTransactionId String?

  // Approval (if required)
  requiresApproval Boolean   @default(false)
  approvedAt       DateTime?
  approvedBy       String?

  // Timestamps
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Who initiated
  initiatedBy String // User ID

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Payment processor used for this refund
  paymentProcessorId String?
  paymentProcessor   PaymentProcessor? @relation(fields: [paymentProcessorId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentProcessorId])
}

// Processed webhook events (for idempotency - US-091)
model ProcessedWebhookEvent {
  id String @id @default(cuid())

  // Event identification (idempotency key)
  eventId   String // External event ID from payment processor
  eventType String // payment.succeeded, payment.failed, etc.

  // Processor info
  processorType PaymentProcessorType
  processorId   String? // Link to PaymentProcessor if organization-specific

  // Processing status
  status      WebhookProcessingStatus @default(PENDING)
  processedAt DateTime?
  retryCount  Int                     @default(0)
  lastError   String?                 @db.Text

  // Event data (raw payload for debugging/replay)
  rawPayload Json

  // Resulting actions taken
  actions Json? // Array of actions taken (e.g., transaction updated, email sent)

  // Timestamps
  receivedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Multi-tenant relation (null for events without org context)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related transaction (if applicable)
  transactionId String?
  transaction   PaymentTransaction? @relation(fields: [transactionId], references: [id])

  @@unique([eventId, processorType])
  @@index([organizationId])
  @@index([eventType])
  @@index([status])
  @@index([receivedAt])
}

// Webhook processing status
enum WebhookProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED // Already processed (idempotent check)
}

// ============================================
// EPIC 11: PATIENT COMMUNICATION HUB
// ============================================

// Communication channel type
enum CommunicationChannel {
  SMS
  EMAIL
  VOICE
  PORTAL
  IN_APP
}

// Message status
enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
  BOUNCED
}

// Message direction
enum MessageDirection {
  OUTBOUND // Practice to patient
  INBOUND // Patient to practice
}

// Communication type/purpose
enum CommunicationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_CANCELLATION
  APPOINTMENT_RESCHEDULE
  FORM_REQUEST
  PAYMENT_REMINDER
  BIRTHDAY
  RECALL
  MARKETING
  GENERAL
  CUSTOM
}

// Message template
model MessageTemplate {
  id          String               @id @default(cuid())
  name        String
  description String?
  type        CommunicationType
  channel     CommunicationChannel

  // Content
  subject String? // For email
  body    String  @db.Text

  // Template variables (e.g., {{patient.firstName}}, {{appointment.date}})
  variables Json? // List of available variables

  // Settings
  isActive Boolean @default(true)
  isSystem Boolean @default(false) // System templates can't be deleted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation (null = system template)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  messages              Message[]
  reminderRules         ReminderRule[]
  recallSequenceSteps   RecallSequenceStep[]
  recallCampaigns       RecallCampaign[]
  reactivationCampaigns ReactivationCampaign[]
  nurtureSequenceSteps  NurtureSequenceStep[]

  @@index([organizationId])
  @@index([type])
  @@index([channel])
  @@index([isActive])
}

// Individual message/communication
model Message {
  id String @id @default(cuid())

  // Routing
  channel   CommunicationChannel
  direction MessageDirection     @default(OUTBOUND)
  type      CommunicationType    @default(GENERAL)

  // Content
  subject String? // For email
  body    String  @db.Text

  // Delivery info
  recipient String // Phone number or email
  sender    String? // From number or email

  // Status tracking
  status        MessageStatus @default(PENDING)
  statusMessage String? // Error message if failed

  // External tracking
  externalId String? // Twilio SID, email message ID, etc.

  // Timestamps
  scheduledAt DateTime? // For scheduled messages
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  templateId String?
  template   MessageTemplate? @relation(fields: [templateId], references: [id])

  // For threaded conversations
  threadId String?
  thread   MessageThread? @relation(fields: [threadId], references: [id])

  // Who sent (for outbound) or received (for inbound review)
  userId String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([appointmentId])
  @@index([status])
  @@index([channel])
  @@index([direction])
  @@index([scheduledAt])
  @@index([createdAt])
  @@index([threadId])
}

// Message thread for conversations
model MessageThread {
  id      String  @id @default(cuid())
  subject String?

  // Status
  isOpen        Boolean  @default(true)
  lastMessageAt DateTime @default(now())

  // Unread tracking
  unreadCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Messages in thread
  messages Message[]

  @@index([organizationId])
  @@index([patientId])
  @@index([isOpen])
  @@index([lastMessageAt])
}

// Patient communication preferences
model CommunicationPreference {
  id String @id @default(cuid())

  // Channel preferences
  allowSms    Boolean @default(true)
  allowEmail  Boolean @default(true)
  allowVoice  Boolean @default(false)
  allowPortal Boolean @default(true)

  // Preferred channel for different types
  preferredChannel CommunicationChannel @default(SMS)

  // Time preferences
  preferredTimeStart String? // "09:00"
  preferredTimeEnd   String? // "17:00"
  timezone           String  @default("America/Los_Angeles")

  // Opt-outs
  optOutMarketing Boolean @default(false)
  optOutReminders Boolean @default(false)

  // Language
  language String @default("en")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

// Reminder rules/automation
model ReminderRule {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Trigger
  triggerType  String // appointment_scheduled, X_before_appointment, etc.
  triggerValue Int? // Minutes/hours/days before
  triggerUnit  String? // minutes, hours, days

  // Channel and template
  channel    CommunicationChannel
  templateId String
  template   MessageTemplate      @relation(fields: [templateId], references: [id])

  // Conditions
  appointmentTypes String[] // Empty = all types

  // Settings
  isActive Boolean @default(true)
  sendTime String? // Specific time to send (e.g., "09:00")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
}

// ============================================
// EPIC 15: REPORTING & ANALYTICS
// ============================================

// Widget type enum
enum WidgetType {
  METRIC // Single number display
  CHART_LINE // Line chart
  CHART_BAR // Bar chart
  CHART_PIE // Pie chart
  TABLE // Data table
  LIST // Simple list
  TREND // Metric with trend
}

// Report type enum
enum ReportType {
  DASHBOARD // Dashboard overview
  PROVIDER_PRODUCTION // Provider production report
  COLLECTIONS // Collections report
  AR_AGING // AR aging report
  KPI_SUMMARY // KPI summary
  CUSTOM // Custom report
}

// Report export format
enum ExportFormat {
  PDF
  CSV
  EXCEL
  JSON
}

// Report schedule frequency
enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

// Dashboard widget configuration
model DashboardWidget {
  id         String     @id @default(cuid())
  name       String
  widgetType WidgetType

  // Configuration
  config     Json // Widget-specific configuration
  dataSource String // Which data to display
  filters    Json? // Default filters

  // Layout
  position Int @default(0) // Order on dashboard
  width    Int @default(1) // 1-4 grid columns
  height   Int @default(1) // 1-4 grid rows

  // Settings
  isActive    Boolean @default(true)
  refreshRate Int? // Auto-refresh in seconds

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User who created/owns this widget
  userId String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([isActive])
}

// Saved report configuration
model SavedReport {
  id          String     @id @default(cuid())
  name        String
  description String?
  reportType  ReportType

  // Report configuration
  config    Json // Report-specific configuration
  filters   Json? // Saved filters
  columns   Json? // Selected columns for display
  sortBy    String? // Sort field
  sortOrder String? // asc or desc

  // Sharing
  isShared Boolean @default(false) // Visible to all users in org

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User who created this report
  userId String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  schedules ReportSchedule[]
  exports   ReportExport[]

  @@index([organizationId])
  @@index([userId])
  @@index([reportType])
}

// Scheduled report delivery
model ReportSchedule {
  id   String @id @default(cuid())
  name String

  // Schedule configuration
  frequency  ScheduleFrequency
  dayOfWeek  Int? // 0-6 for weekly (Sunday=0)
  dayOfMonth Int? // 1-31 for monthly
  timeOfDay  String            @default("08:00") // HH:mm format
  timezone   String            @default("America/Los_Angeles")

  // Export settings
  exportFormat ExportFormat @default(PDF)

  // Delivery
  recipients String[] // Email addresses
  subject    String? // Email subject
  message    String? // Email body text

  // Status
  isActive   Boolean   @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  lastStatus String? // success, error
  lastError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User who created the schedule
  userId String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Linked saved report
  savedReportId String
  savedReport   SavedReport @relation(fields: [savedReportId], references: [id], onDelete: Cascade)

  // Run history relation
  runHistory ScheduleRunHistory[]

  @@index([organizationId])
  @@index([isActive])
  @@index([nextRunAt])
}

// Schedule run history for tracking individual executions
model ScheduleRunHistory {
  id String @id @default(cuid())

  // Run details
  runAt  DateTime @default(now())
  status String // pending, running, completed, failed
  error  String?

  // Delivery tracking
  deliveredTo   String[] // Email addresses that received the report
  deliveryCount Int      @default(0) // Number of successful deliveries
  failedCount   Int      @default(0) // Number of failed deliveries

  // Export reference
  exportId String?

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int? // Duration in milliseconds

  // Schedule reference
  scheduleId String
  schedule   ReportSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([organizationId])
  @@index([runAt])
  @@index([status])
}

// KPI snapshot for historical tracking
model KPISnapshot {
  id           String   @id @default(cuid())
  snapshotDate DateTime @default(now())
  periodType   String // daily, weekly, monthly
  periodStart  DateTime
  periodEnd    DateTime

  // Visit metrics
  totalVisits     Int @default(0)
  completedVisits Int @default(0)
  cancelledVisits Int @default(0)
  noShowVisits    Int @default(0)
  newPatients     Int @default(0)

  // Financial metrics
  totalCharges     Decimal @default(0) @db.Decimal(12, 2)
  totalPayments    Decimal @default(0) @db.Decimal(12, 2)
  totalAdjustments Decimal @default(0) @db.Decimal(12, 2)
  totalAR          Decimal @default(0) @db.Decimal(12, 2)

  // Calculated KPIs
  collectionRate   Decimal? @db.Decimal(5, 2) // Percentage
  noShowRate       Decimal? @db.Decimal(5, 2) // Percentage
  patientRetention Decimal? @db.Decimal(5, 2) // Percentage
  avgVisitValue    Decimal? @db.Decimal(10, 2)
  avgDaysToCollect Decimal? @db.Decimal(5, 1)

  // AR aging breakdown
  arCurrent     Decimal? @db.Decimal(12, 2)
  ar30Days      Decimal? @db.Decimal(12, 2)
  ar60Days      Decimal? @db.Decimal(12, 2)
  ar90Days      Decimal? @db.Decimal(12, 2)
  ar120PlusDays Decimal? @db.Decimal(12, 2)

  // Claims metrics
  claimsSubmitted Int      @default(0)
  claimsPaid      Int      @default(0)
  claimsDenied    Int      @default(0)
  cleanClaimRate  Decimal? @db.Decimal(5, 2)

  // Raw data snapshot for detailed analysis
  metadata Json?

  createdAt DateTime @default(now())

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodType, periodStart])
  @@index([organizationId])
  @@index([snapshotDate])
  @@index([periodType])
  @@index([periodStart])
}

// Report export tracking
model ReportExport {
  id String @id @default(cuid())

  // Export details
  reportType   ReportType
  exportFormat ExportFormat
  fileName     String
  fileSize     Int? // Size in bytes
  storageKey   String? // S3 key or local path

  // Parameters used
  parameters Json? // Date range, filters, etc.

  // Status
  status String  @default("pending") // pending, processing, completed, failed
  error  String?

  // Timestamps
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // When the file will be deleted

  // User who requested
  userId String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Optional link to saved report
  savedReportId String?
  savedReport   SavedReport? @relation(fields: [savedReportId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}

// Generated Report with caching
model Report {
  id         String     @id @default(cuid())
  name       String
  reportType ReportType

  // Report parameters
  parameters Json // Input parameters (date range, filters, etc.)

  // Generated data
  data     Json // The actual report data/results
  metadata Json? // Additional metadata (row count, execution time, etc.)

  // Cache control
  generatedAt DateTime  @default(now())
  expiresAt   DateTime? // When the cache expires
  isStale     Boolean   @default(false) // Mark as needing regeneration

  // Source reference
  savedReportId String? // If generated from a saved report config

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // User who generated
  userId String

  @@index([organizationId])
  @@index([reportType])
  @@index([generatedAt])
  @@index([savedReportId])
  @@index([expiresAt])
}

// ============================================
// EPIC 13: AI SCHEDULING AGENT
// ============================================

// Risk level for no-show prediction
enum NoShowRiskLevel {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

// Overbooking recommendation status
enum OverbookingStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// Recall sequence status
enum RecallStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Recall step type
enum RecallStepType {
  EMAIL
  SMS
  PHONE_CALL
  LETTER
}

// Scheduling suggestion type
enum SuggestionType {
  OPTIMAL_TIME
  GAP_FILL
  WAITLIST_MATCH
  RESCHEDULE
  RECALL
}

// No-show prediction for appointments
model NoShowPrediction {
  id          String          @id @default(cuid())
  probability Float // 0.0 to 1.0
  riskLevel   NoShowRiskLevel

  // Factors contributing to prediction
  factors Json // { dayOfWeek: 0.15, timeSlot: 0.1, patientHistory: 0.3, ... }

  // Model info
  modelVersion    String @default("1.0")
  confidenceScore Float? // Model confidence in prediction

  // Outcome tracking (for model improvement)
  actualOutcome String? // ATTENDED, NO_SHOW, CANCELLED
  wasAccurate   Boolean? // Was the prediction correct?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([riskLevel])
  @@index([createdAt])
}

// Overbooking recommendations
model OverbookingRecommendation {
  id     String            @id @default(cuid())
  status OverbookingStatus @default(PENDING)

  // Recommendation details
  suggestedDate  DateTime
  suggestedTime  String // "09:00" format
  reason         String // Why this overbooking is recommended
  riskAssessment Float // Expected no-show probability for existing appointments
  expectedValue  Float? // Expected additional revenue

  // Decision tracking
  decidedAt     DateTime?
  decidedBy     String? // User ID
  declineReason String?

  // If accepted, link to the created appointment
  bookedAppointmentId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Recommendation expires after this time

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([status])
  @@index([suggestedDate])
}

// Detected schedule gaps
model SchedulingGap {
  id String @id @default(cuid())

  // Gap details
  gapStart        DateTime
  gapEnd          DateTime
  durationMinutes Int

  // Gap type and priority
  gapType      String // CANCELLATION, NATURAL, BETWEEN_BLOCKS
  fillPriority Int    @default(0) // Higher = more important to fill

  // Potential value if filled
  estimatedValue Float? // Estimated revenue if gap is filled

  // Status
  isFilled            Boolean   @default(false)
  filledAt            DateTime?
  filledAppointmentId String?

  // Analysis
  suggestedActions Json? // Array of suggested ways to fill

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([gapStart])
  @@index([isFilled])
}

// Provider utilization metrics
model ProviderUtilization {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  // Core metrics
  availableMinutes Int // Total available time
  bookedMinutes    Int // Time with appointments
  utilizedMinutes  Int // Actual patient time (attended)

  // Calculated rates (stored for quick queries)
  bookingRate     Float // bookedMinutes / availableMinutes
  utilizationRate Float // utilizedMinutes / bookedMinutes
  overallRate     Float // utilizedMinutes / availableMinutes

  // Appointment breakdown
  scheduledCount Int @default(0)
  completedCount Int @default(0)
  noShowCount    Int @default(0)
  cancelledCount Int @default(0)

  // Revenue metrics (optional)
  potentialRevenue Float? // If all slots were filled
  actualRevenue    Float? // Actual revenue generated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([providerId, date])
  @@index([organizationId])
  @@index([date])
}

// AI scheduling suggestions
model SchedulingSuggestion {
  id             String         @id @default(cuid())
  suggestionType SuggestionType

  // Suggestion details
  title       String
  description String
  priority    Int    @default(0) // Higher = more important

  // Suggested action
  suggestedDate       DateTime?
  suggestedTime       String? // "09:00" format
  suggestedProviderId String?

  // Context data
  contextData Json? // Additional context (patient preferences, etc.)

  // Scoring
  confidenceScore Float? // AI confidence in suggestion
  expectedBenefit Float? // Expected value/benefit

  // Status tracking
  isActioned   Boolean   @default(false)
  actionedAt   DateTime?
  actionedBy   String?
  actionResult String? // ACCEPTED, DECLINED, EXPIRED

  // Expiration
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (optional - may be for patient, provider, or general)
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  providerId String?
  provider   Provider? @relation(fields: [providerId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([suggestionType])
  @@index([isActioned])
  @@index([createdAt])
}

// Automated recall sequences
model RecallSequence {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Targeting
  appointmentTypes   String[] // Which appointment types trigger this recall
  daysSinceLastVisit Int // Trigger after X days since last visit

  // Status
  status RecallStatus @default(ACTIVE)

  // Settings
  maxAttempts    Int     @default(3)
  stopOnSchedule Boolean @default(true) // Stop if patient schedules

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  steps       RecallSequenceStep[]
  enrollments RecallEnrollment[]

  @@index([organizationId])
  @@index([status])
}

// Steps within a recall sequence
model RecallSequenceStep {
  id         String @id @default(cuid())
  stepNumber Int // Order in sequence

  // Step configuration
  stepType      RecallStepType
  daysFromStart Int // Days from enrollment to send this step

  // Message template
  templateId String?
  template   MessageTemplate? @relation(fields: [templateId], references: [id])

  // Custom message (if no template)
  subject String?
  body    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sequenceId String
  sequence   RecallSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Execution records
  executions RecallStepExecution[]

  @@unique([sequenceId, stepNumber])
  @@index([sequenceId])
}

// Patient enrollment in recall sequence
model RecallEnrollment {
  id String @id @default(cuid())

  // Enrollment details
  enrolledAt     DateTime  @default(now())
  lastStepNumber Int       @default(0) // Last completed step
  nextStepDue    DateTime? // When next step should be sent

  // Status
  status          RecallStatus @default(ACTIVE)
  completedAt     DateTime?
  completedReason String? // SCHEDULED, MAX_ATTEMPTS, OPTED_OUT, MANUAL

  // Outcome tracking
  didSchedule            Boolean @default(false)
  scheduledAppointmentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  sequenceId String
  sequence   RecallSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Execution records
  executions RecallStepExecution[]

  @@unique([patientId, sequenceId])
  @@index([status])
  @@index([nextStepDue])
}

// Record of executed recall steps
model RecallStepExecution {
  id String @id @default(cuid())

  // Execution details
  executedAt   DateTime @default(now())
  success      Boolean
  errorMessage String?

  // Message tracking
  messageId String? // Link to Message if sent

  // Relations
  enrollmentId String
  enrollment   RecallEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  stepId String
  step   RecallSequenceStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([executedAt])
}

// ============================================
// EPIC 12: AI COMMUNICATION AGENT
// ============================================

// Chat session status
enum ChatSessionStatus {
  ACTIVE
  ENDED
  ABANDONED
  TRANSFERRED
}

// Chat message sender type
enum ChatSenderType {
  USER
  AI
  SYSTEM
}

// Campaign status
enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Campaign type
enum CampaignType {
  RECALL
  REACTIVATION
  BIRTHDAY
  PROMOTIONAL
  SURVEY
}

// Patient campaign status
enum PatientCampaignStatus {
  PENDING
  SENT
  DELIVERED
  RESPONDED
  CONVERTED
  OPTED_OUT
  FAILED
}

// Feedback sentiment
enum FeedbackSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

// AI intent types
enum AIIntent {
  BOOKING
  RESCHEDULE
  CANCEL
  FAQ_INSURANCE
  FAQ_GENERAL
  FAQ_SERVICES
  FAQ_HOURS
  FAQ_LOCATION
  COMPLAINT
  COMPLIMENT
  GENERAL_INQUIRY
  UNKNOWN
}

// Chat session for AI chatbot
model ChatSession {
  id      String               @id @default(cuid())
  status  ChatSessionStatus    @default(ACTIVE)
  channel CommunicationChannel @default(PORTAL)

  // Session metadata
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Context for AI
  context  Json? // Conversation context, detected intents, etc.
  metadata Json? // Browser info, referrer, etc.

  // Summary
  summary        String?  @db.Text // AI-generated session summary
  resolvedIssues String[] // What was resolved

  // Satisfaction tracking
  satisfactionScore Int? // 1-5 rating if provided

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Messages in session
  messages ChatMessage[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([startedAt])
}

// Individual chat message
model ChatMessage {
  id         String         @id @default(cuid())
  senderType ChatSenderType
  content    String         @db.Text

  // Intent detection
  detectedIntent   AIIntent?
  intentConfidence Float? // 0-1 confidence score

  // For AI responses
  responseMetadata Json? // Model used, tokens, latency, etc.

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@index([detectedIntent])
}

// AI Conversation context (for maintaining context across interactions)
model AIConversationContext {
  id String @id @default(cuid())

  // Context data
  patientContext      Json? // Known patient info for personalization
  conversationHistory Json? // Recent conversation turns
  detectedPreferences Json? // Inferred patient preferences

  // Booking context
  pendingBooking Json? // In-progress booking state

  // Last interaction
  lastInteractionAt DateTime @default(now())

  // Expiration
  expiresAt DateTime // Context expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([expiresAt])
}

// Recall campaign (automated follow-up)
model RecallCampaign {
  id          String         @id @default(cuid())
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)
  type        CampaignType   @default(RECALL)

  // Targeting criteria
  targetCriteria Json // Last visit date range, appointment types, etc.

  // Schedule
  scheduledStartAt DateTime?
  scheduledEndAt   DateTime?
  startedAt        DateTime?
  completedAt      DateTime?

  // Message configuration
  channel    CommunicationChannel @default(SMS)
  templateId String?
  template   MessageTemplate?     @relation(fields: [templateId], references: [id])

  // Custom message (if no template)
  messageSubject String?
  messageBody    String? @db.Text

  // Sequence configuration (for multi-touch campaigns)
  sequenceConfig Json? // Array of { delay, channel, template }

  // Stats
  totalTargeted  Int @default(0)
  totalSent      Int @default(0)
  totalDelivered Int @default(0)
  totalResponded Int @default(0)
  totalConverted Int @default(0) // Booked appointment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Patients in campaign
  patients RecallCampaignPatient[]

  @@index([organizationId])
  @@index([status])
  @@index([type])
  @@index([scheduledStartAt])
}

// Patient in recall campaign
model RecallCampaignPatient {
  id     String                @id @default(cuid())
  status PatientCampaignStatus @default(PENDING)

  // Delivery tracking
  sentAt      DateTime?
  deliveredAt DateTime?
  respondedAt DateTime?
  convertedAt DateTime?

  // Response data
  response        String? // Patient response text
  responseChannel CommunicationChannel?

  // Opt-out tracking
  optedOutAt   DateTime?
  optOutReason String?

  // Failure tracking
  failureReason String?
  retryCount    Int       @default(0)
  lastRetryAt   DateTime?

  // Sequence tracking
  currentStep Int       @default(0)
  lastStepAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaignId String
  campaign   RecallCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Related appointment (if converted)
  appointmentId String?

  @@unique([campaignId, patientId])
  @@index([campaignId])
  @@index([patientId])
  @@index([status])
}

// Reactivation campaign (for lapsed patients)
model ReactivationCampaign {
  id          String         @id @default(cuid())
  name        String
  description String?
  status      CampaignStatus @default(DRAFT)

  // Targeting criteria
  minDaysSinceVisit     Int     @default(90) // Minimum days since last visit
  maxDaysSinceVisit     Int? // Maximum days (null = no limit)
  excludeActivePatients Boolean @default(true)
  additionalCriteria    Json? // Extra filtering

  // Schedule
  scheduledStartAt DateTime?
  startedAt        DateTime?
  completedAt      DateTime?

  // Message configuration
  channel    CommunicationChannel @default(EMAIL)
  templateId String?
  template   MessageTemplate?     @relation(fields: [templateId], references: [id])

  // Custom message (if no template)
  messageSubject String?
  messageBody    String? @db.Text

  // Incentive/offer
  offerCode        String?
  offerDescription String?
  offerExpiresAt   DateTime?

  // Stats
  totalTargeted    Int @default(0)
  totalSent        Int @default(0)
  totalDelivered   Int @default(0)
  totalResponded   Int @default(0)
  totalReactivated Int @default(0) // Booked/visited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Patients in campaign
  patients ReactivationCampaignPatient[]

  @@index([organizationId])
  @@index([status])
  @@index([scheduledStartAt])
}

// Patient in reactivation campaign
model ReactivationCampaignPatient {
  id     String                @id @default(cuid())
  status PatientCampaignStatus @default(PENDING)

  // Patient snapshot at targeting
  lastVisitDate  DateTime?
  daysSinceVisit Int?

  // Delivery tracking
  sentAt        DateTime?
  deliveredAt   DateTime?
  respondedAt   DateTime?
  reactivatedAt DateTime? // When they booked/visited

  // Response data
  response String?

  // Opt-out tracking
  optedOutAt DateTime?

  // Failure tracking
  failureReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaignId String
  campaign   ReactivationCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Related appointment (if reactivated)
  appointmentId String?

  @@unique([campaignId, patientId])
  @@index([campaignId])
  @@index([patientId])
  @@index([status])
}

// Patient feedback with sentiment analysis
model PatientFeedback {
  id String @id @default(cuid())

  // Feedback content
  content String @db.Text
  source  String // survey, review, chat, email, etc.

  // Ratings (optional, 1-5 scale)
  overallRating  Int?
  serviceRating  Int?
  staffRating    Int?
  facilityRating Int?

  // Sentiment analysis
  sentiment           FeedbackSentiment?
  sentimentScore      Float? // -1 to 1 (negative to positive)
  sentimentConfidence Float? // 0 to 1

  // AI analysis
  keyTopics        String[] // Extracted topics
  suggestedActions Json? // AI-suggested follow-up actions

  // Follow-up tracking
  requiresFollowUp Boolean   @default(false)
  followedUpAt     DateTime?
  followedUpBy     String?
  followUpNotes    String?   @db.Text

  // Attribution
  appointmentId String? // If related to specific visit
  providerId    String? // If about specific provider

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([sentiment])
  @@index([sentimentScore])
  @@index([requiresFollowUp])
  @@index([createdAt])
}

// ============================================
// EPIC 08: CLEARINGHOUSE INTEGRATION
// ============================================

// Clearinghouse provider type
enum ClearinghouseProvider {
  CHANGE_HEALTHCARE
  TRIZETTO
  AVAILITY
  OFFICE_ALLY
  MOCK // For development/testing
}

// EDI transaction type
enum EDITransactionType {
  CLAIM_837P // Professional claim submission
  ELIGIBILITY_270 // Eligibility inquiry
  ELIGIBILITY_271 // Eligibility response
  STATUS_276 // Claim status inquiry
  STATUS_277 // Claim status response
  REMITTANCE_835 // Electronic remittance advice
}

// Submission status
enum SubmissionStatus {
  PENDING // Queued for submission
  SUBMITTED // Sent to clearinghouse
  ACCEPTED // Acknowledged by clearinghouse
  REJECTED // Rejected by clearinghouse (fixable errors)
  ERROR // System error
  PROCESSING // Clearinghouse processing
  COMPLETED // Successfully processed
}

// Eligibility status
enum EligibilityStatus {
  PENDING
  CHECKING
  ACTIVE // Coverage is active
  INACTIVE // Coverage is inactive
  UNKNOWN // Could not determine
  ERROR // Error checking eligibility
}

// Denial status
enum DenialStatus {
  NEW // New denial received
  UNDER_REVIEW // Being reviewed
  APPEALED // Appeal submitted
  RESOLVED // Resolution received
  WRITTEN_OFF // Written off as uncollectable
  REBILLED // Corrected and rebilled
  CLOSED // Closed without further action
}

// Clearinghouse configuration (per organization)
model ClearinghouseConfig {
  id        String                @id @default(cuid())
  provider  ClearinghouseProvider @default(MOCK)
  name      String // Display name "Change Healthcare - Production"
  isActive  Boolean               @default(true)
  isPrimary Boolean               @default(false) // Primary clearinghouse for org

  // Connection credentials (encrypted in production)
  submitterId String? // Submitter ID for EDI
  username    String?
  password    String? // Should be encrypted
  apiKey      String? // API key if applicable
  siteId      String? // Site/practice ID

  // Endpoints
  baseUrl             String? // API base URL
  claimEndpoint       String? // 837P submission endpoint
  eligibilityEndpoint String? // 270/271 endpoint
  statusEndpoint      String? // 276/277 endpoint
  eraEndpoint         String? // 835 download endpoint

  // Settings
  settings    Json? // Provider-specific settings
  batchSize   Int     @default(50) // Max claims per batch
  autoSubmit  Boolean @default(false) // Auto-submit ready claims
  autoPostEra Boolean @default(false) // Auto-post ERA payments

  // Billing info
  billingNpi   String? // Billing provider NPI
  billingTaxId String? // Tax ID for billing

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  submissions       ClaimSubmission[]
  eligibilityChecks EligibilityCheck[]
  statusChecks      ClaimStatusCheck[]
  remittances       Remittance[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([provider])
  @@index([isActive])
}

// Claim submission tracking (837P)
model ClaimSubmission {
  id             String           @id @default(cuid())
  submissionDate DateTime         @default(now())
  status         SubmissionStatus @default(PENDING)

  // Batch tracking
  batchId       String? // EDI batch/interchange ID
  controlNumber String? // ST02 control number

  // Response tracking
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  responseMessage String? // Error or acknowledgment message
  responseCode    String? // Response code from clearinghouse

  // 999/TA1 acknowledgment
  ackStatus  String? // A=Accepted, R=Rejected, E=Error
  ackDate    DateTime?
  ackDetails Json? // Full acknowledgment details

  // Retry tracking
  retryCount  Int       @default(0)
  lastRetryAt DateTime?
  maxRetries  Int       @default(3)

  // Raw EDI data (for debugging)
  ediContent      String? @db.Text // The 837P content
  responseContent String? @db.Text // The response/ack content

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id])

  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([submissionDate])
  @@index([batchId])
}

// Eligibility verification (270/271)
model EligibilityCheck {
  id        String            @id @default(cuid())
  checkDate DateTime          @default(now())
  status    EligibilityStatus @default(PENDING)

  // Request info
  serviceDate  DateTime? // Date of service for eligibility
  serviceTypes String[] // Service type codes being checked

  // Patient/subscriber info (snapshot at check time)
  subscriberId     String?
  subscriberName   String?
  subscriberDob    DateTime?
  relationshipCode String? // Relationship to subscriber

  // Payer info
  payerId   String? // Payer ID
  payerName String?

  // Response data
  responseDate   DateTime?
  coverageStatus String? // Active, Inactive, etc.
  planName       String?
  planType       String? // HMO, PPO, etc.

  // Benefits info
  deductible     Decimal? @db.Decimal(10, 2)
  deductibleMet  Decimal? @db.Decimal(10, 2)
  outOfPocketMax Decimal? @db.Decimal(10, 2)
  outOfPocketMet Decimal? @db.Decimal(10, 2)
  copay          Decimal? @db.Decimal(10, 2)
  coinsurance    Decimal? @db.Decimal(5, 2) // Percentage

  // Visit limits
  visitsRemaining Int?
  visitsUsed      Int?
  visitsMax       Int?

  // Authorization info
  authRequired      Boolean?
  authNumber        String?
  authEffectiveDate DateTime?
  authTermDate      DateTime?

  // Full response
  responseJson Json? // Full 271 response data
  errorMessage String?

  // Raw EDI
  ediRequest  String? @db.Text
  ediResponse String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  insuranceId String?
  insurance   PatientInsurance? @relation(fields: [insuranceId], references: [id])

  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([checkDate])
}

// Claim status inquiry (276/277)
model ClaimStatusCheck {
  id        String           @id @default(cuid())
  checkDate DateTime         @default(now())
  status    SubmissionStatus @default(PENDING)

  // Request tracking
  traceNumber String? // TRN02 trace number

  // Response data
  responseDate      DateTime?
  claimStatus       String? // Claim status category
  statusCode        String? // Status category code
  statusDescription String?

  // Claim-level response
  totalCharged          Decimal? @db.Decimal(10, 2)
  totalPaid             Decimal? @db.Decimal(10, 2)
  patientResponsibility Decimal? @db.Decimal(10, 2)
  payerClaimNumber      String? // Payer's claim number

  // Adjudication date
  adjudicationDate DateTime?
  checkNumber      String?
  paymentDate      DateTime?

  // Full response
  responseJson Json?
  errorMessage String?

  // Raw EDI
  ediRequest  String? @db.Text
  ediResponse String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id])

  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([checkDate])
}

// Electronic remittance advice (835 ERA/EOB)
model Remittance {
  id            String    @id @default(cuid())
  receivedDate  DateTime  @default(now())
  processedDate DateTime?
  isProcessed   Boolean   @default(false)

  // ERA identification
  checkNumber String? // Check or EFT number
  checkDate   DateTime?
  payerName   String?
  payerId     String?

  // Payment totals
  totalPaid     Decimal @default(0) @db.Decimal(10, 2)
  totalAdjusted Decimal @default(0) @db.Decimal(10, 2)
  totalCharges  Decimal @default(0) @db.Decimal(10, 2)
  claimCount    Int     @default(0)

  // Provider-level payment
  providerPaid     Decimal? @db.Decimal(10, 2)
  providerAdjusted Decimal? @db.Decimal(10, 2)

  // Raw ERA data
  ediContent String? @db.Text // Original 835 content
  parsedData Json? // Parsed ERA data

  // Processing notes
  notes        String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Line items
  lineItems RemittanceLineItem[]

  @@index([organizationId])
  @@index([receivedDate])
  @@index([isProcessed])
  @@index([checkNumber])
}

// Remittance line item (per claim/service)
model RemittanceLineItem {
  id         String @id @default(cuid())
  lineNumber Int

  // Claim reference
  patientName          String?
  patientAccountNumber String?
  payerClaimNumber     String?

  // Service info
  serviceDate DateTime?
  cptCode     String?
  modifiers   String[]
  units       Int       @default(1)

  // Amounts
  chargedAmount  Decimal @default(0) @db.Decimal(10, 2)
  allowedAmount  Decimal @default(0) @db.Decimal(10, 2)
  paidAmount     Decimal @default(0) @db.Decimal(10, 2)
  adjustedAmount Decimal @default(0) @db.Decimal(10, 2)
  patientAmount  Decimal @default(0) @db.Decimal(10, 2)

  // Adjustment reason codes
  adjustmentReasonCodes String[] // CARC codes
  adjustmentAmounts     Json? // Amount per CARC code
  remarkCodes           String[] // RARC codes

  // Status
  isPosted Boolean   @default(false)
  postedAt DateTime?
  postedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  remittanceId String
  remittance   Remittance @relation(fields: [remittanceId], references: [id], onDelete: Cascade)

  // Link to internal claim if matched
  claimId String?
  claim   Claim?  @relation(fields: [claimId], references: [id])

  chargeId String?
  charge   Charge? @relation(fields: [chargeId], references: [id])

  // AI Billing relations (Epic 09)
  paymentMatchSuggestions PaymentMatchSuggestion[]

  @@index([remittanceId])
  @@index([claimId])
  @@index([isPosted])
}

// Denial tracking and management
model Denial {
  id         String       @id @default(cuid())
  denialDate DateTime     @default(now())
  status     DenialStatus @default(NEW)

  // Denial info
  denialCode   String? // CARC/denial code
  denialReason String // Human-readable reason
  category     String? // Category: Authorization, Medical Necessity, etc.

  // Amounts
  deniedAmount Decimal @default(0) @db.Decimal(10, 2)
  billedAmount Decimal @default(0) @db.Decimal(10, 2)

  // Service info
  serviceDate DateTime?
  cptCode     String?

  // Appeal tracking
  appealDeadline DateTime?
  appealedAt     DateTime?
  appealedBy     String?
  appealNumber   String?
  appealNotes    String?   @db.Text
  appealOutcome  String? // Upheld, Overturned, Partial

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?   @db.Text
  recoveredAmount Decimal?  @db.Decimal(10, 2)

  // Payer info
  payerId   String?
  payerName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Notes and documents
  notes DenialNote[]

  // AI Billing relations (Epic 09)
  appealLetters AppealLetter[]

  @@index([organizationId])
  @@index([claimId])
  @@index([patientId])
  @@index([status])
  @@index([denialDate])
  @@index([appealDeadline])
}

// Denial notes/activity log
model DenialNote {
  id        String   @id @default(cuid())
  noteType  String // status_change, appeal, follow_up, resolution, etc.
  note      String   @db.Text
  createdAt DateTime @default(now())
  createdBy String? // User ID

  // Relations
  denialId String
  denial   Denial @relation(fields: [denialId], references: [id], onDelete: Cascade)

  @@index([denialId])
  @@index([createdAt])
}

// ============================================
// EPIC 14: PATIENT PORTAL
// ============================================

// Portal user status
enum PortalUserStatus {
  PENDING // Account created but not verified
  ACTIVE // Active account
  SUSPENDED // Temporarily suspended
  DEACTIVATED // Account deactivated
  LOCKED // Locked due to failed login attempts
}

// Portal document visibility
enum PortalDocumentVisibility {
  ALWAYS // Always visible to patient
  AFTER_REVIEW // Visible after staff review
  HIDDEN // Hidden from patient
}

// Portal document category
enum PortalDocumentCategory {
  VISIT_SUMMARY // Visit summaries
  TREATMENT_PLAN // Treatment plans
  LAB_RESULTS // Lab results
  IMAGING // X-rays, MRIs, etc.
  CONSENT_FORM // Signed consent forms
  EDUCATION // Patient education materials
  BILLING // Bills and statements
  INSURANCE // Insurance documents
  OTHER // Other documents
}

// Secure message status
enum SecureMessageStatus {
  UNREAD
  READ
  ARCHIVED
  DELETED
}

// Secure message priority
enum SecureMessagePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Appointment request status
enum AppointmentRequestStatus {
  PENDING // Awaiting staff review
  APPROVED // Approved and scheduled
  DENIED // Denied by staff
  CANCELLED // Cancelled by patient
  EXPIRED // Request expired
}

// Portal user (patient portal login credentials)
model PortalUser {
  id           String           @id @default(cuid())
  email        String // Email for login (may differ from patient contact email)
  passwordHash String
  status       PortalUserStatus @default(PENDING)

  // Email verification
  emailVerified      Boolean   @default(false)
  emailVerifyToken   String?
  emailVerifyExpires DateTime?

  // Password reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Security tracking
  failedLoginAttempts Int       @default(0)
  lastFailedLogin     DateTime?
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?

  // Terms acceptance
  termsAcceptedAt DateTime?
  termsVersion    String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  activatedAt   DateTime?
  deactivatedAt DateTime?

  // Relations
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  sessions    PortalSession[]
  accessLogs  PortalAccessLog[]
  preferences PortalPreferences?

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([email])
  @@index([status])
  @@index([patientId])
}

// Portal session tracking
model PortalSession {
  id    String @id @default(cuid())
  token String @unique @default(cuid())

  // Session info
  userAgent  String?
  ipAddress  String?
  deviceType String? // mobile, tablet, desktop

  // Timestamps
  createdAt      DateTime  @default(now())
  expiresAt      DateTime
  lastActivityAt DateTime  @default(now())
  revokedAt      DateTime?

  // Relations
  portalUserId String
  portalUser   PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  @@index([portalUserId])
  @@index([token])
  @@index([expiresAt])
}

// Portal access audit log
model PortalAccessLog {
  id         String  @id @default(cuid())
  action     String // LOGIN, LOGOUT, VIEW_APPOINTMENT, DOWNLOAD_DOCUMENT, etc.
  resource   String? // Resource type accessed
  resourceId String? // ID of resource accessed

  // Request info
  ipAddress String?
  userAgent String?

  // Additional context
  metadata Json? // Additional action-specific data

  // Outcome
  success      Boolean @default(true)
  errorMessage String?

  createdAt DateTime @default(now())

  // Relations
  portalUserId String
  portalUser   PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([portalUserId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
}

// Secure messaging between patient and practice
model SecureMessage {
  id      String @id @default(cuid())
  subject String
  body    String @db.Text

  // Sender/recipient
  isFromPatient Boolean @default(true) // true = patient sent, false = staff sent
  senderName    String? // Display name of sender
  senderId      String? // User ID if from staff

  // Status and priority
  status   SecureMessageStatus   @default(UNREAD)
  priority SecureMessagePriority @default(NORMAL)

  // Threading
  parentMessageId String? // For replies
  parentMessage   SecureMessage?  @relation("MessageReplies", fields: [parentMessageId], references: [id])
  replies         SecureMessage[] @relation("MessageReplies")

  // Attachments
  attachments Json? // Array of { fileName, fileSize, storageKey }

  // Timestamps
  readAt     DateTime?
  archivedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([organizationId])
  @@index([status])
  @@index([isFromPatient])
  @@index([createdAt])
  @@index([parentMessageId])
}

// Documents available to patient through portal
model PortalDocument {
  id          String                 @id @default(cuid())
  title       String
  description String?
  category    PortalDocumentCategory

  // File info
  fileName   String
  fileSize   Int // Size in bytes
  mimeType   String
  storageKey String // S3 key or file path

  // Visibility and access
  visibility PortalDocumentVisibility @default(AFTER_REVIEW)
  visibleAt  DateTime? // When document becomes visible

  // Review tracking (for AFTER_REVIEW visibility)
  reviewedAt DateTime?
  reviewedBy String? // User ID

  // Linked records
  encounterId     String? // Associated encounter
  treatmentPlanId String? // Associated treatment plan

  // Expiration (optional)
  expiresAt DateTime?

  // Access tracking
  lastViewedAt     DateTime?
  viewCount        Int       @default(0)
  lastDownloadedAt DateTime?
  downloadCount    Int       @default(0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  uploadedBy String? // User ID

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([organizationId])
  @@index([category])
  @@index([visibility])
  @@index([visibleAt])
  @@index([createdAt])
}

// Patient portal preferences/settings
model PortalPreferences {
  id String @id @default(cuid())

  // Notification preferences
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)

  // Notification types
  notifyAppointmentReminders Boolean @default(true)
  notifyAppointmentChanges   Boolean @default(true)
  notifyNewMessages          Boolean @default(true)
  notifyNewDocuments         Boolean @default(true)
  notifyBillingStatements    Boolean @default(true)
  notifyFormRequests         Boolean @default(true)

  // Appointment reminder timing (hours before appointment)
  reminderTiming1 Int  @default(24) // First reminder (hours before)
  reminderTiming2 Int? // Second reminder (optional)
  reminderTiming3 Int? // Third reminder (optional)

  // Marketing preferences
  marketingEmailOptIn Boolean @default(false) // Newsletter, promotions
  marketingSmsOptIn   Boolean @default(false) // Text campaigns
  marketingCallOptIn  Boolean @default(false) // Phone calls

  // Communication preferences
  preferredLanguage String @default("en")

  // Display preferences
  timezone   String @default("America/Los_Angeles")
  dateFormat String @default("MM/DD/YYYY")
  timeFormat String @default("12h") // 12h or 24h

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  portalUserId String     @unique
  portalUser   PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  @@index([portalUserId])
}

// Appointment request from patient portal
model AppointmentRequest {
  id     String                   @id @default(cuid())
  status AppointmentRequestStatus @default(PENDING)

  // Request details
  requestedDate     DateTime? // Specific date requested
  preferredDates    Json? // Array of preferred dates/times
  appointmentTypeId String? // Requested appointment type
  providerId        String? // Preferred provider (if any)

  // Reason/notes
  reason       String? // Reason for visit
  patientNotes String? @db.Text

  // Urgency
  isUrgent Boolean @default(false)

  // Staff response
  staffNotes   String?   @db.Text
  denialReason String?
  reviewedAt   DateTime?
  reviewedBy   String? // User ID

  // Result
  scheduledAppointmentId String? // Created appointment ID if approved

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// EPIC 17: INVENTORY & POS
// ============================================

// Product status
enum ProductStatus {
  ACTIVE // Available for sale
  INACTIVE // Not available, still in inventory
  DISCONTINUED // No longer sold
  OUT_OF_STOCK // Temporarily out
}

// Inventory movement type
enum InventoryMovementType {
  PURCHASE // Received from vendor
  SALE // Sold to customer
  ADJUSTMENT_UP // Manual increase
  ADJUSTMENT_DOWN // Manual decrease
  TRANSFER_IN // Transferred from another location
  TRANSFER_OUT // Transferred to another location
  RETURN // Customer return
  DAMAGE // Damaged/write-off
  EXPIRY // Expired product
  VOID_SALE // Voided sale reversal
}

// Purchase order status
enum PurchaseOrderStatus {
  DRAFT // Being created
  SUBMITTED // Sent to vendor
  CONFIRMED // Vendor confirmed
  PARTIAL // Partially received
  RECEIVED // Fully received
  CANCELLED // Cancelled
}

// Sale status
enum SaleStatus {
  PENDING // In progress
  COMPLETED // Finalized
  VOIDED // Cancelled/voided
  REFUNDED // Fully refunded
  PARTIAL_REFUND // Partially refunded
}

// Low stock alert status
enum AlertStatus {
  ACTIVE // Alert is active
  ACKNOWLEDGED // Seen but not resolved
  RESOLVED // Stock replenished
  IGNORED // User chose to ignore
}

// Payment method for POS
enum POSPaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  CHECK
  STORE_CREDIT
  INSURANCE
  OTHER
}

// Product category
model ProductCategory {
  id          String  @id @default(cuid())
  name        String // "Supplements", "Orthotics", etc.
  description String?
  slug        String // URL-friendly name
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)

  // Hierarchical categories
  parentId String?
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  products Product[]

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([parentId])
  @@index([isActive])
}

// Product (sellable item)
model Product {
  id          String        @id @default(cuid())
  name        String
  description String?       @db.Text
  sku         String // Stock Keeping Unit (org-unique)
  barcode     String? // UPC/EAN barcode
  status      ProductStatus @default(ACTIVE)

  // Pricing
  costPrice   Decimal @default(0) @db.Decimal(10, 2) // What we pay
  retailPrice Decimal @db.Decimal(10, 2) // What we sell for

  // Tax settings
  isTaxable Boolean  @default(true)
  taxRate   Decimal? @db.Decimal(5, 4) // Override org default

  // Physical attributes
  weight     Decimal? @db.Decimal(10, 2)
  weightUnit String?  @default("oz") // oz, lb, g, kg
  dimensions String? // "LxWxH"

  // Inventory settings
  trackInventory    Boolean @default(true)
  lowStockThreshold Int     @default(5)
  reorderPoint      Int     @default(10)
  reorderQuantity   Int     @default(25)

  // Additional info
  brand        String?
  manufacturer String?
  notes        String? @db.Text
  imageUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Category relation
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id])

  // Preferred vendor
  preferredVendorId String?
  preferredVendor   Vendor? @relation("PreferredVendor", fields: [preferredVendorId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  inventoryItems     InventoryItem[]
  inventoryMovements InventoryMovement[]
  purchaseOrderItems PurchaseOrderItem[]
  saleItems          SaleItem[]
  lowStockAlerts     LowStockAlert[]
  vendorProducts     VendorProduct[]

  // Inter-Location Inventory relations (Epic 25 - US-254)
  transferItems InventoryTransferItem[]

  @@unique([sku, organizationId])
  @@unique([barcode, organizationId])
  @@index([organizationId])
  @@index([categoryId])
  @@index([status])
  @@index([barcode])
  @@index([sku])
}

// Inventory item (product at a location)
model InventoryItem {
  id           String @id @default(cuid())
  quantity     Int    @default(0) // Current stock level
  reservedQty  Int    @default(0) // Reserved for orders
  availableQty Int    @default(0) // quantity - reservedQty

  // Storage location within the practice location
  storageArea String  @default("main") // "main", "backroom", "display"
  binNumber   String? // Shelf/bin location

  // Valuation
  averageCost Decimal @default(0) @db.Decimal(10, 2)
  lastCost    Decimal @default(0) @db.Decimal(10, 2)

  // Tracking
  lastCountDate DateTime?
  lastCountBy   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25)
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  @@unique([productId, storageArea, organizationId, locationId])
  @@index([organizationId])
  @@index([productId])
  @@index([storageArea])
  @@index([locationId])
}

// Inventory movement (stock changes)
model InventoryMovement {
  id           String                @id @default(cuid())
  movementType InventoryMovementType
  quantity     Int // Positive for increases, negative for decreases

  // Reference to source
  referenceType String? // "sale", "purchase_order", "adjustment", "transfer"
  referenceId   String? // ID of the source document

  // Cost at time of movement
  unitCost  Decimal @default(0) @db.Decimal(10, 2)
  totalCost Decimal @default(0) @db.Decimal(10, 2)

  // Storage area tracking (within a location)
  fromStorageArea String?
  toStorageArea   String?

  notes     String?
  createdBy String // User ID
  createdAt DateTime @default(now())

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25)
  locationId     String?
  location       Location? @relation(fields: [locationId], references: [id])
  fromLocationId String? // For inter-location transfers
  toLocationId   String? // For inter-location transfers

  @@index([organizationId])
  @@index([productId])
  @@index([movementType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@index([locationId])
  @@index([fromLocationId])
  @@index([toLocationId])
}

// Vendor/Supplier
model Vendor {
  id       String  @id @default(cuid())
  name     String
  code     String? // Short code for the vendor
  isActive Boolean @default(true)

  // Contact info
  contactName String?
  email       String?
  phone       String?
  fax         String?
  website     String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String  @default("US")

  // Payment terms
  paymentTerms String? // "Net 30", "Net 60", etc.
  creditLimit  Decimal? @db.Decimal(10, 2)

  // Account info
  accountNumber String?
  taxId         String?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  purchaseOrders PurchaseOrder[]
  vendorProducts VendorProduct[]
  preferredFor   Product[]       @relation("PreferredVendor")

  // Security & Compliance relations (Epic 26)
  baaDocuments BAADocument[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([isActive])
  @@index([name])
}

// Vendor product (vendor-specific product info)
model VendorProduct {
  id           String  @id @default(cuid())
  vendorSku    String? // Vendor's SKU for this product
  vendorPrice  Decimal @default(0) @db.Decimal(10, 2)
  minOrderQty  Int     @default(1)
  leadTimeDays Int? // Typical delivery time
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([productId, vendorId])
  @@index([vendorId])
  @@index([productId])
}

// Purchase order
model PurchaseOrder {
  id       String              @id @default(cuid())
  poNumber String // PO-YYYYMMDD-001 format
  status   PurchaseOrderStatus @default(DRAFT)

  // Dates
  orderDate    DateTime  @default(now())
  expectedDate DateTime?
  receivedDate DateTime?

  // Totals
  subtotal     Decimal @default(0) @db.Decimal(10, 2)
  taxAmount    Decimal @default(0) @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal @default(0) @db.Decimal(10, 2)

  // Shipping info
  shipToAddress  String? @db.Text
  shippingMethod String?
  trackingNumber String?

  notes         String? @db.Text
  internalNotes String? @db.Text

  createdBy String // User ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Line items
  items PurchaseOrderItem[]

  @@unique([poNumber, organizationId])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([orderDate])
}

// Purchase order line item
model PurchaseOrderItem {
  id         String @id @default(cuid())
  lineNumber Int

  // Quantities
  orderedQty  Int @default(0)
  receivedQty Int @default(0)

  // Pricing
  unitCost  Decimal @default(0) @db.Decimal(10, 2)
  totalCost Decimal @default(0) @db.Decimal(10, 2)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@unique([purchaseOrderId, lineNumber])
  @@index([purchaseOrderId])
  @@index([productId])
}

// Point of Sale transaction
model Sale {
  id         String     @id @default(cuid())
  saleNumber String // SALE-YYYYMMDD-001 format
  status     SaleStatus @default(PENDING)

  // Timing
  saleDate    DateTime  @default(now())
  completedAt DateTime?
  voidedAt    DateTime?
  voidedBy    String?
  voidReason  String?

  // Totals
  subtotal        Decimal  @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(10, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountReason  String?
  taxAmount       Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal  @default(0) @db.Decimal(10, 2)

  // Payment
  paymentMethod  POSPaymentMethod @default(CASH)
  amountTendered Decimal          @default(0) @db.Decimal(10, 2)
  changeGiven    Decimal          @default(0) @db.Decimal(10, 2)

  // Reference to payment transaction (if card)
  paymentTransactionId String?

  // Customer (optional for POS)
  patientId     String?
  customerName  String? // For non-patient sales
  customerPhone String?
  customerEmail String?

  notes String?

  // Staff info
  salesPersonId String // User ID
  cashierId     String? // User ID (if different)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Line items
  items SaleItem[]

  @@unique([saleNumber, organizationId])
  @@index([organizationId])
  @@index([status])
  @@index([saleDate])
  @@index([patientId])
  @@index([salesPersonId])
}

// Sale line item
model SaleItem {
  id         String @id @default(cuid())
  lineNumber Int

  // Product snapshot at time of sale
  productName String
  productSku  String

  // Quantities
  quantity Int @default(1)

  // Pricing
  unitPrice      Decimal @default(0) @db.Decimal(10, 2)
  unitCost       Decimal @default(0) @db.Decimal(10, 2) // For margin calculation
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2)
  totalPrice     Decimal @default(0) @db.Decimal(10, 2)

  // Refund tracking
  refundedQty    Int     @default(0)
  refundedAmount Decimal @default(0) @db.Decimal(10, 2)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@unique([saleId, lineNumber])
  @@index([saleId])
  @@index([productId])
}

// Low stock alert
model LowStockAlert {
  id     String      @id @default(cuid())
  status AlertStatus @default(ACTIVE)

  // Threshold info
  currentQty   Int
  threshold    Int
  reorderPoint Int
  suggestedQty Int // Suggested order quantity

  // Tracking
  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt     DateTime?
  resolvedBy     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location relation (Epic 25 - US-254)
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  @@index([organizationId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
  @@index([locationId])
}

// ============================================
// EPIC 09: AI BILLING AGENT
// ============================================

// Claim scrub severity
enum ScrubSeverity {
  ERROR // Must fix before submission
  WARNING // Should review, may cause denial
  INFO // Informational/best practice
}

// Claim scrub result status
enum ScrubResultStatus {
  PENDING // Scrub not yet run
  PASSED // All checks passed
  FAILED // Critical errors found
  WARNINGS // Passed with warnings
}

// Denial prediction risk level
enum DenialRiskLevel {
  LOW // <25% denial probability
  MEDIUM // 25-50% denial probability
  HIGH // 50-75% denial probability
  CRITICAL // >75% denial probability
}

// Appeal letter status
enum AppealLetterStatus {
  DRAFT // Generated but not finalized
  READY // Ready to send
  SENT // Sent to payer
  RESPONDED // Payer responded
}

// Payment match status
enum PaymentMatchStatus {
  UNMATCHED // No match found
  SUGGESTED // AI suggested match
  CONFIRMED // User confirmed match
  POSTED // Payment posted
  REJECTED // Match rejected
}

// Underpayment status
enum UnderpaymentStatus {
  DETECTED // Underpayment detected
  UNDER_REVIEW // Being reviewed
  APPEALED // Appeal submitted
  ADJUSTED // Write-off/adjustment made
  RESOLVED // Issue resolved
  IGNORED // Decided not to pursue
}

// AI Billing job type
enum AIBillingJobType {
  CLAIM_SCRUB // Pre-submission validation
  DENIAL_PREDICTION // Predict denial risk
  APPEAL_GENERATION // Generate appeal letter
  PAYMENT_MATCHING // Match payments to charges
  UNDERPAYMENT_SCAN // Scan for underpayments
  STATUS_CHECK // Overnight status check
}

// AI Billing job status
enum AIBillingJobStatus {
  QUEUED // Waiting to run
  RUNNING // Currently processing
  COMPLETED // Successfully completed
  FAILED // Failed with error
  CANCELLED // Manually cancelled
}

// Claim scrubbing result (pre-submission validation)
model ClaimScrubResult {
  id        String            @id @default(cuid())
  scrubDate DateTime          @default(now())
  status    ScrubResultStatus @default(PENDING)

  // Overall score (0-100)
  overallScore  Int @default(0)
  passedChecks  Int @default(0)
  failedChecks  Int @default(0)
  warningChecks Int @default(0)

  // Summary
  summary        String? @db.Text
  recommendation String? // SUBMIT, REVIEW, FIX_REQUIRED

  // Time to complete scrub
  processingTimeMs Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Issues found
  issues ClaimScrubIssue[]

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([scrubDate])
}

// Individual scrub issue
model ClaimScrubIssue {
  id       String        @id @default(cuid())
  severity ScrubSeverity

  // Issue details
  code       String // Error code (e.g., "MISSING_DX", "INVALID_NPI")
  category   String // Category (Patient, Provider, Diagnosis, Procedure, etc.)
  field      String? // Field with issue
  message    String // Human-readable message
  suggestion String? // How to fix

  // Line-level issue (optional)
  claimLineNumber Int?
  cptCode         String?

  // Resolution
  isResolved     Boolean   @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String?

  createdAt DateTime @default(now())

  // Relations
  scrubResultId String
  scrubResult   ClaimScrubResult @relation(fields: [scrubResultId], references: [id], onDelete: Cascade)

  @@index([scrubResultId])
  @@index([severity])
  @@index([isResolved])
}

// Denial prediction (ML-based risk scoring)
model DenialPrediction {
  id             String   @id @default(cuid())
  predictionDate DateTime @default(now())

  // Risk assessment
  riskLevel       DenialRiskLevel @default(MEDIUM)
  riskScore       Int             @default(50) // 0-100 probability
  confidenceScore Float           @default(0.5) // Model confidence

  // Risk factors (what contributes to risk)
  riskFactors Json? // Array of { factor, weight, description }

  // Primary risk reason
  primaryReason String?

  // Historical data used
  historicalDenialRate Float? // Denial rate for similar claims
  payerDenialRate      Float? // This payer's overall denial rate

  // Recommendations
  recommendations Json? // Array of recommendations to reduce risk

  // Model metadata
  modelVersion     String? // Which model version was used
  processingTimeMs Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([riskLevel])
  @@index([predictionDate])
}

// Generated appeal letter
model AppealLetter {
  id          String             @id @default(cuid())
  generatedAt DateTime           @default(now())
  status      AppealLetterStatus @default(DRAFT)

  // Letter content
  subject String
  body    String @db.Text

  // Appeal details
  appealType   String? // First Level, Second Level, External
  denialCode   String? // CARC/denial code being appealed
  denialReason String? // Original denial reason

  // Supporting arguments
  arguments Json? // Array of appeal arguments used
  citations Json? // Medical/legal citations

  // Clinical support
  clinicalSummary  String? @db.Text
  medicalNecessity String? @db.Text

  // Attachments/documents to include
  recommendedDocs Json? // Array of recommended supporting docs

  // Template used
  templateId   String?
  templateName String?

  // Outcome tracking
  sentAt        DateTime?
  sentBy        String?
  payerResponse String?   @db.Text
  responseDate  DateTime?
  outcome       String? // APPROVED, PARTIAL, DENIED, PENDING

  // AI metadata
  modelVersion     String?
  processingTimeMs Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  denialId String
  denial   Denial @relation(fields: [denialId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([denialId])
  @@index([status])
  @@index([generatedAt])
}

// Payment matching suggestion (for ERA/EOB posting)
model PaymentMatchSuggestion {
  id        String             @id @default(cuid())
  matchDate DateTime           @default(now())
  status    PaymentMatchStatus @default(SUGGESTED)

  // Match confidence
  confidenceScore Float   @default(0.5) // 0-1 confidence
  matchMethod     String? // How match was determined

  // Match criteria used
  matchCriteria Json? // { patientMatch, dateMatch, amountMatch, etc. }

  // Payment info (from ERA/EOB)
  paymentAmount Decimal   @db.Decimal(10, 2)
  payerName     String?
  checkNumber   String?
  checkDate     DateTime?

  // Charge info
  chargeAmount Decimal   @db.Decimal(10, 2)
  serviceDate  DateTime?
  cptCode      String?

  // Suggested allocation
  suggestedAllocation Json? // How to allocate payment

  // User action
  actionedAt  DateTime?
  actionedBy  String?
  actionNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  remittanceLineId String?
  remittanceLine   RemittanceLineItem? @relation(fields: [remittanceLineId], references: [id])

  chargeId String?
  charge   Charge? @relation(fields: [chargeId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([chargeId])
  @@index([status])
  @@index([matchDate])
}

// Underpayment detection
model UnderpaymentDetection {
  id         String             @id @default(cuid())
  detectedAt DateTime           @default(now())
  status     UnderpaymentStatus @default(DETECTED)

  // Amounts
  billedAmount    Decimal @db.Decimal(10, 2)
  expectedAmount  Decimal @db.Decimal(10, 2) // Based on fee schedule/contract
  paidAmount      Decimal @db.Decimal(10, 2)
  underpaidAmount Decimal @db.Decimal(10, 2) // Difference

  // Calculation basis
  calculationBasis String? // FEE_SCHEDULE, CONTRACT, HISTORICAL
  feeScheduleId    String? // Fee schedule used for comparison
  contractRate     Decimal? @db.Decimal(5, 2) // Expected contract rate %

  // Analysis
  underpaymentReason String? // Why we think it's underpaid
  adjustmentCodes    Json? // CARC codes that may explain

  // Supporting data
  historicalPayments Json? // Past payments for comparison

  // Recovery potential
  recoveryLikelihood Float? // Estimated chance of recovery
  recoveryAmount     Decimal? @db.Decimal(10, 2) // Estimated recovery

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionType  String? // APPEALED, ADJUSTED, IGNORED
  recoveredAmount Decimal?  @db.Decimal(10, 2)
  resolutionNotes String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String?
  claim   Claim?  @relation(fields: [claimId], references: [id])

  chargeId String?
  charge   Charge? @relation(fields: [chargeId], references: [id])

  payerId   String?
  payerName String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([chargeId])
  @@index([status])
  @@index([detectedAt])
}

// AI Billing batch job (for overnight processing)
model AIBillingJob {
  id      String             @id @default(cuid())
  jobType AIBillingJobType
  status  AIBillingJobStatus @default(QUEUED)

  // Job configuration
  config Json? // Job-specific configuration

  // Scheduling
  scheduledFor DateTime? // When to run
  startedAt    DateTime?
  completedAt  DateTime?

  // Progress tracking
  totalItems     Int @default(0)
  processedItems Int @default(0)
  successCount   Int @default(0)
  failureCount   Int @default(0)

  // Results summary
  resultSummary Json? // Summary of results

  // Error tracking
  errorMessage String? @db.Text
  errorDetails Json?

  // Performance
  processingTimeMs Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User who initiated

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Job logs
  logs AIBillingJobLog[]

  @@index([organizationId])
  @@index([jobType])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
}

// Job execution log
model AIBillingJobLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  level     String // INFO, WARNING, ERROR
  message   String   @db.Text

  // Context
  itemId   String? // Claim/charge ID being processed
  itemType String? // Type of item

  // Relations
  jobId String
  job   AIBillingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([timestamp])
  @@index([level])
}

// AI Billing audit log (for tracking AI decisions)
model AIBillingAudit {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  // Action details
  action     String // SCRUB, PREDICT, GENERATE_APPEAL, MATCH_PAYMENT, etc.
  entityType String // Claim, Charge, Denial, etc.
  entityId   String // ID of entity

  // AI decision
  decision   String? // What AI decided/recommended
  confidence Float? // AI confidence in decision
  reasoning  String? @db.Text // Why AI made this decision

  // Input/output data
  inputData  Json? // Data provided to AI
  outputData Json? // AI output

  // User override
  userOverride   Boolean @default(false)
  overrideBy     String? // User ID
  overrideReason String?

  // Performance
  processingTimeMs Int?
  modelVersion     String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// ============================================
// EPIC 16: AI INSIGHTS AGENT
// ============================================

// Insight category types
enum InsightCategory {
  ANOMALY // Detected anomaly/outlier
  OPPORTUNITY // Revenue opportunity
  CHURN_RISK // Patient at risk of churning
  BENCHMARK // Performance vs benchmark
  RECOMMENDATION // Actionable recommendation
  TREND // Trend detection
}

// Insight priority/severity
enum InsightPriority {
  CRITICAL // Immediate attention required
  HIGH // Important, address soon
  MEDIUM // Worth reviewing
  LOW // Nice to know
  INFO // Informational only
}

// Insight status
enum InsightStatus {
  NEW // Newly generated
  VIEWED // User has seen it
  ACTIONED // User took action
  DISMISSED // User dismissed it
  EXPIRED // No longer relevant
  RESOLVED // Issue resolved automatically
}

// Anomaly type
enum AnomalyType {
  REVENUE_SPIKE // Unusual revenue increase
  REVENUE_DROP // Unusual revenue decrease
  VISIT_SPIKE // Unusual visit increase
  VISIT_DROP // Unusual visit decrease
  PAYMENT_DELAY // Payments taking longer
  NO_SHOW_SPIKE // Unusual no-show increase
  CLAIM_DENIAL_SPIKE // Unusual denial increase
  NEW_PATIENT_SPIKE // Unusual new patient increase
  NEW_PATIENT_DROP // Unusual new patient decrease
  COLLECTION_DROP // Collection rate dropping
}

// Churn risk level
enum ChurnRiskLevel {
  VERY_HIGH // 80-100% risk
  HIGH // 60-80% risk
  MEDIUM // 40-60% risk
  LOW // 20-40% risk
  VERY_LOW // 0-20% risk
}

// AI-generated insight
model AIInsight {
  id       String          @id @default(cuid())
  category InsightCategory
  priority InsightPriority
  status   InsightStatus   @default(NEW)

  // Content
  title          String // Short, actionable title
  description    String  @db.Text // Detailed explanation
  impact         String? @db.Text // Potential impact if addressed/ignored
  recommendation String? @db.Text // What to do about it

  // Context/Data
  dataSnapshot   Json? // Relevant data at time of insight
  relatedMetrics Json? // Related KPIs and values
  confidence     Decimal @db.Decimal(5, 2) // 0-100 confidence score

  // Targeting
  entityType String? // Patient, Provider, Claim, etc.
  entityId   String? // Specific entity ID
  metricName String? // Which metric triggered this

  // Anomaly-specific
  anomalyType      AnomalyType?
  expectedValue    Decimal?     @db.Decimal(12, 2)
  actualValue      Decimal?     @db.Decimal(12, 2)
  deviationPercent Decimal?     @db.Decimal(8, 2)
  zScore           Decimal?     @db.Decimal(6, 2)

  // Time context
  periodStart DateTime?
  periodEnd   DateTime?
  detectedAt  DateTime  @default(now())

  // User interaction
  viewedAt      DateTime?
  viewedBy      String?
  actionedAt    DateTime?
  actionedBy    String?
  actionNotes   String?   @db.Text
  dismissedAt   DateTime?
  dismissedBy   String?
  dismissReason String?

  // Expiration
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  actions InsightAction[]

  @@index([organizationId])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([detectedAt])
  @@index([entityType, entityId])
}

// Action taken on an insight
model InsightAction {
  id         String  @id @default(cuid())
  actionType String // clicked_link, scheduled_followup, sent_message, etc.
  actionData Json? // Action-specific data
  notes      String? @db.Text

  createdAt DateTime @default(now())

  // Who took the action
  userId String

  // Which insight
  insightId String
  insight   AIInsight @relation(fields: [insightId], references: [id], onDelete: Cascade)

  @@index([insightId])
  @@index([userId])
  @@index([createdAt])
}

// Patient churn prediction
model ChurnPrediction {
  id         String         @id @default(cuid())
  riskScore  Decimal        @db.Decimal(5, 2) // 0-100 risk score
  riskLevel  ChurnRiskLevel
  confidence Decimal        @db.Decimal(5, 2) // 0-100 confidence

  // Contributing factors
  riskFactors            Json // Array of { factor, weight, value, impact }
  daysSinceLastVisit     Int?
  avgVisitFrequency      Decimal? @db.Decimal(6, 2) // avg days between visits
  visitFrequencyChange   Decimal? @db.Decimal(6, 2) // % change in frequency
  totalVisits            Int?
  missedAppointments     Int?
  cancelledAppointments  Int?
  hasUpcomingAppointment Boolean  @default(false)

  // Financial factors
  outstandingBalance Decimal? @db.Decimal(10, 2)
  paymentHistory     String? // good, fair, poor

  // Recommendation
  suggestedAction String?         @db.Text
  priority        InsightPriority @default(MEDIUM)

  // Status tracking
  status       String    @default("active") // active, contacted, recovered, churned
  contactedAt  DateTime?
  contactedBy  String?
  contactNotes String?   @db.Text
  recoveredAt  DateTime?
  churnedAt    DateTime? // Confirmed churn date

  calculatedAt DateTime  @default(now())
  expiresAt    DateTime? // When to recalculate

  // Relations
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([riskLevel])
  @@index([riskScore])
  @@index([status])
  @@index([calculatedAt])
}

// Revenue opportunity tracking
model RevenueOpportunity {
  id              String @id @default(cuid())
  opportunityType String // underbilled, missed_service, recall_due, etc.
  title           String
  description     String @db.Text

  // Estimated value
  estimatedValue Decimal @db.Decimal(10, 2)
  confidence     Decimal @db.Decimal(5, 2) // 0-100

  // Context
  entityType  String? // Patient, Service, Payer, etc.
  entityId    String?
  serviceCode String?
  payerName   String?

  // Status
  status        String    @default("identified") // identified, in_progress, captured, declined
  capturedValue Decimal?  @db.Decimal(10, 2) // Actual value captured
  capturedAt    DateTime?
  capturedBy    String?
  notes         String?   @db.Text

  detectedAt DateTime  @default(now())
  expiresAt  DateTime?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Actions taken on this opportunity
  actions OptimizationAction[]

  @@index([organizationId])
  @@index([opportunityType])
  @@index([status])
  @@index([detectedAt])
  @@index([estimatedValue])
}

// ============================================
// EPIC 35: AI REVENUE OPTIMIZER
// ============================================

// Revenue leakage tracking - identifies lost revenue
model RevenueLeakage {
  id          String @id @default(cuid())
  leakageType String // unbilled_service, undercoding, missed_modifier, unbilled_supplies, write_off, collection_issue

  // Source of leakage
  source      String // e.g., "Patient visits", "CMT codes", "Supply billing"
  description String @db.Text

  // Financial impact
  amount       Decimal  @db.Decimal(10, 2) // Estimated leaked amount
  frequency    String? // daily, weekly, monthly, one_time
  annualImpact Decimal? @db.Decimal(12, 2) // Projected annual impact

  // Context
  entityType String? // Patient, Encounter, Claim, Provider
  entityId   String?
  cptCode    String?
  payerName  String?
  providerId String?

  // Recommendation
  recommendation String  @db.Text
  priority       String  @default("medium") // low, medium, high, critical
  effortLevel    String? // easy, moderate, complex

  // Status
  status     String    @default("identified") // identified, investigating, fixing, resolved, ignored
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?   @db.Text

  detectedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([leakageType])
  @@index([status])
  @@index([priority])
  @@index([detectedAt])
  @@index([amount])
}

// Fee schedule analysis - pricing optimization
model FeeScheduleAnalysis {
  id      String  @id @default(cuid())
  cptCode String
  cptName String?

  // Current pricing
  currentFee Decimal @db.Decimal(10, 2)

  // Recommended pricing
  recommendedFee Decimal @db.Decimal(10, 2)
  feeChange      Decimal @db.Decimal(10, 2) // Difference
  changePercent  Decimal @db.Decimal(5, 2) // Percentage change

  // Analysis reasoning
  reasoning String @db.Text

  // Benchmark comparisons
  medicareRate      Decimal? @db.Decimal(10, 2)
  regionalAverage   Decimal? @db.Decimal(10, 2)
  percentOfMedicare Decimal? @db.Decimal(5, 2) // e.g., 125 = 125% of Medicare

  // Payer analysis
  topPayerRate     Decimal? @db.Decimal(10, 2)
  avgReimbursement Decimal? @db.Decimal(10, 2)
  utilizationCount Int? // How many times this code is used

  // Revenue impact
  projectedAnnualImpact Decimal? @db.Decimal(12, 2)
  confidence            Decimal? @db.Decimal(5, 2) // 0-100

  // Status
  status        String    @default("pending") // pending, approved, rejected, implemented
  approvedBy    String?
  approvedAt    DateTime?
  effectiveDate DateTime?

  analyzedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, cptCode, analyzedAt])
  @@index([organizationId])
  @@index([cptCode])
  @@index([status])
  @@index([changePercent])
  @@index([projectedAnnualImpact])
}

// Revenue goals and tracking
model RevenueGoal {
  id         String @id @default(cuid())
  period     String // 2024-01, 2024-Q1, 2024, etc.
  periodType String // daily, weekly, monthly, quarterly, annual

  // Goal details
  goalType String  @default("total_revenue") // total_revenue, collections, new_patients, etc.
  name     String? // Custom name for the goal

  // Financial targets
  target   Decimal @db.Decimal(12, 2)
  actual   Decimal @default(0) @db.Decimal(12, 2)
  variance Decimal @default(0) @db.Decimal(12, 2) // actual - target

  // Performance metrics
  percentAchieved Decimal  @default(0) @db.Decimal(5, 2)
  onTrack         Boolean  @default(true)
  projectedFinal  Decimal? @db.Decimal(12, 2) // Projected end-of-period

  // Breakdown (optional)
  breakdown Json? // { "services": 50000, "products": 10000, etc. }

  // Notes and context
  notes       String?  @db.Text
  createdBy   String?
  lastUpdated DateTime @default(now())

  startDate DateTime
  endDate   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, period, goalType])
  @@index([organizationId])
  @@index([period])
  @@index([periodType])
  @@index([goalType])
  @@index([onTrack])
}

// Optimization actions taken
model OptimizationAction {
  id String @id @default(cuid())

  // Link to opportunity (optional - can be standalone action)
  opportunityId String?
  opportunity   RevenueOpportunity? @relation(fields: [opportunityId], references: [id])

  // Action details
  actionType String // fee_update, coding_change, process_improvement, etc.
  action     String  @db.Text // Description of action taken
  rationale  String? @db.Text // Why this action was taken

  // Impact tracking
  projectedImpact Decimal? @db.Decimal(12, 2)
  actualImpact    Decimal? @db.Decimal(12, 2)
  impactPeriod    String? // monthly, annual

  // Result
  result  String?  @db.Text // Outcome description
  success Boolean? // Was the action successful

  // Status
  status      String    @default("planned") // planned, in_progress, completed, failed, cancelled
  completedAt DateTime?
  completedBy String?

  // Tracking
  startedAt DateTime?
  dueDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([opportunityId])
  @@index([actionType])
  @@index([status])
  @@index([createdAt])
}

// Natural language query history
model NLQueryHistory {
  id             String  @id @default(cuid())
  query          String  @db.Text // Original natural language query
  parsedIntent   String? // Detected intent
  parsedEntities Json? // Extracted entities
  generatedQuery String? @db.Text // SQL or API query generated

  // Response
  successful   Boolean @default(false)
  responseType String? // chart, table, number, text
  responseData Json? // Cached response data
  error        String? @db.Text

  // Feedback
  userRating   Int? // 1-5 star rating
  userFeedback String?  @db.Text
  wasHelpful   Boolean?

  executionTimeMs Int?
  createdAt       DateTime @default(now())

  // User who ran the query
  userId String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@index([parsedIntent])
}

// Benchmark data for comparison
model BenchmarkData {
  id            String @id @default(cuid())
  benchmarkType String // industry, regional, size_based, etc.
  metricName    String // collectionRate, noShowRate, etc.
  period        String // Q1_2024, 2024, etc.

  // Values
  median       Decimal  @db.Decimal(12, 2)
  percentile25 Decimal? @db.Decimal(12, 2)
  percentile75 Decimal? @db.Decimal(12, 2)
  percentile90 Decimal? @db.Decimal(12, 2)
  average      Decimal? @db.Decimal(12, 2)
  sampleSize   Int?

  // Segment
  specialty    String? // chiropractic, pt, etc.
  region       String? // west, midwest, etc.
  practiceSize String? // solo, small, medium, large

  source        String? // Where data came from
  effectiveDate DateTime
  expiresAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([benchmarkType, metricName, period, specialty, region, practiceSize])
  @@index([metricName])
  @@index([benchmarkType])
  @@index([effectiveDate])
}

// ============================================
// EPIC 18: MARKETING & REFERRALS
// ============================================

// Referral reward type
enum ReferralRewardType {
  DISCOUNT_PERCENT // Percentage off
  DISCOUNT_FIXED // Fixed dollar amount off
  CREDIT // Account credit
  CASH // Cash reward
  GIFT_CARD // Gift card
  FREE_SERVICE // Free service/visit
}

// Referral status
enum ReferralStatus {
  PENDING // Referral created, patient not yet seen
  QUALIFIED // Referred patient has first appointment
  COMPLETED // Reward has been issued
  EXPIRED // Referral expired before qualification
  CANCELLED // Referral was cancelled
}

// Lead status
enum LeadStatus {
  NEW // Just captured
  CONTACTED // Initial contact made
  ENGAGED // Actively communicating
  QUALIFIED // Ready for appointment
  CONVERTED // Became a patient
  LOST // No longer interested
  UNRESPONSIVE // No response after attempts
}

// Lead source
enum LeadSource {
  WEBSITE // Website form
  REFERRAL // Patient referral
  GOOGLE_ADS // Google advertising
  FACEBOOK_ADS // Facebook/Meta advertising
  INSTAGRAM // Instagram
  WALK_IN // Walk-in inquiry
  PHONE_CALL // Called the office
  SOCIAL_MEDIA // Organic social
  EVENT // Community event
  PARTNER // Partner practice
  DIRECTORY // Online directory listing
  OTHER // Other source
}

// Nurture sequence status
enum NurtureSequenceStatus {
  DRAFT // Being built
  ACTIVE // Running
  PAUSED // Temporarily paused
  COMPLETED // All steps done
  CANCELLED // Stopped early
}

// Review platform
enum ReviewPlatform {
  GOOGLE // Google Business
  YELP // Yelp
  FACEBOOK // Facebook Reviews
  HEALTHGRADES // Healthgrades
  ZOCDOC // ZocDoc
  OTHER // Other platform
}

// Review request status
enum ReviewRequestStatus {
  PENDING // Not yet sent
  SENT // Request sent
  CLICKED // Clicked review link
  REVIEWED // Left a review
  DECLINED // Opted out
  FAILED // Failed to send
}

// Campaign status
enum MarketingCampaignStatus {
  DRAFT // Being planned
  SCHEDULED // Scheduled to start
  ACTIVE // Currently running
  PAUSED // Temporarily paused
  COMPLETED // Finished running
  CANCELLED // Stopped early
}

// Campaign type
enum MarketingCampaignType {
  EMAIL // Email campaign
  SMS // SMS/Text campaign
  SOCIAL // Social media campaign
  REFERRAL // Referral promotion
  REVIEW // Review solicitation
  REACTIVATION // Win-back campaign
  RETENTION // Retention campaign
}

// Referral program configuration
model ReferralProgram {
  id          String  @id @default(cuid())
  name        String // "Patient Referral Program"
  description String? @db.Text

  // Reward configuration for referrer (existing patient)
  referrerRewardType  ReferralRewardType
  referrerRewardValue Decimal            @db.Decimal(10, 2) // Amount or percentage
  referrerRewardMax   Decimal?           @db.Decimal(10, 2) // Max reward cap
  referrerRewardNote  String? // "Get $50 off your next visit"

  // Reward configuration for referee (new patient)
  refereeRewardType  ReferralRewardType?
  refereeRewardValue Decimal?            @db.Decimal(10, 2)
  refereeRewardMax   Decimal?            @db.Decimal(10, 2)
  refereeRewardNote  String? // "New patient receives $25 off"

  // Program rules
  qualificationCriteria  String? // "First completed appointment"
  expirationDays         Int? // Days before referral expires
  maxReferralsPerPatient Int? // Max referrals per referrer
  requireNewPatient      Boolean @default(true)

  // Terms and conditions
  termsAndConditions String? @db.Text

  // Status
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Referrals using this program
  referrals Referral[]

  @@index([organizationId])
  @@index([isActive])
}

// Individual referral tracking
model Referral {
  id           String         @id @default(cuid())
  referralCode String // Unique tracking code
  status       ReferralStatus @default(PENDING)

  // Referrer (existing patient who made the referral)
  referrerId String
  referrer   Patient @relation("ReferrerPatient", fields: [referrerId], references: [id])

  // Referee (new patient being referred) - optional until they become a patient
  refereeId String?
  referee   Patient? @relation("RefereePatient", fields: [refereeId], references: [id])

  // Referee info (before they're a patient)
  refereeName  String?
  refereeEmail String?
  refereePhone String?
  refereeNotes String?

  // Program used
  programId String
  program   ReferralProgram @relation(fields: [programId], references: [id])

  // Reward tracking
  referrerRewardIssued   Boolean   @default(false)
  referrerRewardAmount   Decimal?  @db.Decimal(10, 2)
  referrerRewardIssuedAt DateTime?
  referrerRewardNotes    String?

  refereeRewardIssued   Boolean   @default(false)
  refereeRewardAmount   Decimal?  @db.Decimal(10, 2)
  refereeRewardIssuedAt DateTime?
  refereeRewardNotes    String?

  // Dates
  qualifiedAt DateTime? // When referee qualified
  completedAt DateTime? // When rewards issued
  expiresAt   DateTime?

  // Attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([referralCode, organizationId])
  @@index([organizationId])
  @@index([referrerId])
  @@index([refereeId])
  @@index([status])
  @@index([programId])
  @@index([createdAt])
}

// Lead tracking
model Lead {
  id     String     @id @default(cuid())
  status LeadStatus @default(NEW)
  source LeadSource @default(WEBSITE)

  // Contact info
  firstName String
  lastName  String
  email     String?
  phone     String?

  // Demographics (optional)
  dateOfBirth DateTime?
  gender      String?
  address     String?
  city        String?
  state       String?
  zipCode     String?

  // Interest/Inquiry
  primaryConcern   String? // "Back pain", "Wellness care"
  notes            String? @db.Text
  preferredContact String? // "email", "phone", "text"
  preferredTimes   String? // "mornings", "evenings"

  // Lead scoring
  score        Int   @default(0)
  scoreFactors Json? // { "opened_email": 5, "clicked_link": 10 }

  // Attribution
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  landingPage String?
  referrerUrl String?

  // Campaign attribution
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  // Referral attribution
  referralId String?

  // Conversion tracking
  convertedToPatientId String?
  convertedToPatient   Patient?  @relation("LeadConversion", fields: [convertedToPatientId], references: [id])
  convertedAt          DateTime?

  // Communication tracking
  lastContactedAt DateTime?
  contactAttempts Int       @default(0)

  // Follow-up
  nextFollowUpAt   DateTime?
  assignedToUserId String?

  // Nurturing
  currentSequenceId String?
  currentSequence   NurtureSequence? @relation(fields: [currentSequenceId], references: [id])
  currentStepNumber Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Activities
  activities LeadActivity[]

  @@index([organizationId])
  @@index([status])
  @@index([source])
  @@index([email])
  @@index([phone])
  @@index([score])
  @@index([nextFollowUpAt])
  @@index([assignedToUserId])
  @@index([createdAt])
}

// Lead activity/history
model LeadActivity {
  id           String @id @default(cuid())
  activityType String // "email_sent", "phone_call", "note_added", "status_change"
  description  String @db.Text
  metadata     Json? // Activity-specific data

  performedBy String? // User ID

  createdAt DateTime @default(now())

  // Relations
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([activityType])
  @@index([createdAt])
}

// Nurture sequence (automated lead follow-up)
model NurtureSequence {
  id          String  @id @default(cuid())
  name        String // "New Lead Welcome Series"
  description String?

  status NurtureSequenceStatus @default(DRAFT)

  // Trigger
  triggerType  String // "lead_created", "manual", "score_threshold"
  triggerValue String? // Specific value for trigger

  // Entry criteria
  leadSources LeadSource[] // Which sources can enter
  minScore    Int? // Minimum lead score
  maxScore    Int? // Maximum lead score

  // Exit criteria
  exitOnConversion  Boolean @default(true)
  exitOnUnsubscribe Boolean @default(true)
  maxDays           Int? // Auto-exit after N days

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Steps
  steps NurtureSequenceStep[]

  // Leads in this sequence
  leads Lead[]

  @@index([organizationId])
  @@index([status])
}

// Nurture sequence step
model NurtureSequenceStep {
  id         String @id @default(cuid())
  stepNumber Int // Order in sequence
  name       String // "Welcome Email"

  // Timing
  delayDays  Int     @default(0)
  delayHours Int     @default(0)
  sendTime   String? // Specific time "09:00"

  // Action type
  actionType String // "send_email", "send_sms", "create_task", "update_score"

  // Email/SMS content
  templateId String?
  template   MessageTemplate? @relation(fields: [templateId], references: [id])

  // Task creation
  taskTitle       String?
  taskDescription String?
  taskAssignTo    String? // User ID or "lead_owner"

  // Score update
  scoreChange Int? // +5, -2, etc.

  // Conditional
  condition Json? // { "lead.score": { "gte": 50 } }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sequenceId String
  sequence   NurtureSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepNumber])
  @@index([sequenceId])
}

// Review request tracking
model ReviewRequest {
  id       String              @id @default(cuid())
  platform ReviewPlatform
  status   ReviewRequestStatus @default(PENDING)

  // Patient who should review
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Trigger info
  triggeredByAppointmentId String?

  // Communication
  sentAt    DateTime?
  sentVia   String? // "email", "sms"
  messageId String? // Reference to Message

  // Response tracking
  clickedAt  DateTime?
  reviewedAt DateTime?
  rating     Int? // 1-5 stars if captured
  reviewUrl  String? // Direct link to review

  // Failure info
  failureReason String?

  // Timing
  scheduledFor DateTime?
  expiresAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
}

// Marketing campaign
model Campaign {
  id           String                  @id @default(cuid())
  name         String // "Spring Wellness Promo"
  description  String?                 @db.Text
  campaignType MarketingCampaignType
  status       MarketingCampaignStatus @default(DRAFT)

  // Schedule
  startDate DateTime?
  endDate   DateTime?

  // Budget (optional)
  budget      Decimal? @db.Decimal(10, 2)
  actualSpend Decimal? @db.Decimal(10, 2)

  // Goals
  targetLeads       Int?
  targetConversions Int?
  targetRevenue     Decimal? @db.Decimal(10, 2)

  // UTM parameters for tracking
  utmSource   String?
  utmMedium   String?
  utmCampaign String // Required, auto-generated if not set
  utmContent  String?

  // Targeting
  targetAudience Json? // { "status": "active", "lastVisit": "30d" }

  // Content
  content Json? // Campaign-specific content config

  // Results
  totalImpressions Int     @default(0)
  totalClicks      Int     @default(0)
  totalLeads       Int     @default(0)
  totalConversions Int     @default(0)
  totalRevenue     Decimal @default(0) @db.Decimal(10, 2)

  // Analysis
  clickThroughRate  Decimal? @db.Decimal(5, 4) // e.g., 0.0525 = 5.25%
  conversionRate    Decimal? @db.Decimal(5, 4)
  costPerLead       Decimal? @db.Decimal(10, 2)
  costPerConversion Decimal? @db.Decimal(10, 2)
  roi               Decimal? @db.Decimal(10, 4) // Return on investment

  createdBy String? // User ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Leads from this campaign
  leads Lead[]

  @@index([organizationId])
  @@index([status])
  @@index([campaignType])
  @@index([startDate])
  @@index([utmCampaign])
}

// Landing page tracking
model LandingPage {
  id   String @id @default(cuid())
  name String // "New Patient Special"
  slug String // URL slug: "new-patient-special"

  // Status
  isActive Boolean @default(true)

  // Page content (simple)
  headline    String?
  subheadline String?
  bodyContent String? @db.Text
  ctaText     String? // "Book Now"
  ctaLink     String?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Form configuration
  formEnabled    Boolean @default(true)
  formFields     Json? // Which fields to show
  successMessage String?
  redirectUrl    String?

  // Campaign attribution
  defaultUtmSource  String?
  defaultUtmMedium  String?
  defaultCampaignId String?

  // Tracking
  totalViews       Int      @default(0)
  totalSubmissions Int      @default(0)
  conversionRate   Decimal? @db.Decimal(5, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([isActive])
  @@index([slug])
}

// Marketing consent tracking (TCPA/GDPR compliance)
model MarketingConsent {
  id String @id @default(cuid())

  // Who gave consent
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  // For non-patients (leads)
  leadId String?

  email String?
  phone String?

  // Consent details
  consentType String // "email_marketing", "sms_marketing", "phone_calls"
  consented   Boolean @default(false)

  // How consent was given
  consentMethod String // "website_form", "in_office", "verbal", "text_opt_in"
  consentSource String? // URL or form name
  ipAddress     String?
  userAgent     String?

  // Consent text shown
  consentText String? @db.Text

  // Revocation
  revokedAt        DateTime?
  revocationMethod String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([email])
  @@index([phone])
  @@index([consentType])
}

// =============================================================================
// EPIC 19: CHIROPRACTIC CLINICAL INTELLIGENCE
// =============================================================================

// Spinal region enumeration
enum SpinalRegion {
  CERVICAL
  THORACIC
  LUMBAR
  SACRAL
  PELVIS
}

// Severity scale for subluxations
enum SubluxationSeverity {
  MINIMAL // 1 - Minimal dysfunction
  MILD // 2 - Mild dysfunction
  MODERATE // 3 - Moderate dysfunction
  SEVERE // 4 - Severe dysfunction
  EXTREME // 5 - Extreme dysfunction
}

// Technique category
enum TechniqueCategory {
  MANUAL // Traditional hands-on techniques
  INSTRUMENT // Instrument-assisted (Activator, etc.)
  TABLE_ASSISTED // Drop table, flexion-distraction
  LOW_FORCE // Gentle/low-force techniques
}

// Patient response to adjustment
enum AdjustmentResponse {
  EXCELLENT // Cavitation, immediate relief
  GOOD // Partial correction, positive response
  FAIR // Minimal response
  GUARDED // Muscle guarding present
  POOR // No correction achieved
}

// Chiropractic technique library
model Technique {
  id                String            @id @default(cuid())
  name              String // e.g., "Diversified", "Gonstead", "Activator"
  category          TechniqueCategory
  description       String?           @db.Text
  indications       String[] // Conditions/areas where technique is indicated
  contraindications String[] // When NOT to use
  instructions      String?           @db.Text // How to perform
  imageUrl          String? // Reference image
  videoUrl          String? // Tutorial video

  // System vs custom
  isSystem Boolean @default(false) // Pre-seeded techniques
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation (null for system techniques)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  adjustments       Adjustment[]
  providerFavorites TechniqueFavorite[]

  @@unique([name, organizationId])
  @@index([organizationId])
  @@index([category])
  @@index([isSystem])
}

// Provider's favorite techniques for quick access
model TechniqueFavorite {
  id           String   @id @default(cuid())
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  techniqueId String
  technique   Technique @relation(fields: [techniqueId], references: [id], onDelete: Cascade)

  @@unique([providerId, techniqueId])
  @@index([providerId])
}

// Subluxation finding documentation
model Subluxation {
  id       String              @id @default(cuid())
  vertebra String // e.g., "C1", "T5", "L4", "Sacrum", "Ilium"
  region   SpinalRegion
  listing  String // Standard listing notation (e.g., "PLS", "PRI", "AS-IN")
  severity SubluxationSeverity @default(MODERATE)
  notes    String?             @db.Text

  // Body diagram reference (if marked on diagram)
  bodyDiagramId String?
  bodyDiagram   BodyDiagram? @relation(fields: [bodyDiagramId], references: [id])

  // Status tracking
  isResolved    Boolean   @default(false)
  resolvedAt    DateTime?
  resolvedNotes String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // History tracking
  history     SubluxationHistory[]
  adjustments Adjustment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([vertebra])
  @@index([region])
  @@index([isResolved])
}

// Track subluxation changes over time
model SubluxationHistory {
  id               String               @id @default(cuid())
  previousListing  String?
  newListing       String
  previousSeverity SubluxationSeverity?
  newSeverity      SubluxationSeverity
  notes            String?              @db.Text
  changeReason     String? // Why the change occurred

  createdAt DateTime @default(now())

  subluxationId String
  subluxation   Subluxation @relation(fields: [subluxationId], references: [id], onDelete: Cascade)

  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id])

  // Who documented the change
  documentedById String?
  documentedBy   User?   @relation(fields: [documentedById], references: [id])

  @@index([subluxationId])
  @@index([encounterId])
  @@index([createdAt])
}

// Adjustment documentation
model Adjustment {
  id       String       @id @default(cuid())
  vertebra String // Segment adjusted
  region   SpinalRegion

  // Technique used
  techniqueId    String?
  technique      Technique? @relation(fields: [techniqueId], references: [id])
  techniqueNotes String? // Additional notes on technique variation

  // Adjustment details
  force     String? // Light, Moderate, Firm
  direction String? // Direction of thrust
  position  String? // Patient position (prone, supine, side-lying, seated)

  // Pre-adjustment findings
  preLegLength String? // Leg length difference before
  preROM       String? // Range of motion before
  prePain      Int? // Pain scale 0-10

  // Post-adjustment findings
  postLegLength String?
  postROM       String?
  postPain      Int?

  // Patient response
  response        AdjustmentResponse @default(GOOD)
  cavitation      Boolean            @default(false) // Audible release
  muscleGuarding  Boolean            @default(false)
  immediateRelief Boolean            @default(false)
  responseNotes   String?            @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Optional link to subluxation being addressed
  subluxationId String?
  subluxation   Subluxation? @relation(fields: [subluxationId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([subluxationId])
  @@index([vertebra])
  @@index([region])
  @@index([techniqueId])
}

// Vertebral listing documentation (detailed biomechanical analysis)
model VertebralListing {
  id      String       @id @default(cuid())
  segment String // Vertebral segment (e.g., "C2", "T6", "L5")
  region  SpinalRegion

  // Gonstead listing notation
  laterality String? // PL (Posterior Left), PR (Posterior Right)
  rotation   String? // S (Superior), I (Inferior)
  listing    String // Full listing (e.g., "PLS", "PRI", "PRS-m")

  // Palmer listing notation (alternative)
  palmerListing String?

  // Positional analysis
  flexion        Boolean @default(false)
  extension      Boolean @default(false)
  lateralFlexion String? // Left/Right
  rotationDir    String? // Left/Right

  // Additional findings
  fixation      Boolean @default(false)
  hypermobility Boolean @default(false)
  edema         Boolean @default(false)
  tenderness    Int? // 0-10 scale
  muscleSpasm   Boolean @default(false)

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([segment])
  @@index([region])
}

// Comprehensive chiropractic examination
model ChiropracticExam {
  id String @id @default(cuid())

  // Leg Length Assessment
  legLengthProne  String? // e.g., "Right short 1/4 inch"
  legLengthSupine String?
  legLengthSeated String?
  legLengthNotes  String? @db.Text

  // Muscle Testing (grades 0-5)
  muscleTestingData  Json? // { "muscle": grade, ... }
  muscleTestingNotes String? @db.Text

  // Static Palpation
  staticPalpationFindings Json? // { "segment": "finding", ... }
  staticPalpationNotes    String? @db.Text

  // Motion Palpation
  motionPalpationFindings Json? // { "segment": "restriction type", ... }
  motionPalpationNotes    String? @db.Text

  // Postural Analysis
  posturalFindings Json? // Structured postural analysis data
  posturalNotes    String? @db.Text

  // Orthopedic Tests
  orthopedicTests Json? // { "testName": { "result": "positive/negative", "notes": "" } }

  // Neurological Screening
  dtrFindings       Json? // Deep tendon reflexes
  dermatomeFindings Json? // Dermatomal sensation
  myotomeFindings   Json? // Myotomal strength
  neurologicalNotes String? @db.Text

  // Range of Motion
  cervicalROM Json? // { "flexion": 50, "extension": 60, ... }
  thoracicROM Json?
  lumbarROM   Json?
  romNotes    String? @db.Text

  // Additional findings
  vitalSigns          Json? // BP, pulse, resp, temp if needed
  generalObservations String? @db.Text

  // Exam summary (for notes integration)
  summary String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String    @unique
  encounter   Encounter @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
}

// =============================================================================
// EPIC 20: AI POSTURE & MOVEMENT ANALYSIS
// =============================================================================

// View type for posture photos
enum PostureView {
  ANTERIOR // Front view
  POSTERIOR // Back view
  LATERAL_LEFT // Left side view
  LATERAL_RIGHT // Right side view
}

// Deviation severity
enum DeviationSeverity {
  MINIMAL // Within normal limits
  MILD // Slight deviation
  MODERATE // Noticeable deviation
  SEVERE // Significant deviation
  EXTREME // Extreme deviation
}

// Joint/region for ROM
enum ROMJoint {
  // Cervical spine
  CERVICAL_FLEXION
  CERVICAL_EXTENSION
  CERVICAL_LATERAL_LEFT
  CERVICAL_LATERAL_RIGHT
  CERVICAL_ROTATION_LEFT
  CERVICAL_ROTATION_RIGHT
  // Thoracic spine
  THORACIC_FLEXION
  THORACIC_EXTENSION
  THORACIC_ROTATION_LEFT
  THORACIC_ROTATION_RIGHT
  // Lumbar spine
  LUMBAR_FLEXION
  LUMBAR_EXTENSION
  LUMBAR_LATERAL_LEFT
  LUMBAR_LATERAL_RIGHT
  // Shoulder
  SHOULDER_FLEXION
  SHOULDER_EXTENSION
  SHOULDER_ABDUCTION
  SHOULDER_ADDUCTION
  SHOULDER_INTERNAL_ROTATION
  SHOULDER_EXTERNAL_ROTATION
  // Elbow
  ELBOW_FLEXION
  ELBOW_EXTENSION
  // Hip
  HIP_FLEXION
  HIP_EXTENSION
  HIP_ABDUCTION
  HIP_ADDUCTION
  HIP_INTERNAL_ROTATION
  HIP_EXTERNAL_ROTATION
  // Knee
  KNEE_FLEXION
  KNEE_EXTENSION
  // Ankle
  ANKLE_DORSIFLEXION
  ANKLE_PLANTARFLEXION
  ANKLE_INVERSION
  ANKLE_EVERSION
}

// Posture assessment (main record linking patient and analysis)
model PostureAssessment {
  id             String   @id @default(cuid())
  assessmentDate DateTime @default(now())
  notes          String?  @db.Text

  // Summary findings
  overallAssessment String? @db.Text
  recommendations   String? @db.Text

  // Status tracking
  isComplete  Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  images     PostureImage[]
  deviations PostureDeviation[]

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([assessmentDate])
}

// Image for posture analysis
model PostureImage {
  id           String      @id @default(cuid())
  imageUrl     String // URL to stored image
  thumbnailUrl String? // Thumbnail version
  view         PostureView
  captureDate  DateTime    @default(now())
  notes        String?

  // Image metadata
  width    Int?
  height   Int?
  fileSize Int? // in bytes
  mimeType String?

  // Analysis status
  isAnalyzed   Boolean   @default(false)
  analyzedAt   DateTime?
  analysisData Json? // Raw analysis output from AI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assessmentId String
  assessment   PostureAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Landmarks detected in this image
  landmarks PostureLandmark[]

  @@index([assessmentId])
  @@index([view])
}

// Body landmark detected in image
model PostureLandmark {
  id   String @id @default(cuid())
  name String // e.g., "left_ear", "right_shoulder", "left_hip", "C7_spinous"

  // Coordinates (normalized 0-1 or pixel coordinates)
  x Float
  y Float
  z Float? // For 3D landmark data if available

  // Detection confidence (0-1)
  confidence Float?

  // Whether manually adjusted
  isManual  Boolean @default(false)
  originalX Float? // Original AI-detected X before manual adjustment
  originalY Float? // Original AI-detected Y before manual adjustment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  imageId String
  image   PostureImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([imageId])
  @@index([name])
}

// Postural deviation finding
model PostureDeviation {
  id            String  @id @default(cuid())
  deviationType String // e.g., "head_forward", "shoulder_uneven", "hip_tilt", "scoliosis"
  description   String?

  // Measurement
  measurementValue Float? // The actual measurement
  measurementUnit  String? // "degrees", "mm", "inches", "%"

  // Normal range reference
  normalRangeMin Float?
  normalRangeMax Float?

  // Deviation from normal
  deviationAmount Float? // How far from normal
  severity        DeviationSeverity @default(MILD)

  // Direction/side if applicable
  direction String? // "left", "right", "anterior", "posterior"

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assessmentId String
  assessment   PostureAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([deviationType])
  @@index([severity])
}

// Range of motion measurement
model RangeOfMotion {
  id    String   @id @default(cuid())
  joint ROMJoint

  // Measurement
  degrees       Float // Measured degrees
  normalDegrees Float // Normal range maximum

  // Calculated fields
  percentOfNormal Float? // (degrees / normalDegrees) * 100
  isRestricted    Boolean @default(false)

  // Pain during movement
  painLevel     Int? // 0-10 scale
  painAtDegrees Float? // At what degree pain starts

  // Test details
  side     String? // "left", "right", "bilateral"
  position String? // Patient position during test
  notes    String? @db.Text

  measurementDate DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([joint])
  @@index([measurementDate])
}

// Functional Movement Screen test
model FunctionalMovement {
  id       String @id @default(cuid())
  testName String // e.g., "deep_squat", "hurdle_step", "inline_lunge", "shoulder_mobility"

  // Scoring (standard FMS 0-3)
  score Int // 0=pain, 1=dysfunction, 2=compensated, 3=optimal

  // Asymmetry detection
  leftScore    Int? // Score for left side if applicable
  rightScore   Int? // Score for right side
  isAsymmetric Boolean @default(false)

  // Additional findings
  painDuringTest Boolean  @default(false)
  painLocation   String?
  compensations  String[] // List of compensatory patterns observed

  // Movement pattern analysis
  movementQuality String? // Description of movement quality
  limitingFactors String[] // What's limiting the movement

  notes String? @db.Text

  // Exercise recommendations based on findings
  exerciseRecommendations Json? // Suggested corrective exercises

  assessmentDate DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([testName])
  @@index([assessmentDate])
}

// ============================================
// EPIC 21: TELEHEALTH & VIRTUAL CARE
// ============================================

// Telehealth provider for video conferencing
enum TelehealthProvider {
  TWILIO // Twilio Video (primary)
  ZOOM // Zoom SDK
  GOOGLE_MEET // Google Meet
  CUSTOM // Custom/self-hosted solution
}

// Telehealth session status
enum TelehealthSessionStatus {
  SCHEDULED // Session scheduled, not started
  WAITING // Patient in waiting room
  IN_PROGRESS // Video session active
  COMPLETED // Session ended normally
  NO_SHOW // Patient didn't join
  CANCELLED // Session cancelled
  TECHNICAL_ISSUES // Ended due to technical problems
}

// Virtual waiting room status
enum WaitingRoomStatus {
  WAITING // Patient is waiting
  ADMITTED // Patient admitted to session
  LEFT // Patient left waiting room
  TIMED_OUT // Session timed out
}

// Consent type for telehealth
enum TelehealthConsentType {
  GENERAL // General telehealth consent
  HIPAA // HIPAA acknowledgment for telehealth
  RECORDING // Consent to record session
  STATE_SPECIFIC // State-specific telehealth consent
}

// Consent status
enum ConsentStatus {
  PENDING // Consent requested but not signed
  SIGNED // Consent signed and active
  DECLINED // Patient declined consent
  EXPIRED // Consent has expired
  REVOKED // Patient revoked consent
}

// Telehealth session - tracks individual video consultations
model TelehealthSession {
  id        String                  @id @default(cuid())
  status    TelehealthSessionStatus @default(SCHEDULED)
  provider  TelehealthProvider      @default(TWILIO)
  roomUrl   String // Unique room/meeting URL
  roomToken String? // Access token for the room (encrypted)

  // Timing
  scheduledStartTime DateTime
  scheduledEndTime   DateTime
  actualStartTime    DateTime?
  actualEndTime      DateTime?

  // Session details
  joinInstructions String? @db.Text // Instructions for joining
  technicalNotes   String? @db.Text // Notes about technical issues

  // Quality metrics
  connectionQuality String? // good, fair, poor
  audioQuality      String?
  videoQuality      String?

  // Billing support
  placeOfServiceCode String? // CMS place of service for telehealth (typically "02")
  telehealthModifier String? // Billing modifier (95, GT, etc.)

  // Locations (required for billing compliance)
  patientLocation  String? // Where patient is located (city, state)
  providerLocation String? // Where provider is located (city, state)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  waitingRoom VirtualWaitingRoom?
  recordings  SessionRecording[]

  @@index([organizationId])
  @@index([status])
  @@index([scheduledStartTime])
  @@index([appointmentId])
}

// Virtual waiting room for patients before telehealth visits
model VirtualWaitingRoom {
  id     String            @id @default(cuid())
  status WaitingRoomStatus @default(WAITING)

  // Timing
  joinTime    DateTime  @default(now()) // When patient joined waiting room
  admitTime   DateTime? // When patient was admitted to session
  leaveTime   DateTime? // When patient left waiting room
  waitSeconds Int? // Total wait time in seconds

  // Pre-visit checklist
  cameraChecked     Boolean @default(false)
  microphoneChecked Boolean @default(false)
  connectionChecked Boolean @default(false)

  // Pre-visit questionnaire
  preVisitQuestionnaireCompleted Boolean @default(false)
  preVisitResponses              Json? // Responses to pre-visit questions

  // Device/connection info
  deviceType     String? // mobile, desktop, tablet
  browserInfo    String? // Browser name and version
  connectionType String? // wifi, cellular, ethernet

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  sessionId String            @unique
  session   TelehealthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([joinTime])
}

// Telehealth consent tracking
model TelehealthConsent {
  id          String                @id @default(cuid())
  consentType TelehealthConsentType
  status      ConsentStatus         @default(PENDING)

  // Consent details
  consentFormVersion String? // Version of consent form used
  consentText        String? @db.Text // Full text of consent (snapshot)

  // Signature
  signatureData   String?   @db.Text // Base64 signature image or signature data
  signatureType   String? // electronic, digital, typed
  signedAt        DateTime?
  signerName      String? // Name as signed
  signerIpAddress String?

  // Validity
  effectiveDate  DateTime  @default(now())
  expirationDate DateTime? // When consent expires
  revokedAt      DateTime? // When consent was revoked
  revokedReason  String?

  // State-specific requirements
  stateCode         String? // State for state-specific consent
  stateRequirements Json? // State-specific requirement details

  // Audit trail
  sentAt     DateTime? // When consent request was sent
  viewedAt   DateTime? // When patient viewed consent
  remindedAt DateTime? // When reminder was sent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([consentType])
  @@index([status])
  @@index([expirationDate])
}

// Session recording (if enabled and consented)
model SessionRecording {
  id     String @id @default(cuid())
  status String @default("processing") // processing, available, failed, deleted

  // Recording details
  recordingUrl String? // URL to recording (encrypted storage)
  recordingKey String? // Encryption key reference
  duration     Int? // Duration in seconds
  fileSize     Int? // Size in bytes
  format       String? // mp4, webm, etc.
  resolution   String? // 720p, 1080p, etc.

  // Timestamps
  recordingStartTime  DateTime?
  recordingEndTime    DateTime?
  processedAt         DateTime?
  deletionScheduledAt DateTime? // When recording will be auto-deleted

  // Retention policy
  retentionDays Int       @default(30) // Days to keep recording
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  deletedReason String?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessionId String
  session   TelehealthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sessionId])
  @@index([status])
  @@index([deletionScheduledAt])
}

// ============================================
// REMOTE MONITORING (US-222)
// ============================================

// Types of remote monitoring submissions
enum RemoteSubmissionType {
  PHOTO // Patient-submitted photos
  VIDEO // Patient-submitted videos
  PAIN_DIARY // Daily pain diary entries
  EXERCISE // Exercise completion/feedback
  ACTIVITY // Activity tracking data
  QUESTIONNAIRE // General questionnaire responses
}

// Status of remote submissions
enum RemoteSubmissionStatus {
  PENDING // Awaiting provider review
  REVIEWED // Provider has reviewed
  FLAGGED // Needs follow-up
  ARCHIVED // No longer active
}

// Patient remote monitoring submission
model RemoteMonitoringSubmission {
  id             String                 @id @default(cuid())
  submissionType RemoteSubmissionType
  status         RemoteSubmissionStatus @default(PENDING)

  // Content
  title       String? // Optional title for the submission
  description String? @db.Text // Patient's description/notes

  // For media submissions (photos/videos)
  mediaUrl      String? // Encrypted storage URL
  mediaKey      String? // Encryption key reference
  mediaMimeType String? // image/jpeg, video/mp4, etc.
  mediaSize     Int? // File size in bytes
  mediaDuration Int? // Duration in seconds (for videos)
  thumbnailUrl  String? // Thumbnail for videos

  // For pain diary entries
  painLevel    Int? // Pain level 0-10
  painLocation String? // Body area affected
  painNotes    String? @db.Text // Additional pain notes

  // For exercise submissions
  exerciseId       String? // Link to prescribed exercise
  exerciseName     String? // Name of exercise
  exerciseDuration Int? // Duration in seconds
  exerciseReps     Int? // Number of repetitions
  exerciseSets     Int? // Number of sets completed
  exerciseFeedback String? @db.Text // Patient feedback on exercise

  // For activity tracking
  activityType   String? // walking, steps, etc.
  activityValue  Float? // Numeric value
  activityUnit   String? // steps, miles, minutes, etc.
  activitySource String? // Device/app source

  // Questionnaire responses (JSON)
  questionnaireResponses Json? // Structured responses

  // Provider review
  reviewedAt       DateTime?
  reviewedById     String? // Provider who reviewed
  reviewNotes      String?   @db.Text // Provider's review notes
  followUpRequired Boolean   @default(false)
  followUpNotes    String?   @db.Text

  // Timestamps
  submittedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String? // Optional link to encounter
  encounter   Encounter? @relation(fields: [encounterId], references: [id], onDelete: SetNull)

  telehealthSessionId String? // Optional link to telehealth session

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Attachments (for multiple files per submission)
  attachments RemoteSubmissionAttachment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([submissionType])
  @@index([submittedAt])
  @@index([encounterId])
  @@index([telehealthSessionId])
}

// Attachments for remote monitoring submissions (for multi-file uploads)
model RemoteSubmissionAttachment {
  id String @id @default(cuid())

  fileName     String // Original file name
  fileUrl      String // Encrypted storage URL
  fileKey      String? // Encryption key reference
  mimeType     String // MIME type
  fileSize     Int // Size in bytes
  duration     Int? // Duration for videos (seconds)
  thumbnailUrl String? // Thumbnail for images/videos

  createdAt DateTime @default(now())

  // Relations
  submissionId String
  submission   RemoteMonitoringSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
}

// Provider alerts for new submissions
model RemoteMonitoringAlert {
  id String @id @default(cuid())

  alertType String // new_submission, high_pain, missed_exercise, etc.
  priority  String @default("normal") // low, normal, high, urgent
  message   String @db.Text

  isRead Boolean   @default(false)
  readAt DateTime?

  isDismissed   Boolean   @default(false)
  dismissedAt   DateTime?
  dismissedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  submissionId String? // Optional link to submission

  providerId String // Provider to alert
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([patientId])
  @@index([isRead])
  @@index([priority])
  @@index([createdAt])
}

// ============================================
// EPIC 22: IMAGING & X-RAY INTEGRATION
// ============================================

// Imaging modality types
enum ImagingModality {
  XRAY // Standard X-ray
  MRI // Magnetic Resonance Imaging
  CT // Computed Tomography
  ULTRASOUND // Ultrasound/Sonography
}

// Imaging study status
enum ImagingStudyStatus {
  SCHEDULED // Study scheduled but not performed
  IN_PROGRESS // Study being performed
  COMPLETED // Study completed, images available
  REPORTED // Final report issued
  CANCELLED // Study cancelled
}

// Annotation type for image markup
enum ImagingAnnotationType {
  ARROW // Arrow pointing to area of interest
  LINE // Measurement line
  TEXT // Text label
  CIRCLE // Circle/ellipse highlight
  RECTANGLE // Rectangle highlight
  ANGLE // Angle measurement
  COBB_ANGLE // Cobb angle for scoliosis
  FREEHAND // Freeform drawing
}

// Measurement type for imaging
enum ImagingMeasurementType {
  LINEAR // Linear distance measurement
  ANGLE // Angle measurement
  COBB_ANGLE // Cobb angle for scoliosis
  CERVICAL_LORDOSIS // Cervical lordosis angle
  LUMBAR_LORDOSIS // Lumbar lordosis angle
  DISC_HEIGHT // Disc space height
  VERTEBRAL_HEIGHT // Vertebral body height
  ATLAS_PLANE // Atlas plane line
  AREA // Area measurement
}

// Report status for imaging reports
enum ImagingReportStatus {
  DRAFT // Report in progress
  PENDING_REVIEW // Awaiting review
  FINAL // Final report
  AMENDED // Report has been amended
  ADDENDUM // Addendum added
}

// Imaging study - represents a collection of images from one session
model ImagingStudy {
  id        String             @id @default(cuid())
  studyDate DateTime // When the study was performed
  modality  ImagingModality // Type of imaging
  bodyPart  String // Body region imaged (e.g., "Cervical Spine", "Lumbar Spine")
  status    ImagingStudyStatus @default(SCHEDULED)

  // Study identification
  accessionNumber  String? // Unique study identifier
  studyInstanceUid String? // DICOM Study Instance UID
  description      String? // Study description

  // Clinical context
  indication      String? // Reason for study
  clinicalHistory String? @db.Text

  // Technical info
  equipment  String? // Equipment/machine used
  technician String? // Technician who performed study

  // Metadata
  numberOfImages Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  orderingProviderId String? // Provider who ordered the study
  orderingProvider   Provider? @relation("OrderingProvider", fields: [orderingProviderId], references: [id], onDelete: SetNull)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  images  ImagingImage[]
  reports ImagingReport[]

  // Link to encounter if applicable
  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([patientId])
  @@index([studyDate])
  @@index([modality])
  @@index([status])
  @@index([accessionNumber])
}

// Individual image within a study
model ImagingImage {
  id String @id @default(cuid())

  // Image identification
  imageUrl     String // URL to stored image (HIPAA-compliant storage)
  thumbnailUrl String? // Compressed thumbnail for gallery view
  originalUrl  String? // Original uncompressed file URL

  // DICOM-specific fields
  seriesNumber      Int? // Series number within study
  instanceNumber    Int? // Instance number within series
  seriesInstanceUid String? // DICOM Series Instance UID
  sopInstanceUid    String? // DICOM SOP Instance UID

  // Image metadata
  fileName String? // Original file name
  fileSize Int? // File size in bytes
  mimeType String  @default("application/dicom") // image/jpeg, image/png, application/dicom
  width    Int? // Image width in pixels
  height   Int? // Image height in pixels

  // DICOM window/level defaults
  windowCenter Float? // Window center (DICOM)
  windowWidth  Float? // Window width (DICOM)

  // View information
  viewPosition     String? // AP, PA, LAT, OBL, etc.
  bodyPartExamined String? // Specific body part
  laterality       String? // L, R, or bilateral

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studyId String
  study   ImagingStudy @relation(fields: [studyId], references: [id], onDelete: Cascade)

  // Annotations and measurements on this image
  annotations  ImagingAnnotation[]
  measurements ImagingMeasurement[]

  @@index([studyId])
  @@index([seriesNumber, instanceNumber])
}

// Annotation on an image (arrows, circles, text labels)
model ImagingAnnotation {
  id   String                @id @default(cuid())
  type ImagingAnnotationType // Type of annotation

  // Position and shape (stored as JSON for flexibility)
  coordinates Json // Start/end points, dimensions, etc.

  // Text content
  text String? // Label text

  // Style properties
  color     String? @default("#FF0000") // Annotation color
  lineWidth Int?    @default(2)
  fontSize  Int?    @default(14)

  // Visibility
  isVisible Boolean @default(true)
  layer     Int     @default(0) // Stacking order

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  imageId String
  image   ImagingImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  createdById String // User who created the annotation

  @@index([imageId])
  @@index([type])
}

// Measurement on an image (angles, distances, Cobb angles)
model ImagingMeasurement {
  id   String                 @id @default(cuid())
  type ImagingMeasurementType // Type of measurement

  // Measurement value
  value Float // Measured value
  unit  String // Unit (degrees, mm, cm, etc.)

  // Position (stored as JSON for flexibility)
  coordinates Json // Points used for measurement

  // Reference values for comparison
  normalMin Float? // Normal range minimum
  normalMax Float? // Normal range maximum
  deviation Float? // Deviation from normal (auto-calculated)

  // Labeling
  label       String? // Custom label
  description String? // Description of finding

  // Style
  color String? @default("#00FF00")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  imageId String
  image   ImagingImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  createdById String // User who created the measurement

  @@index([imageId])
  @@index([type])
}

// Imaging report - clinical interpretation of study
model ImagingReport {
  id     String              @id @default(cuid())
  status ImagingReportStatus @default(DRAFT)

  // Report content
  findings   String  @db.Text // Detailed findings
  impression String? @db.Text // Summary/conclusion

  // Structured findings (optional, JSON for flexibility)
  structuredFindings Json? // Structured finding data

  // Comparison
  comparisonStudyId String? // Prior study for comparison
  comparisonNotes   String? @db.Text

  // Recommendations
  recommendations String? @db.Text

  // Clinical correlation
  clinicalCorrelation String? @db.Text

  // Workflow
  dictatedAt    DateTime? // When report was dictated
  transcribedAt DateTime? // When report was transcribed
  signedAt      DateTime? // When report was signed
  amendedAt     DateTime? // When report was amended

  // Electronic signature
  signatureData String? // Base64 signature image or hash

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studyId String
  study   ImagingStudy @relation(fields: [studyId], references: [id], onDelete: Cascade)

  reportedById String // Provider who created the report
  reportedBy   Provider @relation(fields: [reportedById], references: [id], onDelete: Restrict)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to treatment plan for recommendations
  treatmentPlanId String?
  treatmentPlan   TreatmentPlan? @relation(fields: [treatmentPlanId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([studyId])
  @@index([status])
  @@index([reportedById])
  @@index([signedAt])
}

// ============================================================================
// Patient Education & Home Care (Epic 23)
// ============================================================================

// Exercise difficulty levels
enum ExerciseDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Body region for exercises
enum BodyRegion {
  CERVICAL
  THORACIC
  LUMBAR
  SACRAL
  UPPER_EXTREMITY
  LOWER_EXTREMITY
  CORE
  FULL_BODY
}

// Exercise category type
enum ExerciseCategoryType {
  STRETCHING
  STRENGTHENING
  MOBILITY
  POSTURE
  BALANCE
  STABILITY
  REHABILITATION
}

// Prescription status
enum PrescriptionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  DISCONTINUED
}

// Home care instruction status
enum HomeCareInstructionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

// Reading level for education content
enum ReadingLevel {
  SIMPLE // 5th grade
  STANDARD // 8th grade
  DETAILED // 12th grade
}

// Exercise category model
model ExerciseCategory {
  id          String               @id @default(cuid())
  name        String // e.g., "Neck Stretches"
  type        ExerciseCategoryType // Stretching, Strengthening, etc.
  description String?              @db.Text
  iconUrl     String? // Icon for category
  sortOrder   Int                  @default(0)
  isActive    Boolean              @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  exercises Exercise[]

  @@index([type])
  @@index([isActive])
}

// Therapeutic exercise model
model Exercise {
  id           String  @id @default(cuid())
  name         String // e.g., "Chin Tucks"
  description  String  @db.Text
  instructions String  @db.Text // Step-by-step instructions
  videoUrl     String? // URL to demonstration video
  imageUrl     String? // Static image of exercise
  thumbnailUrl String? // Thumbnail for lists

  // Classification
  difficulty    ExerciseDifficulty @default(BEGINNER)
  bodyRegion    BodyRegion // Target area
  targetMuscles String[] // Specific muscles targeted
  conditions    String[] // Conditions this exercise helps

  // Parameters
  defaultSets      Int? // Default number of sets
  defaultReps      Int? // Default number of reps
  defaultHoldTime  Int? // Hold time in seconds
  defaultFrequency String? // e.g., "3x daily"

  // Equipment
  equipmentRequired String[] // Equipment needed
  modifications     String?  @db.Text // Modifications for different abilities

  // Safety
  contraindications String? @db.Text // When NOT to do this exercise
  precautions       String? @db.Text // Safety precautions

  // Metadata
  isCustom  Boolean @default(false) // Custom exercise vs library
  isActive  Boolean @default(true)
  createdBy String? // User ID who created (for custom)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  categoryId String
  category   ExerciseCategory @relation(fields: [categoryId], references: [id])

  prescriptions ExercisePrescription[]
  progressLogs  PatientExerciseProgress[]

  @@index([difficulty])
  @@index([bodyRegion])
  @@index([isActive])
  @@index([categoryId])
}

// Education article model
model EducationArticle {
  id           String       @id @default(cuid())
  title        String
  content      String       @db.Text // Full article content (HTML/Markdown)
  summary      String?      @db.Text // Brief summary
  category     String // e.g., "Conditions", "Prevention", "Lifestyle"
  readingLevel ReadingLevel @default(STANDARD)
  language     String       @default("en")

  // Related conditions and keywords
  relatedConditions String[] // ICD-10 codes or condition names
  keywords          String[] // Search keywords
  tags              String[] // UI tags

  // Media
  featuredImageUrl String? // Featured image
  attachments      Json? // Array of attachment URLs/metadata

  // Publishing
  isPublished    Boolean   @default(false)
  publishedAt    DateTime?
  authorName     String? // Display name of author
  lastReviewedAt DateTime? // Medical review date

  // Metrics
  viewCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prescribed articles
  prescribedArticles PrescribedArticle[]

  @@index([category])
  @@index([isPublished])
  @@index([language])
}

// Exercise prescription - links patient to exercises
model ExercisePrescription {
  id     String             @id @default(cuid())
  status PrescriptionStatus @default(ACTIVE)

  // Exercise parameters
  sets      Int? // Number of sets
  reps      Int? // Number of reps per set
  holdTime  Int? // Hold time in seconds
  frequency String? // e.g., "3x daily", "Every 2 hours"
  duration  String? // e.g., "2 weeks", "Until follow-up"

  // Schedule
  startDate DateTime  @default(now())
  endDate   DateTime?

  // Instructions
  specialInstructions String? @db.Text // Modifications or notes
  precautions         String? @db.Text // Patient-specific precautions

  // Progression
  progressionSchedule Json? // Planned progression (sets/reps increases)
  currentWeek         Int   @default(1) // Current week of progression

  // Metadata
  prescribedAt       DateTime  @default(now())
  discontinuedAt     DateTime?
  discontinuedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  prescriberId String // Provider who prescribed
  prescriber   Provider @relation(fields: [prescriberId], references: [id])

  // Optional links
  encounterId String? // Encounter where prescribed
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  treatmentPlanId String? // Associated treatment plan
  treatmentPlan   TreatmentPlan? @relation(fields: [treatmentPlanId], references: [id])

  diagnosisId String? // Associated diagnosis
  diagnosis   Diagnosis? @relation(fields: [diagnosisId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Progress tracking
  progressLogs PatientExerciseProgress[]

  @@index([patientId])
  @@index([status])
  @@index([prescriberId])
  @@index([organizationId])
  @@index([exerciseId])
}

// Prescribed education article - links patient to articles
model PrescribedArticle {
  id         String    @id @default(cuid())
  isRead     Boolean   @default(false)
  readAt     DateTime?
  assignedAt DateTime  @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  articleId String
  article   EducationArticle @relation(fields: [articleId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  prescriberId String
  prescriber   Provider @relation(fields: [prescriberId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([articleId])
  @@index([organizationId])
}

// Home care instructions
model HomeCareInstruction {
  id     String                    @id @default(cuid())
  status HomeCareInstructionStatus @default(ACTIVE)

  // Instructions content
  instructions String @db.Text // Main instructions (HTML/Markdown)

  // Specific protocols
  iceProtocol   String? @db.Text // Ice therapy instructions
  heatProtocol  String? @db.Text // Heat therapy instructions
  activityMods  String? @db.Text // Activity modifications
  ergonomicRecs String? @db.Text // Ergonomic recommendations
  warningSigns  String? @db.Text // Signs to watch for
  followUpInstr String? @db.Text // Follow-up instructions

  // Duration
  durationDays Int? // How long to follow instructions
  startDate    DateTime  @default(now())
  endDate      DateTime?

  // Delivery
  deliveredAt    DateTime?
  deliveryMethod String? // email, portal, print
  pdfUrl         String? // Generated PDF URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([status])
  @@index([organizationId])
  @@index([encounterId])
}

// Patient exercise progress tracking
model PatientExerciseProgress {
  id          String   @id @default(cuid())
  completedAt DateTime @default(now())

  // What was done
  setsCompleted Int? // Actual sets completed
  repsCompleted Int? // Actual reps per set
  holdTime      Int? // Actual hold time in seconds
  duration      Int? // Total duration in minutes

  // Feedback
  painBefore Int? // Pain level 0-10 before
  painAfter  Int? // Pain level 0-10 after
  difficulty Int? // Perceived difficulty 1-5
  notes      String? @db.Text // Patient notes

  // Session info
  skipped    Boolean @default(false) // Was this session skipped?
  skipReason String? // Why skipped

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  prescriptionId String
  prescription   ExercisePrescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([prescriptionId])
  @@index([patientId])
  @@index([completedAt])
  @@index([organizationId])
}

// =============================================================================
// Epic 24: Wearable & Device Integration
// =============================================================================

// Types of wearable devices and health platforms
enum DeviceType {
  APPLE_HEALTH
  GOOGLE_FIT
  FITBIT
  WHOOP
  POSTURE_SENSOR
}

// Connection status for devices
enum DeviceConnectionStatus {
  PENDING // Authorization initiated but not completed
  CONNECTED // Successfully connected and syncing
  EXPIRED // Token expired, needs reauthorization
  DISCONNECTED // User disconnected the device
  ERROR // Connection error
}

// Device/platform connections for patients
model DeviceConnection {
  id        String                 @id @default(cuid())
  status    DeviceConnectionStatus @default(PENDING)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  // Device info
  deviceType  DeviceType
  deviceName  String? // Friendly name (e.g., "John's Apple Watch")
  deviceModel String? // Model info if available

  // OAuth/Authorization
  connectionToken String?   @db.Text // Encrypted access token
  refreshToken    String?   @db.Text // Encrypted refresh token
  tokenExpiresAt  DateTime?
  scopes          String[] // Permissions granted

  // Sync settings
  lastSyncAt    DateTime?
  syncFrequency Int       @default(60) // Minutes between syncs
  syncEnabled   Boolean   @default(true)

  // Error tracking
  lastError   String?   @db.Text
  lastErrorAt DateTime?
  errorCount  Int       @default(0)

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Data relations
  activityData  ActivityData[]
  sleepData     SleepData[]
  postureData   PostureData[]
  heartRateData HeartRateData[]

  @@unique([patientId, deviceType]) // One connection per device type per patient
  @@index([patientId])
  @@index([organizationId])
  @@index([status])
  @@index([deviceType])
}

// Daily activity data from wearables
model ActivityData {
  id        String   @id @default(cuid())
  date      DateTime // The date this data is for (date only, no time)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Activity metrics
  steps         Int? // Total steps
  distance      Float? // Distance in meters
  activeMinutes Int? // Total active minutes
  calories      Int? // Calories burned

  // Detailed breakdown (JSON for flexibility)
  hourlySteps Json? // Steps per hour { "0": 0, "1": 50, ... }
  workouts    Json? // Workout sessions [{ type, duration, calories, startTime }]

  // Source info
  sourceDevice String? // Which device provided this data

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  deviceConnectionId String
  deviceConnection   DeviceConnection @relation(fields: [deviceConnectionId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([patientId, date, deviceConnectionId]) // One record per day per device
  @@index([patientId])
  @@index([date])
  @@index([organizationId])
}

// Sleep data from wearables
model SleepData {
  id        String   @id @default(cuid())
  date      DateTime // The night this sleep data is for
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Sleep metrics
  duration   Int? // Total sleep duration in minutes
  quality    Int? // Sleep quality score 0-100
  efficiency Int? // Sleep efficiency percentage

  // Sleep times
  sleepStart  DateTime? // When user fell asleep
  sleepEnd    DateTime? // When user woke up
  timeToSleep Int? // Minutes to fall asleep

  // Sleep stages (in minutes)
  stages       Json? // { awake, light, deep, rem }
  awakeMinutes Int?
  lightMinutes Int?
  deepMinutes  Int?
  remMinutes   Int?

  // Disturbances
  awakenings   Int? // Number of times woke up
  restlessness Int? // Restlessness score

  // Source info
  sourceDevice String?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  deviceConnectionId String
  deviceConnection   DeviceConnection @relation(fields: [deviceConnectionId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([patientId, date, deviceConnectionId])
  @@index([patientId])
  @@index([date])
  @@index([organizationId])
}

// Posture data from posture sensors
model PostureData {
  id        String   @id @default(cuid())
  timestamp DateTime // Exact timestamp of the measurement
  createdAt DateTime @default(now())

  // Posture metrics
  score     Int? // Posture score 0-100
  isAlert   Boolean @default(false) // Was this a slouch alert?
  alertType String? // Type of alert (slouch, hunched, etc.)

  // Position data
  angle    Float? // Spine angle in degrees
  position String? // Sitting, standing, etc.
  duration Int? // How long in this position (seconds)

  // Session tracking
  sessionId String? // Group readings into sessions

  // Source info
  sourceDevice String? // Which sensor provided this

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  deviceConnectionId String
  deviceConnection   DeviceConnection @relation(fields: [deviceConnectionId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([timestamp])
  @@index([isAlert])
  @@index([organizationId])
  @@index([sessionId])
}

// Heart rate data from wearables
enum HeartRateType {
  RESTING // Resting heart rate
  ACTIVE // During activity
  WORKOUT // During workout
  CONTINUOUS // Continuous monitoring reading
  SPOT_CHECK // Manual spot check
}

model HeartRateData {
  id        String   @id @default(cuid())
  timestamp DateTime // When this reading was taken
  createdAt DateTime @default(now())

  // Heart rate metrics
  bpm  Int // Beats per minute
  type HeartRateType @default(CONTINUOUS)

  // Variability (if available)
  hrv Float? // Heart rate variability (ms)

  // Context
  activityLevel String? // What user was doing (resting, walking, etc.)

  // Source info
  sourceDevice String?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  deviceConnectionId String
  deviceConnection   DeviceConnection @relation(fields: [deviceConnectionId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([timestamp])
  @@index([type])
  @@index([organizationId])
}

// Goal types for activity tracking
enum GoalType {
  STEPS // Daily step count goal
  ACTIVE_MINUTES // Active minutes goal
  SLEEP_DURATION // Sleep duration goal
  CALORIES // Calories burned goal
  DISTANCE // Distance goal
}

// Activity goal tracking model
model ActivityGoal {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Goal configuration
  goalType    GoalType
  targetValue Int // Target value (steps, minutes, etc.)
  unit        String // Unit of measurement (steps, minutes, hours, etc.)

  // Goal status
  isActive  Boolean   @default(true)
  startDate DateTime  @default(now()) // When goal becomes active
  endDate   DateTime? // Optional end date for time-limited goals

  // Alert preferences
  alertOnAchieve    Boolean @default(true) // Alert when goal is achieved
  alertOnDecrease   Boolean @default(true) // Alert on significant activity decrease
  decreaseThreshold Int     @default(30) // Percentage decrease to trigger alert

  // Progress tracking
  currentStreak     Int       @default(0) // Days in a row goal was achieved
  longestStreak     Int       @default(0) // Best streak ever
  lastAchievedAt    DateTime? // Last time goal was achieved
  totalAchievements Int       @default(0) // Total times goal was achieved

  // Notes
  notes String? @db.Text // Provider notes about the goal

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  @@unique([patientId, goalType]) // One active goal per type per patient
  @@index([patientId])
  @@index([goalType])
  @@index([isActive])
  @@index([organizationId])
}

// ============================================
// EPIC 25: MULTI-LOCATION ENTERPRISE
// ============================================

// Practice location within an organization
model Location {
  id        String  @id @default(cuid())
  name      String // Display name (e.g., "Downtown Clinic")
  code      String // Short code (e.g., "DT")
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false) // Primary/headquarters location

  // Address
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  zipCode      String
  country      String  @default("US")

  // Contact
  phone String
  fax   String?
  email String?

  // Timezone for scheduling
  timezone String @default("America/New_York")

  // Branding (optional location-specific)
  logoUrl      String?
  primaryColor String?
  accentColor  String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  locationStaff      LocationStaff[]
  locationHours      LocationHours[]
  locationSettings   LocationSettings?
  appointments       Appointment[]
  encounters         Encounter[]
  inventoryItems     InventoryItem[]
  inventoryMovements InventoryMovement[]

  // Multi-Location Patient relations (Epic 25)
  homePatients            Patient[]                @relation("PatientHomeLocation")
  crossLocationAccessLogs CrossLocationAccessLog[]
  patientBalances         PatientLocationBalance[]

  // Cross-Location Scheduling relations (Epic 25 - US-252)
  rooms                       Room[]
  resources                   Resource[]
  appointmentTypeAvailability AppointmentTypeLocation[]

  // Inter-Location Inventory relations (Epic 25 - US-254)
  outgoingTransfers InventoryTransfer[] @relation("TransferFromLocation")
  incomingTransfers InventoryTransfer[] @relation("TransferToLocation")
  lowStockAlerts    LowStockAlert[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([isActive])
}

// Staff assignment to location with role
model LocationStaff {
  id        String  @id @default(cuid())
  isPrimary Boolean @default(false) // Primary work location for this user
  isActive  Boolean @default(true)

  // Role override at this location (optional)
  roleOverride Role?

  // Schedule visibility - can this staff member see this location's schedule?
  canViewSchedule   Boolean @default(true)
  canManageSchedule Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
  @@index([isActive])
}

// Operating hours for a location
model LocationHours {
  id        String  @id @default(cuid())
  dayOfWeek Int // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  isOpen    Boolean @default(true)

  // Regular hours
  openTime  String? // "09:00" in 24hr format
  closeTime String? // "17:00" in 24hr format

  // Break time (optional)
  breakStart String?
  breakEnd   String?

  // Override for specific dates
  isHoliday     Boolean   @default(false)
  holidayName   String?
  effectiveDate DateTime? // For specific date overrides

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, dayOfWeek, effectiveDate])
  @@index([locationId])
  @@index([dayOfWeek])
}

// Location-specific settings
model LocationSettings {
  id String @id @default(cuid())

  // Appointment settings
  defaultAppointmentDuration Int     @default(30) // minutes
  slotInterval               Int     @default(15) // minutes
  bufferTime                 Int     @default(0) // minutes between appointments
  allowOnlineBooking         Boolean @default(true)
  allowWalkIns               Boolean @default(true)

  // Scheduling constraints
  maxAdvanceBookingDays  Int @default(90)
  minAdvanceBookingHours Int @default(24)

  // Patient settings
  allowCrossLocationAccess Boolean @default(true)
  sharePatientRecords      Boolean @default(true)

  // Inventory settings
  trackInventory       Boolean @default(true)
  lowStockAlertEnabled Boolean @default(true)

  // Billing settings
  billingSeparate      Boolean @default(false) // Separate billing per location
  defaultFeeScheduleId String?

  // Communication settings
  appointmentReminderEnabled Boolean @default(true)
  reminderHoursBeforeAppt    Int     @default(24)

  // Custom settings JSON for extensibility
  customSettings Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  locationId String   @unique
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
}

// =============================================================================
// Cross-Location Patient Access (Epic 25 - US-251)
// =============================================================================

// Access type for cross-location audit
enum CrossLocationAccessType {
  VIEW_RECORD // Viewed patient record from another location
  VIEW_ENCOUNTERS // Viewed patient encounters
  VIEW_BALANCE // Viewed patient balance/financial info
  VIEW_DOCUMENTS // Viewed patient documents
  CREATE_ENCOUNTER // Created encounter at non-home location
  CREATE_APPOINTMENT // Created appointment at non-home location
  UPDATE_RECORD // Updated patient info from another location
}

// Audit log for cross-location patient access
model CrossLocationAccessLog {
  id         String                  @id @default(cuid())
  accessedAt DateTime                @default(now())
  accessType CrossLocationAccessType

  // What was accessed
  entityType String // Encounter, Appointment, Document, etc.
  entityId   String? // ID of the entity accessed

  // Access details
  reason String? // Optional reason for access
  notes  String? // Optional notes

  // IP and user agent for security audit
  ipAddress String?
  userAgent String?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Location where access occurred (different from patient's home location)
  accessingLocationId String
  accessingLocation   Location @relation(fields: [accessingLocationId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([userId])
  @@index([accessingLocationId])
  @@index([accessedAt])
  @@index([organizationId])
}

// Patient balance tracking by location (optional feature)
model PatientLocationBalance {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Balance amounts
  totalCharges     Decimal @default(0) @db.Decimal(10, 2)
  totalPayments    Decimal @default(0) @db.Decimal(10, 2)
  totalAdjustments Decimal @default(0) @db.Decimal(10, 2)
  currentBalance   Decimal @default(0) @db.Decimal(10, 2)

  // Last activity
  lastChargeDate  DateTime?
  lastPaymentDate DateTime?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([patientId, locationId])
  @@index([patientId])
  @@index([locationId])
  @@index([organizationId])
}

// ============================================
// Inter-Location Inventory (Epic 25 - US-254)
// ============================================

// Transfer request status
enum TransferStatus {
  PENDING // Request created, awaiting approval
  APPROVED // Approved by destination location
  REJECTED // Rejected by destination location
  IN_TRANSIT // Items shipped, in transit
  RECEIVED // Items received at destination
  CANCELLED // Cancelled by requester
  PARTIAL // Partially received
}

// Inventory transfer between locations
model InventoryTransfer {
  id             String         @id @default(cuid())
  transferNumber String // Auto-generated transfer number (TRN-001)
  status         TransferStatus @default(PENDING)

  // Transfer details
  requestedAt DateTime  @default(now())
  approvedAt  DateTime?
  shippedAt   DateTime?
  receivedAt  DateTime?
  completedAt DateTime?

  // Shipping info
  trackingNumber String?
  shippingMethod String? // "Internal courier", "UPS", etc.
  shippingCost   Decimal? @db.Decimal(10, 2)

  // Notes
  requestNotes   String? // Notes from requester
  approvalNotes  String? // Notes from approver
  receivingNotes String? // Notes from receiver

  // Rejection reason
  rejectionReason String?

  // Priority for urgent transfers
  priority Int @default(0) // 0 = normal, 1 = urgent, 2 = critical

  // Expected dates
  expectedShipDate    DateTime?
  expectedArrivalDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - People involved
  requestedById String
  requestedBy   User   @relation("TransferRequestedBy", fields: [requestedById], references: [id])

  approvedById String?
  approvedBy   User?   @relation("TransferApprovedBy", fields: [approvedById], references: [id])

  receivedById String?
  receivedBy   User?   @relation("TransferReceivedBy", fields: [receivedById], references: [id])

  // Relations - Locations
  fromLocationId String
  fromLocation   Location @relation("TransferFromLocation", fields: [fromLocationId], references: [id])

  toLocationId String
  toLocation   Location @relation("TransferToLocation", fields: [toLocationId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transfer items
  items InventoryTransferItem[]

  @@unique([transferNumber, organizationId])
  @@index([organizationId])
  @@index([status])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([requestedById])
  @@index([requestedAt])
}

// Items in an inventory transfer
model InventoryTransferItem {
  id String @id @default(cuid())

  // Quantities
  requestedQty Int // Quantity requested
  approvedQty  Int? // Quantity approved (may differ from requested)
  shippedQty   Int? // Quantity actually shipped
  receivedQty  Int? // Quantity received (may differ due to damage/loss)

  // Cost tracking
  unitCost  Decimal @db.Decimal(10, 2)
  totalCost Decimal @db.Decimal(10, 2) // Based on shipped or approved qty

  // Notes
  notes String?

  // Condition on receipt
  conditionNotes String? // Notes about condition when received

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  transferId String
  transfer   InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@index([transferId])
  @@index([productId])
}

// ============================================
// EPIC 26: ADVANCED SECURITY & COMPLIANCE
// ============================================

// MFA method types
enum MFAMethod {
  TOTP // Time-based One-Time Password (Google Authenticator, etc.)
  SMS // SMS verification code
  EMAIL // Email verification code
}

// Security event types for comprehensive logging
enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILURE
  LOGIN_MFA_REQUIRED
  LOGIN_MFA_SUCCESS
  LOGIN_MFA_FAILURE
  LOGOUT
  PASSWORD_CHANGE
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  MFA_ENABLED
  MFA_DISABLED
  MFA_RECOVERY_USED
  SESSION_CREATED
  SESSION_EXPIRED
  SESSION_TERMINATED
  SESSION_SUSPICIOUS
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  ROLE_CHANGED
  PHI_ACCESSED
  PHI_EXPORTED
  PHI_MODIFIED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  EMERGENCY_ACCESS_USED
  IP_BLOCKED
  IP_ALLOWED
  ENCRYPTION_KEY_ROTATED
  BAA_SIGNED
  BAA_EXPIRED
  CONFIG_CHANGED
  SUSPICIOUS_ACTIVITY
}

// Session status for enhanced tracking
enum SessionStatus {
  ACTIVE
  EXPIRED
  TERMINATED
  SUSPICIOUS
}

// BAA status
enum BAAStatus {
  DRAFT
  PENDING_SIGNATURE
  ACTIVE
  EXPIRED
  TERMINATED
}

// Encryption key status
enum EncryptionKeyStatus {
  ACTIVE
  ROTATING
  RETIRED
  COMPROMISED
}

// MFA Configuration for users
model MFAConfiguration {
  id              String    @id @default(cuid())
  method          MFAMethod @default(TOTP)
  secret          String // Encrypted TOTP secret or phone/email for SMS/Email
  verified        Boolean   @default(false)
  verifiedAt      DateTime?
  backupCodes     String[] // Encrypted backup codes
  backupCodesUsed Int       @default(0)
  lastUsedAt      DateTime?
  failedAttempts  Int       @default(0)
  lockedUntil     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([method])
}

// Security event logging for audit and compliance
model SecurityEvent {
  id          String            @id @default(cuid())
  eventType   SecurityEventType
  severity    String            @default("INFO") // INFO, WARNING, CRITICAL
  description String?           @db.Text

  // Request context
  ipAddress     String?
  userAgent     String? @db.Text
  requestPath   String?
  requestMethod String?

  // Additional metadata
  metadata Json? // Flexible field for event-specific data

  // Geolocation (if available)
  country String?
  city    String?

  // Related entity (optional)
  entityType String? // Patient, Claim, etc.
  entityId   String?

  // Result of event
  success       Boolean @default(true)
  failureReason String?

  createdAt DateTime @default(now())

  // User relation (nullable for unauthenticated events)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([severity])
  @@index([ipAddress])
}

// Enhanced user session tracking
model UserSession {
  id           String        @id @default(cuid())
  sessionToken String        @unique // Hashed session token
  status       SessionStatus @default(ACTIVE)

  // Device information
  deviceFingerprint String? // Hashed device fingerprint
  deviceType        String? // desktop, mobile, tablet
  browser           String?
  browserVersion    String?
  os                String?
  osVersion         String?

  // Location/network
  ipAddress String?
  country   String?
  city      String?

  // Session timing
  expiresAt      DateTime
  lastActivityAt DateTime  @default(now())
  idleTimeoutAt  DateTime? // When session will idle-timeout

  // Trust level
  rememberDevice Boolean @default(false)
  mfaVerified    Boolean @default(false)
  trustScore     Int     @default(100) // 0-100, decreases with suspicious activity

  // Termination details
  terminatedAt     DateTime?
  terminatedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([expiresAt])
  @@index([lastActivityAt])
  @@index([sessionToken])
}

// Business Associate Agreement tracking for HIPAA compliance
model BAADocument {
  id     String    @id @default(cuid())
  status BAAStatus @default(DRAFT)

  // Vendor information
  vendorName    String
  vendorContact String?
  vendorEmail   String?
  vendorPhone   String?
  vendorAddress String? @db.Text

  // Agreement details
  documentUrl  String? // Link to stored document
  documentHash String? // SHA-256 hash for integrity verification
  version      String? // Document version

  // Key dates
  signedDate        DateTime?
  effectiveDate     DateTime?
  expirationDate    DateTime?
  renewalDate       DateTime? // When to start renewal process
  terminatedDate    DateTime?
  terminationReason String?

  // Risk assessment
  riskLevel          String? // LOW, MEDIUM, HIGH, CRITICAL
  lastRiskAssessment DateTime?
  riskNotes          String?   @db.Text

  // Services covered
  servicesCovered String[] // List of services covered by BAA
  dataTypes       String[] // Types of PHI shared (names, SSN, medical records, etc.)

  // Compliance notes
  notes String? @db.Text

  // Renewal tracking
  reminderSent   Boolean   @default(false)
  reminderSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Optionally linked to a Vendor from inventory
  vendorId String?
  vendor   Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([status])
  @@index([expirationDate])
  @@index([vendorName])
}

// Encryption key management for field-level encryption
model EncryptionKey {
  id            String              @id @default(cuid())
  keyIdentifier String              @unique // Unique identifier for key reference
  status        EncryptionKeyStatus @default(ACTIVE)

  // Key metadata (never store actual key here - use HSM/KMS)
  algorithm  String @default("AES-256-GCM")
  keyVersion Int    @default(1)
  purpose    String // PHI_ENCRYPTION, API_KEY_ENCRYPTION, etc.

  // Key lifecycle
  createdAt   DateTime  @default(now())
  activatedAt DateTime?
  rotatedAt   DateTime?
  retiredAt   DateTime?
  expiresAt   DateTime?

  // Rotation tracking
  rotationSchedule String? // MONTHLY, QUARTERLY, YEARLY
  nextRotationAt   DateTime?
  previousKeyId    String? // Reference to previous key version

  // Access control
  allowedUsers String[] // List of user IDs with access
  allowedRoles Role[] // List of roles with access

  // Audit
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([keyIdentifier])
  @@index([purpose])
}

// Organization-level security settings/policies
model SecuritySetting {
  id String @id @default(cuid())

  // Session policies
  sessionTimeoutMinutes Int @default(60) // Max session duration
  idleTimeoutMinutes    Int @default(15) // Idle timeout before warning
  maxConcurrentSessions Int @default(3) // Max sessions per user

  // MFA policies
  mfaRequired         Boolean @default(false) // Require MFA for all users
  mfaRequiredForRoles Role[] // Roles that require MFA
  mfaGracePeriodDays  Int     @default(7) // Days to enable MFA before lockout

  // Password policies
  passwordMinLength        Int     @default(12)
  passwordRequireUppercase Boolean @default(true)
  passwordRequireLowercase Boolean @default(true)
  passwordRequireNumbers   Boolean @default(true)
  passwordRequireSymbols   Boolean @default(true)
  passwordExpiryDays       Int     @default(90) // 0 = never expires
  passwordHistoryCount     Int     @default(5) // Prevent reusing last N passwords

  // Login policies
  maxLoginAttempts       Int @default(5)
  lockoutDurationMinutes Int @default(30)

  // IP restrictions
  ipWhitelistEnabled Boolean  @default(false)
  ipWhitelist        String[] // Allowed IPs/CIDRs
  ipBlacklist        String[] // Blocked IPs/CIDRs

  // Time-based restrictions
  accessHoursEnabled  Boolean @default(false)
  accessHoursStart    String? // e.g., "08:00"
  accessHoursEnd      String? // e.g., "18:00"
  accessHoursTimezone String? // e.g., "America/Los_Angeles"
  accessHoursDays     Int[] // Days of week (0=Sun, 1=Mon, etc.)

  // Emergency access (break glass)
  emergencyAccessEnabled      Boolean  @default(true)
  emergencyAccessCode         String? // Encrypted emergency access code
  emergencyAccessNotifyEmails String[] // Emails to notify on emergency access

  // Audit settings
  auditRetentionDays   Int     @default(2555) // ~7 years for HIPAA
  detailedAuditLogging Boolean @default(true)

  // PHI access settings
  requireReasonForPHIAccess Boolean @default(false)
  logAllPHIAccess           Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // One-to-one with Organization
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ============================================
// Access Control Enhancements (US-262)
// ============================================

// Status of an access request
enum AccessRequestStatus {
  PENDING
  APPROVED
  DENIED
  EXPIRED
  CANCELLED
}

// Type of permission being requested
enum PermissionType {
  PATIENT_ACCESS // Access to patient records
  PHI_ACCESS // Access to Protected Health Information
  BILLING_ACCESS // Access to billing/financial data
  ADMIN_ACCESS // Administrative access
  LOCATION_ACCESS // Access to a specific location
  REPORT_ACCESS // Access to reports/analytics
  ROLE_ELEVATION // Request for role change
  EMERGENCY_ACCESS // Break glass emergency access
}

// Access request workflow - for requesting elevated permissions
model AccessRequest {
  id String @id @default(cuid())

  // Request details
  requestedBy     String // User ID requesting access
  requestedByUser User           @relation("AccessRequestRequester", fields: [requestedBy], references: [id], onDelete: Cascade)
  permissionType  PermissionType
  justification   String // Required reason for access
  targetResource  String? // Specific resource (patient ID, location ID, etc.)
  targetRole      Role? // If requesting role elevation

  // Time-bounded access
  requestedDuration Int? // Duration in minutes (null = permanent)
  validFrom         DateTime? // When access should start
  validUntil        DateTime? // When access expires

  // Workflow
  status         AccessRequestStatus @default(PENDING)
  reviewedBy     String? // User ID who reviewed
  reviewedByUser User?               @relation("AccessRequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)
  reviewedAt     DateTime?
  reviewNotes    String? // Reviewer's notes/comments

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([requestedBy])
  @@index([status])
  @@index([permissionType])
}

// Emergency access (break glass) log
model EmergencyAccessLog {
  id String @id @default(cuid())

  // Who used emergency access
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Access details
  reason           String // Required justification
  resourceAccessed String? // What was accessed
  ipAddress        String?
  userAgent        String?

  // Notification tracking
  notificationsSent Boolean  @default(false)
  notifiedEmails    String[]

  // Time tracking
  accessedAt DateTime  @default(now())
  expiresAt  DateTime? // When emergency access expires
  revokedAt  DateTime? // If manually revoked early
  revokedBy  String? // Who revoked it

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([accessedAt])
}

// Granular permission grants (beyond role-based)
model PermissionGrant {
  id String @id @default(cuid())

  // Who has the permission
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What permission
  permissionType PermissionType
  resourceType   String? // e.g., "Patient", "Location", "Report"
  resourceId     String? // Specific resource ID (null = all of type)

  // Time bounds
  validFrom  DateTime  @default(now())
  validUntil DateTime? // null = permanent

  // Who granted it
  grantedBy     String
  grantedByUser User     @relation("PermissionGranter", fields: [grantedBy], references: [id], onDelete: Cascade)
  grantedAt     DateTime @default(now())
  reason        String? // Why permission was granted

  // Revocation
  revokedAt     DateTime?
  revokedBy     String?
  revokedByUser User?     @relation("PermissionRevoker", fields: [revokedBy], references: [id], onDelete: SetNull)
  revokeReason  String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([permissionType])
  @@index([validUntil])
}

// Role inheritance configuration
model RoleInheritance {
  id String @id @default(cuid())

  // Parent role inherits from child role
  parentRole Role // The role that gains permissions
  childRole  Role // The role whose permissions are inherited

  // Configuration
  isActive Boolean @default(true)

  // Audit
  createdBy     String
  createdByUser User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Multi-tenant relation (organization-specific inheritance)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([parentRole, childRole, organizationId])
  @@index([organizationId])
  @@index([parentRole])
}

// ============================================================================
// Mobile Applications (Epic 27)
// ============================================================================

// Device platform types
enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

// Sync operation types
enum SyncOperationType {
  CREATE
  UPDATE
  DELETE
}

// Sync status
enum SyncStatus {
  PENDING
  SYNCING
  COMPLETED
  FAILED
  CONFLICT
}

// Notification types
enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_CANCELLATION
  MESSAGE_RECEIVED
  FORM_ASSIGNED
  TREATMENT_REMINDER
  ALERT
  GENERAL
}

// Notification delivery status
enum NotificationDeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

// Mobile device registration for authentication
model MobileDevice {
  id String @id @default(cuid())

  // Device identification
  deviceId   String // Unique device identifier
  deviceName String? // User-friendly device name
  platform   DevicePlatform
  osVersion  String?
  appVersion String?

  // Push notification tokens
  fcmToken  String? // Firebase Cloud Messaging token
  apnsToken String? // Apple Push Notification Service token

  // Security
  deviceFingerprint String? // For fraud detection
  isActive          Boolean @default(true)
  isTrusted         Boolean @default(false) // Has passed additional verification

  // Session tracking
  lastActiveAt  DateTime @default(now())
  lastIpAddress String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Refresh tokens for this device
  refreshTokens MobileRefreshToken[]

  @@unique([deviceId, userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([deviceId])
  @@index([fcmToken])
  @@index([apnsToken])
}

// Refresh tokens for JWT authentication
model MobileRefreshToken {
  id String @id @default(cuid())

  // Token data
  tokenHash  String @unique // Hashed refresh token
  family     String // Token family for rotation detection
  generation Int    @default(0) // Increments with each rotation

  // Validity
  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?
  expiresAt     DateTime

  // Security metadata
  issuedIp   String?
  lastUsedIp String?
  lastUsedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device relation (optional, token may outlive device registration)
  mobileDeviceId String?
  mobileDevice   MobileDevice? @relation(fields: [mobileDeviceId], references: [id], onDelete: SetNull)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([family])
  @@index([expiresAt])
  @@index([isRevoked])
}

// Rate limiting for mobile API endpoints
model MobileRateLimit {
  id String @id @default(cuid())

  // Rate limit key (can be user ID, device ID, or IP)
  keyType  String // "user", "device", "ip"
  keyValue String // The actual key value
  endpoint String // API endpoint being rate limited

  // Counters
  requestCount     Int      @default(0)
  windowStart      DateTime @default(now())
  windowDurationMs Int      @default(60000) // 1 minute default

  // Blocking
  isBlocked    Boolean   @default(false)
  blockedUntil DateTime?
  blockReason  String?

  // Multi-tenant relation (optional for IP-based limits)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([keyType, keyValue, endpoint, organizationId])
  @@index([keyType, keyValue])
  @@index([windowStart])
  @@index([isBlocked])
}

// Offline sync queue for mobile apps
model OfflineSyncQueue {
  id String @id @default(cuid())

  // Operation details
  operationType SyncOperationType
  entityType    String // "appointment", "encounter", "note", etc.
  entityId      String? // ID of existing entity (for UPDATE/DELETE)
  payload       Json // The data to sync

  // Sync status
  status        SyncStatus @default(PENDING)
  attempts      Int        @default(0)
  lastAttemptAt DateTime?
  errorMessage  String?

  // Conflict resolution
  conflictData Json? // Server version if conflict detected
  resolvedAt   DateTime?
  resolvedBy   String? // "client", "server", "manual"

  // Client tracking
  clientId String // Client-generated ID for deduplication
  deviceId String? // Which device created this
  queuedAt DateTime  @default(now())
  syncedAt DateTime?

  // API version for compatibility
  apiVersion String @default("v1")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([clientId, organizationId])
  @@index([organizationId])
  @@index([status])
  @@index([entityType])
  @@index([queuedAt])
}

// Push notifications
model PushNotification {
  id String @id @default(cuid())

  // Notification content
  type  NotificationType
  title String
  body  String
  data  Json? // Additional payload

  // Delivery tracking
  deliveryStatus NotificationDeliveryStatus @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  failedAt       DateTime?
  failureReason  String?

  // Targeting
  platform      DevicePlatform? // null = all platforms
  fcmMessageId  String? // Firebase message ID
  apnsMessageId String? // APNS message ID

  // Related entities
  relatedEntityType String? // "appointment", "message", etc.
  relatedEntityId   String?

  // Scheduling
  scheduledFor DateTime? // For scheduled notifications
  expiresAt    DateTime? // Don't deliver after this time

  // Timestamps
  createdAt DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([deliveryStatus])
  @@index([type])
  @@index([scheduledFor])
  @@index([createdAt])
}

// Notification preferences per user (US-265)
model NotificationPreference {
  id String @id @default(cuid())

  // Notification type preferences
  appointmentReminders     Boolean @default(true)
  appointmentConfirmations Boolean @default(true)
  appointmentCancellations Boolean @default(true)
  messageNotifications     Boolean @default(true)
  formNotifications        Boolean @default(true)
  treatmentReminders       Boolean @default(true)
  generalAlerts            Boolean @default(true)
  marketingMessages        Boolean @default(false)

  // Quiet hours (don't send during these times)
  quietHoursEnabled  Boolean @default(false)
  quietHoursStart    String? // HH:MM format
  quietHoursEnd      String? // HH:MM format
  quietHoursTimezone String? // IANA timezone

  // Frequency settings
  appointmentReminderTiming Int     @default(24) // Hours before appointment
  dailyDigest               Boolean @default(false)
  digestTime                String? // HH:MM format for digest

  // Channel preferences (which channels to use)
  pushEnabled  Boolean @default(true)
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Notification history/log for tracking sent notifications (US-265)
model NotificationLog {
  id String @id @default(cuid())

  // Notification details
  notificationType NotificationType
  title            String
  body             String
  data             Json? // Additional payload sent

  // Delivery details
  channel  String // 'push', 'email', 'sms'
  platform DevicePlatform? // For push: IOS, ANDROID
  deviceId String? // Device that received it

  // Status tracking
  status        NotificationDeliveryStatus @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  failureReason String?

  // External IDs
  fcmMessageId  String? // Firebase message ID
  apnsMessageId String? // APNS message ID
  externalId    String? // Any other external tracking ID

  // Related entities
  relatedEntityType  String?
  relatedEntityId    String?
  pushNotificationId String? // Link to PushNotification if applicable

  // Timestamps
  createdAt DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([notificationType])
  @@index([createdAt])
}

// Mobile charting draft for offline documentation (US-267)
model MobileChartingDraft {
  id String @id @default(cuid())

  // Draft identification
  draftType String // "soap", "diagnosis", "procedure", "body_diagram"

  // Associated encounter (may be null if creating new)
  encounterId   String?
  appointmentId String? // Can create draft before encounter exists
  patientId     String

  // Draft content
  content Json // The draft data

  // Voice-to-text transcript (if used)
  voiceTranscript String? @db.Text

  // Photo attachments
  photoUrls String[] // URLs to uploaded photos

  // Body diagram markings (for quick access)
  bodyDiagramType String?
  bodyMarkings    Json?

  // Sync status
  status       SyncStatus @default(PENDING)
  lastSyncedAt DateTime?
  syncError    String?

  // Device tracking
  deviceId String

  // Auto-save timestamp
  lastAutoSaveAt DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Provider relation
  providerId String

  // Multi-tenant relation
  organizationId String

  @@unique([deviceId, encounterId, draftType, organizationId])
  @@index([organizationId])
  @@index([providerId])
  @@index([patientId])
  @@index([encounterId])
  @@index([status])
  @@index([deviceId])
}

// Common diagnosis codes for quick select (US-267)
model CommonDiagnosis {
  id String @id @default(cuid())

  icd10Code   String
  description String
  shortName   String? // Quick display name
  category    String? // "cervical", "lumbar", "thoracic", etc.

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Provider-specific favorites
  providerId String? // null = org-wide

  // Sort order
  sortOrder Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String

  @@unique([icd10Code, providerId, organizationId])
  @@index([organizationId])
  @@index([providerId])
  @@index([category])
  @@index([usageCount])
}

// Common procedure codes for quick entry (US-267)
model CommonProcedure {
  id String @id @default(cuid())

  cptCode     String
  description String
  shortName   String? // Quick display name
  category    String? // "adjustment", "exam", "therapy", etc.

  // Default values for quick entry
  defaultUnits     Int      @default(1)
  defaultModifiers String[]

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // Provider-specific favorites
  providerId String? // null = org-wide

  // Sort order
  sortOrder Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String

  @@unique([cptCode, providerId, organizationId])
  @@index([organizationId])
  @@index([providerId])
  @@index([category])
  @@index([usageCount])
}

// =============================================================================
// Epic 27: Mobile Patient Health Features (US-269)
// =============================================================================

// Body location enum for pain diary
enum BodyLocation {
  HEAD
  NECK
  UPPER_BACK
  MID_BACK
  LOWER_BACK
  LEFT_SHOULDER
  RIGHT_SHOULDER
  LEFT_ARM
  RIGHT_ARM
  LEFT_WRIST_HAND
  RIGHT_WRIST_HAND
  CHEST
  ABDOMEN
  LEFT_HIP
  RIGHT_HIP
  LEFT_LEG
  RIGHT_LEG
  LEFT_KNEE
  RIGHT_KNEE
  LEFT_ANKLE_FOOT
  RIGHT_ANKLE_FOOT
  OTHER
}

// Pain quality descriptors
enum PainQuality {
  SHARP
  DULL
  ACHING
  BURNING
  THROBBING
  STABBING
  SHOOTING
  TINGLING
  NUMBNESS
  CRAMPING
  OTHER
}

// Patient health goal status (distinct from activity GoalStatus)
enum PatientHealthGoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

// Patient health goal type categories (distinct from activity GoalType)
enum PatientHealthGoalType {
  PAIN_REDUCTION
  MOBILITY
  EXERCISE
  ACTIVITY
  WELLNESS
  CUSTOM
}

// Pain diary entry for daily symptom tracking
model PainDiaryEntry {
  id        String   @id @default(cuid())
  entryDate DateTime @default(now()) // Date/time of entry

  // Pain details
  painLevel         Int // 0-10 scale
  bodyLocation      BodyLocation
  bodyLocationOther String? // If OTHER selected
  painQuality       PainQuality[]
  painQualityOther  String? // If OTHER included

  // Triggers and factors
  triggers         String[] // What triggered/worsened pain
  relievingFactors String[] // What helped reduce pain

  // Impact on daily life
  affectsWork     Boolean @default(false)
  affectsSleep    Boolean @default(false)
  affectsActivity Boolean @default(false)
  affectsMood     Boolean @default(false)

  // Additional context
  duration        String? // "constant", "intermittent", "brief"
  medicationTaken String? // Any medication taken
  notes           String? @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([entryDate])
  @@index([organizationId])
  @@index([bodyLocation])
}

// Progress photo type
enum PhotoType {
  POSTURE_FRONT
  POSTURE_SIDE
  POSTURE_BACK
  RANGE_OF_MOTION
  INJURY_DOCUMENTATION
  PROGRESS_COMPARISON
  OTHER
}

// Progress photos for visual tracking
model ProgressPhoto {
  id String @id @default(cuid())

  // Photo details
  photoUrl     String // URL to stored photo
  thumbnailUrl String? // Smaller thumbnail version
  photoType    PhotoType
  caption      String?

  // Metadata
  takenAt  DateTime      @default(now()) // When photo was taken
  angle    String? // "front", "left-side", "right-side", "back"
  bodyArea BodyLocation?

  // Comparison tracking
  isBaseline        Boolean @default(false) // Is this a baseline photo?
  comparisonGroupId String? // Group photos for side-by-side comparison

  // Notes
  notes String? @db.Text

  // Provider review
  reviewedAt    DateTime?
  reviewedBy    String? // Provider ID who reviewed
  providerNotes String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([takenAt])
  @@index([photoType])
  @@index([organizationId])
  @@index([comparisonGroupId])
}

// Patient health goals
model PatientGoal {
  id String @id @default(cuid())

  // Goal details
  title       String
  description String?                 @db.Text
  goalType    PatientHealthGoalType
  status      PatientHealthGoalStatus @default(ACTIVE)

  // Target and progress
  targetValue  Float? // Numeric target (e.g., pain level of 3)
  targetUnit   String? // Unit for target (e.g., "pain level", "days/week")
  currentValue Float? // Current progress value
  startValue   Float? // Starting value for comparison

  // Timeline
  startDate   DateTime  @default(now())
  targetDate  DateTime? // Goal completion target
  completedAt DateTime?

  // Progress tracking
  progressNotes      Json? // Array of progress updates [{date, value, note}]
  lastProgressUpdate DateTime?

  // Milestones
  milestones Json? // Array of milestones [{target, reached, date}]

  // Provider-assigned vs patient-created
  isProviderAssigned Boolean @default(false)
  assignedBy         String? // Provider ID if assigned

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([status])
  @@index([goalType])
  @@index([organizationId])
}

// =============================================================================
// Epic 27: Offline Mode (US-270)
// =============================================================================

// Offline cache for storing entity data locally
model OfflineCache {
  id String @id @default(cuid())

  // Entity identification
  entityType String // "patient", "appointment", "encounter", etc.
  entityId   String // ID of the cached entity

  // Cached data
  data    Json // The full entity data
  version Int // Version number for conflict detection

  // Cache metadata
  cachedAt  DateTime @default(now())
  expiresAt DateTime // When this cache entry expires

  // Device tracking
  deviceId String // Which device has this cached

  // User relation (for multi-user devices)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([entityType, entityId, deviceId, organizationId])
  @@index([organizationId])
  @@index([deviceId])
  @@index([userId])
  @@index([entityType])
  @@index([expiresAt])
}

// Sync conflict record for manual resolution
model SyncConflict {
  id String @id @default(cuid())

  // Operation that caused conflict
  syncQueueId String? // Reference to OfflineSyncQueue

  // Entity details
  entityType String
  entityId   String

  // Conflict data
  clientData   Json // Data from client
  serverData   Json // Data from server
  conflictType String // "version_mismatch", "deleted_on_server", "updated_on_server"

  // Resolution
  status       String    @default("pending") // "pending", "resolved_client", "resolved_server", "resolved_merge"
  resolvedData Json? // Final merged data if resolved
  resolvedAt   DateTime?
  resolvedBy   String? // User ID who resolved

  // Device info
  deviceId String

  // Timestamps
  detectedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([entityType])
  @@index([deviceId])
}

// Device sync state for tracking what data each device has
model DeviceSyncState {
  id String @id @default(cuid())

  // Device identification
  deviceId String

  // Sync watermarks (timestamps of last synced data per entity type)
  patientSyncedAt     DateTime?
  appointmentSyncedAt DateTime?
  encounterSyncedAt   DateTime?
  scheduleSyncedAt    DateTime?

  // General sync tracking
  lastFullSyncAt        DateTime?
  lastIncrementalSyncAt DateTime?

  // Sync stats
  pendingOperations Int @default(0)
  failedOperations  Int @default(0)
  conflictCount     Int @default(0)

  // Connection tracking
  isOnline     Boolean  @default(true)
  lastOnlineAt DateTime @default(now())

  // Cache stats
  cacheSize      Int @default(0) // Approximate size in bytes
  cachedEntities Int @default(0) // Number of cached entities

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([deviceId, userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([deviceId])
}

// =============================================================================
// EPIC 30: AI RECEPTIONIST AGENT
// =============================================================================

// Channel for AI receptionist conversations
enum ConversationChannel {
  PHONE
  CHAT
  SMS
  EMAIL
}

// Status of AI receptionist conversations
enum AIConversationStatus {
  ACTIVE // Currently in progress
  COMPLETED // Successfully resolved
  ESCALATED // Handed off to human
  ABANDONED // Patient disconnected
  FAILED // System error
}

// Type of AI receptionist actions
enum AIActionType {
  BOOK_APPOINTMENT
  RESCHEDULE_APPOINTMENT
  CANCEL_APPOINTMENT
  ANSWER_QUESTION
  IDENTIFY_PATIENT
  CREATE_PATIENT
  VERIFY_INSURANCE
  SEND_CONFIRMATION
  TRANSFER_CALL
  TAKE_MESSAGE
  COLLECT_INFO
}

// Result status of AI actions
enum AIActionResult {
  SUCCESS
  PARTIAL
  FAILED
  PENDING
}

// Escalation reason for AI conversations
enum AIEscalationReason {
  PATIENT_REQUEST // Patient asked for human
  CLINICAL_QUESTION // Medical/clinical question
  BILLING_DISPUTE // Billing issue
  FRUSTRATION_DETECTED // AI detected frustration
  URGENCY_DETECTED // Urgent matter
  COMPLEX_REQUEST // Too complex for AI
  REPEATED_FAILURE // Multiple failed attempts
  LOW_CONFIDENCE // AI not confident in response
  AFTER_HOURS_URGENT // Urgent after-hours call
}

// Knowledge base category for FAQ and practice information
enum KnowledgeBaseCategory {
  PRACTICE_INFO // Hours, location, parking
  INSURANCE // Insurance and payment info
  SERVICES // Treatments and services offered
  PROVIDERS // Provider bios and specialties
  APPOINTMENT_PREP // How to prepare for visits
  NEW_PATIENT // New patient process
  POLICIES // Office policies
  EMERGENCY // Emergency procedures
  CUSTOM // Custom practice-specific info
}

// AI Receptionist conversation
model AIReceptionistConversation {
  id      String               @id @default(cuid())
  channel ConversationChannel
  status  AIConversationStatus @default(ACTIVE)

  // Call/conversation details
  externalCallId String? // Twilio SID or other external ID
  phoneNumber    String? // Caller phone number
  duration       Int? // Duration in seconds

  // Transcript and context
  transcript Json? // Full conversation transcript
  context    Json? // AI conversation context
  metadata   Json? // Additional metadata (browser, device, etc.)

  // Summary
  summary        String?  @db.Text // AI-generated summary
  resolvedTopics String[] // What was resolved

  // Timing
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  // Recording consent
  recordingConsent Boolean @default(false)
  recordingUrl     String? // URL to recording if consented

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  actions    AIReceptionistAction[]
  escalation AIReceptionistEscalation?

  @@index([organizationId])
  @@index([patientId])
  @@index([channel])
  @@index([status])
  @@index([startedAt])
  @@index([phoneNumber])
}

// AI Receptionist action taken during conversation
model AIReceptionistAction {
  id         String       @id @default(cuid())
  actionType AIActionType

  // Action details
  parameters    Json? // Input parameters for the action
  result        AIActionResult @default(PENDING)
  resultDetails Json? // Output/result details

  // Confidence and reasoning
  confidence Float? // 0-1 confidence score
  reasoning  String? @db.Text // AI reasoning for taking this action

  // Related entities created/modified
  appointmentId String? // If appointment was created/modified
  patientId     String? // If patient was created/identified

  // Error handling
  errorMessage String? @db.Text
  retryCount   Int     @default(0)

  // Timing
  executedAt  DateTime  @default(now())
  completedAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  conversationId String
  conversation   AIReceptionistConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([conversationId])
  @@index([actionType])
  @@index([result])
  @@index([executedAt])
}

// AI Receptionist escalation to human
model AIReceptionistEscalation {
  id     String             @id @default(cuid())
  reason AIEscalationReason

  // Escalation details
  reasonDetails String? @db.Text // Additional context
  urgencyLevel  Int     @default(1) // 1-5, 5 being most urgent

  // Context handoff
  contextSummary   String?  @db.Text // Summary for human staff
  suggestedActions String[] // What AI suggests human should do

  // Assignment
  assignedToUserId String? // Staff member assigned

  // Resolution
  resolvedAt       DateTime?
  resolutionNotes  String?   @db.Text
  resolvedByUserId String? // Who resolved it

  // Timing
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  conversationId String                     @unique
  conversation   AIReceptionistConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([reason])
  @@index([urgencyLevel])
  @@index([assignedToUserId])
  @@index([resolvedAt])
}

// AI Knowledge base for FAQ and practice information
model AIKnowledgeBase {
  id       String                @id @default(cuid())
  category KnowledgeBaseCategory

  // Content
  question String   @db.Text // The question or topic
  answer   String   @db.Text // The answer or response
  keywords String[] // Keywords for matching

  // Variations
  variations String[] // Alternative phrasings of the question

  // Usage tracking
  timesUsed      Int       @default(0)
  helpfulCount   Int       @default(0)
  unhelpfulCount Int       @default(0)
  lastUsedAt     DateTime?

  // Status
  isActive Boolean @default(true)
  priority Int     @default(0) // Higher = more relevant

  // Review
  reviewedAt       DateTime?
  reviewedByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([priority])
}

// AI Voice configuration for phone calls
model AIVoiceConfig {
  id String @id @default(cuid())

  // Voice settings
  voiceProvider String @default("openai") // openai, elevenlabs, etc.
  voiceId       String @default("alloy") // Voice identifier
  voiceSpeed    Float  @default(1.0) // Speaking speed multiplier
  voicePitch    Float  @default(1.0) // Voice pitch adjustment

  // Greeting and messages
  greeting        String  @db.Text // Initial greeting message
  holdMessage     String? @db.Text // Message when putting caller on hold
  transferMessage String? @db.Text // Message before transferring
  afterHoursMsg   String? @db.Text // After-hours greeting
  emergencyMsg    String? @db.Text // Emergency instructions

  // Hold settings
  holdMusicUrl   String? // URL to hold music
  maxHoldSeconds Int     @default(120)

  // Call handling
  maxCallDuration Int @default(900) // Max call length in seconds
  silenceTimeout  Int @default(10) // Seconds of silence before prompting

  // Business hours (stored as JSON for flexibility)
  businessHours Json? // { monday: { open: "09:00", close: "17:00" }, ... }
  timezone      String @default("America/Los_Angeles")

  // Recording settings
  recordByDefault     Boolean @default(false)
  recordingDisclosure String? @db.Text // Disclosure message for recording

  // Escalation settings
  escalationPhone String? // Phone to transfer urgent calls to
  escalationRules Json? // Rules for automatic escalation

  // Language settings
  primaryLanguage String   @default("en-US")
  supportedLangs  String[] @default(["en-US"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // One config per organization
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ============================================
// EPIC 31: AI BILLING AGENT
// ============================================

// Billing task type enum
enum BillingTaskType {
  SUBMIT // Submit new claims
  FOLLOW_UP // Follow up on pending claims
  APPEAL // Appeal denied claims
  CORRECT // Correct rejected claims
  POST // Post payments from ERA/EOB
  SCRUB // Pre-submission scrubbing
  ELIGIBILITY // Check patient eligibility
  STATUS // Check claim status
}

// Billing task status enum
enum BillingTaskStatus {
  QUEUED // Waiting to be processed
  IN_PROGRESS // Currently being processed
  COMPLETED // Successfully completed
  FAILED // Processing failed
  SKIPPED // Skipped due to conditions
  CANCELLED // Cancelled by user or system
  NEEDS_REVIEW // Requires human review
}

// AI Billing Task - Tracks individual billing agent activities
model AIBillingTask {
  id       String            @id @default(cuid())
  taskType BillingTaskType
  status   BillingTaskStatus @default(QUEUED)

  // Task target
  claimId   String?
  patientId String?
  payerId   String?
  chargeId  String?

  // Priority and scheduling
  priority     Int       @default(0) // Higher = more urgent
  scheduledFor DateTime? // When to execute (null = ASAP)
  startedAt    DateTime?
  completedAt  DateTime?

  // Retry tracking
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  lastError   String?   @db.Text
  nextRetryAt DateTime?

  // Task result
  result          Json? // Outcome data from processing
  resultSummary   String? // Human-readable summary
  amountRecovered Decimal? @db.Decimal(10, 2) // For financial impact tracking

  // Context and metadata
  context  Json? // Input context for processing
  metadata Json? // Additional metadata

  // AI processing
  aiModelUsed      String?
  processingTimeMs Int?
  tokensUsed       Int?

  // Audit
  createdBy String? // User or system that created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claim   Claim?          @relation(fields: [claimId], references: [id])
  patient Patient?        @relation(fields: [patientId], references: [id])
  payer   InsurancePayer? @relation(fields: [payerId], references: [id])
  charge  Charge?         @relation(fields: [chargeId], references: [id])

  // Related decisions
  decisions AIBillingDecision[]

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([taskType])
  @@index([status])
  @@index([claimId])
  @@index([patientId])
  @@index([scheduledFor])
  @@index([createdAt])
}

// AI Billing Decision - Records AI decisions with reasoning
model AIBillingDecision {
  id String @id @default(cuid())

  // Decision details
  decision   String @db.Text // The decision made
  reasoning  String @db.Text // Why this decision was made
  confidence Float // 0-1 confidence score

  // Alternatives considered
  alternatives Json? // Array of { option, reason, score }

  // Evidence/supporting data
  evidence     Json? // Data that informed the decision
  rulesApplied Json? // Which billing rules were applied

  // Risk assessment
  riskLevel   String? // low, medium, high
  riskFactors Json? // What risks were identified

  // Outcome tracking (filled in after action)
  outcomeStatus  String? // success, partial, failed
  outcomeDetails Json?
  actualImpact   Decimal? @db.Decimal(10, 2) // Actual financial impact

  // User override
  wasOverridden  Boolean   @default(false)
  overriddenBy   String?
  overrideReason String?   @db.Text
  overriddenAt   DateTime?

  // AI metadata
  modelVersion     String?
  processingTimeMs Int?
  promptUsed       String? @db.Text // For debugging/improvement

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  taskId String
  task   AIBillingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([taskId])
  @@index([decision])
  @@index([confidence])
  @@index([createdAt])
}

// Appeal status enum
enum AIAppealStatus {
  DRAFT // Being prepared
  READY // Ready to send
  SUBMITTED // Sent to payer
  ACKNOWLEDGED // Payer acknowledged receipt
  IN_REVIEW // Payer is reviewing
  ADDITIONAL_INFO // Payer requested more info
  APPROVED // Appeal approved
  PARTIAL // Partially approved
  DENIED // Appeal denied
  ESCALATED // Escalated to higher level
}

// AI Appeal - Comprehensive appeal tracking
model AIAppeal {
  id     String         @id @default(cuid())
  status AIAppealStatus @default(DRAFT)

  // Appeal content
  appealType String @default("FIRST_LEVEL") // FIRST_LEVEL, SECOND_LEVEL, EXTERNAL
  subject    String
  body       String @db.Text

  // Denial being appealed
  denialCode   String? // Original denial code
  denialReason String?   @db.Text
  denialDate   DateTime?
  denialAmount Decimal?  @db.Decimal(10, 2)

  // Supporting arguments
  arguments        Json? // Array of appeal arguments
  medicalNecessity String? @db.Text // Medical necessity justification
  clinicalSummary  String? @db.Text // Relevant clinical information
  citations        Json? // Legal/medical citations

  // Attachments
  attachments Json? // Array of { name, type, url, description }

  // Deadlines
  appealDeadline   DateTime? // When appeal must be submitted
  payerResponseDue DateTime? // Expected response date

  // Submission tracking
  submittedAt        DateTime?
  submittedBy        String?
  submissionMethod   String? // electronic, mail, fax, portal
  confirmationNumber String?

  // Payer response
  responseDate    DateTime?
  responseDetails String?   @db.Text
  approvedAmount  Decimal?  @db.Decimal(10, 2)
  adjustmentCodes Json? // Any adjustment codes in response

  // Financial tracking
  originalAmount  Decimal? @db.Decimal(10, 2) // Original claim amount
  recoveredAmount Decimal? @db.Decimal(10, 2) // Amount recovered

  // Learning/improvement
  successFactors  Json? // What made this appeal successful/unsuccessful
  templateVersion String?

  // AI metadata
  generatedByAI    Boolean @default(true)
  aiModelUsed      String?
  processingTimeMs Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([appealDeadline])
  @@index([createdAt])
}

// AI Billing Rule - Configurable rules for billing agent behavior
model AIBillingRule {
  id       String @id @default(cuid())
  name     String
  category String // submission, scrubbing, appeal, followup, posting

  // Rule definition
  description String @db.Text
  conditions  Json // Array of { field, operator, value }
  actions     Json // Array of { action, parameters }

  // Applicability
  payerIds       String[] // Specific payers (empty = all)
  procedureCodes String[] // Specific CPT codes (empty = all)
  claimTypes     String[] // professional, institutional (empty = all)

  // Scheduling/triggers
  triggerType  String  @default("automatic") // automatic, scheduled, manual
  triggerTime  String? // Cron expression for scheduled
  delayMinutes Int     @default(0) // Delay before executing

  // Priority and thresholds
  priority       Int      @default(0) // Higher = runs first
  minClaimAmount Decimal? @db.Decimal(10, 2) // Minimum claim amount to apply
  maxClaimAmount Decimal? @db.Decimal(10, 2) // Maximum claim amount

  // Safety limits
  maxActionsPerDay  Int      @default(100) // Max executions per day
  requiresApproval  Boolean  @default(false) // Needs human approval
  approvalThreshold Decimal? @db.Decimal(10, 2) // Amount above which needs approval

  // Status
  isActive    Boolean   @default(true)
  lastRunAt   DateTime?
  runCount    Int       @default(0)
  successRate Float? // Historical success rate

  // Audit
  createdBy  String?
  modifiedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([priority])
}

// AI Billing Metric - Performance tracking for the billing agent
model AIBillingMetric {
  id         String   @id @default(cuid())
  metricDate DateTime @default(now())
  periodType String   @default("daily") // hourly, daily, weekly, monthly

  // Task metrics
  tasksQueued     Int @default(0)
  tasksCompleted  Int @default(0)
  tasksFailed     Int @default(0)
  tasksSkipped    Int @default(0)
  avgProcessingMs Int @default(0)

  // Submission metrics
  claimsSubmitted Int   @default(0)
  claimsAccepted  Int   @default(0)
  claimsRejected  Int   @default(0)
  submissionRate  Float @default(0) // % accepted

  // Follow-up metrics
  followUpsPerformed Int @default(0)
  statusesUpdated    Int @default(0)
  stalledIdentified  Int @default(0)

  // Appeal metrics
  appealsGenerated  Int   @default(0)
  appealsSubmitted  Int   @default(0)
  appealsWon        Int   @default(0)
  appealsLost       Int   @default(0)
  appealSuccessRate Float @default(0)

  // Posting metrics
  paymentsPosted Int     @default(0)
  amountPosted   Decimal @default(0) @db.Decimal(12, 2)
  autoMatchRate  Float   @default(0) // % auto-matched

  // Financial impact
  revenueRecovered      Decimal @default(0) @db.Decimal(12, 2)
  underpaymentsCaught   Int     @default(0)
  underpaymentAmount    Decimal @default(0) @db.Decimal(12, 2)
  denialPreventionSaved Decimal @default(0) @db.Decimal(12, 2)

  // AR metrics
  avgDaysInAR    Float   @default(0)
  arOver30Days   Decimal @default(0) @db.Decimal(12, 2)
  arOver60Days   Decimal @default(0) @db.Decimal(12, 2)
  arOver90Days   Decimal @default(0) @db.Decimal(12, 2)
  collectionRate Float   @default(0) // % collected

  // AI performance
  aiDecisionsMade    Int   @default(0)
  aiDecisionsCorrect Int   @default(0)
  aiAccuracyRate     Float @default(0)
  userOverrides      Int   @default(0)

  // Cost tracking
  aiTokensUsed Int     @default(0)
  aiCostUsd    Decimal @default(0) @db.Decimal(8, 4)

  // Comparison to manual
  manualHoursEquivalent Float   @default(0) // Hours saved
  costSavingsUsd        Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, metricDate, periodType])
  @@index([organizationId])
  @@index([metricDate])
  @@index([periodType])
}

// ============================================
// EPIC 32: AI DOCUMENTATION AGENT
// ============================================

// Transcription status enum
enum TranscriptionStatus {
  RECORDING // Currently recording
  PROCESSING // Being transcribed
  COMPLETED // Transcription complete
  FAILED // Transcription failed
  PAUSED // Recording paused
}

// AI Draft Note status enum
enum DraftNoteStatus {
  GENERATING // Being generated
  PENDING_REVIEW // Awaiting provider review
  APPROVED // Accepted by provider
  REJECTED // Rejected by provider
  EDITED // Edited by provider
  APPLIED // Applied to encounter
}

// Code suggestion status enum
enum CodeSuggestionStatus {
  PENDING // Awaiting review
  ACCEPTED // Code accepted
  REJECTED // Code rejected
  MODIFIED // Code modified before accepting
}

// Compliance issue severity enum
enum ComplianceSeverity {
  INFO // Informational only
  WARNING // Should be addressed
  ERROR // Must be fixed before billing
  CRITICAL // Prevents claim submission
}

// AI Transcription - Stores real-time encounter transcriptions
model AITranscription {
  id     String              @id @default(cuid())
  status TranscriptionStatus @default(RECORDING)

  // Audio information
  audioUrl      String? // URL to stored audio file
  audioDuration Int     @default(0) // Duration in seconds

  // Transcription content
  transcript String? @db.Text // Full transcript text
  segments   Json? // Array of { speaker, text, startTime, endTime, confidence }

  // Speaker diarization
  speakerCount  Int   @default(2) // Number of speakers detected
  speakerLabels Json? // { "SPEAKER_1": "provider", "SPEAKER_2": "patient" }

  // Processing metadata
  transcriptionModel String? // e.g., "whisper-1", "deepgram"
  language           String  @default("en-US")
  accuracy           Float? // Overall transcription accuracy 0-1

  // Medical terminology processing
  medicalTermsFound Json? // Array of detected medical terms
  correctedTerms    Json? // Auto-corrections made { original, corrected }

  // Timing
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  processingMs Int? // Time to process transcription

  // Error tracking
  errorMessage String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related draft notes generated from this transcription
  draftNotes AIDraftNote[]

  @@index([organizationId])
  @@index([encounterId])
  @@index([status])
  @@index([createdAt])
}

// AI Draft Note - AI-generated SOAP notes from transcriptions
model AIDraftNote {
  id     String          @id @default(cuid())
  status DraftNoteStatus @default(GENERATING)

  // SOAP content
  subjective String? @db.Text
  objective  String? @db.Text
  assessment String? @db.Text
  plan       String? @db.Text

  // Structured content (for template matching)
  soapJson Json? // Complete structured SOAP content

  // Confidence scores (0-1)
  subjectiveConfidence Float?
  objectiveConfidence  Float?
  assessmentConfidence Float?
  planConfidence       Float?
  overallConfidence    Float?

  // Provider style matching
  styleMatchScore Float? // How well it matches provider's style 0-1
  styleElements   Json? // Which style elements were applied

  // Provider review
  reviewedAt       DateTime?
  reviewedByUserId String?
  reviewNotes      String?   @db.Text

  // Edits tracking
  editedContent Json? // Provider's edited version
  editCount     Int   @default(0)
  editReasons   Json? // Array of edit reasons for learning

  // AI metadata
  aiModelUsed      String?
  processingTimeMs Int?
  promptVersion    String? // Version of prompt used
  tokensUsed       Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  transcriptionId String?
  transcription   AITranscription? @relation(fields: [transcriptionId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([transcriptionId])
  @@index([status])
  @@index([createdAt])
}

// AI Code Suggestion - Diagnosis and procedure code suggestions
model AICodeSuggestion {
  id     String               @id @default(cuid())
  status CodeSuggestionStatus @default(PENDING)

  // Code type
  codeType String // "ICD10", "CPT", "MODIFIER"

  // Suggested code(s)
  suggestedCode   String // Primary code suggested
  suggestedCodes  Json? // Array of codes if multiple
  codeDescription String? // Human-readable description

  // Reasoning
  reasoning      String  @db.Text // Why this code was suggested
  evidenceQuotes Json? // Quotes from documentation supporting this code
  relevantText   String? @db.Text // Text that triggered suggestion

  // Confidence and ranking
  confidence Float // 0-1 confidence score
  rank       Int   @default(1) // Ranking among alternatives

  // Alternative suggestions
  alternatives Json? // Array of { code, description, confidence, reasoning }

  // Code validation
  codeValid       Boolean @default(true) // Is the code currently valid
  specificityOk   Boolean @default(true) // Is specificity appropriate
  modifiersNeeded Json? // Suggested modifiers

  // Compliance flags
  upcodingRisk   Boolean @default(false)
  downcodingRisk Boolean @default(false)
  auditRisk      String? // low, medium, high

  // Provider response
  acceptedAt   DateTime?
  rejectedAt   DateTime?
  modifiedCode String? // If provider modified the code
  modifyReason String? // Why it was modified

  // AI metadata
  aiModelUsed      String?
  processingTimeMs Int?
  promptVersion    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([codeType])
  @@index([status])
  @@index([confidence])
  @@index([createdAt])
}

// AI Compliance Check - Documentation compliance validation
model AIComplianceCheck {
  id String @id @default(cuid())

  // Issue details
  issueType   String // e.g., "MISSING_ELEMENT", "SPECIFICITY", "MEDICAL_NECESSITY"
  severity    ComplianceSeverity
  title       String
  description String             @db.Text

  // Location of issue
  soapSection String? // subjective, objective, assessment, plan
  fieldPath   String? // Specific field within section
  lineNumber  Int? // If applicable

  // Compliance context
  requirementSource String? // CMS, payer, state law, etc.
  requirementCode   String? // Specific requirement reference
  payerSpecific     String? // Which payer this applies to (null = all)

  // Suggestions
  suggestion    String? @db.Text // How to fix the issue
  exampleFix    String? @db.Text // Example correction
  autoFixable   Boolean @default(false) // Can AI auto-fix
  suggestedText String? @db.Text // If autoFixable, the suggested text

  // Resolution
  resolved     Boolean   @default(false)
  resolvedAt   DateTime?
  resolvedBy   String? // User ID who resolved
  resolution   String? // How it was resolved
  wasDismissed Boolean   @default(false) // Dismissed without fixing

  // Risk scoring
  auditRiskImpact Int? // Impact on audit risk 0-100
  denialRisk      Float? // Probability of denial 0-1

  // AI metadata
  aiModelUsed      String?
  processingTimeMs Int?
  rulesApplied     Json? // Which rules detected this issue

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - can link to SOAPNote or Encounter
  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  noteId   String?
  soapNote SOAPNote? @relation(fields: [noteId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([noteId])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

// Provider Preference - Learns and stores provider documentation preferences
model ProviderPreference {
  id String @id @default(cuid())

  // Preference category
  category String // terminology, style, format, template, phrases

  // Preference key-value
  preferenceKey   String // Specific preference identifier
  preferenceValue Json // The learned value/pattern

  // Learning data
  learnedFrom     Int      @default(0) // Number of examples this was learned from
  confidenceScore Float    @default(0.5) // How confident we are in this preference
  lastUpdated     DateTime @default(now()) // When preference was last updated

  // Usage tracking
  timesApplied  Int @default(0) // Times this preference was applied
  timesAccepted Int @default(0) // Times the result was accepted
  timesRejected Int @default(0) // Times the result was rejected/edited

  // Example data
  examples Json? // Array of examples that formed this preference

  // Metadata
  isActive    Boolean @default(true)
  description String? // Human-readable description
  source      String? // How this was learned (edits, explicit setting, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([providerId, category, preferenceKey])
  @@index([organizationId])
  @@index([providerId])
  @@index([category])
  @@index([isActive])
}

// Text macro for smart text expansion (US-321)
model TextMacro {
  id String @id @default(cuid())

  // Macro trigger and expansion
  trigger     String // Short trigger text like ".hpi" or ".pain"
  expansion   String  @db.Text // Full expansion text
  description String? // Human-readable description

  // Macro category
  category String // general, subjective, objective, assessment, plan, common_phrases

  // Scope
  scope String @default("provider") // provider, organization, system

  // Context-awareness
  encounterTypes String[] // Which encounter types this applies to (empty = all)
  soapSections   String[] // Which SOAP sections (S, O, A, P, or empty = all)

  // Variables/placeholders
  variables Json? // Variables that need to be filled in

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  // AI learning
  learnedFromProvider Boolean @default(false) // Was this learned from provider patterns?
  confidence          Float   @default(1.0) // Confidence score for AI-generated macros

  // Active state
  isActive Boolean @default(true)
  isSystem Boolean @default(false) // System macros can't be deleted by users

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - null providerId = organization-wide or system macro
  providerId String?
  provider   Provider? @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([trigger, providerId, organizationId])
  @@index([organizationId])
  @@index([providerId])
  @@index([category])
  @@index([isActive])
  @@index([scope])
}

// AI template suggestion tracking (US-321)
model AITemplateSuggestion {
  id String @id @default(cuid())

  // Context
  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  appointmentType String // The appointment type that triggered suggestion
  encounterType   String // The encounter type

  // Suggestion details
  suggestedTemplateId String // ID of the suggested NoteTemplate
  suggestedContent    Json? // Specific content suggestions

  // Reasoning
  reasoning String? // Why this template was suggested

  // Confidence
  confidence Float @default(0.8)

  // Outcome
  status      String    @default("SUGGESTED") // SUGGESTED, ACCEPTED, REJECTED, MODIFIED
  acceptedAt  DateTime?
  rejectedAt  DateTime?
  modifyNotes String?

  // Pull-forward data (from previous notes)
  pullForwardData Json? // Content pulled from previous visits
  pullForwardFrom String? // ID of the note pulled from

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([appointmentType])
  @@index([encounterType])
  @@index([status])
}

// ============================================
// EPIC 33: AI CARE COORDINATOR AGENT
// ============================================

// Types of care gaps that can be identified
enum CareGapType {
  OVERDUE_FOLLOWUP // Patient overdue for follow-up visit
  MISSED_APPOINTMENT // Missed scheduled appointment
  INCOMPLETE_TREATMENT // Treatment plan not completed
  MISSING_ASSESSMENT // Outcome assessment not completed
  LAPSED_PATIENT // Patient hasn't visited in extended period
  OVERDUE_RECALL // Due for recall/maintenance visit
  INCOMPLETE_DOCUMENTATION // Missing required documentation
  MISSED_MILESTONE // Treatment milestone not achieved
}

// Status of care gaps
enum CareGapStatus {
  IDENTIFIED // Gap has been identified
  OUTREACH_SCHEDULED // Outreach planned
  OUTREACH_SENT // Outreach communication sent
  RESPONDED // Patient responded to outreach
  RESOLVED // Gap has been resolved
  DISMISSED // Gap dismissed (not applicable)
  ESCALATED // Escalated to provider
}

// Types of care outreach
enum CareOutreachType {
  APPOINTMENT_REMINDER // Upcoming appointment reminder
  FOLLOWUP_SCHEDULING // Request to schedule follow-up
  CARE_GAP_NOTIFICATION // Notification about care gap
  TREATMENT_PROGRESS // Treatment progress check-in
  REACTIVATION // Lapsed patient reactivation
  RECALL_REMINDER // Maintenance/recall reminder
  EXERCISE_REMINDER // Home exercise reminder
  OUTCOME_ASSESSMENT // Request to complete assessment
}

// Status of outreach attempts
enum CareOutreachStatus {
  SCHEDULED // Outreach scheduled
  SENT // Communication sent
  DELIVERED // Confirmed delivered
  OPENED // Email opened
  CLICKED // Link clicked
  RESPONDED // Patient responded
  CONVERTED // Resulted in desired action
  FAILED // Failed to deliver
  BOUNCED // Email bounced
}

// Patient care journey types
enum CareJourneyType {
  NEW_PATIENT // New patient onboarding
  ACTIVE_CARE // Active treatment phase
  MAINTENANCE // Maintenance/wellness care
  ACUTE_EPISODE // Acute care episode
  POST_DISCHARGE // Post-discharge follow-up
  REENGAGEMENT // Lapsed patient re-engagement
  CUSTOM // Custom defined journey
}

// Journey stage status
enum JourneyStageStatus {
  NOT_STARTED // Stage not yet started
  IN_PROGRESS // Currently in this stage
  COMPLETED // Stage completed
  SKIPPED // Stage was skipped
  PAUSED // Stage paused
}

// Care coordinator action types
enum CareCoordinatorActionType {
  OUTREACH_SENT // Sent outreach message
  APPOINTMENT_SCHEDULED // Scheduled appointment
  APPOINTMENT_RESCHEDULED // Rescheduled appointment
  GAP_IDENTIFIED // Identified a care gap
  GAP_RESOLVED // Resolved a care gap
  ENGAGEMENT_SCORED // Updated engagement score
  JOURNEY_ADVANCED // Advanced patient in journey
  ALERT_TRIGGERED // Triggered provider alert
  RECOMMENDATION_MADE // Made care recommendation
  TASK_CREATED // Created follow-up task
}

// CareGap model - tracks identified gaps in patient care
model CareGap {
  id      String        @id @default(cuid())
  gapType CareGapType
  status  CareGapStatus @default(IDENTIFIED)

  // Gap details
  title       String // Human-readable title
  description String?   @db.Text // Detailed description
  dueDate     DateTime? // When this gap should be addressed
  priority    Int       @default(5) // 1-10, higher = more urgent

  // Resolution tracking
  resolvedDate    DateTime?
  resolvedBy      String? // User ID who resolved
  resolution      String? // How it was resolved
  dismissedReason String? // If dismissed, why

  // Related care data
  treatmentPlanId String? // Related treatment plan
  appointmentId   String? // Related appointment
  encounterId     String? // Related encounter

  // Auto-detection metadata
  detectedBy     String? // Algorithm/rule that detected this
  detectionScore Float? // Confidence score of detection
  detectionData  Json? // Additional detection context

  // Outreach tracking
  outreachCount  Int       @default(0) // Number of outreach attempts
  lastOutreachAt DateTime? // Last outreach attempt
  nextOutreachAt DateTime? // Scheduled next outreach

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related outreach attempts
  outreachAttempts CareOutreach[]

  @@index([organizationId])
  @@index([patientId])
  @@index([gapType])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@index([createdAt])
}

// CareOutreach model - tracks outreach communications to patients
model CareOutreach {
  id     String             @id @default(cuid())
  type   CareOutreachType
  status CareOutreachStatus @default(SCHEDULED)

  // Scheduling
  scheduledAt DateTime? // When outreach is scheduled
  sentAt      DateTime? // When actually sent

  // Communication details
  channel    String // email, sms, phone, portal
  subject    String? // Subject line (for emails)
  content    String  @db.Text // Message content
  templateId String? // Template used

  // Delivery tracking
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  respondedAt DateTime?

  // Response details
  response        String? @db.Text // Patient's response
  responseChannel String? // How they responded
  outcome         String? // Outcome of the outreach
  convertedAction String? // What action did they take

  // For appointment reminders
  appointmentId       String? // Related appointment
  reminderSequence    Int? // Which reminder in sequence
  includeInstructions Boolean @default(true)

  // Personalization
  personalizationData Json? // Data used for personalization

  // AI optimization
  optimalTimeUsed Boolean @default(false) // Used AI-optimized timing
  noShowRiskLevel Float? // No-show risk at time of send
  sentimentScore  Float? // Sentiment of patient response

  // Error tracking
  errorMessage String? // If failed, why
  retryCount   Int       @default(0)
  lastRetryAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Optional link to care gap
  careGapId String?
  careGap   CareGap? @relation(fields: [careGapId], references: [id], onDelete: SetNull)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([type])
  @@index([status])
  @@index([scheduledAt])
  @@index([sentAt])
  @@index([careGapId])
}

// PatientEngagementScore model - tracks patient engagement metrics
model PatientEngagementScore {
  id    String @id @default(cuid())
  score Int // Overall engagement score 0-100

  // Score components (each 0-100)
  visitAttendanceScore    Int? // Based on appointment attendance
  portalUsageScore        Int? // Based on portal activity
  communicationScore      Int? // Based on message responses
  exerciseComplianceScore Int? // Based on home exercise completion
  appointmentBookingScore Int? // Proactive vs reactive booking
  paymentTimelinessScore  Int? // Payment behavior

  // Factor weights used (for transparency)
  factorWeights Json? // { visitAttendance: 0.3, portalUsage: 0.15, ... }

  // Score breakdown details
  factors Json? // Detailed factor breakdown

  // Trend data
  previousScore Int? // Previous score for comparison
  trend         String? // improving, stable, declining
  trendDuration Int? // How many periods trending

  // Segmentation
  engagementLevel String // high, medium, low, at-risk
  segment         String? // Additional segmentation label

  // Calculation metadata
  calculatedAt DateTime @default(now())
  dataWindow   Int      @default(90) // Days of data used in calculation
  dataPoints   Int? // Number of data points used

  // Intervention tracking
  interventionTriggered Boolean   @default(false)
  interventionType      String?
  interventionDate      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([score])
  @@index([engagementLevel])
  @@index([calculatedAt])
}

// CareJourney model - tracks patient through care journey stages
model CareJourney {
  id          String          @id @default(cuid())
  journeyType CareJourneyType
  name        String // Journey name for display

  // Journey status
  isActive    Boolean   @default(true)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  pausedAt    DateTime?
  pauseReason String?

  // Current position in journey
  currentStage      String // Current stage identifier
  currentStageStart DateTime @default(now())

  // Progress tracking
  completedStages Json // Array of completed stage IDs with dates
  skippedStages   Json? // Array of skipped stage IDs with reasons

  // Milestones
  milestones          Json? // Array of milestone definitions
  completedMilestones Json? // Array of completed milestone IDs with dates
  nextMilestone       String? // Next milestone to achieve
  nextMilestoneTarget DateTime? // Target date for next milestone

  // Journey configuration
  journeyConfig Json? // Journey-specific configuration

  // Outcome tracking
  outcome       String? // success, abandoned, transferred, etc.
  outcomeReason String?
  outcomeDate   DateTime?

  // AI personalization
  personalizedPath     Boolean @default(false) // AI-customized path
  pathAdjustments      Json? // Record of AI path adjustments
  nextActionSuggestion String? // AI-suggested next action

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related actions
  actions CareCoordinatorAction[]

  @@index([organizationId])
  @@index([patientId])
  @@index([journeyType])
  @@index([isActive])
  @@index([currentStage])
  @@index([startedAt])
}

// CareCoordinatorAction model - logs all AI care coordinator actions
model CareCoordinatorAction {
  id         String                    @id @default(cuid())
  actionType CareCoordinatorActionType

  // Action details
  title       String // Human-readable title
  description String? @db.Text // Detailed description of action

  // Result tracking
  result       String? // success, failed, pending, cancelled
  resultData   Json? // Detailed result data
  errorMessage String? // If failed, error details

  // Related entities (at least one should be set)
  appointmentId   String?
  encounterId     String?
  careGapId       String?
  outreachId      String?
  treatmentPlanId String?

  // Journey context
  careJourneyId String?
  careJourney   CareJourney? @relation(fields: [careJourneyId], references: [id], onDelete: SetNull)
  journeyStage  String? // Stage at time of action

  // AI metadata
  aiInitiated   Boolean @default(true) // AI vs manual action
  aiConfidence  Float? // AI confidence in action
  aiReasoning   String? @db.Text // AI reasoning for action
  modelUsed     String? // AI model used
  promptVersion String? // Prompt version used

  // Performance tracking
  executionTimeMs Int? // Time to execute action
  retryCount      Int  @default(0)

  // Approval tracking (for actions requiring approval)
  requiresApproval Boolean   @default(false)
  approvedBy       String? // User ID who approved
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  rejectionReason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([actionType])
  @@index([result])
  @@index([careJourneyId])
  @@index([createdAt])
  @@index([aiInitiated])
}

// ============================================
// EPIC 36: AI QUALITY ASSURANCE AGENT
// ============================================

// Audit type categories
enum QAAuditType {
  DOCUMENTATION       // Clinical documentation quality
  CODING              // Coding accuracy and appropriateness
  COMPLIANCE          // Regulatory and billing compliance
  CLINICAL            // Clinical quality measures
  WORKFLOW            // Workflow efficiency
  FINANCIAL           // Financial accuracy
  AUDIT_PREPARATION   // Audit readiness preparation (US-353)
  MOCK_AUDIT          // Mock audit simulation (US-353)
}

// Finding severity levels
enum QAFindingSeverity {
  CRITICAL // Must address immediately
  HIGH     // Significant risk or issue
  MEDIUM   // Moderate concern
  LOW      // Minor improvement opportunity
  INFO     // Informational only
}

// Finding status
enum QAFindingStatus {
  OPEN       // Not yet addressed
  IN_REVIEW  // Being reviewed
  IN_PROGRESS // Being worked on
  RESOLVED   // Fixed
  DISMISSED  // Determined to be not applicable
  DEFERRED   // Postponed for later
}

// Metric types for quality tracking
enum QAMetricType {
  DOCUMENTATION_COMPLETENESS
  DOCUMENTATION_ACCURACY
  CODING_ACCURACY
  CODING_COMPLIANCE
  MODIFIER_ACCURACY
  MEDICAL_NECESSITY
  HIPAA_COMPLIANCE
  BILLING_COMPLIANCE
  CONSENT_COMPLIANCE
  OUTCOME_TRACKING
  TREATMENT_EFFECTIVENESS
  PATIENT_SATISFACTION
  DENIAL_RATE
  AUDIT_RISK_SCORE
  // Compliance monitoring metrics (US-350)
  COMPLIANCE_OVERALL
  COMPLIANCE_HIPAA
  COMPLIANCE_BILLING
  COMPLIANCE_CONSENT
  COMPLIANCE_AUDIT_TRAIL
  // Clinical quality metrics (US-351)
  CLINICAL_QUALITY_OVERALL
  CARE_GAP_CLOSURE
  PROVIDER_PERFORMANCE
  FUNCTIONAL_IMPROVEMENT
  PAIN_REDUCTION
  VISIT_COMPLIANCE
  // Risk identification metrics (US-352)
  RISK_AUDIT_TARGET
  RISK_PATTERN
  RISK_PROVIDER_OUTLIER
  RISK_PAYER_AUDIT
  RISK_OVERALL
}

// Compliance alert types
enum ComplianceAlertType {
  HIPAA_VIOLATION
  BILLING_IRREGULARITY
  DOCUMENTATION_GAP
  CONSENT_MISSING
  AUDIT_TRAIL_GAP
  UNUSUAL_PATTERN
  POLICY_VIOLATION
  CREDENTIAL_EXPIRING
  TRAINING_DUE
}

// Compliance alert status
enum ComplianceAlertStatus {
  NEW
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  DISMISSED
  ESCALATED
}

// QA rule trigger types
enum QARuleTrigger {
  ENCOUNTER_CREATED
  ENCOUNTER_COMPLETED
  CLAIM_SUBMITTED
  CLAIM_DENIED
  PAYMENT_POSTED
  DAILY_BATCH
  WEEKLY_BATCH
  MONTHLY_BATCH
  MANUAL
}

// QA audit record
model QAAudit {
  id        String      @id @default(cuid())
  auditType QAAuditType
  auditDate DateTime    @default(now())

  // Audit scope
  targetType String? // Encounter, Provider, Claim, Note, etc.
  targetId   String? // ID of specific entity being audited
  providerId String? // Provider being audited (if applicable)
  dateFrom   DateTime? // Audit period start
  dateTo     DateTime? // Audit period end

  // Scoring
  score         Int?     @default(0) // Overall score 0-100
  maxScore      Int?     @default(100)
  scoreCategory String?  // excellent, good, needs_improvement, poor
  passFail      Boolean? // For pass/fail type audits

  // Summary
  findingsCount Int @default(0)
  criticalCount Int @default(0)
  highCount     Int @default(0)
  mediumCount   Int @default(0)
  lowCount      Int @default(0)

  // Audit details
  summary            String?  @db.Text // Executive summary
  methodology        String? // How audit was conducted
  sampleSize         Int? // Number of items sampled
  populationSize     Int? // Total population
  confidenceLevel    Float? // Statistical confidence
  recommendations    Json? // Array of high-level recommendations
  previousAuditId    String? // Link to previous audit for comparison
  scoreChangePercent Float? // Change from previous audit

  // AI metadata
  aiGenerated    Boolean @default(true)
  modelVersion   String?
  processingTime Int? // milliseconds

  // Status
  status      String    @default("completed") // in_progress, completed, failed
  completedAt DateTime?
  reviewedBy  String? // User who reviewed
  reviewedAt  DateTime?
  reviewNotes String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  findings QAFinding[]

  @@index([organizationId])
  @@index([auditType])
  @@index([auditDate])
  @@index([providerId])
  @@index([targetType, targetId])
  @@index([score])
}

// Individual finding from an audit
model QAFinding {
  id          String            @id @default(cuid())
  findingType String // Specific type of finding
  severity    QAFindingSeverity
  status      QAFindingStatus   @default(OPEN)

  // Finding details
  title       String // Short description
  description String  @db.Text // Detailed explanation
  evidence    String? @db.Text // Supporting evidence
  impact      String? @db.Text // Potential impact if not addressed

  // Location/context
  entityType String? // Note, Claim, Encounter, etc.
  entityId   String? // ID of affected entity
  fieldName  String? // Specific field with issue
  providerId String? // Provider associated with finding
  patientId  String? // Patient associated with finding (if applicable)

  // Recommendations
  recommendation String? @db.Text // What to do about it
  correctiveAction String? @db.Text // Specific corrective action
  preventiveAction String? @db.Text // How to prevent recurrence

  // Risk assessment
  riskScore       Int? // 0-100 risk score
  complianceImpact Boolean @default(false) // Affects compliance
  financialImpact Decimal? @db.Decimal(10, 2) // Estimated financial impact
  auditRiskFactor Float?  // Contribution to audit risk

  // Resolution tracking
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String?   @db.Text
  dueDate        DateTime? // Target resolution date
  reminderSent   Boolean   @default(false)

  // AI metadata
  confidence     Float? // AI confidence in finding
  relatedCodes   Json?  // Related CPT, ICD codes
  citedGuidelines Json? // Payer guidelines, LCD/NCDs cited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auditId String
  audit   QAAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([auditId])
  @@index([severity])
  @@index([status])
  @@index([findingType])
  @@index([providerId])
  @@index([dueDate])
  @@index([createdAt])
}

// Quality metrics tracking over time
model QAMetric {
  id         String       @id @default(cuid())
  metricType QAMetricType
  period     String // monthly, quarterly, yearly
  periodStart DateTime
  periodEnd   DateTime

  // Metric values
  score      Decimal @db.Decimal(6, 2) // Actual score/value
  maxScore   Decimal @db.Decimal(6, 2) // Maximum possible
  percentage Decimal @db.Decimal(5, 2) // Score as percentage
  benchmark  Decimal? @db.Decimal(5, 2) // Industry/internal benchmark
  target     Decimal? @db.Decimal(5, 2) // Target for this period

  // Performance assessment
  meetsTarget    Boolean? // Whether target is met
  meetsBenchmark Boolean? // Whether benchmark is met
  trend          String?  // improving, stable, declining
  trendPercent   Float?   // Percentage change from prior period

  // Breakdown
  sampleSize    Int? // Number of items measured
  passCount     Int? // Items that passed
  failCount     Int? // Items that failed
  breakdown     Json? // Detailed breakdown by subcategory
  topIssues     Json? // Most common issues

  // Provider-level metrics
  providerId     String?
  providerName   String?
  providerScore  Decimal? @db.Decimal(5, 2)
  providerRank   Int? // Rank among providers

  // Calculation metadata
  calculatedAt   DateTime @default(now())
  calculationMethod String? // How metric was calculated
  dataSourceIds  Json?    // IDs of records used in calculation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, metricType, period, periodStart, providerId])
  @@index([organizationId])
  @@index([metricType])
  @@index([periodStart])
  @@index([providerId])
  @@index([meetsTarget])
}

// Real-time compliance alerts
model ComplianceAlert {
  id       String              @id @default(cuid())
  type     ComplianceAlertType
  severity QAFindingSeverity
  status   ComplianceAlertStatus @default(NEW)

  // Alert details
  title       String
  description String  @db.Text
  evidence    String? @db.Text

  // Context
  entityType String? // What triggered the alert
  entityId   String?
  providerId String?
  patientId  String?
  userId     String? // User involved (if applicable)

  // Detection info
  detectedAt DateTime @default(now())
  detectedBy String   @default("AI") // AI or rule name
  ruleId     String?  // QA rule that triggered (if applicable)

  // Risk assessment
  riskLevel     String? // low, medium, high, critical
  riskScore     Int? // 0-100
  complianceRisk Boolean @default(true)
  financialRisk  Boolean @default(false)
  reputationRisk Boolean @default(false)

  // Required actions
  requiredAction String? @db.Text
  actionDueDate  DateTime?
  escalationDate DateTime? // When to escalate if not resolved

  // Resolution tracking
  acknowledgedAt   DateTime?
  acknowledgedBy   String?
  resolvedAt       DateTime?
  resolvedBy       String?
  resolutionNote   String?   @db.Text
  escalatedAt      DateTime?
  escalatedTo      String?
  escalationReason String?

  // Related alerts
  parentAlertId String? // If this is part of a pattern
  relatedAlerts Json?   // IDs of related alerts

  // Notification tracking
  notificationsSent Json? // Array of notification records

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  rule QARule? @relation(fields: [ruleId], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@index([providerId])
  @@index([ruleId])
  @@index([actionDueDate])
}

// Configurable QA rules
model QARule {
  id          String        @id @default(cuid())
  name        String
  description String        @db.Text
  category    QAAuditType
  trigger     QARuleTrigger

  // Rule configuration
  isActive    Boolean @default(true)
  priority    Int     @default(50) // 1-100, higher = more important
  severity    QAFindingSeverity @default(MEDIUM)

  // Rule logic
  conditions  Json // Array of condition objects
  thresholds  Json? // Threshold values for triggering
  checkType   String // compliance_check, threshold_check, pattern_check, etc.

  // Actions when triggered
  actions        Json   // What to do when triggered
  createsFinding Boolean @default(true)
  createsAlert   Boolean @default(false)
  alertType      ComplianceAlertType?

  // Notification settings
  notifyRoles   Json? // Roles to notify
  notifyUsers   Json? // Specific users to notify
  escalationPath Json? // Escalation configuration

  // Performance tracking
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)
  falsePositives  Int       @default(0)
  effectiveness   Float? // Success rate

  // Metadata
  source          String? // Where rule came from (built-in, custom, payer)
  payerId         String? // If payer-specific rule
  effectiveDate   DateTime? // When rule becomes active
  expirationDate  DateTime? // When rule expires
  version         Int       @default(1)
  previousVersion String?   // ID of previous version

  // Documentation
  rationale   String? @db.Text // Why this rule exists
  references  Json?   // Links to guidelines, policies
  examples    Json?   // Example findings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  triggeredAlerts ComplianceAlert[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([category])
  @@index([trigger])
  @@index([isActive])
  @@index([priority])
}

// ============================================
// EPIC 37: AI PRACTICE GROWTH AGENT
// ============================================

// Growth lead status for AI tracking
enum GrowthLeadStatus {
  NEW // Just identified
  SCORING // AI is scoring
  HOT // High conversion probability
  WARM // Medium conversion probability
  COLD // Low conversion probability
  NURTURING // In nurture sequence
  READY // Ready for staff follow-up
  CONVERTED // Became a patient
  LOST // Did not convert
}

// Growth campaign type
enum GrowthCampaignType {
  LEAD_GENERATION // New patient acquisition
  REACTIVATION // Win back lapsed patients
  REFERRAL // Referral program promotion
  REVIEW // Review/reputation management
  RETENTION // Patient retention
  UPSELL // Additional services promotion
  SEASONAL // Holiday/seasonal campaigns
  EVENT // Event-based campaigns
}

// Growth campaign status
enum GrowthCampaignStatus {
  DRAFT // Being created
  SCHEDULED // Scheduled for future
  ACTIVE // Currently running
  PAUSED // Temporarily paused
  COMPLETED // Finished running
  CANCELLED // Cancelled before completion
}

// Referral opportunity status
enum ReferralOpportunityStatus {
  IDENTIFIED // AI identified potential
  PENDING // Waiting for outreach
  CONTACTED // Outreach sent
  ENGAGED // Patient responded positively
  REFERRED // Patient made referral
  EXPIRED // Opportunity window passed
  DECLINED // Patient declined
}

// AI-managed growth lead scoring and tracking
model GrowthLead {
  id     String           @id @default(cuid())
  status GrowthLeadStatus @default(NEW)

  // Link to base Lead model (optional - can exist independently)
  leadId String?

  // Contact info (if not linked to Lead)
  firstName String?
  lastName  String?
  email     String?
  phone     String?

  // AI scoring
  qualityScore        Int       @default(0) // 0-100 quality score
  conversionProbability Decimal @db.Decimal(5, 4) // 0.0000-1.0000
  urgencyScore        Int       @default(0) // 0-100 urgency
  intentSignals       Json?     // Array of detected intent signals

  // Scoring factors
  scoreFactors Json? // { "website_visits": 20, "form_partial": 15, "email_opened": 10 }
  scoreHistory Json? // Array of score changes over time

  // Source attribution
  source         String?  // "website", "google_ads", "referral", "social"
  sourceDetail   String?  // Specific source details
  campaignId     String?  // Growth campaign that generated this lead

  // Behavioral data
  websiteVisits     Int      @default(0)
  pageViews         Int      @default(0)
  lastPageViewed    String?
  timeOnSite        Int?     // Seconds
  formAbandoned     Boolean  @default(false)
  emailsOpened      Int      @default(0)
  linksClicked      Int      @default(0)

  // Assignment and follow-up
  assignedToUserId String?
  priorityRank     Int?     // Rank among all leads
  nextActionDate   DateTime?
  nextAction       String?  // Recommended next action

  // Nurturing
  nurtureSequenceId String?
  nurtureStepNumber Int?
  nurtureStartedAt  DateTime?

  // Conversion tracking
  convertedToPatientId String?
  convertedAt          DateTime?
  conversionValue      Decimal? @db.Decimal(10, 2) // Estimated lifetime value

  // AI analysis
  lastAnalyzedAt DateTime?
  aiNotes        String?   @db.Text // AI observations and recommendations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  campaign GrowthCampaign? @relation(fields: [campaignId], references: [id])

  activities GrowthLeadActivity[]

  @@index([organizationId])
  @@index([status])
  @@index([qualityScore])
  @@index([conversionProbability])
  @@index([assignedToUserId])
  @@index([nextActionDate])
  @@index([createdAt])
}

// Activity tracking for growth leads
model GrowthLeadActivity {
  id           String   @id @default(cuid())
  activityType String   // "score_updated", "status_changed", "email_sent", "sms_sent", "call_made", "ai_analysis"
  description  String   @db.Text

  // Activity details
  metadata     Json?    // Activity-specific data
  oldValue     String?  // Previous value (for changes)
  newValue     String?  // New value (for changes)

  // Performer
  performedBy  String?  // User ID or "AI"
  isAutomated  Boolean  @default(false)

  createdAt DateTime @default(now())

  // Relations
  growthLeadId String
  growthLead   GrowthLead @relation(fields: [growthLeadId], references: [id], onDelete: Cascade)

  @@index([growthLeadId])
  @@index([activityType])
  @@index([createdAt])
}

// AI-driven growth campaigns
model GrowthCampaign {
  id           String               @id @default(cuid())
  name         String
  description  String?              @db.Text
  campaignType GrowthCampaignType
  status       GrowthCampaignStatus @default(DRAFT)

  // Schedule
  startDate DateTime?
  endDate   DateTime?

  // Targeting
  targetAudience     Json?    // Audience criteria
  targetPatientCount Int?     // Estimated target count
  actualReach        Int      @default(0)

  // Goals
  targetLeads       Int?
  targetConversions Int?
  targetRevenue     Decimal? @db.Decimal(10, 2)
  targetROI         Decimal? @db.Decimal(10, 4)

  // Budget
  budget      Decimal? @db.Decimal(10, 2)
  actualSpend Decimal? @db.Decimal(10, 2)

  // Content strategy (AI-generated)
  contentStrategy Json?    // AI-recommended content approach
  messagingTone   String?  // "professional", "friendly", "urgent"
  channels        String[] // ["email", "sms", "social"]

  // Execution
  sequences   Json?    // Array of campaign sequences/steps
  abTestConfig Json?   // A/B testing configuration

  // Results
  totalImpressions Int     @default(0)
  totalClicks      Int     @default(0)
  totalLeads       Int     @default(0)
  totalConversions Int     @default(0)
  totalRevenue     Decimal @default(0) @db.Decimal(10, 2)

  // Calculated metrics
  clickThroughRate  Decimal? @db.Decimal(5, 4)
  conversionRate    Decimal? @db.Decimal(5, 4)
  costPerLead       Decimal? @db.Decimal(10, 2)
  costPerConversion Decimal? @db.Decimal(10, 2)
  roi               Decimal? @db.Decimal(10, 4)

  // AI optimization
  optimizationScore Int?     // How well AI optimized this campaign
  aiRecommendations Json?    // AI recommendations for improvement
  lastOptimizedAt   DateTime?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  leads GrowthLead[]

  @@index([organizationId])
  @@index([status])
  @@index([campaignType])
  @@index([startDate])
}

// AI-identified referral opportunities
model ReferralOpportunity {
  id     String                    @id @default(cuid())
  status ReferralOpportunityStatus @default(IDENTIFIED)

  // Patient who could refer
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Scoring
  referralScore       Int      @default(0) // 0-100 likelihood to refer
  npsScore            Int?     // Net Promoter Score (0-10)
  satisfactionScore   Int?     // Overall satisfaction (0-100)
  loyaltyScore        Int?     // Patient loyalty score

  // Score factors
  scoreFactors Json? // { "visit_frequency": 25, "positive_reviews": 30, "tenure": 20 }

  // Patient indicators
  visitCount          Int      @default(0) // Total visits
  consecutiveVisits   Int      @default(0) // Visits without missing
  treatmentSuccess    Boolean? // Has treatment been successful
  hasLeftReview       Boolean  @default(false)
  reviewRating        Int?     // If they left a review, what was rating

  // Referral history
  previousReferrals   Int      @default(0) // Past referrals made
  lastReferralDate    DateTime?

  // Outreach
  outreachDate       DateTime?
  outreachMethod     String?   // "email", "sms", "in_person"
  outreachMessageId  String?   // Reference to message sent
  outreachResponse   String?   // Patient's response

  // Outcome
  referralMade       Boolean   @default(false)
  referralDate       DateTime?
  referredPatientId  String?   // New patient referred

  // Timing optimization
  optimalOutreachDate DateTime? // AI-calculated best time
  optimalChannel      String?   // AI-recommended channel

  // AI analysis
  aiAnalysis    String?   @db.Text // AI observations
  aiConfidence  Decimal?  @db.Decimal(5, 4) // Confidence in scoring
  lastAnalyzed  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([referralScore])
  @@index([optimalOutreachDate])
}

// Reputation monitoring and tracking
model ReputationMetric {
  id String @id @default(cuid())

  // Platform
  platform     String   // "google", "yelp", "facebook", "healthgrades"
  platformUrl  String?  // Direct link to profile

  // Metrics
  averageRating     Decimal  @db.Decimal(3, 2) // 0.00-5.00
  totalReviews      Int      @default(0)
  newReviewsCount   Int      @default(0) // Since last check
  responseRate      Decimal? @db.Decimal(5, 4) // Percentage of reviews responded to

  // Breakdown by rating
  fiveStarCount  Int @default(0)
  fourStarCount  Int @default(0)
  threeStarCount Int @default(0)
  twoStarCount   Int @default(0)
  oneStarCount   Int @default(0)

  // Sentiment analysis
  sentimentScore    Decimal? @db.Decimal(5, 4) // -1 to 1
  commonPraises     Json?    // Array of common positive themes
  commonComplaints  Json?    // Array of common negative themes
  keywordFrequency  Json?    // Most mentioned keywords

  // Competitive comparison
  competitorAverage Decimal? @db.Decimal(3, 2) // Area average
  marketRank        Int?     // Rank among local competitors

  // Alerts
  hasNewNegative    Boolean  @default(false)
  unrepliedCount    Int      @default(0)

  // Snapshot timestamp
  snapshotDate DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([platform])
  @@index([snapshotDate])
  @@index([averageRating])
}

// Patient reactivation tracking
model ReactivationOpportunity {
  id     String @id @default(cuid())
  status String @default("IDENTIFIED") // IDENTIFIED, CONTACTED, ENGAGED, REACTIVATED, DECLINED, LOST

  // Lapsed patient
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Lapse analysis
  lastVisitDate       DateTime
  daysSinceLastVisit  Int
  expectedReturnDate  DateTime? // Based on treatment plan
  daysOverdue         Int?      // Days past expected return

  // Patient value
  lifetimeValue       Decimal? @db.Decimal(10, 2)
  averageVisitValue   Decimal? @db.Decimal(10, 2)
  potentialRecovery   Decimal? @db.Decimal(10, 2) // Estimated value if reactivated

  // Lapse reason analysis
  likelyReason        String?  // AI-determined likely reason
  reasonConfidence    Decimal? @db.Decimal(5, 4)
  reasonFactors       Json?    // Factors contributing to determination

  // Reactivation strategy
  recommendedApproach String?  // "special_offer", "wellness_check", "personal_outreach"
  recommendedOffer    String?  // Specific offer recommendation
  recommendedChannel  String?  // "email", "sms", "phone"
  recommendedTiming   DateTime?

  // Outreach tracking
  outreachAttempts    Int       @default(0)
  lastOutreachDate    DateTime?
  lastOutreachMethod  String?
  responseReceived    Boolean   @default(false)
  responseDate        DateTime?
  responseContent     String?   @db.Text

  // Outcome
  reactivated         Boolean   @default(false)
  reactivationDate    DateTime?
  reactivationVisitId String?   // First appointment after reactivation

  // AI scoring
  reactivationScore   Int       @default(0) // 0-100 likelihood
  priorityRank        Int?      // Rank among reactivation opportunities

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([reactivationScore])
  @@index([lastVisitDate])
  @@index([daysSinceLastVisit])
}

// Practice growth KPIs and metrics
model GrowthMetric {
  id         String   @id @default(cuid())
  metricType String   // "new_patients", "referrals", "reactivations", "reviews", "conversion_rate"
  period     String   // "daily", "weekly", "monthly", "quarterly"
  periodStart DateTime
  periodEnd   DateTime

  // Metric values
  value      Decimal  @db.Decimal(12, 4)
  target     Decimal? @db.Decimal(12, 4)
  benchmark  Decimal? @db.Decimal(12, 4)

  // Comparison
  previousPeriodValue Decimal? @db.Decimal(12, 4)
  changePercent       Decimal? @db.Decimal(8, 4)
  trend               String?  // "improving", "stable", "declining"

  // Breakdown
  breakdown   Json?    // Detailed breakdown by source, channel, etc.

  // AI analysis
  aiInsight   String?  @db.Text // AI interpretation
  aiActions   Json?    // Recommended actions

  calculatedAt DateTime @default(now())

  createdAt DateTime @default(now())

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, metricType, period, periodStart])
  @@index([organizationId])
  @@index([metricType])
  @@index([periodStart])
}
