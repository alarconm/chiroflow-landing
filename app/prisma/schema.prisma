// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant organization (practice)
model Organization {
  id        String   @id @default(cuid())
  name      String
  subdomain String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users      User[]
  auditLogs  AuditLog[]
  patients   Patient[]
  households Household[]

  // Scheduling relations
  providers        Provider[]
  appointmentTypes AppointmentType[]
  rooms            Room[]
  resources        Resource[]
  appointments     Appointment[]
  recurringSeries  RecurringSeries[]
  scheduleBlocks   ScheduleBlock[]
  waitlistEntries  WaitlistEntry[]

  // Intake form relations
  formTemplates   FormTemplate[]
  formSubmissions FormSubmission[]
  formDeliveries  FormDelivery[]

  // Clinical/EHR relations
  encounters          Encounter[]
  treatmentPlans      TreatmentPlan[]
  noteTemplates       NoteTemplate[]
  assessmentTemplates AssessmentTemplate[]
  outcomeAssessments  OutcomeAssessment[]
  codeFavorites       CodeFavorite[]

  // Billing relations
  feeSchedules        FeeSchedule[]
  charges             Charge[]
  payments            Payment[]
  claims              Claim[]

  // Communication relations
  messageTemplates    MessageTemplate[]
  messages            Message[]
  messageThreads      MessageThread[]
  reminderRules       ReminderRule[]

  // Payment Processing relations (Epic 10)
  paymentProcessors    PaymentProcessor[]
  storedPaymentMethods StoredPaymentMethod[]
  paymentTransactions  PaymentTransaction[]
  paymentPlans         PaymentPlan[]
  patientStatements    PatientStatement[]
  autoPayEnrollments   AutoPayEnrollment[]
  refunds              Refund[]

  // Reporting & Analytics relations (Epic 15)
  dashboardWidgets    DashboardWidget[]
  savedReports        SavedReport[]
  reportSchedules     ReportSchedule[]
  kpiSnapshots        KPISnapshot[]
  reportExports       ReportExport[]

  // AI Scheduling relations (Epic 13)
  overbookingRecommendations OverbookingRecommendation[]
  schedulingGaps             SchedulingGap[]
  providerUtilizations       ProviderUtilization[]
  schedulingSuggestions      SchedulingSuggestion[]
  recallSequences            RecallSequence[]

  // AI Communication relations (Epic 12)
  chatSessions               ChatSession[]
  aiConversationContexts     AIConversationContext[]
  recallCampaigns            RecallCampaign[]
  reactivationCampaigns      ReactivationCampaign[]
  patientFeedback            PatientFeedback[]

  // Clearinghouse relations (Epic 08)
  clearinghouseConfigs  ClearinghouseConfig[]
  claimSubmissions      ClaimSubmission[]
  eligibilityChecks     EligibilityCheck[]
  claimStatusChecks     ClaimStatusCheck[]
  remittances           Remittance[]
  denials               Denial[]

  // AI Billing relations (Epic 09)
  claimScrubResults         ClaimScrubResult[]
  denialPredictions         DenialPrediction[]
  appealLetters             AppealLetter[]
  paymentMatchSuggestions   PaymentMatchSuggestion[]
  underpaymentDetections    UnderpaymentDetection[]
  aiBillingJobs             AIBillingJob[]
  aiBillingAudits           AIBillingAudit[]

  // Patient Portal relations (Epic 14)
  portalUsers           PortalUser[]
  portalAccessLogs      PortalAccessLog[]
  secureMessages        SecureMessage[]
  portalDocuments       PortalDocument[]
  appointmentRequests   AppointmentRequest[]

  // Inventory & POS relations (Epic 17)
  productCategories     ProductCategory[]
  products              Product[]
  inventoryItems        InventoryItem[]
  inventoryMovements    InventoryMovement[]
  vendors               Vendor[]
  purchaseOrders        PurchaseOrder[]
  sales                 Sale[]
  lowStockAlerts        LowStockAlert[]

  // AI Insights Agent relations (Epic 16)
  aiInsights            AIInsight[]
  churnPredictions      ChurnPrediction[]
  revenueOpportunities  RevenueOpportunity[]
  nlQueryHistory        NLQueryHistory[]

  // Marketing & Referrals relations (Epic 18)
  referralPrograms      ReferralProgram[]
  referrals             Referral[]
  leads                 Lead[]
  nurtureSequences      NurtureSequence[]
  reviewRequests        ReviewRequest[]
  campaigns             Campaign[]
  landingPages          LandingPage[]
  marketingConsents     MarketingConsent[]

  @@index([subdomain])
}

// User roles for RBAC
enum Role {
  OWNER // Full access, can delete organization
  ADMIN // Full access except organization deletion
  PROVIDER // Clinical access, can see all patients
  STAFF // Front desk, limited patient access
  BILLER // Billing and claims access only
}

// User account
model User {
  id           String    @id @default(cuid())
  email        String
  passwordHash String
  firstName    String
  lastName     String
  role         Role      @default(STAFF)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  auditLogs AuditLog[]
  provider  Provider? // If user is a clinical provider

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([email])
}

// Audit log for HIPAA compliance
model AuditLog {
  id         String   @id @default(cuid())
  action     String // CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT, etc.
  entityType String // User, Patient, Appointment, etc.
  entityId   String? // ID of the affected entity
  changes    Json? // Before/after state for mutations
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  userId         String?
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================
// EPIC 02: PATIENT MANAGEMENT
// ============================================

// Patient status
enum PatientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
  DECEASED
}

// Gender options
enum Gender {
  MALE
  FEMALE
  NON_BINARY
  OTHER
  PREFER_NOT_TO_SAY
}

// Contact preference
enum ContactPreference {
  EMAIL
  PHONE
  SMS
  MAIL
}

// Insurance type
enum InsuranceType {
  PRIMARY
  SECONDARY
  TERTIARY
}

// Subscriber relationship to patient
enum SubscriberRelationship {
  SELF
  SPOUSE
  CHILD
  OTHER
}

// Family relationship type
enum FamilyRelationship {
  SPOUSE
  PARENT
  CHILD
  SIBLING
  GUARDIAN
  OTHER
}

// Document type
enum DocumentType {
  INSURANCE_CARD_FRONT
  INSURANCE_CARD_BACK
  PHOTO_ID
  CONSENT_FORM
  INTAKE_FORM
  CLINICAL_NOTE
  LAB_RESULT
  IMAGING
  REFERRAL
  OTHER
}

// Core Patient model
model Patient {
  id         String        @id @default(cuid())
  mrn        String // Medical Record Number (org-unique)
  status     PatientStatus @default(ACTIVE)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  archivedAt DateTime?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  demographics      PatientDemographics?
  contacts          PatientContact[]
  emergencyContacts EmergencyContact[]
  insurances        PatientInsurance[]
  documents         PatientDocument[]
  householdMembers  HouseholdMember[]
  mergeHistory      PatientMerge[]       @relation("MergedIntoPatient")
  mergedFrom        PatientMerge[]       @relation("SourcePatient")

  // Scheduling relations
  appointments    Appointment[]
  waitlistEntries WaitlistEntry[]

  // Intake form relations
  formSubmissions FormSubmission[]
  formDeliveries  FormDelivery[]

  // Clinical/EHR relations
  encounters         Encounter[]
  treatmentPlans     TreatmentPlan[]
  outcomeAssessments OutcomeAssessment[]

  // Billing relations
  charges            Charge[]
  payments           Payment[]
  claims             Claim[]

  // Communication relations
  messages               Message[]
  messageThreads         MessageThread[]
  communicationPreference CommunicationPreference?

  // Payment Processing relations (Epic 10)
  storedPaymentMethods   StoredPaymentMethod[]
  paymentTransactions    PaymentTransaction[]
  paymentPlans           PaymentPlan[]
  patientStatements      PatientStatement[]
  autoPayEnrollments     AutoPayEnrollment[]
  refunds                Refund[]

  // AI Scheduling relations (Epic 13)
  schedulingSuggestions  SchedulingSuggestion[]
  recallEnrollments      RecallEnrollment[]

  // AI Communication relations (Epic 12)
  chatSessions               ChatSession[]
  aiConversationContext      AIConversationContext?
  recallCampaignPatients     RecallCampaignPatient[]
  reactivationCampaignPatients ReactivationCampaignPatient[]
  patientFeedback            PatientFeedback[]

  // Clearinghouse relations (Epic 08)
  eligibilityChecks      EligibilityCheck[]
  denials                Denial[]

  // AI Billing relations (Epic 09)
  paymentMatchSuggestions PaymentMatchSuggestion[]

  // Patient Portal relations (Epic 14)
  portalUser             PortalUser?
  secureMessages         SecureMessage[]
  portalDocuments        PortalDocument[]
  appointmentRequests    AppointmentRequest[]

  // AI Insights relations (Epic 16)
  churnPrediction        ChurnPrediction?

  // Marketing & Referrals relations (Epic 18)
  referralsMade          Referral[] @relation("ReferrerPatient")
  referralsReceived      Referral[] @relation("RefereePatient")
  leadsConverted         Lead[] @relation("LeadConversion")
  reviewRequests         ReviewRequest[]
  marketingConsents      MarketingConsent[]

  @@unique([mrn, organizationId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// Patient demographics (1:1 with Patient)
model PatientDemographics {
  id            String   @id @default(cuid())
  firstName     String
  middleName    String?
  lastName      String
  preferredName String?
  dateOfBirth   DateTime
  gender        Gender   @default(PREFER_NOT_TO_SAY)
  pronouns      String?
  ssn           String? // Encrypted, store last 4 for display
  ssnLast4      String? // Last 4 digits for display
  language      String   @default("en")
  ethnicity     String?
  race          String?
  maritalStatus String?
  occupation    String?
  employer      String?
  notes         String? // Internal notes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Search indexes for phonetic matching
  firstNameSoundex String? // Soundex code for first name
  lastNameSoundex  String? // Soundex code for last name

  @@index([firstName, lastName])
  @@index([dateOfBirth])
  @@index([firstNameSoundex])
  @@index([lastNameSoundex])
}

// Patient contact information (1:many - can have multiple addresses/phones)
model PatientContact {
  id                String            @id @default(cuid())
  isPrimary         Boolean           @default(false)
  contactPreference ContactPreference @default(PHONE)

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String  @default("US")

  // Phone
  homePhone   String?
  mobilePhone String?
  workPhone   String?

  // Email
  email String?

  // Opt-in preferences
  allowSms       Boolean @default(true)
  allowEmail     Boolean @default(true)
  allowVoicemail Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([email])
  @@index([mobilePhone])
}

// Emergency contacts
model EmergencyContact {
  id           String   @id @default(cuid())
  name         String
  relationship String
  phone        String
  altPhone     String?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

// Patient insurance information
model PatientInsurance {
  id       String        @id @default(cuid())
  type     InsuranceType @default(PRIMARY)
  isActive Boolean       @default(true)

  // Insurance company info
  payerName String
  payerId   String? // Payer ID for EDI
  planName  String?
  planType  String? // PPO, HMO, EPO, etc.

  // Policy details
  policyNumber String
  groupNumber  String?

  // Subscriber info (may be different from patient)
  subscriberRelationship SubscriberRelationship @default(SELF)
  subscriberId           String?
  subscriberFirstName    String?
  subscriberLastName     String?
  subscriberDob          DateTime?

  // Coverage dates
  effectiveDate   DateTime?
  terminationDate DateTime?

  // Benefits
  copay          Decimal? @db.Decimal(10, 2)
  deductible     Decimal? @db.Decimal(10, 2)
  deductibleMet  Decimal? @db.Decimal(10, 2)
  outOfPocketMax Decimal? @db.Decimal(10, 2)
  outOfPocketMet Decimal? @db.Decimal(10, 2)

  // Verification
  verifiedAt        DateTime?
  verifiedBy        String?
  verificationNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Link to InsurancePayer if in system
  insurancePayerId String?
  insurancePayer   InsurancePayer? @relation(fields: [insurancePayerId], references: [id])

  // Billing relations
  claims    Claim[]

  // Clearinghouse relations (Epic 08)
  eligibilityChecks EligibilityCheck[]

  @@index([patientId])
  @@index([type])
  @@index([payerName])
  @@index([insurancePayerId])
}

// Patient documents
model PatientDocument {
  id          String       @id @default(cuid())
  type        DocumentType
  fileName    String
  fileSize    Int // Size in bytes
  mimeType    String
  storageKey  String // S3 key or local path
  description String?

  // Upload info
  uploadedById String
  uploadedAt   DateTime @default(now())

  // Access control
  isConfidential Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([type])
  @@index([uploadedAt])
}

// Household for family linking
model Household {
  id        String   @id @default(cuid())
  name      String? // Optional household name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  members HouseholdMember[]

  @@index([organizationId])
}

// Household membership (links patients to households)
model HouseholdMember {
  id            String             @id @default(cuid())
  relationship  FamilyRelationship
  isHeadOfHouse Boolean            @default(false)
  isGuarantor   Boolean            @default(false) // Responsible for billing
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  // Relations
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  householdId String
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([patientId, householdId])
  @@index([householdId])
  @@index([patientId])
}

// Patient merge tracking
model PatientMerge {
  id             String   @id @default(cuid())
  mergedAt       DateTime @default(now())
  mergedBy       String // User ID who performed merge
  reason         String? // Why merge was performed
  sourceSnapshot Json // Snapshot of source patient before merge
  fieldsKept     Json // Which fields were kept from source

  // Relations
  sourcePatientId String
  sourcePatient   Patient @relation("SourcePatient", fields: [sourcePatientId], references: [id])
  targetPatientId String
  targetPatient   Patient @relation("MergedIntoPatient", fields: [targetPatientId], references: [id])

  @@index([sourcePatientId])
  @@index([targetPatientId])
  @@index([mergedAt])
}

// ============================================
// EPIC 03: SCHEDULING ENGINE
// ============================================

// Appointment status workflow
enum AppointmentStatus {
  SCHEDULED // Booked but not confirmed
  CONFIRMED // Patient confirmed attendance
  CHECKED_IN // Patient arrived
  IN_PROGRESS // Currently being seen
  COMPLETED // Visit finished
  CANCELLED // Cancelled by patient or staff
  NO_SHOW // Patient didn't arrive
  RESCHEDULED // Moved to different time
}

// Recurring frequency
enum RecurringFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

// Schedule block types (non-patient time)
enum BlockType {
  LUNCH
  MEETING
  ADMIN
  PERSONAL
  BREAK
  TRAINING
  OTHER
}

// Waitlist priority
enum WaitlistPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Day of week for recurring schedules
enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

// Provider profile (extends User for clinical staff)
model Provider {
  id            String   @id @default(cuid())
  title         String? // Dr., DC, etc.
  specialty     String? // Chiropractic, PT, etc.
  npiNumber     String? // National Provider Identifier
  licenseNumber String?
  color         String   @default("#3B82F6") // Calendar color
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  bio           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Link to user account
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  schedules           ProviderSchedule[]
  exceptions          ProviderException[]
  appointments        Appointment[]
  scheduleBlocks      ScheduleBlock[]
  waitlistPreferences WaitlistEntry[]

  // Clinical/EHR relations
  encounters     Encounter[]
  treatmentPlans TreatmentPlan[]

  // Billing relations
  charges        Charge[]

  // AI Scheduling relations (Epic 13)
  overbookingRecommendations OverbookingRecommendation[]
  schedulingGaps             SchedulingGap[]
  utilizations               ProviderUtilization[]
  schedulingSuggestions      SchedulingSuggestion[]

  @@index([organizationId])
  @@index([isActive])
}

// Provider weekly recurring schedule
model ProviderSchedule {
  id        String    @id @default(cuid())
  dayOfWeek DayOfWeek
  startTime String // "09:00" format (24hr)
  endTime   String // "17:00" format (24hr)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([dayOfWeek])
}

// Provider one-off schedule exceptions
model ProviderException {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  isAvailable Boolean  @default(false) // false = off, true = custom hours
  startTime   String? // Override start time if available
  endTime     String? // Override end time if available
  reason      String? // Vacation, sick, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, date])
  @@index([date])
}

// Appointment types (New Patient, Follow-up, etc.)
model AppointmentType {
  id           String   @id @default(cuid())
  name         String // "New Patient Exam"
  code         String? // Short code "NPE"
  description  String?
  duration     Int // Duration in minutes
  color        String   @default("#10B981") // Display color
  requiresRoom Boolean  @default(true)
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  defaultPrice Decimal? @db.Decimal(10, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  appointments    Appointment[]
  waitlistEntries WaitlistEntry[]

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([isActive])
}

// Treatment rooms
model Room {
  id          String   @id @default(cuid())
  name        String // "Room 1", "Adjustment Bay A"
  description String?
  capacity    Int      @default(1)
  equipment   String[] // List of equipment in room
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  color       String   @default("#6366F1")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  appointments Appointment[]

  @@index([organizationId])
  @@index([isActive])
}

// Shared resources (equipment that needs scheduling)
model Resource {
  id          String   @id @default(cuid())
  name        String // "X-Ray Machine", "TENS Unit"
  type        String? // Category
  description String?
  quantity    Int      @default(1) // How many available
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  appointments AppointmentResource[]

  @@index([organizationId])
  @@index([isActive])
}

// Recurring appointment series
model RecurringSeries {
  id             String             @id @default(cuid())
  frequency      RecurringFrequency
  endDate        DateTime? // Series end date
  maxOccurrences Int? // Or max number of appointments
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  appointments Appointment[]

  @@index([organizationId])
}

// Core Appointment model
model Appointment {
  id             String            @id @default(cuid())
  startTime      DateTime
  endTime        DateTime
  status         AppointmentStatus @default(SCHEDULED)
  notes          String? // Staff notes
  patientNotes   String? // Patient-provided notes
  chiefComplaint String? // Reason for visit

  // Confirmation tracking
  confirmedAt DateTime?
  confirmedBy String? // User ID or "PATIENT"

  // Check-in tracking
  checkedInAt DateTime?
  checkedInBy String?

  // Completion tracking
  completedAt DateTime?
  completedBy String?

  // Cancellation tracking
  cancelledAt  DateTime?
  cancelledBy  String?
  cancelReason String?

  // Billing reference
  chargeAmount Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  appointmentTypeId String
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [id])

  roomId String?
  room   Room?   @relation(fields: [roomId], references: [id])

  recurringSeriesId String?
  recurringSeries   RecurringSeries? @relation(fields: [recurringSeriesId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  resources AppointmentResource[]

  // Clinical/EHR relation
  encounter Encounter?

  // Communication relations
  messages  Message[]

  // AI Scheduling relations (Epic 13)
  noShowPrediction NoShowPrediction?

  @@index([organizationId])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
  @@index([patientId])
  @@index([providerId])
  @@index([roomId])
  @@index([appointmentTypeId])
  @@index([recurringSeriesId])
  // Composite index for calendar queries
  @@index([organizationId, startTime, endTime])
  @@index([providerId, startTime, endTime])
}

// Join table for appointment resources
model AppointmentResource {
  id        String   @id @default(cuid())
  quantity  Int      @default(1)
  createdAt DateTime @default(now())

  // Relations
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, resourceId])
  @@index([resourceId])
}

// Schedule blocks (non-patient time)
model ScheduleBlock {
  id             String    @id @default(cuid())
  title          String // "Lunch", "Staff Meeting"
  blockType      BlockType
  startTime      DateTime
  endTime        DateTime
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // iCal RRULE format for complex recurrence
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Provider-specific or org-wide
  providerId String?
  provider   Provider? @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([startTime])
  @@index([endTime])
}

// Waitlist for patients wanting appointments
model WaitlistEntry {
  id       String           @id @default(cuid())
  priority WaitlistPriority @default(NORMAL)
  notes    String?

  // Time preferences
  preferredDays      DayOfWeek[] // Preferred days of week
  preferredTimeStart String? // Earliest acceptable time "09:00"
  preferredTimeEnd   String? // Latest acceptable time "17:00"

  // Status
  isActive    Boolean   @default(true)
  expiresAt   DateTime? // Auto-expire date
  scheduledAt DateTime? // When they were scheduled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  appointmentTypeId String
  appointmentType   AppointmentType @relation(fields: [appointmentTypeId], references: [id])

  preferredProviderId String?
  preferredProvider   Provider? @relation(fields: [preferredProviderId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
  @@index([patientId])
  @@index([createdAt])
}

// ============================================
// EPIC 05: EHR & SOAP NOTES
// ============================================

// Encounter status workflow
enum EncounterStatus {
  SCHEDULED // Linked to appointment, not started
  IN_PROGRESS // Provider is charting
  COMPLETED // Chart complete, not signed
  SIGNED // Signed and locked
  AMENDED // Has addendums
}

// Encounter type
enum EncounterType {
  INITIAL_EVAL // First visit
  FOLLOW_UP // Regular visit
  RE_EVALUATION // Progress assessment
  DISCHARGE // Final visit
  MAINTENANCE // Wellness/maintenance
  ACUTE // Acute injury visit
  WORKERS_COMP // WC case
  PERSONAL_INJURY // PI case
}

// Diagnosis status
enum DiagnosisStatus {
  ACTIVE
  RESOLVED
  CHRONIC
  RECURRENT
}

// Treatment plan status
enum TreatmentPlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  DISCONTINUED
  EXPIRED
}

// Goal status
enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  PARTIALLY_ACHIEVED
  NOT_ACHIEVED
}

// Assessment type for outcome measures
enum AssessmentType {
  ODI // Oswestry Disability Index
  NDI // Neck Disability Index
  VAS_PAIN // Visual Analog Scale
  NPRS // Numeric Pain Rating Scale
  FABQ // Fear-Avoidance Beliefs
  DASH // Disabilities of Arm Shoulder Hand
  SF36 // Short Form 36
  CUSTOM // Custom questionnaire
}

// Clinical encounter (visit documentation container)
model Encounter {
  id             String          @id @default(cuid())
  encounterDate  DateTime        @default(now())
  status         EncounterStatus @default(IN_PROGRESS)
  encounterType  EncounterType   @default(FOLLOW_UP)
  chiefComplaint String?
  location       String? // Location of service

  // Timestamps
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  signedAt    DateTime?
  signedBy    String? // Provider user ID who signed

  // Visit metrics
  visitNumber Int? // Visit # in treatment plan

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  appointmentId String?      @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  treatmentPlanId String?
  treatmentPlan   TreatmentPlan? @relation(fields: [treatmentPlanId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  soapNote     SOAPNote?
  diagnoses    Diagnosis[]
  procedures   Procedure[]
  assessments  OutcomeAssessment[]
  bodyDiagrams BodyDiagram[]
  addendums    NoteAddendum[]

  // Billing relations
  charges      Charge[]
  claims       Claim[]

  @@index([organizationId])
  @@index([patientId])
  @@index([providerId])
  @@index([encounterDate])
  @@index([status])
  @@index([appointmentId])
  @@index([treatmentPlanId])
}

// SOAP Note (1:1 with Encounter)
model SOAPNote {
  id         String  @id @default(cuid())
  subjective String? @db.Text // S - Patient's complaints
  objective  String? @db.Text // O - Provider's findings
  assessment String? @db.Text // A - Provider's assessment
  plan       String? @db.Text // P - Treatment plan

  // Structured content (optional JSON for template-based entry)
  subjectiveJson Json?
  objectiveJson  Json?
  assessmentJson Json?
  planJson       Json?

  // Template used
  templateId String?
  template   NoteTemplate? @relation(fields: [templateId], references: [id])

  // Version tracking
  version  Int       @default(1)
  isLocked Boolean   @default(false)
  lockedAt DateTime?
  lockedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String    @unique
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([templateId])
}

// Addendum for locked notes
model NoteAddendum {
  id      String  @id @default(cuid())
  content String  @db.Text
  reason  String? // Why addendum was needed

  // Who added it
  addedBy   String
  addedAt   DateTime  @default(now())
  signedAt  DateTime?
  signature String? // Base64 or reference

  createdAt DateTime @default(now())

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([addedAt])
}

// Note template for SOAP notes
model NoteTemplate {
  id          String        @id @default(cuid())
  name        String // "Initial Evaluation", "Follow-up"
  description String?
  category    EncounterType // Which type of visit this is for

  // Template content (JSON structure)
  subjectiveTemplate Json? // Default S content
  objectiveTemplate  Json? // Default O content
  assessmentTemplate Json? // Default A content
  planTemplate       Json? // Default P content

  // Template macros/variables
  variables Json? // Available variables like {{patient.name}}

  isActive  Boolean @default(true)
  isSystem  Boolean @default(false) // System templates can't be deleted
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation (null = system template)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  soapNotes SOAPNote[]

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

// Diagnosis (ICD-10) on encounter
model Diagnosis {
  id          String          @id @default(cuid())
  icd10Code   String // ICD-10 code
  description String // Diagnosis description
  isPrimary   Boolean         @default(false)
  status      DiagnosisStatus @default(ACTIVE)

  // Clinical info
  onsetDate    DateTime?
  resolvedDate DateTime?
  notes        String?
  bodySite     String? // Left knee, cervical spine, etc.
  laterality   String? // Left, Right, Bilateral

  // Sequencing for claims
  sequence Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([icd10Code])
  @@index([status])
}

// Procedure (CPT) on encounter
model Procedure {
  id          String  @id @default(cuid())
  cptCode     String // CPT code
  description String // Procedure description
  units       Int     @default(1)
  modifier1   String? // Modifier 1 (e.g., 59, 25)
  modifier2   String?
  modifier3   String?
  modifier4   String?
  notes       String?

  // Pricing
  chargeAmount  Decimal? @db.Decimal(10, 2)
  allowedAmount Decimal? @db.Decimal(10, 2)

  // Rendering provider if different
  renderingProviderId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  // Linked diagnoses for this procedure (diagnosis pointers)
  diagnosisPointers Json? // Array of diagnosis sequence numbers

  @@index([encounterId])
  @@index([cptCode])
}

// Treatment plan (spans multiple visits)
model TreatmentPlan {
  id          String              @id @default(cuid())
  name        String // "Lumbar Rehabilitation Program"
  description String?
  status      TreatmentPlanStatus @default(DRAFT)

  // Duration
  startDate       DateTime  @default(now())
  endDate         DateTime?
  plannedVisits   Int? // Total visits planned
  completedVisits Int       @default(0)
  frequency       String? // "2x/week", "3x/week for 4 weeks"
  duration        String? // "6 weeks"

  // Clinical goals (summary)
  shortTermGoals String? @db.Text
  longTermGoals  String? @db.Text

  // Approval tracking
  approvedAt DateTime?
  approvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  providerId String
  provider   Provider @relation(fields: [providerId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  goals      TreatmentGoal[]
  encounters Encounter[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([startDate])
}

// Individual goals within treatment plan
model TreatmentGoal {
  id          String     @id @default(cuid())
  description String
  targetDate  DateTime?
  status      GoalStatus @default(NOT_STARTED)

  // Measurable criteria
  metric        String? // "Pain level", "Range of motion"
  baselineValue String? // Starting value
  targetValue   String? // Goal value
  currentValue  String? // Current progress
  unit          String? // "degrees", "1-10 scale"

  // Progress notes
  notes    String? @db.Text
  progress Int     @default(0) // 0-100 percentage

  achievedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  treatmentPlanId String
  treatmentPlan   TreatmentPlan @relation(fields: [treatmentPlanId], references: [id], onDelete: Cascade)

  @@index([treatmentPlanId])
  @@index([status])
}

// Outcome assessment (standardized questionnaires)
model OutcomeAssessment {
  id             String         @id @default(cuid())
  assessmentType AssessmentType
  templateId     String? // Custom assessment template

  // Scoring
  rawScore       Decimal? @db.Decimal(10, 2)
  percentScore   Decimal? @db.Decimal(5, 2) // 0-100
  maxPossible    Decimal? @db.Decimal(10, 2)
  interpretation String? // "Minimal disability", "Moderate"

  // Raw answers
  answers Json? // Array of { questionId, answer, score }

  // Comparison
  previousScore Decimal? @db.Decimal(10, 2)
  changeScore   Decimal? @db.Decimal(10, 2)
  changePercent Decimal? @db.Decimal(5, 2)

  administeredAt DateTime  @default(now())
  completedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encounterId])
  @@index([patientId])
  @@index([assessmentType])
  @@index([administeredAt])
}

// Assessment template for custom questionnaires
model AssessmentTemplate {
  id             String         @id @default(cuid())
  name           String // "Modified Oswestry"
  assessmentType AssessmentType @default(CUSTOM)
  description    String?

  // Questions structure
  questions Json // Array of { id, text, type, options, scoring }

  // Scoring configuration
  scoringMethod  String? // "sum", "average", "weighted"
  maxScore       Decimal? @db.Decimal(10, 2)
  interpretation Json? // Ranges and their meanings

  isActive Boolean @default(true)
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relation (null = system template)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([assessmentType])
  @@index([isActive])
}

// Body diagram markings
model BodyDiagram {
  id          String @id @default(cuid())
  diagramType String // "body_front", "body_back", "spine", "cervical"

  // Markings data
  markings Json // Array of { x, y, type, label, color }

  // Types: pain, tenderness, subluxation, adjustment, inflammation
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@index([diagramType])
}

// ICD-10 Code lookup table (reference data)
model ICD10Code {
  id          String  @id @default(cuid())
  code        String  @unique
  description String
  category    String? // M54.5 -> M54
  chapter     String? // Musculoskeletal

  // Common in chiropractic
  isChiroCommon Boolean @default(false)

  // Searchable
  searchTerms String[] // Additional search terms

  @@index([code])
  @@index([description])
  @@index([isChiroCommon])
}

// CPT Code lookup table (reference data)
model CPTCode {
  id          String  @id @default(cuid())
  code        String  @unique
  description String
  shortDesc   String? // Short description
  category    String? // E/M, Chiro Manipulation, etc.

  // Time units
  timeMinutes Int?

  // Common in chiropractic
  isChiroCommon Boolean @default(false)

  // Relative value units (for pricing)
  rvuWork        Decimal? @db.Decimal(10, 4)
  rvuPractice    Decimal? @db.Decimal(10, 4)
  rvuMalpractice Decimal? @db.Decimal(10, 4)

  @@index([code])
  @@index([description])
  @@index([isChiroCommon])
}

// Organization code favorites
model CodeFavorite {
  id          String @id @default(cuid())
  codeType    String // "icd10" or "cpt"
  code        String
  description String
  sortOrder   Int    @default(0)

  createdAt DateTime @default(now())

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, codeType, code])
  @@index([organizationId])
  @@index([codeType])
}

// ============================================
// EPIC 04: DIGITAL INTAKE SYSTEM
// ============================================

// Form field types
enum FormFieldType {
  TEXT
  TEXTAREA
  SELECT
  RADIO
  CHECKBOX
  CHECKBOX_GROUP
  DATE
  TIME
  DATETIME
  PHONE
  EMAIL
  SSN
  NUMBER
  CURRENCY
  SIGNATURE
  FILE
  HEADING
  PARAGRAPH
  DIVIDER
}

// Form submission status
enum FormSubmissionStatus {
  DRAFT // Started but not submitted
  PENDING // Submitted, awaiting review
  COMPLETED // Reviewed and accepted
  REJECTED // Rejected, needs resubmission
  EXPIRED // Form link expired
}

// Form delivery method
enum FormDeliveryMethod {
  EMAIL
  SMS
  KIOSK
  PORTAL
  IN_PERSON
}

// Form template (reusable form structure)
model FormTemplate {
  id          String  @id @default(cuid())
  name        String // "New Patient Health History"
  description String?
  version     Int     @default(1)
  isActive    Boolean @default(true)
  isSystem    Boolean @default(false) // System templates can't be deleted
  isDraft     Boolean @default(true) // Draft until published

  // Auto-population config
  patientMapping Json? // Map fields to patient demographics

  // Expiration settings
  expiresInDays Int? // Form expires N days after sent

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  sections    FormSection[]
  fields      FormField[]
  submissions FormSubmission[]
  deliveries  FormDelivery[]

  @@index([organizationId])
  @@index([isActive])
  @@index([isSystem])
}

// Form section (grouping of fields)
model FormSection {
  id            String  @id @default(cuid())
  title         String // "Personal Information"
  description   String?
  order         Int     @default(0)
  isCollapsible Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  fields FormField[]

  @@index([templateId])
  @@index([order])
}

// Form field definition
model FormField {
  id          String        @id @default(cuid())
  fieldType   FormFieldType
  label       String // Display label
  name        String // Field name for data storage
  placeholder String?
  helpText    String?
  order       Int           @default(0)

  // Validation
  isRequired     Boolean  @default(false)
  minLength      Int?
  maxLength      Int?
  minValue       Decimal? @db.Decimal(10, 2)
  maxValue       Decimal? @db.Decimal(10, 2)
  pattern        String? // Regex pattern
  patternMessage String? // Custom error message

  // Select/Radio/Checkbox options
  options Json? // Array of { value, label }

  // Conditional display
  conditionalOn    String? // Field name to check
  conditionalValue String? // Value that must match
  conditionalOp    String? // equals, not_equals, contains, etc.

  // Patient mapping
  mapsToPatient String? // Demographics field this maps to

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  sectionId String?
  section   FormSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  responses FormResponse[]

  @@index([templateId])
  @@index([sectionId])
  @@index([order])
}

// Form submission (patient's filled form)
model FormSubmission {
  id          String               @id @default(cuid())
  status      FormSubmissionStatus @default(PENDING)
  accessToken String               @unique @default(cuid()) // Unique URL token

  // Submission source
  source    FormDeliveryMethod @default(PORTAL)
  ipAddress String?
  userAgent String?

  // Timestamps
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String? // User ID

  // Review notes
  staffNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id])

  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  // Form delivery that triggered this submission
  deliveryId String?
  delivery   FormDelivery? @relation(fields: [deliveryId], references: [id])

  // Linked appointment (if form was for specific visit)
  appointmentId String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  responses  FormResponse[]
  signatures ESignature[]

  @@index([organizationId])
  @@index([templateId])
  @@index([patientId])
  @@index([status])
  @@index([accessToken])
  @@index([submittedAt])
}

// Individual field response
model FormResponse {
  id        String  @id @default(cuid())
  value     String? // String representation of value
  valueJson Json? // Complex values (file metadata, arrays)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  fieldId String
  field   FormField @relation(fields: [fieldId], references: [id])

  @@unique([submissionId, fieldId])
  @@index([fieldId])
}

// Electronic signature
model ESignature {
  id            String   @id @default(cuid())
  signatureData String   @db.Text // Base64 encoded image
  signedAt      DateTime @default(now())

  // Legal compliance
  ipAddress   String?
  userAgent   String?
  consentText String? // Text shown before signing

  // Signer info (may differ from patient for guardians)
  signerName   String?
  signerEmail  String?
  relationship String? // "Self", "Parent", "Guardian"

  createdAt DateTime @default(now())

  // Relations
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([signedAt])
}

// Form delivery tracking
model FormDelivery {
  id     String             @id @default(cuid())
  method FormDeliveryMethod

  // Delivery details
  sentTo       String? // Email or phone number
  scheduledFor DateTime? // If scheduled for future
  sentAt       DateTime?
  openedAt     DateTime?
  completedAt  DateTime?

  // Status tracking
  sendStatus String? // pending, sent, failed, bounced
  sendError  String? // Error message if failed

  // Reminder tracking
  reminderSentAt DateTime?
  reminderCount  Int       @default(0)
  maxReminders   Int       @default(2)
  nextReminderAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Resulting submissions
  submissions FormSubmission[]

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([templateId])
  @@index([patientId])
  @@index([sentAt])
  @@index([completedAt])
}

// ============================================
// BILLING & CLAIMS MODELS
// ============================================

// Charge status enum
enum ChargeStatus {
  PENDING     // Not yet billed
  BILLED      // Included on a claim
  PAID        // Payment received
  ADJUSTED    // Written off or adjusted
  VOID        // Voided/cancelled
}

// Payment method enum
enum PaymentMethod {
  CASH
  CHECK
  CREDIT_CARD
  DEBIT_CARD
  ACH
  INSURANCE
  OTHER
}

// Claim status enum
enum ClaimStatus {
  DRAFT       // Being created
  READY       // Ready for submission
  SUBMITTED   // Sent to payer
  ACCEPTED    // Acknowledged by payer
  REJECTED    // Rejected by payer (fixable)
  PAID        // Payment received
  DENIED      // Denied by payer
  APPEALED    // Appeal submitted
  VOID        // Cancelled
}

// Place of service codes (common ones for chiropractic)
enum PlaceOfService {
  OFFICE          // 11
  HOME            // 12
  TELEHEALTH      // 02
  URGENT_CARE     // 20
  INPATIENT       // 21
  OUTPATIENT      // 22
  EMERGENCY       // 23
  OTHER           // 99
}

// Insurance Payer (the insurance companies)
model InsurancePayer {
  id               String  @id @default(cuid())
  name             String  // Aetna, Blue Cross, etc.
  payerId          String? @unique // Payer ID for EDI (e.g., 60054)
  electronicPayerId String? // Electronic payer ID if different

  // Contact info
  address1         String?
  address2         String?
  city             String?
  state            String?
  zip              String?
  phone            String?
  fax              String?
  website          String?

  // Submission settings
  claimSubmissionMethod String @default("electronic") // electronic, paper, portal
  acceptsEdi       Boolean @default(true)
  timelyFilingDays Int     @default(90) // Days to submit claim

  // Notes
  notes            String?

  isActive         Boolean @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  patientInsurances PatientInsurance[]
  claims           Claim[]

  @@index([name])
  @@index([payerId])
}

// Fee Schedule (defines prices for CPT codes)
model FeeSchedule {
  id            String   @id @default(cuid())
  name          String   // "Standard", "Cash Pay", "Medicare"
  description   String?
  isDefault     Boolean  @default(false)
  effectiveDate DateTime @default(now())
  endDate       DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  items         FeeScheduleItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isDefault])
}

// Fee Schedule Item (individual CPT code pricing)
model FeeScheduleItem {
  id            String  @id @default(cuid())
  cptCode       String
  description   String? // Override description
  fee           Decimal @db.Decimal(10, 2) // Billed amount
  allowedAmount Decimal? @db.Decimal(10, 2) // Expected reimbursement

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  feeScheduleId String
  feeSchedule   FeeSchedule @relation(fields: [feeScheduleId], references: [id], onDelete: Cascade)

  @@unique([feeScheduleId, cptCode])
  @@index([cptCode])
}

// Charge (billable service/procedure)
model Charge {
  id            String       @id @default(cuid())
  chargeDate    DateTime     @default(now())
  serviceDate   DateTime     // Date service was rendered

  // Procedure info
  cptCode       String
  description   String
  modifiers     String[]     // -25, -59, etc.
  units         Int          @default(1)

  // Diagnosis pointers (reference to encounter diagnoses)
  diagnosisPointers Int[]    // 1, 2, 3, 4 - positions in claim
  icd10Codes    String[]     // Actual codes for reference

  // Pricing
  fee           Decimal      @db.Decimal(10, 2) // Billed amount
  adjustments   Decimal      @db.Decimal(10, 2) @default(0) // Write-offs
  payments      Decimal      @db.Decimal(10, 2) @default(0) // Total payments received
  balance       Decimal      @db.Decimal(10, 2) // Remaining balance

  // Status
  status        ChargeStatus @default(PENDING)
  voidReason    String?
  voidedAt      DateTime?
  voidedBy      String?

  // Place of service
  placeOfService PlaceOfService @default(OFFICE)

  // Notes
  notes         String?
  internalNotes String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  patientId     String
  patient       Patient @relation(fields: [patientId], references: [id])

  encounterId   String?
  encounter     Encounter? @relation(fields: [encounterId], references: [id])

  procedureId   String? // Link to encounter procedure if applicable

  providerId    String?
  provider      Provider? @relation(fields: [providerId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  paymentAllocations PaymentAllocation[]
  claimLines    ClaimLine[]

  // Clearinghouse relations (Epic 08)
  remittanceLineItems RemittanceLineItem[]

  // AI Billing relations (Epic 09)
  paymentMatchSuggestions PaymentMatchSuggestion[]
  underpayments           UnderpaymentDetection[]

  @@index([organizationId])
  @@index([patientId])
  @@index([encounterId])
  @@index([status])
  @@index([serviceDate])
  @@index([chargeDate])
}

// Payment (patient or insurance payment)
model Payment {
  id              String        @id @default(cuid())
  paymentDate     DateTime      @default(now())
  postedDate      DateTime      @default(now())

  // Payment details
  amount          Decimal       @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  referenceNumber String?       // Check number, transaction ID, etc.

  // Payer info
  payerType       String        @default("patient") // patient, insurance, other
  payerName       String?       // Insurance company name if applicable

  // For insurance payments
  checkNumber     String?
  checkDate       DateTime?
  eobDate         DateTime?

  // Unapplied amount (credit balance)
  unappliedAmount Decimal       @db.Decimal(10, 2) @default(0)

  // Status
  isVoid          Boolean       @default(false)
  voidReason      String?
  voidedAt        DateTime?
  voidedBy        String?

  // Notes
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Applied to charges
  allocations     PaymentAllocation[]

  // If from insurance claim
  claimId         String?
  claim           Claim? @relation(fields: [claimId], references: [id])

  // Link to payment transaction (Epic 10)
  paymentTransaction PaymentTransaction?

  @@index([organizationId])
  @@index([patientId])
  @@index([paymentDate])
  @@index([paymentMethod])
}

// Payment Allocation (how payment is applied to charges)
model PaymentAllocation {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(10, 2)
  allocatedAt DateTime @default(now())

  // Relations
  paymentId   String
  payment     Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  chargeId    String
  charge      Charge @relation(fields: [chargeId], references: [id])

  @@index([paymentId])
  @@index([chargeId])
}

// Insurance Claim
model Claim {
  id              String      @id @default(cuid())
  claimNumber     String?     // Internal claim number
  payerClaimNumber String?    // Payer-assigned claim number

  // Dates
  createdDate     DateTime    @default(now())
  submittedDate   DateTime?
  acceptedDate    DateTime?
  paidDate        DateTime?

  // Status
  status          ClaimStatus @default(DRAFT)
  statusMessage   String?     // Rejection/denial reason

  // Claim totals
  totalCharges    Decimal     @db.Decimal(10, 2) @default(0)
  totalAllowed    Decimal     @db.Decimal(10, 2) @default(0)
  totalPaid       Decimal     @db.Decimal(10, 2) @default(0)
  totalAdjusted   Decimal     @db.Decimal(10, 2) @default(0)
  patientResponsibility Decimal @db.Decimal(10, 2) @default(0)

  // Claim type
  claimType       String      @default("professional") // professional, institutional
  isSecondary     Boolean     @default(false)
  originalClaimId String?     // If this is a corrected claim

  // Submission info
  submissionMethod String?    // electronic, paper, portal
  batchId         String?     // EDI batch identifier

  // Provider info (snapshot at time of claim)
  billingProviderId String?
  billingNpi      String?
  renderingNpi    String?
  facilityNpi     String?

  // Notes
  notes           String?
  internalNotes   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  encounterId     String?
  encounter       Encounter? @relation(fields: [encounterId], references: [id])

  insurancePolicyId String?
  insurancePolicy PatientInsurance? @relation(fields: [insurancePolicyId], references: [id])

  payerId         String?
  payer           InsurancePayer? @relation(fields: [payerId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related
  claimLines      ClaimLine[]
  payments        Payment[]
  claimNotes      ClaimNote[]

  // Clearinghouse relations (Epic 08)
  submissions         ClaimSubmission[]
  statusChecks        ClaimStatusCheck[]
  remittanceLineItems RemittanceLineItem[]
  denials             Denial[]

  // AI Billing relations (Epic 09)
  scrubResults        ClaimScrubResult[]
  denialPredictions   DenialPrediction[]
  underpayments       UnderpaymentDetection[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([submittedDate])
  @@index([payerId])
}

// Claim Line (individual service on a claim)
model ClaimLine {
  id              String   @id @default(cuid())
  lineNumber      Int      // Sequence on claim

  // Service info
  serviceDateFrom DateTime
  serviceDateTo   DateTime
  placeOfService  PlaceOfService @default(OFFICE)

  // Procedure
  cptCode         String
  modifiers       String[]
  description     String
  units           Int      @default(1)

  // Diagnosis pointers (1-4, reference to claim diagnoses)
  diagnosisPointers Int[]

  // Amounts
  chargedAmount   Decimal  @db.Decimal(10, 2)
  allowedAmount   Decimal  @db.Decimal(10, 2) @default(0)
  paidAmount      Decimal  @db.Decimal(10, 2) @default(0)
  adjustedAmount  Decimal  @db.Decimal(10, 2) @default(0)
  patientAmount   Decimal  @db.Decimal(10, 2) @default(0) // Copay/coinsurance

  // Adjudication
  adjudicationDate DateTime?
  adjustmentReasonCodes String[] // CARC codes
  remarkCodes     String[]       // RARC codes

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  claimId         String
  claim           Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  chargeId        String?
  charge          Charge? @relation(fields: [chargeId], references: [id])

  @@index([claimId])
  @@index([chargeId])
}

// Claim Note (history/activity on claim)
model ClaimNote {
  id          String   @id @default(cuid())
  noteType    String   // status_change, submission, rejection, appeal, etc.
  note        String
  createdAt   DateTime @default(now())

  // Who made the note
  userId      String?

  // Relations
  claimId     String
  claim       Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([createdAt])
}

// ============================================
// EPIC 10: PAYMENT PROCESSING
// ============================================

// Card type enum
enum CardType {
  CREDIT
  DEBIT
  HSA
  FSA
}

// Card brand enum
enum CardBrand {
  VISA
  MASTERCARD
  AMEX
  DISCOVER
  OTHER
}

// Payment transaction status
enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
  VOIDED
}

// Payment plan status
enum PaymentPlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  DEFAULTED
  PAUSED
}

// Installment status
enum InstallmentStatus {
  SCHEDULED
  PENDING
  PAID
  FAILED
  SKIPPED
}

// Statement status
enum StatementStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
}

// Auto-pay frequency
enum AutoPayFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  ON_STATEMENT
}

// Payment processor type
enum PaymentProcessorType {
  STRIPE
  SQUARE
  AUTHORIZE_NET
  MOCK // For development/testing
}

// Payment processor configuration
model PaymentProcessor {
  id              String               @id @default(cuid())
  name            String               // "Main Stripe Account", "Square Terminal"
  type            PaymentProcessorType
  isDefault       Boolean              @default(false)
  isActive        Boolean              @default(true)

  // Encrypted credentials (NEVER store plain text)
  apiKeyEncrypted       String?        // Encrypted API key
  secretKeyEncrypted    String?        // Encrypted secret key
  webhookSecretEncrypted String?       // Encrypted webhook secret

  // Public identifiable info (safe to store)
  publishableKey  String?              // Stripe publishable key (safe to expose)
  merchantId      String?              // Square merchant ID
  accountId       String?              // Processor account ID

  // Configuration
  testMode        Boolean              @default(false) // Use sandbox/test environment
  supportedCardBrands Json             @default("[]")  // ["VISA", "MASTERCARD", ...]
  settings        Json                 @default("{}")  // Additional processor-specific settings

  // Webhook configuration
  webhookEndpoint String?              // Our endpoint URL for this processor
  webhookEvents   Json                 @default("[]")  // Subscribed events

  // Audit
  lastVerifiedAt  DateTime?            // Last successful API connection test
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transactions processed by this processor
  transactions    PaymentTransaction[]
  refunds         Refund[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isActive])
  @@index([type])
}

// Stored payment method (tokenized card info - NEVER store raw card numbers)
model StoredPaymentMethod {
  id              String    @id @default(cuid())

  // Card identification (tokenized - from payment processor)
  paymentToken    String    // Stripe payment method ID or similar
  last4           String    // Last 4 digits for display
  cardBrand       CardBrand
  cardType        CardType  @default(CREDIT)
  expiryMonth     Int       // 1-12
  expiryYear      Int       // 4-digit year

  // Cardholder info
  cardholderName  String
  billingZip      String?

  // Settings
  isDefault       Boolean   @default(false)
  isActive        Boolean   @default(true)
  nickname        String?   // "Personal Visa", "HSA Card"

  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastUsedAt      DateTime?

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Transactions made with this card
  transactions    PaymentTransaction[]
  autoPayEnrollments AutoPayEnrollment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([isActive])
}

// Payment transaction (actual card charges)
model PaymentTransaction {
  id              String                   @id @default(cuid())

  // Transaction details
  amount          Decimal                  @db.Decimal(10, 2)
  currency        String                   @default("USD")
  status          PaymentTransactionStatus @default(PENDING)

  // External processor info
  externalTransactionId String?            // Stripe charge ID, Square payment ID, etc.
  processorResponse     Json?              // Full response from processor

  // Error info (if failed)
  errorCode       String?
  errorMessage    String?
  declineCode     String?

  // For refunds
  isRefund        Boolean                  @default(false)
  originalTransactionId String?
  originalTransaction PaymentTransaction?  @relation("RefundRelation", fields: [originalTransactionId], references: [id])
  refunds         PaymentTransaction[]     @relation("RefundRelation")
  refundReason    String?

  // Timestamps
  processedAt     DateTime?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  paymentMethodId String?
  paymentMethod   StoredPaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  // Payment processor used for this transaction
  paymentProcessorId String?
  paymentProcessor   PaymentProcessor? @relation(fields: [paymentProcessorId], references: [id])

  // Link to existing Payment model for allocation
  paymentId       String?                  @unique
  payment         Payment? @relation(fields: [paymentId], references: [id])

  // If part of a payment plan
  installmentId   String?                  @unique
  installment     PaymentPlanInstallment? @relation(fields: [installmentId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@index([externalTransactionId])
  @@index([paymentProcessorId])
}

// Payment plan for installment payments
model PaymentPlan {
  id              String            @id @default(cuid())
  name            String?           // "6-Month Payment Plan"

  // Plan details
  totalAmount     Decimal           @db.Decimal(10, 2)
  downPayment     Decimal           @db.Decimal(10, 2) @default(0)
  numberOfInstallments Int
  installmentAmount Decimal         @db.Decimal(10, 2)
  frequency       AutoPayFrequency  @default(MONTHLY)

  // Interest/fees (optional)
  interestRate    Decimal?          @db.Decimal(5, 2) // Annual percentage
  setupFee        Decimal?          @db.Decimal(10, 2)

  // Status
  status          PaymentPlanStatus @default(ACTIVE)

  // Progress
  amountPaid      Decimal           @db.Decimal(10, 2) @default(0)
  amountRemaining Decimal           @db.Decimal(10, 2)
  installmentsPaid Int              @default(0)

  // Schedule
  startDate       DateTime
  nextDueDate     DateTime?
  endDate         DateTime?

  // Notes
  notes           String?
  termsAcceptedAt DateTime?

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  cancelledAt     DateTime?
  cancelReason    String?

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Installments
  installments    PaymentPlanInstallment[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([nextDueDate])
}

// Individual installment in a payment plan
model PaymentPlanInstallment {
  id              String            @id @default(cuid())
  installmentNumber Int             // 1, 2, 3, etc.

  // Amount
  amount          Decimal           @db.Decimal(10, 2)

  // Schedule
  dueDate         DateTime

  // Status
  status          InstallmentStatus @default(SCHEDULED)
  paidAt          DateTime?
  paidAmount      Decimal?          @db.Decimal(10, 2)

  // Retry tracking
  attemptCount    Int               @default(0)
  lastAttemptAt   DateTime?
  nextRetryAt     DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  paymentPlanId   String
  paymentPlan     PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  // Transaction that paid this installment
  transaction     PaymentTransaction?

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([status])
}

// Patient statement
model PatientStatement {
  id              String          @id @default(cuid())
  statementNumber String          // STM-2024-001

  // Period covered
  statementDate   DateTime        @default(now())
  periodStart     DateTime
  periodEnd       DateTime

  // Amounts
  previousBalance Decimal         @db.Decimal(10, 2) @default(0)
  newCharges      Decimal         @db.Decimal(10, 2) @default(0)
  payments        Decimal         @db.Decimal(10, 2) @default(0)
  adjustments     Decimal         @db.Decimal(10, 2) @default(0)
  totalDue        Decimal         @db.Decimal(10, 2)
  minimumDue      Decimal?        @db.Decimal(10, 2)

  // Due date
  dueDate         DateTime

  // Status
  status          StatementStatus @default(DRAFT)

  // Content snapshot (for historical accuracy)
  chargeDetails   Json?           // Array of charges included
  paymentDetails  Json?           // Array of payments in period

  // Delivery
  sentAt          DateTime?
  sentVia         String?         // email, mail, portal
  sentTo          String?         // Email or address
  viewedAt        DateTime?

  // PDF storage
  pdfStorageKey   String?

  // Notes
  notes           String?
  messageToPatient String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, statementNumber])
  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([statementDate])
  @@index([dueDate])
}

// Auto-pay enrollment
model AutoPayEnrollment {
  id              String           @id @default(cuid())

  // Settings
  frequency       AutoPayFrequency @default(ON_STATEMENT)
  maxAmount       Decimal?         @db.Decimal(10, 2) // Optional limit per charge

  // Schedule (for non-statement frequencies)
  dayOfWeek       Int?             // 0-6 for weekly
  dayOfMonth      Int?             // 1-28 for monthly

  // Status
  isActive        Boolean          @default(true)

  // Next scheduled
  nextChargeDate  DateTime?

  // Consent
  consentedAt     DateTime         @default(now())
  consentIp       String?
  termsVersion    String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  cancelledAt     DateTime?

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  paymentMethodId String
  paymentMethod   StoredPaymentMethod @relation(fields: [paymentMethodId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([patientId, organizationId]) // One enrollment per patient per org
  @@index([organizationId])
  @@index([isActive])
  @@index([nextChargeDate])
}

// Refund tracking (extends PaymentTransaction for detailed tracking)
model Refund {
  id              String    @id @default(cuid())

  // Amount
  amount          Decimal   @db.Decimal(10, 2)

  // Reason
  reason          String
  reasonCategory  String?   // duplicate, patient_request, service_not_rendered, etc.

  // Status
  status          PaymentTransactionStatus @default(PENDING)

  // Processor info
  processorRefundId String?

  // Original payment reference
  originalPaymentId String
  originalTransactionId String?

  // Approval (if required)
  requiresApproval Boolean  @default(false)
  approvedAt       DateTime?
  approvedBy       String?

  // Timestamps
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Who initiated
  initiatedBy     String    // User ID

  // Relations
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Payment processor used for this refund
  paymentProcessorId String?
  paymentProcessor   PaymentProcessor? @relation(fields: [paymentProcessorId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentProcessorId])
}

// ============================================
// EPIC 11: PATIENT COMMUNICATION HUB
// ============================================

// Communication channel type
enum CommunicationChannel {
  SMS
  EMAIL
  VOICE
  PORTAL
  IN_APP
}

// Message status
enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
  BOUNCED
}

// Message direction
enum MessageDirection {
  OUTBOUND  // Practice to patient
  INBOUND   // Patient to practice
}

// Communication type/purpose
enum CommunicationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  APPOINTMENT_CANCELLATION
  APPOINTMENT_RESCHEDULE
  FORM_REQUEST
  PAYMENT_REMINDER
  BIRTHDAY
  RECALL
  MARKETING
  GENERAL
  CUSTOM
}

// Message template
model MessageTemplate {
  id          String            @id @default(cuid())
  name        String
  description String?
  type        CommunicationType
  channel     CommunicationChannel

  // Content
  subject     String?           // For email
  body        String            @db.Text

  // Template variables (e.g., {{patient.firstName}}, {{appointment.date}})
  variables   Json?             // List of available variables

  // Settings
  isActive    Boolean           @default(true)
  isSystem    Boolean           @default(false) // System templates can't be deleted

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Multi-tenant relation (null = system template)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  messages    Message[]
  reminderRules ReminderRule[]
  recallSequenceSteps RecallSequenceStep[]
  recallCampaigns RecallCampaign[]
  reactivationCampaigns ReactivationCampaign[]
  nurtureSequenceSteps NurtureSequenceStep[]

  @@index([organizationId])
  @@index([type])
  @@index([channel])
  @@index([isActive])
}

// Individual message/communication
model Message {
  id          String            @id @default(cuid())

  // Routing
  channel     CommunicationChannel
  direction   MessageDirection  @default(OUTBOUND)
  type        CommunicationType @default(GENERAL)

  // Content
  subject     String?           // For email
  body        String            @db.Text

  // Delivery info
  recipient   String            // Phone number or email
  sender      String?           // From number or email

  // Status tracking
  status      MessageStatus     @default(PENDING)
  statusMessage String?         // Error message if failed

  // External tracking
  externalId  String?           // Twilio SID, email message ID, etc.

  // Timestamps
  scheduledAt DateTime?         // For scheduled messages
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  patientId   String?
  patient     Patient? @relation(fields: [patientId], references: [id])

  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])

  templateId  String?
  template    MessageTemplate? @relation(fields: [templateId], references: [id])

  // For threaded conversations
  threadId    String?
  thread      MessageThread? @relation(fields: [threadId], references: [id])

  // Who sent (for outbound) or received (for inbound review)
  userId      String?

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([appointmentId])
  @@index([status])
  @@index([channel])
  @@index([direction])
  @@index([scheduledAt])
  @@index([createdAt])
  @@index([threadId])
}

// Message thread for conversations
model MessageThread {
  id          String    @id @default(cuid())
  subject     String?

  // Status
  isOpen      Boolean   @default(true)
  lastMessageAt DateTime @default(now())

  // Unread tracking
  unreadCount Int       @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  patientId   String
  patient     Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Messages in thread
  messages    Message[]

  @@index([organizationId])
  @@index([patientId])
  @@index([isOpen])
  @@index([lastMessageAt])
}

// Patient communication preferences
model CommunicationPreference {
  id          String   @id @default(cuid())

  // Channel preferences
  allowSms    Boolean  @default(true)
  allowEmail  Boolean  @default(true)
  allowVoice  Boolean  @default(false)
  allowPortal Boolean  @default(true)

  // Preferred channel for different types
  preferredChannel CommunicationChannel @default(SMS)

  // Time preferences
  preferredTimeStart String? // "09:00"
  preferredTimeEnd   String? // "17:00"
  timezone           String  @default("America/Los_Angeles")

  // Opt-outs
  optOutMarketing Boolean @default(false)
  optOutReminders Boolean @default(false)

  // Language
  language    String   @default("en")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  patientId   String   @unique
  patient     Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
}

// Reminder rules/automation
model ReminderRule {
  id          String            @id @default(cuid())
  name        String
  description String?

  // Trigger
  triggerType String            // appointment_scheduled, X_before_appointment, etc.
  triggerValue Int?             // Minutes/hours/days before
  triggerUnit  String?          // minutes, hours, days

  // Channel and template
  channel     CommunicationChannel
  templateId  String
  template    MessageTemplate @relation(fields: [templateId], references: [id])

  // Conditions
  appointmentTypes String[]     // Empty = all types

  // Settings
  isActive    Boolean           @default(true)
  sendTime    String?           // Specific time to send (e.g., "09:00")

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
}

// ============================================
// EPIC 15: REPORTING & ANALYTICS
// ============================================

// Widget type enum
enum WidgetType {
  METRIC      // Single number display
  CHART_LINE  // Line chart
  CHART_BAR   // Bar chart
  CHART_PIE   // Pie chart
  TABLE       // Data table
  LIST        // Simple list
  TREND       // Metric with trend
}

// Report type enum
enum ReportType {
  DASHBOARD          // Dashboard overview
  PROVIDER_PRODUCTION // Provider production report
  COLLECTIONS        // Collections report
  AR_AGING           // AR aging report
  KPI_SUMMARY        // KPI summary
  CUSTOM             // Custom report
}

// Report export format
enum ExportFormat {
  PDF
  CSV
  EXCEL
  JSON
}

// Report schedule frequency
enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
}

// Dashboard widget configuration
model DashboardWidget {
  id          String     @id @default(cuid())
  name        String
  widgetType  WidgetType

  // Configuration
  config      Json       // Widget-specific configuration
  dataSource  String     // Which data to display
  filters     Json?      // Default filters

  // Layout
  position    Int        @default(0) // Order on dashboard
  width       Int        @default(1) // 1-4 grid columns
  height      Int        @default(1) // 1-4 grid rows

  // Settings
  isActive    Boolean    @default(true)
  refreshRate Int?       // Auto-refresh in seconds

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // User who created/owns this widget
  userId      String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([isActive])
}

// Saved report configuration
model SavedReport {
  id          String     @id @default(cuid())
  name        String
  description String?
  reportType  ReportType

  // Report configuration
  config      Json       // Report-specific configuration
  filters     Json?      // Saved filters
  columns     Json?      // Selected columns for display
  sortBy      String?    // Sort field
  sortOrder   String?    // asc or desc

  // Sharing
  isShared    Boolean    @default(false) // Visible to all users in org

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // User who created this report
  userId      String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  schedules   ReportSchedule[]
  exports     ReportExport[]

  @@index([organizationId])
  @@index([userId])
  @@index([reportType])
}

// Scheduled report delivery
model ReportSchedule {
  id          String            @id @default(cuid())
  name        String

  // Schedule configuration
  frequency   ScheduleFrequency
  dayOfWeek   Int?              // 0-6 for weekly (Sunday=0)
  dayOfMonth  Int?              // 1-31 for monthly
  timeOfDay   String            @default("08:00") // HH:mm format
  timezone    String            @default("America/Los_Angeles")

  // Export settings
  exportFormat ExportFormat     @default(PDF)

  // Delivery
  recipients  String[]          // Email addresses
  subject     String?           // Email subject
  message     String?           // Email body text

  // Status
  isActive    Boolean           @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  lastStatus  String?           // success, error
  lastError   String?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // User who created the schedule
  userId      String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Linked saved report
  savedReportId String
  savedReport   SavedReport @relation(fields: [savedReportId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isActive])
  @@index([nextRunAt])
}

// KPI snapshot for historical tracking
model KPISnapshot {
  id              String   @id @default(cuid())
  snapshotDate    DateTime @default(now())
  periodType      String   // daily, weekly, monthly
  periodStart     DateTime
  periodEnd       DateTime

  // Visit metrics
  totalVisits     Int      @default(0)
  completedVisits Int      @default(0)
  cancelledVisits Int      @default(0)
  noShowVisits    Int      @default(0)
  newPatients     Int      @default(0)

  // Financial metrics
  totalCharges    Decimal  @db.Decimal(12, 2) @default(0)
  totalPayments   Decimal  @db.Decimal(12, 2) @default(0)
  totalAdjustments Decimal @db.Decimal(12, 2) @default(0)
  totalAR         Decimal  @db.Decimal(12, 2) @default(0)

  // Calculated KPIs
  collectionRate     Decimal? @db.Decimal(5, 2) // Percentage
  noShowRate         Decimal? @db.Decimal(5, 2) // Percentage
  patientRetention   Decimal? @db.Decimal(5, 2) // Percentage
  avgVisitValue      Decimal? @db.Decimal(10, 2)
  avgDaysToCollect   Decimal? @db.Decimal(5, 1)

  // AR aging breakdown
  arCurrent          Decimal? @db.Decimal(12, 2)
  ar30Days           Decimal? @db.Decimal(12, 2)
  ar60Days           Decimal? @db.Decimal(12, 2)
  ar90Days           Decimal? @db.Decimal(12, 2)
  ar120PlusDays      Decimal? @db.Decimal(12, 2)

  // Claims metrics
  claimsSubmitted    Int      @default(0)
  claimsPaid         Int      @default(0)
  claimsDenied       Int      @default(0)
  cleanClaimRate     Decimal? @db.Decimal(5, 2)

  // Raw data snapshot for detailed analysis
  metadata    Json?

  createdAt   DateTime @default(now())

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, periodType, periodStart])
  @@index([organizationId])
  @@index([snapshotDate])
  @@index([periodType])
  @@index([periodStart])
}

// Report export tracking
model ReportExport {
  id            String       @id @default(cuid())

  // Export details
  reportType    ReportType
  exportFormat  ExportFormat
  fileName      String
  fileSize      Int?         // Size in bytes
  storageKey    String?      // S3 key or local path

  // Parameters used
  parameters    Json?        // Date range, filters, etc.

  // Status
  status        String       @default("pending") // pending, processing, completed, failed
  error         String?

  // Timestamps
  requestedAt   DateTime     @default(now())
  completedAt   DateTime?
  expiresAt     DateTime?    // When the file will be deleted

  // User who requested
  userId        String

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Optional link to saved report
  savedReportId String?
  savedReport   SavedReport? @relation(fields: [savedReportId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}

// ============================================
// EPIC 13: AI SCHEDULING AGENT
// ============================================

// Risk level for no-show prediction
enum NoShowRiskLevel {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

// Overbooking recommendation status
enum OverbookingStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// Recall sequence status
enum RecallStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Recall step type
enum RecallStepType {
  EMAIL
  SMS
  PHONE_CALL
  LETTER
}

// Scheduling suggestion type
enum SuggestionType {
  OPTIMAL_TIME
  GAP_FILL
  WAITLIST_MATCH
  RESCHEDULE
  RECALL
}

// No-show prediction for appointments
model NoShowPrediction {
  id              String         @id @default(cuid())
  probability     Float          // 0.0 to 1.0
  riskLevel       NoShowRiskLevel

  // Factors contributing to prediction
  factors         Json           // { dayOfWeek: 0.15, timeSlot: 0.1, patientHistory: 0.3, ... }

  // Model info
  modelVersion    String         @default("1.0")
  confidenceScore Float?         // Model confidence in prediction

  // Outcome tracking (for model improvement)
  actualOutcome   String?        // ATTENDED, NO_SHOW, CANCELLED
  wasAccurate     Boolean?       // Was the prediction correct?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  appointmentId   String         @unique
  appointment     Appointment    @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([riskLevel])
  @@index([createdAt])
}

// Overbooking recommendations
model OverbookingRecommendation {
  id              String           @id @default(cuid())
  status          OverbookingStatus @default(PENDING)

  // Recommendation details
  suggestedDate   DateTime
  suggestedTime   String           // "09:00" format
  reason          String           // Why this overbooking is recommended
  riskAssessment  Float            // Expected no-show probability for existing appointments
  expectedValue   Float?           // Expected additional revenue

  // Decision tracking
  decidedAt       DateTime?
  decidedBy       String?          // User ID
  declineReason   String?

  // If accepted, link to the created appointment
  bookedAppointmentId String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  expiresAt       DateTime?        // Recommendation expires after this time

  // Relations
  providerId      String
  provider        Provider         @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([status])
  @@index([suggestedDate])
}

// Detected schedule gaps
model SchedulingGap {
  id              String    @id @default(cuid())

  // Gap details
  gapStart        DateTime
  gapEnd          DateTime
  durationMinutes Int

  // Gap type and priority
  gapType         String    // CANCELLATION, NATURAL, BETWEEN_BLOCKS
  fillPriority    Int       @default(0) // Higher = more important to fill

  // Potential value if filled
  estimatedValue  Float?    // Estimated revenue if gap is filled

  // Status
  isFilled        Boolean   @default(false)
  filledAt        DateTime?
  filledAppointmentId String?

  // Analysis
  suggestedActions Json?    // Array of suggested ways to fill

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  providerId      String
  provider        Provider  @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([providerId])
  @@index([gapStart])
  @@index([isFilled])
}

// Provider utilization metrics
model ProviderUtilization {
  id                String   @id @default(cuid())
  date              DateTime @db.Date

  // Core metrics
  availableMinutes  Int      // Total available time
  bookedMinutes     Int      // Time with appointments
  utilizedMinutes   Int      // Actual patient time (attended)

  // Calculated rates (stored for quick queries)
  bookingRate       Float    // bookedMinutes / availableMinutes
  utilizationRate   Float    // utilizedMinutes / bookedMinutes
  overallRate       Float    // utilizedMinutes / availableMinutes

  // Appointment breakdown
  scheduledCount    Int      @default(0)
  completedCount    Int      @default(0)
  noShowCount       Int      @default(0)
  cancelledCount    Int      @default(0)

  // Revenue metrics (optional)
  potentialRevenue  Float?   // If all slots were filled
  actualRevenue     Float?   // Actual revenue generated

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  providerId        String
  provider          Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([providerId, date])
  @@index([organizationId])
  @@index([date])
}

// AI scheduling suggestions
model SchedulingSuggestion {
  id              String         @id @default(cuid())
  suggestionType  SuggestionType

  // Suggestion details
  title           String
  description     String
  priority        Int            @default(0) // Higher = more important

  // Suggested action
  suggestedDate   DateTime?
  suggestedTime   String?        // "09:00" format
  suggestedProviderId String?

  // Context data
  contextData     Json?          // Additional context (patient preferences, etc.)

  // Scoring
  confidenceScore Float?         // AI confidence in suggestion
  expectedBenefit Float?         // Expected value/benefit

  // Status tracking
  isActioned      Boolean        @default(false)
  actionedAt      DateTime?
  actionedBy      String?
  actionResult    String?        // ACCEPTED, DECLINED, EXPIRED

  // Expiration
  expiresAt       DateTime?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations (optional - may be for patient, provider, or general)
  patientId       String?
  patient         Patient?       @relation(fields: [patientId], references: [id])

  providerId      String?
  provider        Provider?      @relation(fields: [providerId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([suggestionType])
  @@index([isActioned])
  @@index([createdAt])
}

// Automated recall sequences
model RecallSequence {
  id              String       @id @default(cuid())
  name            String
  description     String?

  // Targeting
  appointmentTypes String[]    // Which appointment types trigger this recall
  daysSinceLastVisit Int       // Trigger after X days since last visit

  // Status
  status          RecallStatus @default(ACTIVE)

  // Settings
  maxAttempts     Int          @default(3)
  stopOnSchedule  Boolean      @default(true) // Stop if patient schedules

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  steps           RecallSequenceStep[]
  enrollments     RecallEnrollment[]

  @@index([organizationId])
  @@index([status])
}

// Steps within a recall sequence
model RecallSequenceStep {
  id              String         @id @default(cuid())
  stepNumber      Int            // Order in sequence

  // Step configuration
  stepType        RecallStepType
  daysFromStart   Int            // Days from enrollment to send this step

  // Message template
  templateId      String?
  template        MessageTemplate? @relation(fields: [templateId], references: [id])

  // Custom message (if no template)
  subject         String?
  body            String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  sequenceId      String
  sequence        RecallSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Execution records
  executions      RecallStepExecution[]

  @@unique([sequenceId, stepNumber])
  @@index([sequenceId])
}

// Patient enrollment in recall sequence
model RecallEnrollment {
  id              String       @id @default(cuid())

  // Enrollment details
  enrolledAt      DateTime     @default(now())
  lastStepNumber  Int          @default(0) // Last completed step
  nextStepDue     DateTime?    // When next step should be sent

  // Status
  status          RecallStatus @default(ACTIVE)
  completedAt     DateTime?
  completedReason String?      // SCHEDULED, MAX_ATTEMPTS, OPTED_OUT, MANUAL

  // Outcome tracking
  didSchedule     Boolean      @default(false)
  scheduledAppointmentId String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  patientId       String
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  sequenceId      String
  sequence        RecallSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  // Execution records
  executions      RecallStepExecution[]

  @@unique([patientId, sequenceId])
  @@index([status])
  @@index([nextStepDue])
}

// Record of executed recall steps
model RecallStepExecution {
  id              String    @id @default(cuid())

  // Execution details
  executedAt      DateTime  @default(now())
  success         Boolean
  errorMessage    String?

  // Message tracking
  messageId       String?   // Link to Message if sent

  // Relations
  enrollmentId    String
  enrollment      RecallEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  stepId          String
  step            RecallSequenceStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([executedAt])
}

// ============================================
// EPIC 12: AI COMMUNICATION AGENT
// ============================================

// Chat session status
enum ChatSessionStatus {
  ACTIVE
  ENDED
  ABANDONED
  TRANSFERRED
}

// Chat message sender type
enum ChatSenderType {
  USER
  AI
  SYSTEM
}

// Campaign status
enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Campaign type
enum CampaignType {
  RECALL
  REACTIVATION
  BIRTHDAY
  PROMOTIONAL
  SURVEY
}

// Patient campaign status
enum PatientCampaignStatus {
  PENDING
  SENT
  DELIVERED
  RESPONDED
  CONVERTED
  OPTED_OUT
  FAILED
}

// Feedback sentiment
enum FeedbackSentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

// AI intent types
enum AIIntent {
  BOOKING
  RESCHEDULE
  CANCEL
  FAQ_INSURANCE
  FAQ_GENERAL
  FAQ_SERVICES
  FAQ_HOURS
  FAQ_LOCATION
  COMPLAINT
  COMPLIMENT
  GENERAL_INQUIRY
  UNKNOWN
}

// Chat session for AI chatbot
model ChatSession {
  id             String            @id @default(cuid())
  status         ChatSessionStatus @default(ACTIVE)
  channel        CommunicationChannel @default(PORTAL)

  // Session metadata
  startedAt      DateTime          @default(now())
  endedAt        DateTime?

  // Context for AI
  context        Json?             // Conversation context, detected intents, etc.
  metadata       Json?             // Browser info, referrer, etc.

  // Summary
  summary        String?           @db.Text // AI-generated session summary
  resolvedIssues String[]          // What was resolved

  // Satisfaction tracking
  satisfactionScore Int?           // 1-5 rating if provided

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  patientId      String?
  patient        Patient?          @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Messages in session
  messages       ChatMessage[]

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([startedAt])
}

// Individual chat message
model ChatMessage {
  id           String         @id @default(cuid())
  senderType   ChatSenderType
  content      String         @db.Text

  // Intent detection
  detectedIntent AIIntent?
  intentConfidence Float?     // 0-1 confidence score

  // For AI responses
  responseMetadata Json?      // Model used, tokens, latency, etc.

  // Timestamps
  createdAt    DateTime       @default(now())

  // Relations
  sessionId    String
  session      ChatSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@index([detectedIntent])
}

// AI Conversation context (for maintaining context across interactions)
model AIConversationContext {
  id             String   @id @default(cuid())

  // Context data
  patientContext Json?    // Known patient info for personalization
  conversationHistory Json? // Recent conversation turns
  detectedPreferences Json? // Inferred patient preferences

  // Booking context
  pendingBooking Json?    // In-progress booking state

  // Last interaction
  lastInteractionAt DateTime @default(now())

  // Expiration
  expiresAt      DateTime   // Context expiration

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  patientId      String     @unique
  patient        Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([expiresAt])
}

// Recall campaign (automated follow-up)
model RecallCampaign {
  id             String         @id @default(cuid())
  name           String
  description    String?
  status         CampaignStatus @default(DRAFT)
  type           CampaignType   @default(RECALL)

  // Targeting criteria
  targetCriteria Json          // Last visit date range, appointment types, etc.

  // Schedule
  scheduledStartAt DateTime?
  scheduledEndAt   DateTime?
  startedAt        DateTime?
  completedAt      DateTime?

  // Message configuration
  channel        CommunicationChannel @default(SMS)
  templateId     String?
  template       MessageTemplate? @relation(fields: [templateId], references: [id])

  // Custom message (if no template)
  messageSubject String?
  messageBody    String?        @db.Text

  // Sequence configuration (for multi-touch campaigns)
  sequenceConfig Json?          // Array of { delay, channel, template }

  // Stats
  totalTargeted  Int            @default(0)
  totalSent      Int            @default(0)
  totalDelivered Int            @default(0)
  totalResponded Int            @default(0)
  totalConverted Int            @default(0) // Booked appointment

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  createdBy      String?

  // Multi-tenant relation
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Patients in campaign
  patients       RecallCampaignPatient[]

  @@index([organizationId])
  @@index([status])
  @@index([type])
  @@index([scheduledStartAt])
}

// Patient in recall campaign
model RecallCampaignPatient {
  id             String               @id @default(cuid())
  status         PatientCampaignStatus @default(PENDING)

  // Delivery tracking
  sentAt         DateTime?
  deliveredAt    DateTime?
  respondedAt    DateTime?
  convertedAt    DateTime?

  // Response data
  response       String?              // Patient response text
  responseChannel CommunicationChannel?

  // Opt-out tracking
  optedOutAt     DateTime?
  optOutReason   String?

  // Failure tracking
  failureReason  String?
  retryCount     Int                  @default(0)
  lastRetryAt    DateTime?

  // Sequence tracking
  currentStep    Int                  @default(0)
  lastStepAt     DateTime?

  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  // Relations
  campaignId     String
  campaign       RecallCampaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  patientId      String
  patient        Patient              @relation(fields: [patientId], references: [id])

  // Related appointment (if converted)
  appointmentId  String?

  @@unique([campaignId, patientId])
  @@index([campaignId])
  @@index([patientId])
  @@index([status])
}

// Reactivation campaign (for lapsed patients)
model ReactivationCampaign {
  id             String         @id @default(cuid())
  name           String
  description    String?
  status         CampaignStatus @default(DRAFT)

  // Targeting criteria
  minDaysSinceVisit Int         @default(90) // Minimum days since last visit
  maxDaysSinceVisit Int?        // Maximum days (null = no limit)
  excludeActivePatients Boolean @default(true)
  additionalCriteria Json?      // Extra filtering

  // Schedule
  scheduledStartAt DateTime?
  startedAt        DateTime?
  completedAt      DateTime?

  // Message configuration
  channel        CommunicationChannel @default(EMAIL)
  templateId     String?
  template       MessageTemplate? @relation(fields: [templateId], references: [id])

  // Custom message (if no template)
  messageSubject String?
  messageBody    String?        @db.Text

  // Incentive/offer
  offerCode      String?
  offerDescription String?
  offerExpiresAt DateTime?

  // Stats
  totalTargeted  Int            @default(0)
  totalSent      Int            @default(0)
  totalDelivered Int            @default(0)
  totalResponded Int            @default(0)
  totalReactivated Int          @default(0) // Booked/visited

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  createdBy      String?

  // Multi-tenant relation
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Patients in campaign
  patients       ReactivationCampaignPatient[]

  @@index([organizationId])
  @@index([status])
  @@index([scheduledStartAt])
}

// Patient in reactivation campaign
model ReactivationCampaignPatient {
  id             String               @id @default(cuid())
  status         PatientCampaignStatus @default(PENDING)

  // Patient snapshot at targeting
  lastVisitDate  DateTime?
  daysSinceVisit Int?

  // Delivery tracking
  sentAt         DateTime?
  deliveredAt    DateTime?
  respondedAt    DateTime?
  reactivatedAt  DateTime?           // When they booked/visited

  // Response data
  response       String?

  // Opt-out tracking
  optedOutAt     DateTime?

  // Failure tracking
  failureReason  String?

  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  // Relations
  campaignId     String
  campaign       ReactivationCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  patientId      String
  patient        Patient              @relation(fields: [patientId], references: [id])

  // Related appointment (if reactivated)
  appointmentId  String?

  @@unique([campaignId, patientId])
  @@index([campaignId])
  @@index([patientId])
  @@index([status])
}

// Patient feedback with sentiment analysis
model PatientFeedback {
  id              String            @id @default(cuid())

  // Feedback content
  content         String            @db.Text
  source          String            // survey, review, chat, email, etc.

  // Ratings (optional, 1-5 scale)
  overallRating   Int?
  serviceRating   Int?
  staffRating     Int?
  facilityRating  Int?

  // Sentiment analysis
  sentiment       FeedbackSentiment?
  sentimentScore  Float?            // -1 to 1 (negative to positive)
  sentimentConfidence Float?        // 0 to 1

  // AI analysis
  keyTopics       String[]          // Extracted topics
  suggestedActions Json?            // AI-suggested follow-up actions

  // Follow-up tracking
  requiresFollowUp Boolean          @default(false)
  followedUpAt    DateTime?
  followedUpBy    String?
  followUpNotes   String?           @db.Text

  // Attribution
  appointmentId   String?           // If related to specific visit
  providerId      String?           // If about specific provider

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  patientId       String
  patient         Patient           @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([sentiment])
  @@index([sentimentScore])
  @@index([requiresFollowUp])
  @@index([createdAt])
}

// ============================================
// EPIC 08: CLEARINGHOUSE INTEGRATION
// ============================================

// Clearinghouse provider type
enum ClearinghouseProvider {
  CHANGE_HEALTHCARE
  TRIZETTO
  AVAILITY
  OFFICE_ALLY
  MOCK // For development/testing
}

// EDI transaction type
enum EDITransactionType {
  CLAIM_837P        // Professional claim submission
  ELIGIBILITY_270   // Eligibility inquiry
  ELIGIBILITY_271   // Eligibility response
  STATUS_276        // Claim status inquiry
  STATUS_277        // Claim status response
  REMITTANCE_835    // Electronic remittance advice
}

// Submission status
enum SubmissionStatus {
  PENDING         // Queued for submission
  SUBMITTED       // Sent to clearinghouse
  ACCEPTED        // Acknowledged by clearinghouse
  REJECTED        // Rejected by clearinghouse (fixable errors)
  ERROR           // System error
  PROCESSING      // Clearinghouse processing
  COMPLETED       // Successfully processed
}

// Eligibility status
enum EligibilityStatus {
  PENDING
  CHECKING
  ACTIVE          // Coverage is active
  INACTIVE        // Coverage is inactive
  UNKNOWN         // Could not determine
  ERROR           // Error checking eligibility
}

// Denial status
enum DenialStatus {
  NEW             // New denial received
  UNDER_REVIEW    // Being reviewed
  APPEALED        // Appeal submitted
  RESOLVED        // Resolution received
  WRITTEN_OFF     // Written off as uncollectable
  REBILLED        // Corrected and rebilled
  CLOSED          // Closed without further action
}

// Clearinghouse configuration (per organization)
model ClearinghouseConfig {
  id              String               @id @default(cuid())
  provider        ClearinghouseProvider @default(MOCK)
  name            String               // Display name "Change Healthcare - Production"
  isActive        Boolean              @default(true)
  isPrimary       Boolean              @default(false) // Primary clearinghouse for org

  // Connection credentials (encrypted in production)
  submitterId     String?              // Submitter ID for EDI
  username        String?
  password        String?              // Should be encrypted
  apiKey          String?              // API key if applicable
  siteId          String?              // Site/practice ID

  // Endpoints
  baseUrl         String?              // API base URL
  claimEndpoint   String?              // 837P submission endpoint
  eligibilityEndpoint String?          // 270/271 endpoint
  statusEndpoint  String?              // 276/277 endpoint
  eraEndpoint     String?              // 835 download endpoint

  // Settings
  settings        Json?                // Provider-specific settings
  batchSize       Int                  @default(50) // Max claims per batch
  autoSubmit      Boolean              @default(false) // Auto-submit ready claims
  autoPostEra     Boolean              @default(false) // Auto-post ERA payments

  // Billing info
  billingNpi      String?              // Billing provider NPI
  billingTaxId    String?              // Tax ID for billing

  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  submissions     ClaimSubmission[]
  eligibilityChecks EligibilityCheck[]
  statusChecks    ClaimStatusCheck[]
  remittances     Remittance[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([provider])
  @@index([isActive])
}

// Claim submission tracking (837P)
model ClaimSubmission {
  id              String           @id @default(cuid())
  submissionDate  DateTime         @default(now())
  status          SubmissionStatus @default(PENDING)

  // Batch tracking
  batchId         String?          // EDI batch/interchange ID
  controlNumber   String?          // ST02 control number

  // Response tracking
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  responseMessage String?          // Error or acknowledgment message
  responseCode    String?          // Response code from clearinghouse

  // 999/TA1 acknowledgment
  ackStatus       String?          // A=Accepted, R=Rejected, E=Error
  ackDate         DateTime?
  ackDetails      Json?            // Full acknowledgment details

  // Retry tracking
  retryCount      Int              @default(0)
  lastRetryAt     DateTime?
  maxRetries      Int              @default(3)

  // Raw EDI data (for debugging)
  ediContent      String?          @db.Text // The 837P content
  responseContent String?          @db.Text // The response/ack content

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  claimId         String
  claim           Claim @relation(fields: [claimId], references: [id])

  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([submissionDate])
  @@index([batchId])
}

// Eligibility verification (270/271)
model EligibilityCheck {
  id              String            @id @default(cuid())
  checkDate       DateTime          @default(now())
  status          EligibilityStatus @default(PENDING)

  // Request info
  serviceDate     DateTime?         // Date of service for eligibility
  serviceTypes    String[]          // Service type codes being checked

  // Patient/subscriber info (snapshot at check time)
  subscriberId    String?
  subscriberName  String?
  subscriberDob   DateTime?
  relationshipCode String?          // Relationship to subscriber

  // Payer info
  payerId         String?           // Payer ID
  payerName       String?

  // Response data
  responseDate    DateTime?
  coverageStatus  String?           // Active, Inactive, etc.
  planName        String?
  planType        String?           // HMO, PPO, etc.

  // Benefits info
  deductible         Decimal?       @db.Decimal(10, 2)
  deductibleMet      Decimal?       @db.Decimal(10, 2)
  outOfPocketMax     Decimal?       @db.Decimal(10, 2)
  outOfPocketMet     Decimal?       @db.Decimal(10, 2)
  copay              Decimal?       @db.Decimal(10, 2)
  coinsurance        Decimal?       @db.Decimal(5, 2) // Percentage

  // Visit limits
  visitsRemaining    Int?
  visitsUsed         Int?
  visitsMax          Int?

  // Authorization info
  authRequired       Boolean?
  authNumber         String?
  authEffectiveDate  DateTime?
  authTermDate       DateTime?

  // Full response
  responseJson       Json?          // Full 271 response data
  errorMessage       String?

  // Raw EDI
  ediRequest         String?        @db.Text
  ediResponse        String?        @db.Text

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  // Relations
  patientId          String
  patient            Patient @relation(fields: [patientId], references: [id])

  insuranceId        String?
  insurance          PatientInsurance? @relation(fields: [insuranceId], references: [id])

  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId     String
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([status])
  @@index([checkDate])
}

// Claim status inquiry (276/277)
model ClaimStatusCheck {
  id              String           @id @default(cuid())
  checkDate       DateTime         @default(now())
  status          SubmissionStatus @default(PENDING)

  // Request tracking
  traceNumber     String?          // TRN02 trace number

  // Response data
  responseDate    DateTime?
  claimStatus     String?          // Claim status category
  statusCode      String?          // Status category code
  statusDescription String?

  // Claim-level response
  totalCharged    Decimal?         @db.Decimal(10, 2)
  totalPaid       Decimal?         @db.Decimal(10, 2)
  patientResponsibility Decimal?   @db.Decimal(10, 2)
  payerClaimNumber String?         // Payer's claim number

  // Adjudication date
  adjudicationDate DateTime?
  checkNumber      String?
  paymentDate      DateTime?

  // Full response
  responseJson     Json?
  errorMessage     String?

  // Raw EDI
  ediRequest       String?         @db.Text
  ediResponse      String?         @db.Text

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  claimId          String
  claim            Claim @relation(fields: [claimId], references: [id])

  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([checkDate])
}

// Electronic remittance advice (835 ERA/EOB)
model Remittance {
  id              String           @id @default(cuid())
  receivedDate    DateTime         @default(now())
  processedDate   DateTime?
  isProcessed     Boolean          @default(false)

  // ERA identification
  checkNumber     String?          // Check or EFT number
  checkDate       DateTime?
  payerName       String?
  payerId         String?

  // Payment totals
  totalPaid       Decimal          @db.Decimal(10, 2) @default(0)
  totalAdjusted   Decimal          @db.Decimal(10, 2) @default(0)
  totalCharges    Decimal          @db.Decimal(10, 2) @default(0)
  claimCount      Int              @default(0)

  // Provider-level payment
  providerPaid    Decimal?         @db.Decimal(10, 2)
  providerAdjusted Decimal?        @db.Decimal(10, 2)

  // Raw ERA data
  ediContent      String?          @db.Text // Original 835 content
  parsedData      Json?            // Parsed ERA data

  // Processing notes
  notes           String?
  errorMessage    String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  clearinghouseConfigId String
  clearinghouseConfig   ClearinghouseConfig @relation(fields: [clearinghouseConfigId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Line items
  lineItems       RemittanceLineItem[]

  @@index([organizationId])
  @@index([receivedDate])
  @@index([isProcessed])
  @@index([checkNumber])
}

// Remittance line item (per claim/service)
model RemittanceLineItem {
  id              String   @id @default(cuid())
  lineNumber      Int

  // Claim reference
  patientName     String?
  patientAccountNumber String?
  payerClaimNumber String?

  // Service info
  serviceDate     DateTime?
  cptCode         String?
  modifiers       String[]
  units           Int      @default(1)

  // Amounts
  chargedAmount   Decimal  @db.Decimal(10, 2) @default(0)
  allowedAmount   Decimal  @db.Decimal(10, 2) @default(0)
  paidAmount      Decimal  @db.Decimal(10, 2) @default(0)
  adjustedAmount  Decimal  @db.Decimal(10, 2) @default(0)
  patientAmount   Decimal  @db.Decimal(10, 2) @default(0)

  // Adjustment reason codes
  adjustmentReasonCodes String[]  // CARC codes
  adjustmentAmounts     Json?     // Amount per CARC code
  remarkCodes           String[]  // RARC codes

  // Status
  isPosted        Boolean  @default(false)
  postedAt        DateTime?
  postedBy        String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  remittanceId    String
  remittance      Remittance @relation(fields: [remittanceId], references: [id], onDelete: Cascade)

  // Link to internal claim if matched
  claimId         String?
  claim           Claim? @relation(fields: [claimId], references: [id])

  chargeId        String?
  charge          Charge? @relation(fields: [chargeId], references: [id])

  // AI Billing relations (Epic 09)
  paymentMatchSuggestions PaymentMatchSuggestion[]

  @@index([remittanceId])
  @@index([claimId])
  @@index([isPosted])
}

// Denial tracking and management
model Denial {
  id              String       @id @default(cuid())
  denialDate      DateTime     @default(now())
  status          DenialStatus @default(NEW)

  // Denial info
  denialCode      String?      // CARC/denial code
  denialReason    String       // Human-readable reason
  category        String?      // Category: Authorization, Medical Necessity, etc.

  // Amounts
  deniedAmount    Decimal      @db.Decimal(10, 2) @default(0)
  billedAmount    Decimal      @db.Decimal(10, 2) @default(0)

  // Service info
  serviceDate     DateTime?
  cptCode         String?

  // Appeal tracking
  appealDeadline  DateTime?
  appealedAt      DateTime?
  appealedBy      String?
  appealNumber    String?
  appealNotes     String?      @db.Text
  appealOutcome   String?      // Upheld, Overturned, Partial

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?      @db.Text
  recoveredAmount Decimal?     @db.Decimal(10, 2)

  // Payer info
  payerId         String?
  payerName       String?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  claimId         String
  claim           Claim @relation(fields: [claimId], references: [id])

  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Notes and documents
  notes           DenialNote[]

  // AI Billing relations (Epic 09)
  appealLetters   AppealLetter[]

  @@index([organizationId])
  @@index([claimId])
  @@index([patientId])
  @@index([status])
  @@index([denialDate])
  @@index([appealDeadline])
}

// Denial notes/activity log
model DenialNote {
  id          String   @id @default(cuid())
  noteType    String   // status_change, appeal, follow_up, resolution, etc.
  note        String   @db.Text
  createdAt   DateTime @default(now())
  createdBy   String?  // User ID

  // Relations
  denialId    String
  denial      Denial @relation(fields: [denialId], references: [id], onDelete: Cascade)

  @@index([denialId])
  @@index([createdAt])
}

// ============================================
// EPIC 14: PATIENT PORTAL
// ============================================

// Portal user status
enum PortalUserStatus {
  PENDING        // Account created but not verified
  ACTIVE         // Active account
  SUSPENDED      // Temporarily suspended
  DEACTIVATED    // Account deactivated
  LOCKED         // Locked due to failed login attempts
}

// Portal document visibility
enum PortalDocumentVisibility {
  ALWAYS         // Always visible to patient
  AFTER_REVIEW   // Visible after staff review
  HIDDEN         // Hidden from patient
}

// Portal document category
enum PortalDocumentCategory {
  VISIT_SUMMARY   // Visit summaries
  TREATMENT_PLAN  // Treatment plans
  LAB_RESULTS     // Lab results
  IMAGING         // X-rays, MRIs, etc.
  CONSENT_FORM    // Signed consent forms
  EDUCATION       // Patient education materials
  BILLING         // Bills and statements
  INSURANCE       // Insurance documents
  OTHER           // Other documents
}

// Secure message status
enum SecureMessageStatus {
  UNREAD
  READ
  ARCHIVED
  DELETED
}

// Secure message priority
enum SecureMessagePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Appointment request status
enum AppointmentRequestStatus {
  PENDING        // Awaiting staff review
  APPROVED       // Approved and scheduled
  DENIED         // Denied by staff
  CANCELLED      // Cancelled by patient
  EXPIRED        // Request expired
}

// Portal user (patient portal login credentials)
model PortalUser {
  id              String           @id @default(cuid())
  email           String           // Email for login (may differ from patient contact email)
  passwordHash    String
  status          PortalUserStatus @default(PENDING)

  // Email verification
  emailVerified   Boolean          @default(false)
  emailVerifyToken String?
  emailVerifyExpires DateTime?

  // Password reset
  passwordResetToken String?
  passwordResetExpires DateTime?

  // Security tracking
  failedLoginAttempts Int          @default(0)
  lastFailedLogin DateTime?
  lockedUntil     DateTime?
  lastLoginAt     DateTime?
  lastLoginIp     String?

  // Terms acceptance
  termsAcceptedAt DateTime?
  termsVersion    String?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  activatedAt     DateTime?
  deactivatedAt   DateTime?

  // Relations
  patientId       String           @unique
  patient         Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Related records
  sessions        PortalSession[]
  accessLogs      PortalAccessLog[]
  preferences     PortalPreferences?

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([email])
  @@index([status])
  @@index([patientId])
}

// Portal session tracking
model PortalSession {
  id              String    @id @default(cuid())
  token           String    @unique @default(cuid())

  // Session info
  userAgent       String?
  ipAddress       String?
  deviceType      String?   // mobile, tablet, desktop

  // Timestamps
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  lastActivityAt  DateTime  @default(now())
  revokedAt       DateTime?

  // Relations
  portalUserId    String
  portalUser      PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  @@index([portalUserId])
  @@index([token])
  @@index([expiresAt])
}

// Portal access audit log
model PortalAccessLog {
  id              String    @id @default(cuid())
  action          String    // LOGIN, LOGOUT, VIEW_APPOINTMENT, DOWNLOAD_DOCUMENT, etc.
  resource        String?   // Resource type accessed
  resourceId      String?   // ID of resource accessed

  // Request info
  ipAddress       String?
  userAgent       String?

  // Additional context
  metadata        Json?     // Additional action-specific data

  // Outcome
  success         Boolean   @default(true)
  errorMessage    String?

  createdAt       DateTime  @default(now())

  // Relations
  portalUserId    String
  portalUser      PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([portalUserId])
  @@index([organizationId])
  @@index([action])
  @@index([createdAt])
}

// Secure messaging between patient and practice
model SecureMessage {
  id              String              @id @default(cuid())
  subject         String
  body            String              @db.Text

  // Sender/recipient
  isFromPatient   Boolean             @default(true) // true = patient sent, false = staff sent
  senderName      String?             // Display name of sender
  senderId        String?             // User ID if from staff

  // Status and priority
  status          SecureMessageStatus @default(UNREAD)
  priority        SecureMessagePriority @default(NORMAL)

  // Threading
  parentMessageId String?             // For replies
  parentMessage   SecureMessage?      @relation("MessageReplies", fields: [parentMessageId], references: [id])
  replies         SecureMessage[]     @relation("MessageReplies")

  // Attachments
  attachments     Json?               // Array of { fileName, fileSize, storageKey }

  // Timestamps
  readAt          DateTime?
  archivedAt      DateTime?
  deletedAt       DateTime?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  patientId       String
  patient         Patient             @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([organizationId])
  @@index([status])
  @@index([isFromPatient])
  @@index([createdAt])
  @@index([parentMessageId])
}

// Documents available to patient through portal
model PortalDocument {
  id              String                   @id @default(cuid())
  title           String
  description     String?
  category        PortalDocumentCategory

  // File info
  fileName        String
  fileSize        Int                      // Size in bytes
  mimeType        String
  storageKey      String                   // S3 key or file path

  // Visibility and access
  visibility      PortalDocumentVisibility @default(AFTER_REVIEW)
  visibleAt       DateTime?                // When document becomes visible

  // Review tracking (for AFTER_REVIEW visibility)
  reviewedAt      DateTime?
  reviewedBy      String?                  // User ID

  // Linked records
  encounterId     String?                  // Associated encounter
  treatmentPlanId String?                  // Associated treatment plan

  // Expiration (optional)
  expiresAt       DateTime?

  // Access tracking
  lastViewedAt    DateTime?
  viewCount       Int                      @default(0)
  lastDownloadedAt DateTime?
  downloadCount   Int                      @default(0)

  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  uploadedBy      String?                  // User ID

  // Relations
  patientId       String
  patient         Patient                  @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([organizationId])
  @@index([category])
  @@index([visibility])
  @@index([visibleAt])
  @@index([createdAt])
}

// Patient portal preferences/settings
model PortalPreferences {
  id              String    @id @default(cuid())

  // Notification preferences
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(false)

  // Notification types
  notifyAppointmentReminders Boolean @default(true)
  notifyAppointmentChanges   Boolean @default(true)
  notifyNewMessages          Boolean @default(true)
  notifyNewDocuments         Boolean @default(true)
  notifyBillingStatements    Boolean @default(true)
  notifyFormRequests         Boolean @default(true)

  // Communication preferences
  preferredLanguage String   @default("en")

  // Display preferences
  timezone          String   @default("America/Los_Angeles")
  dateFormat        String   @default("MM/DD/YYYY")
  timeFormat        String   @default("12h")  // 12h or 24h

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  portalUserId      String   @unique
  portalUser        PortalUser @relation(fields: [portalUserId], references: [id], onDelete: Cascade)

  @@index([portalUserId])
}

// Appointment request from patient portal
model AppointmentRequest {
  id              String                  @id @default(cuid())
  status          AppointmentRequestStatus @default(PENDING)

  // Request details
  requestedDate   DateTime?               // Specific date requested
  preferredDates  Json?                   // Array of preferred dates/times
  appointmentTypeId String?               // Requested appointment type
  providerId      String?                 // Preferred provider (if any)

  // Reason/notes
  reason          String?                 // Reason for visit
  patientNotes    String?                 @db.Text

  // Urgency
  isUrgent        Boolean                 @default(false)

  // Staff response
  staffNotes      String?                 @db.Text
  denialReason    String?
  reviewedAt      DateTime?
  reviewedBy      String?                 // User ID

  // Result
  scheduledAppointmentId String?          // Created appointment ID if approved

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  expiresAt       DateTime?

  // Relations
  patientId       String
  patient         Patient                 @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// EPIC 17: INVENTORY & POS
// ============================================

// Product status
enum ProductStatus {
  ACTIVE      // Available for sale
  INACTIVE    // Not available, still in inventory
  DISCONTINUED // No longer sold
  OUT_OF_STOCK // Temporarily out
}

// Inventory movement type
enum InventoryMovementType {
  PURCHASE        // Received from vendor
  SALE            // Sold to customer
  ADJUSTMENT_UP   // Manual increase
  ADJUSTMENT_DOWN // Manual decrease
  TRANSFER_IN     // Transferred from another location
  TRANSFER_OUT    // Transferred to another location
  RETURN          // Customer return
  DAMAGE          // Damaged/write-off
  EXPIRY          // Expired product
  VOID_SALE       // Voided sale reversal
}

// Purchase order status
enum PurchaseOrderStatus {
  DRAFT       // Being created
  SUBMITTED   // Sent to vendor
  CONFIRMED   // Vendor confirmed
  PARTIAL     // Partially received
  RECEIVED    // Fully received
  CANCELLED   // Cancelled
}

// Sale status
enum SaleStatus {
  PENDING     // In progress
  COMPLETED   // Finalized
  VOIDED      // Cancelled/voided
  REFUNDED    // Fully refunded
  PARTIAL_REFUND // Partially refunded
}

// Low stock alert status
enum AlertStatus {
  ACTIVE      // Alert is active
  ACKNOWLEDGED // Seen but not resolved
  RESOLVED    // Stock replenished
  IGNORED     // User chose to ignore
}

// Payment method for POS
enum POSPaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  CHECK
  STORE_CREDIT
  INSURANCE
  OTHER
}

// Product category
model ProductCategory {
  id          String   @id @default(cuid())
  name        String   // "Supplements", "Orthotics", etc.
  description String?
  slug        String   // URL-friendly name
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  // Hierarchical categories
  parentId    String?
  parent      ProductCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  products    Product[]

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([parentId])
  @@index([isActive])
}

// Product (sellable item)
model Product {
  id           String        @id @default(cuid())
  name         String
  description  String?       @db.Text
  sku          String        // Stock Keeping Unit (org-unique)
  barcode      String?       // UPC/EAN barcode
  status       ProductStatus @default(ACTIVE)

  // Pricing
  costPrice    Decimal       @db.Decimal(10, 2) @default(0) // What we pay
  retailPrice  Decimal       @db.Decimal(10, 2) // What we sell for

  // Tax settings
  isTaxable    Boolean       @default(true)
  taxRate      Decimal?      @db.Decimal(5, 4) // Override org default

  // Physical attributes
  weight       Decimal?      @db.Decimal(10, 2)
  weightUnit   String?       @default("oz") // oz, lb, g, kg
  dimensions   String?       // "LxWxH"

  // Inventory settings
  trackInventory Boolean     @default(true)
  lowStockThreshold Int      @default(5)
  reorderPoint  Int          @default(10)
  reorderQuantity Int        @default(25)

  // Additional info
  brand        String?
  manufacturer String?
  notes        String?       @db.Text
  imageUrl     String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Category relation
  categoryId   String?
  category     ProductCategory? @relation(fields: [categoryId], references: [id])

  // Preferred vendor
  preferredVendorId String?
  preferredVendor   Vendor? @relation("PreferredVendor", fields: [preferredVendorId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  inventoryItems      InventoryItem[]
  inventoryMovements  InventoryMovement[]
  purchaseOrderItems  PurchaseOrderItem[]
  saleItems           SaleItem[]
  lowStockAlerts      LowStockAlert[]
  vendorProducts      VendorProduct[]

  @@unique([sku, organizationId])
  @@unique([barcode, organizationId])
  @@index([organizationId])
  @@index([categoryId])
  @@index([status])
  @@index([barcode])
  @@index([sku])
}

// Inventory item (product at a location)
model InventoryItem {
  id           String   @id @default(cuid())
  quantity     Int      @default(0)  // Current stock level
  reservedQty  Int      @default(0)  // Reserved for orders
  availableQty Int      @default(0)  // quantity - reservedQty

  // Location (if multiple storage areas)
  location     String   @default("main") // "main", "backroom", "display"
  binNumber    String?  // Shelf/bin location

  // Valuation
  averageCost  Decimal  @db.Decimal(10, 2) @default(0)
  lastCost     Decimal  @db.Decimal(10, 2) @default(0)

  // Tracking
  lastCountDate DateTime?
  lastCountBy   String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([productId, location, organizationId])
  @@index([organizationId])
  @@index([productId])
  @@index([location])
}

// Inventory movement (stock changes)
model InventoryMovement {
  id           String               @id @default(cuid())
  movementType InventoryMovementType
  quantity     Int                  // Positive for increases, negative for decreases

  // Reference to source
  referenceType String?             // "sale", "purchase_order", "adjustment", "transfer"
  referenceId   String?             // ID of the source document

  // Cost at time of movement
  unitCost     Decimal             @db.Decimal(10, 2) @default(0)
  totalCost    Decimal             @db.Decimal(10, 2) @default(0)

  // Location tracking
  fromLocation String?
  toLocation   String?

  notes        String?
  createdBy    String              // User ID
  createdAt    DateTime            @default(now())

  // Relations
  productId    String
  product      Product @relation(fields: [productId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([productId])
  @@index([movementType])
  @@index([referenceType, referenceId])
  @@index([createdAt])
}

// Vendor/Supplier
model Vendor {
  id           String   @id @default(cuid())
  name         String
  code         String?  // Short code for the vendor
  isActive     Boolean  @default(true)

  // Contact info
  contactName  String?
  email        String?
  phone        String?
  fax          String?
  website      String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zipCode      String?
  country      String   @default("US")

  // Payment terms
  paymentTerms String?  // "Net 30", "Net 60", etc.
  creditLimit  Decimal? @db.Decimal(10, 2)

  // Account info
  accountNumber String?
  taxId         String?

  notes        String?  @db.Text

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  purchaseOrders  PurchaseOrder[]
  vendorProducts  VendorProduct[]
  preferredFor    Product[] @relation("PreferredVendor")

  @@unique([code, organizationId])
  @@index([organizationId])
  @@index([isActive])
  @@index([name])
}

// Vendor product (vendor-specific product info)
model VendorProduct {
  id           String   @id @default(cuid())
  vendorSku    String?  // Vendor's SKU for this product
  vendorPrice  Decimal  @db.Decimal(10, 2) @default(0)
  minOrderQty  Int      @default(1)
  leadTimeDays Int?     // Typical delivery time
  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  vendorId     String
  vendor       Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([productId, vendorId])
  @@index([vendorId])
  @@index([productId])
}

// Purchase order
model PurchaseOrder {
  id           String              @id @default(cuid())
  poNumber     String              // PO-YYYYMMDD-001 format
  status       PurchaseOrderStatus @default(DRAFT)

  // Dates
  orderDate    DateTime            @default(now())
  expectedDate DateTime?
  receivedDate DateTime?

  // Totals
  subtotal     Decimal             @db.Decimal(10, 2) @default(0)
  taxAmount    Decimal             @db.Decimal(10, 2) @default(0)
  shippingCost Decimal             @db.Decimal(10, 2) @default(0)
  totalAmount  Decimal             @db.Decimal(10, 2) @default(0)

  // Shipping info
  shipToAddress String?            @db.Text
  shippingMethod String?
  trackingNumber String?

  notes        String?             @db.Text
  internalNotes String?            @db.Text

  createdBy    String              // User ID
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  vendorId     String
  vendor       Vendor @relation(fields: [vendorId], references: [id])

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Line items
  items        PurchaseOrderItem[]

  @@unique([poNumber, organizationId])
  @@index([organizationId])
  @@index([vendorId])
  @@index([status])
  @@index([orderDate])
}

// Purchase order line item
model PurchaseOrderItem {
  id           String   @id @default(cuid())
  lineNumber   Int

  // Quantities
  orderedQty   Int      @default(0)
  receivedQty  Int      @default(0)

  // Pricing
  unitCost     Decimal  @db.Decimal(10, 2) @default(0)
  totalCost    Decimal  @db.Decimal(10, 2) @default(0)

  notes        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  productId    String
  product      Product @relation(fields: [productId], references: [id])

  @@unique([purchaseOrderId, lineNumber])
  @@index([purchaseOrderId])
  @@index([productId])
}

// Point of Sale transaction
model Sale {
  id           String     @id @default(cuid())
  saleNumber   String     // SALE-YYYYMMDD-001 format
  status       SaleStatus @default(PENDING)

  // Timing
  saleDate     DateTime   @default(now())
  completedAt  DateTime?
  voidedAt     DateTime?
  voidedBy     String?
  voidReason   String?

  // Totals
  subtotal     Decimal    @db.Decimal(10, 2) @default(0)
  discountAmount Decimal  @db.Decimal(10, 2) @default(0)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountReason String?
  taxAmount    Decimal    @db.Decimal(10, 2) @default(0)
  totalAmount  Decimal    @db.Decimal(10, 2) @default(0)

  // Payment
  paymentMethod POSPaymentMethod @default(CASH)
  amountTendered Decimal @db.Decimal(10, 2) @default(0)
  changeGiven   Decimal  @db.Decimal(10, 2) @default(0)

  // Reference to payment transaction (if card)
  paymentTransactionId String?

  // Customer (optional for POS)
  patientId    String?
  customerName String?    // For non-patient sales
  customerPhone String?
  customerEmail String?

  notes        String?

  // Staff info
  salesPersonId String    // User ID
  cashierId     String?   // User ID (if different)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Line items
  items        SaleItem[]

  @@unique([saleNumber, organizationId])
  @@index([organizationId])
  @@index([status])
  @@index([saleDate])
  @@index([patientId])
  @@index([salesPersonId])
}

// Sale line item
model SaleItem {
  id           String   @id @default(cuid())
  lineNumber   Int

  // Product snapshot at time of sale
  productName  String
  productSku   String

  // Quantities
  quantity     Int      @default(1)

  // Pricing
  unitPrice    Decimal  @db.Decimal(10, 2) @default(0)
  unitCost     Decimal  @db.Decimal(10, 2) @default(0) // For margin calculation
  discountAmount Decimal @db.Decimal(10, 2) @default(0)
  taxAmount    Decimal  @db.Decimal(10, 2) @default(0)
  totalPrice   Decimal  @db.Decimal(10, 2) @default(0)

  // Refund tracking
  refundedQty  Int      @default(0)
  refundedAmount Decimal @db.Decimal(10, 2) @default(0)

  notes        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  saleId       String
  sale         Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId    String
  product      Product @relation(fields: [productId], references: [id])

  @@unique([saleId, lineNumber])
  @@index([saleId])
  @@index([productId])
}

// Low stock alert
model LowStockAlert {
  id           String      @id @default(cuid())
  status       AlertStatus @default(ACTIVE)

  // Threshold info
  currentQty   Int
  threshold    Int
  reorderPoint Int
  suggestedQty Int         // Suggested order quantity

  // Tracking
  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt     DateTime?
  resolvedBy     String?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// EPIC 09: AI BILLING AGENT
// ============================================

// Claim scrub severity
enum ScrubSeverity {
  ERROR        // Must fix before submission
  WARNING      // Should review, may cause denial
  INFO         // Informational/best practice
}

// Claim scrub result status
enum ScrubResultStatus {
  PENDING      // Scrub not yet run
  PASSED       // All checks passed
  FAILED       // Critical errors found
  WARNINGS     // Passed with warnings
}

// Denial prediction risk level
enum DenialRiskLevel {
  LOW          // <25% denial probability
  MEDIUM       // 25-50% denial probability
  HIGH         // 50-75% denial probability
  CRITICAL     // >75% denial probability
}

// Appeal letter status
enum AppealLetterStatus {
  DRAFT        // Generated but not finalized
  READY        // Ready to send
  SENT         // Sent to payer
  RESPONDED    // Payer responded
}

// Payment match status
enum PaymentMatchStatus {
  UNMATCHED    // No match found
  SUGGESTED    // AI suggested match
  CONFIRMED    // User confirmed match
  POSTED       // Payment posted
  REJECTED     // Match rejected
}

// Underpayment status
enum UnderpaymentStatus {
  DETECTED     // Underpayment detected
  UNDER_REVIEW // Being reviewed
  APPEALED     // Appeal submitted
  ADJUSTED     // Write-off/adjustment made
  RESOLVED     // Issue resolved
  IGNORED      // Decided not to pursue
}

// AI Billing job type
enum AIBillingJobType {
  CLAIM_SCRUB        // Pre-submission validation
  DENIAL_PREDICTION  // Predict denial risk
  APPEAL_GENERATION  // Generate appeal letter
  PAYMENT_MATCHING   // Match payments to charges
  UNDERPAYMENT_SCAN  // Scan for underpayments
  STATUS_CHECK       // Overnight status check
}

// AI Billing job status
enum AIBillingJobStatus {
  QUEUED       // Waiting to run
  RUNNING      // Currently processing
  COMPLETED    // Successfully completed
  FAILED       // Failed with error
  CANCELLED    // Manually cancelled
}

// Claim scrubbing result (pre-submission validation)
model ClaimScrubResult {
  id              String           @id @default(cuid())
  scrubDate       DateTime         @default(now())
  status          ScrubResultStatus @default(PENDING)

  // Overall score (0-100)
  overallScore    Int              @default(0)
  passedChecks    Int              @default(0)
  failedChecks    Int              @default(0)
  warningChecks   Int              @default(0)

  // Summary
  summary         String?          @db.Text
  recommendation  String?          // SUBMIT, REVIEW, FIX_REQUIRED

  // Time to complete scrub
  processingTimeMs Int?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  claimId         String
  claim           Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Issues found
  issues          ClaimScrubIssue[]

  @@index([organizationId])
  @@index([claimId])
  @@index([status])
  @@index([scrubDate])
}

// Individual scrub issue
model ClaimScrubIssue {
  id              String       @id @default(cuid())
  severity        ScrubSeverity

  // Issue details
  code            String       // Error code (e.g., "MISSING_DX", "INVALID_NPI")
  category        String       // Category (Patient, Provider, Diagnosis, Procedure, etc.)
  field           String?      // Field with issue
  message         String       // Human-readable message
  suggestion      String?      // How to fix

  // Line-level issue (optional)
  claimLineNumber Int?
  cptCode         String?

  // Resolution
  isResolved      Boolean      @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNote  String?

  createdAt       DateTime     @default(now())

  // Relations
  scrubResultId   String
  scrubResult     ClaimScrubResult @relation(fields: [scrubResultId], references: [id], onDelete: Cascade)

  @@index([scrubResultId])
  @@index([severity])
  @@index([isResolved])
}

// Denial prediction (ML-based risk scoring)
model DenialPrediction {
  id              String          @id @default(cuid())
  predictionDate  DateTime        @default(now())

  // Risk assessment
  riskLevel       DenialRiskLevel @default(MEDIUM)
  riskScore       Int             @default(50) // 0-100 probability
  confidenceScore Float           @default(0.5) // Model confidence

  // Risk factors (what contributes to risk)
  riskFactors     Json?           // Array of { factor, weight, description }

  // Primary risk reason
  primaryReason   String?

  // Historical data used
  historicalDenialRate Float?     // Denial rate for similar claims
  payerDenialRate Float?          // This payer's overall denial rate

  // Recommendations
  recommendations Json?           // Array of recommendations to reduce risk

  // Model metadata
  modelVersion    String?         // Which model version was used
  processingTimeMs Int?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  claimId         String
  claim           Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([riskLevel])
  @@index([predictionDate])
}

// Generated appeal letter
model AppealLetter {
  id              String            @id @default(cuid())
  generatedAt     DateTime          @default(now())
  status          AppealLetterStatus @default(DRAFT)

  // Letter content
  subject         String
  body            String            @db.Text

  // Appeal details
  appealType      String?           // First Level, Second Level, External
  denialCode      String?           // CARC/denial code being appealed
  denialReason    String?           // Original denial reason

  // Supporting arguments
  arguments       Json?             // Array of appeal arguments used
  citations       Json?             // Medical/legal citations

  // Clinical support
  clinicalSummary String?           @db.Text
  medicalNecessity String?          @db.Text

  // Attachments/documents to include
  recommendedDocs Json?             // Array of recommended supporting docs

  // Template used
  templateId      String?
  templateName    String?

  // Outcome tracking
  sentAt          DateTime?
  sentBy          String?
  payerResponse   String?           @db.Text
  responseDate    DateTime?
  outcome         String?           // APPROVED, PARTIAL, DENIED, PENDING

  // AI metadata
  modelVersion    String?
  processingTimeMs Int?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  denialId        String
  denial          Denial @relation(fields: [denialId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([denialId])
  @@index([status])
  @@index([generatedAt])
}

// Payment matching suggestion (for ERA/EOB posting)
model PaymentMatchSuggestion {
  id              String            @id @default(cuid())
  matchDate       DateTime          @default(now())
  status          PaymentMatchStatus @default(SUGGESTED)

  // Match confidence
  confidenceScore Float             @default(0.5) // 0-1 confidence
  matchMethod     String?           // How match was determined

  // Match criteria used
  matchCriteria   Json?             // { patientMatch, dateMatch, amountMatch, etc. }

  // Payment info (from ERA/EOB)
  paymentAmount   Decimal           @db.Decimal(10, 2)
  payerName       String?
  checkNumber     String?
  checkDate       DateTime?

  // Charge info
  chargeAmount    Decimal           @db.Decimal(10, 2)
  serviceDate     DateTime?
  cptCode         String?

  // Suggested allocation
  suggestedAllocation Json?         // How to allocate payment

  // User action
  actionedAt      DateTime?
  actionedBy      String?
  actionNotes     String?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  remittanceLineId String?
  remittanceLine  RemittanceLineItem? @relation(fields: [remittanceLineId], references: [id])

  chargeId        String?
  charge          Charge? @relation(fields: [chargeId], references: [id])

  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([chargeId])
  @@index([status])
  @@index([matchDate])
}

// Underpayment detection
model UnderpaymentDetection {
  id              String             @id @default(cuid())
  detectedAt      DateTime           @default(now())
  status          UnderpaymentStatus @default(DETECTED)

  // Amounts
  billedAmount    Decimal            @db.Decimal(10, 2)
  expectedAmount  Decimal            @db.Decimal(10, 2) // Based on fee schedule/contract
  paidAmount      Decimal            @db.Decimal(10, 2)
  underpaidAmount Decimal            @db.Decimal(10, 2) // Difference

  // Calculation basis
  calculationBasis String?           // FEE_SCHEDULE, CONTRACT, HISTORICAL
  feeScheduleId   String?            // Fee schedule used for comparison
  contractRate    Decimal?           @db.Decimal(5, 2) // Expected contract rate %

  // Analysis
  underpaymentReason String?         // Why we think it's underpaid
  adjustmentCodes Json?              // CARC codes that may explain

  // Supporting data
  historicalPayments Json?           // Past payments for comparison

  // Recovery potential
  recoveryLikelihood Float?          // Estimated chance of recovery
  recoveryAmount    Decimal?         @db.Decimal(10, 2) // Estimated recovery

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionType  String?            // APPEALED, ADJUSTED, IGNORED
  recoveredAmount Decimal?           @db.Decimal(10, 2)
  resolutionNotes String?            @db.Text

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  claimId         String?
  claim           Claim? @relation(fields: [claimId], references: [id])

  chargeId        String?
  charge          Charge? @relation(fields: [chargeId], references: [id])

  payerId         String?
  payerName       String?

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([claimId])
  @@index([chargeId])
  @@index([status])
  @@index([detectedAt])
}

// AI Billing batch job (for overnight processing)
model AIBillingJob {
  id              String            @id @default(cuid())
  jobType         AIBillingJobType
  status          AIBillingJobStatus @default(QUEUED)

  // Job configuration
  config          Json?             // Job-specific configuration

  // Scheduling
  scheduledFor    DateTime?         // When to run
  startedAt       DateTime?
  completedAt     DateTime?

  // Progress tracking
  totalItems      Int               @default(0)
  processedItems  Int               @default(0)
  successCount    Int               @default(0)
  failureCount    Int               @default(0)

  // Results summary
  resultSummary   Json?             // Summary of results

  // Error tracking
  errorMessage    String?           @db.Text
  errorDetails    Json?

  // Performance
  processingTimeMs Int?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  createdBy       String?           // User who initiated

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Job logs
  logs            AIBillingJobLog[]

  @@index([organizationId])
  @@index([jobType])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
}

// Job execution log
model AIBillingJobLog {
  id              String    @id @default(cuid())
  timestamp       DateTime  @default(now())
  level           String    // INFO, WARNING, ERROR
  message         String    @db.Text

  // Context
  itemId          String?   // Claim/charge ID being processed
  itemType        String?   // Type of item

  // Relations
  jobId           String
  job             AIBillingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([timestamp])
  @@index([level])
}

// AI Billing audit log (for tracking AI decisions)
model AIBillingAudit {
  id              String    @id @default(cuid())
  timestamp       DateTime  @default(now())

  // Action details
  action          String    // SCRUB, PREDICT, GENERATE_APPEAL, MATCH_PAYMENT, etc.
  entityType      String    // Claim, Charge, Denial, etc.
  entityId        String    // ID of entity

  // AI decision
  decision        String?   // What AI decided/recommended
  confidence      Float?    // AI confidence in decision
  reasoning       String?   @db.Text // Why AI made this decision

  // Input/output data
  inputData       Json?     // Data provided to AI
  outputData      Json?     // AI output

  // User override
  userOverride    Boolean   @default(false)
  overrideBy      String?   // User ID
  overrideReason  String?

  // Performance
  processingTimeMs Int?
  modelVersion    String?

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([timestamp])
}

// ============================================
// EPIC 16: AI INSIGHTS AGENT
// ============================================

// Insight category types
enum InsightCategory {
  ANOMALY           // Detected anomaly/outlier
  OPPORTUNITY       // Revenue opportunity
  CHURN_RISK        // Patient at risk of churning
  BENCHMARK         // Performance vs benchmark
  RECOMMENDATION    // Actionable recommendation
  TREND             // Trend detection
}

// Insight priority/severity
enum InsightPriority {
  CRITICAL          // Immediate attention required
  HIGH              // Important, address soon
  MEDIUM            // Worth reviewing
  LOW               // Nice to know
  INFO              // Informational only
}

// Insight status
enum InsightStatus {
  NEW               // Newly generated
  VIEWED            // User has seen it
  ACTIONED          // User took action
  DISMISSED         // User dismissed it
  EXPIRED           // No longer relevant
  RESOLVED          // Issue resolved automatically
}

// Anomaly type
enum AnomalyType {
  REVENUE_SPIKE     // Unusual revenue increase
  REVENUE_DROP      // Unusual revenue decrease
  VISIT_SPIKE       // Unusual visit increase
  VISIT_DROP        // Unusual visit decrease
  PAYMENT_DELAY     // Payments taking longer
  NO_SHOW_SPIKE     // Unusual no-show increase
  CLAIM_DENIAL_SPIKE // Unusual denial increase
  NEW_PATIENT_SPIKE  // Unusual new patient increase
  NEW_PATIENT_DROP   // Unusual new patient decrease
  COLLECTION_DROP    // Collection rate dropping
}

// Churn risk level
enum ChurnRiskLevel {
  VERY_HIGH         // 80-100% risk
  HIGH              // 60-80% risk
  MEDIUM            // 40-60% risk
  LOW               // 20-40% risk
  VERY_LOW          // 0-20% risk
}

// AI-generated insight
model AIInsight {
  id              String          @id @default(cuid())
  category        InsightCategory
  priority        InsightPriority
  status          InsightStatus   @default(NEW)

  // Content
  title           String          // Short, actionable title
  description     String          @db.Text // Detailed explanation
  impact          String?         @db.Text // Potential impact if addressed/ignored
  recommendation  String?         @db.Text // What to do about it

  // Context/Data
  dataSnapshot    Json?           // Relevant data at time of insight
  relatedMetrics  Json?           // Related KPIs and values
  confidence      Decimal         @db.Decimal(5, 2) // 0-100 confidence score

  // Targeting
  entityType      String?         // Patient, Provider, Claim, etc.
  entityId        String?         // Specific entity ID
  metricName      String?         // Which metric triggered this

  // Anomaly-specific
  anomalyType     AnomalyType?
  expectedValue   Decimal?        @db.Decimal(12, 2)
  actualValue     Decimal?        @db.Decimal(12, 2)
  deviationPercent Decimal?       @db.Decimal(8, 2)
  zScore          Decimal?        @db.Decimal(6, 2)

  // Time context
  periodStart     DateTime?
  periodEnd       DateTime?
  detectedAt      DateTime        @default(now())

  // User interaction
  viewedAt        DateTime?
  viewedBy        String?
  actionedAt      DateTime?
  actionedBy      String?
  actionNotes     String?         @db.Text
  dismissedAt     DateTime?
  dismissedBy     String?
  dismissReason   String?

  // Expiration
  expiresAt       DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Multi-tenant relation
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  actions         InsightAction[]

  @@index([organizationId])
  @@index([category])
  @@index([priority])
  @@index([status])
  @@index([detectedAt])
  @@index([entityType, entityId])
}

// Action taken on an insight
model InsightAction {
  id              String          @id @default(cuid())
  actionType      String          // clicked_link, scheduled_followup, sent_message, etc.
  actionData      Json?           // Action-specific data
  notes           String?         @db.Text

  createdAt       DateTime        @default(now())

  // Who took the action
  userId          String

  // Which insight
  insightId       String
  insight         AIInsight       @relation(fields: [insightId], references: [id], onDelete: Cascade)

  @@index([insightId])
  @@index([userId])
  @@index([createdAt])
}

// Patient churn prediction
model ChurnPrediction {
  id              String          @id @default(cuid())
  riskScore       Decimal         @db.Decimal(5, 2) // 0-100 risk score
  riskLevel       ChurnRiskLevel
  confidence      Decimal         @db.Decimal(5, 2) // 0-100 confidence

  // Contributing factors
  riskFactors     Json            // Array of { factor, weight, value, impact }
  daysSinceLastVisit  Int?
  avgVisitFrequency   Decimal?    @db.Decimal(6, 2) // avg days between visits
  visitFrequencyChange Decimal?   @db.Decimal(6, 2) // % change in frequency
  totalVisits     Int?
  missedAppointments Int?
  cancelledAppointments Int?
  hasUpcomingAppointment Boolean @default(false)

  // Financial factors
  outstandingBalance Decimal?     @db.Decimal(10, 2)
  paymentHistory     String?      // good, fair, poor

  // Recommendation
  suggestedAction String?         @db.Text
  priority        InsightPriority @default(MEDIUM)

  // Status tracking
  status          String          @default("active") // active, contacted, recovered, churned
  contactedAt     DateTime?
  contactedBy     String?
  contactNotes    String?         @db.Text
  recoveredAt     DateTime?
  churnedAt       DateTime?       // Confirmed churn date

  calculatedAt    DateTime        @default(now())
  expiresAt       DateTime?       // When to recalculate

  // Relations
  patientId       String          @unique
  patient         Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Multi-tenant relation
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  @@index([organizationId])
  @@index([riskLevel])
  @@index([riskScore])
  @@index([status])
  @@index([calculatedAt])
}

// Revenue opportunity tracking
model RevenueOpportunity {
  id              String          @id @default(cuid())
  opportunityType String          // underbilled, missed_service, recall_due, etc.
  title           String
  description     String          @db.Text

  // Estimated value
  estimatedValue  Decimal         @db.Decimal(10, 2)
  confidence      Decimal         @db.Decimal(5, 2) // 0-100

  // Context
  entityType      String?         // Patient, Service, Payer, etc.
  entityId        String?
  serviceCode     String?
  payerName       String?

  // Status
  status          String          @default("identified") // identified, in_progress, captured, declined
  capturedValue   Decimal?        @db.Decimal(10, 2) // Actual value captured
  capturedAt      DateTime?
  capturedBy      String?
  notes           String?         @db.Text

  detectedAt      DateTime        @default(now())
  expiresAt       DateTime?

  // Multi-tenant relation
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([opportunityType])
  @@index([status])
  @@index([detectedAt])
  @@index([estimatedValue])
}

// Natural language query history
model NLQueryHistory {
  id              String          @id @default(cuid())
  query           String          @db.Text // Original natural language query
  parsedIntent    String?         // Detected intent
  parsedEntities  Json?           // Extracted entities
  generatedQuery  String?         @db.Text // SQL or API query generated

  // Response
  successful      Boolean         @default(false)
  responseType    String?         // chart, table, number, text
  responseData    Json?           // Cached response data
  error           String?         @db.Text

  // Feedback
  userRating      Int?            // 1-5 star rating
  userFeedback    String?         @db.Text
  wasHelpful      Boolean?

  executionTimeMs Int?
  createdAt       DateTime        @default(now())

  // User who ran the query
  userId          String

  // Multi-tenant relation
  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@index([parsedIntent])
}

// Benchmark data for comparison
model BenchmarkData {
  id              String          @id @default(cuid())
  benchmarkType   String          // industry, regional, size_based, etc.
  metricName      String          // collectionRate, noShowRate, etc.
  period          String          // Q1_2024, 2024, etc.

  // Values
  median          Decimal         @db.Decimal(12, 2)
  percentile25    Decimal?        @db.Decimal(12, 2)
  percentile75    Decimal?        @db.Decimal(12, 2)
  percentile90    Decimal?        @db.Decimal(12, 2)
  average         Decimal?        @db.Decimal(12, 2)
  sampleSize      Int?

  // Segment
  specialty       String?         // chiropractic, pt, etc.
  region          String?         // west, midwest, etc.
  practiceSize    String?         // solo, small, medium, large

  source          String?         // Where data came from
  effectiveDate   DateTime
  expiresAt       DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([benchmarkType, metricName, period, specialty, region, practiceSize])
  @@index([metricName])
  @@index([benchmarkType])
  @@index([effectiveDate])
}

// ============================================
// EPIC 18: MARKETING & REFERRALS
// ============================================

// Referral reward type
enum ReferralRewardType {
  DISCOUNT_PERCENT   // Percentage off
  DISCOUNT_FIXED     // Fixed dollar amount off
  CREDIT             // Account credit
  CASH               // Cash reward
  GIFT_CARD          // Gift card
  FREE_SERVICE       // Free service/visit
}

// Referral status
enum ReferralStatus {
  PENDING            // Referral created, patient not yet seen
  QUALIFIED          // Referred patient has first appointment
  COMPLETED          // Reward has been issued
  EXPIRED            // Referral expired before qualification
  CANCELLED          // Referral was cancelled
}

// Lead status
enum LeadStatus {
  NEW                // Just captured
  CONTACTED          // Initial contact made
  ENGAGED            // Actively communicating
  QUALIFIED          // Ready for appointment
  CONVERTED          // Became a patient
  LOST               // No longer interested
  UNRESPONSIVE       // No response after attempts
}

// Lead source
enum LeadSource {
  WEBSITE            // Website form
  REFERRAL           // Patient referral
  GOOGLE_ADS         // Google advertising
  FACEBOOK_ADS       // Facebook/Meta advertising
  INSTAGRAM          // Instagram
  WALK_IN            // Walk-in inquiry
  PHONE_CALL         // Called the office
  SOCIAL_MEDIA       // Organic social
  EVENT              // Community event
  PARTNER            // Partner practice
  DIRECTORY          // Online directory listing
  OTHER              // Other source
}

// Nurture sequence status
enum NurtureSequenceStatus {
  DRAFT              // Being built
  ACTIVE             // Running
  PAUSED             // Temporarily paused
  COMPLETED          // All steps done
  CANCELLED          // Stopped early
}

// Review platform
enum ReviewPlatform {
  GOOGLE             // Google Business
  YELP               // Yelp
  FACEBOOK           // Facebook Reviews
  HEALTHGRADES       // Healthgrades
  ZOCDOC             // ZocDoc
  OTHER              // Other platform
}

// Review request status
enum ReviewRequestStatus {
  PENDING            // Not yet sent
  SENT               // Request sent
  CLICKED            // Clicked review link
  REVIEWED           // Left a review
  DECLINED           // Opted out
  FAILED             // Failed to send
}

// Campaign status
enum MarketingCampaignStatus {
  DRAFT              // Being planned
  SCHEDULED          // Scheduled to start
  ACTIVE             // Currently running
  PAUSED             // Temporarily paused
  COMPLETED          // Finished running
  CANCELLED          // Stopped early
}

// Campaign type
enum MarketingCampaignType {
  EMAIL              // Email campaign
  SMS                // SMS/Text campaign
  SOCIAL             // Social media campaign
  REFERRAL           // Referral promotion
  REVIEW             // Review solicitation
  REACTIVATION       // Win-back campaign
  RETENTION          // Retention campaign
}

// Referral program configuration
model ReferralProgram {
  id              String             @id @default(cuid())
  name            String             // "Patient Referral Program"
  description     String?            @db.Text

  // Reward configuration for referrer (existing patient)
  referrerRewardType   ReferralRewardType
  referrerRewardValue  Decimal        @db.Decimal(10, 2) // Amount or percentage
  referrerRewardMax    Decimal?       @db.Decimal(10, 2) // Max reward cap
  referrerRewardNote   String?        // "Get $50 off your next visit"

  // Reward configuration for referee (new patient)
  refereeRewardType    ReferralRewardType?
  refereeRewardValue   Decimal?       @db.Decimal(10, 2)
  refereeRewardMax     Decimal?       @db.Decimal(10, 2)
  refereeRewardNote    String?        // "New patient receives $25 off"

  // Program rules
  qualificationCriteria String?       // "First completed appointment"
  expirationDays       Int?           // Days before referral expires
  maxReferralsPerPatient Int?         // Max referrals per referrer
  requireNewPatient    Boolean        @default(true)

  // Terms and conditions
  termsAndConditions   String?        @db.Text

  // Status
  isActive             Boolean        @default(true)
  startDate            DateTime?
  endDate              DateTime?

  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  // Multi-tenant relation
  organizationId       String
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Referrals using this program
  referrals            Referral[]

  @@index([organizationId])
  @@index([isActive])
}

// Individual referral tracking
model Referral {
  id                String          @id @default(cuid())
  referralCode      String          // Unique tracking code
  status            ReferralStatus  @default(PENDING)

  // Referrer (existing patient who made the referral)
  referrerId        String
  referrer          Patient @relation("ReferrerPatient", fields: [referrerId], references: [id])

  // Referee (new patient being referred) - optional until they become a patient
  refereeId         String?
  referee           Patient? @relation("RefereePatient", fields: [refereeId], references: [id])

  // Referee info (before they're a patient)
  refereeName       String?
  refereeEmail      String?
  refereePhone      String?
  refereeNotes      String?

  // Program used
  programId         String
  program           ReferralProgram @relation(fields: [programId], references: [id])

  // Reward tracking
  referrerRewardIssued   Boolean     @default(false)
  referrerRewardAmount   Decimal?    @db.Decimal(10, 2)
  referrerRewardIssuedAt DateTime?
  referrerRewardNotes    String?

  refereeRewardIssued    Boolean     @default(false)
  refereeRewardAmount    Decimal?    @db.Decimal(10, 2)
  refereeRewardIssuedAt  DateTime?
  refereeRewardNotes     String?

  // Dates
  qualifiedAt       DateTime?       // When referee qualified
  completedAt       DateTime?       // When rewards issued
  expiresAt         DateTime?

  // Attribution
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Multi-tenant relation
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([referralCode, organizationId])
  @@index([organizationId])
  @@index([referrerId])
  @@index([refereeId])
  @@index([status])
  @@index([programId])
  @@index([createdAt])
}

// Lead tracking
model Lead {
  id                String       @id @default(cuid())
  status            LeadStatus   @default(NEW)
  source            LeadSource   @default(WEBSITE)

  // Contact info
  firstName         String
  lastName          String
  email             String?
  phone             String?

  // Demographics (optional)
  dateOfBirth       DateTime?
  gender            String?
  address           String?
  city              String?
  state             String?
  zipCode           String?

  // Interest/Inquiry
  primaryConcern    String?      // "Back pain", "Wellness care"
  notes             String?      @db.Text
  preferredContact  String?      // "email", "phone", "text"
  preferredTimes    String?      // "mornings", "evenings"

  // Lead scoring
  score             Int          @default(0)
  scoreFactors      Json?        // { "opened_email": 5, "clicked_link": 10 }

  // Attribution
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  utmContent        String?
  utmTerm           String?
  landingPage       String?
  referrerUrl       String?

  // Campaign attribution
  campaignId        String?
  campaign          Campaign? @relation(fields: [campaignId], references: [id])

  // Referral attribution
  referralId        String?

  // Conversion tracking
  convertedToPatientId String?
  convertedToPatient   Patient? @relation("LeadConversion", fields: [convertedToPatientId], references: [id])
  convertedAt          DateTime?

  // Communication tracking
  lastContactedAt   DateTime?
  contactAttempts   Int          @default(0)

  // Follow-up
  nextFollowUpAt    DateTime?
  assignedToUserId  String?

  // Nurturing
  currentSequenceId String?
  currentSequence   NurtureSequence? @relation(fields: [currentSequenceId], references: [id])
  currentStepNumber Int?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Multi-tenant relation
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Activities
  activities        LeadActivity[]

  @@index([organizationId])
  @@index([status])
  @@index([source])
  @@index([email])
  @@index([phone])
  @@index([score])
  @@index([nextFollowUpAt])
  @@index([assignedToUserId])
  @@index([createdAt])
}

// Lead activity/history
model LeadActivity {
  id           String   @id @default(cuid())
  activityType String   // "email_sent", "phone_call", "note_added", "status_change"
  description  String   @db.Text
  metadata     Json?    // Activity-specific data

  performedBy  String?  // User ID

  createdAt    DateTime @default(now())

  // Relations
  leadId       String
  lead         Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([activityType])
  @@index([createdAt])
}

// Nurture sequence (automated lead follow-up)
model NurtureSequence {
  id           String               @id @default(cuid())
  name         String               // "New Lead Welcome Series"
  description  String?

  status       NurtureSequenceStatus @default(DRAFT)

  // Trigger
  triggerType  String               // "lead_created", "manual", "score_threshold"
  triggerValue String?              // Specific value for trigger

  // Entry criteria
  leadSources  LeadSource[]         // Which sources can enter
  minScore     Int?                 // Minimum lead score
  maxScore     Int?                 // Maximum lead score

  // Exit criteria
  exitOnConversion Boolean          @default(true)
  exitOnUnsubscribe Boolean         @default(true)
  maxDays          Int?             // Auto-exit after N days

  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  // Multi-tenant relation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Steps
  steps        NurtureSequenceStep[]

  // Leads in this sequence
  leads        Lead[]

  @@index([organizationId])
  @@index([status])
}

// Nurture sequence step
model NurtureSequenceStep {
  id           String   @id @default(cuid())
  stepNumber   Int      // Order in sequence
  name         String   // "Welcome Email"

  // Timing
  delayDays    Int      @default(0)
  delayHours   Int      @default(0)
  sendTime     String?  // Specific time "09:00"

  // Action type
  actionType   String   // "send_email", "send_sms", "create_task", "update_score"

  // Email/SMS content
  templateId   String?
  template     MessageTemplate? @relation(fields: [templateId], references: [id])

  // Task creation
  taskTitle    String?
  taskDescription String?
  taskAssignTo String?  // User ID or "lead_owner"

  // Score update
  scoreChange  Int?     // +5, -2, etc.

  // Conditional
  condition    Json?    // { "lead.score": { "gte": 50 } }

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  sequenceId   String
  sequence     NurtureSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, stepNumber])
  @@index([sequenceId])
}

// Review request tracking
model ReviewRequest {
  id              String              @id @default(cuid())
  platform        ReviewPlatform
  status          ReviewRequestStatus @default(PENDING)

  // Patient who should review
  patientId       String
  patient         Patient @relation(fields: [patientId], references: [id])

  // Trigger info
  triggeredByAppointmentId String?

  // Communication
  sentAt          DateTime?
  sentVia         String?            // "email", "sms"
  messageId       String?            // Reference to Message

  // Response tracking
  clickedAt       DateTime?
  reviewedAt      DateTime?
  rating          Int?               // 1-5 stars if captured
  reviewUrl       String?            // Direct link to review

  // Failure info
  failureReason   String?

  // Timing
  scheduledFor    DateTime?
  expiresAt       DateTime?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Multi-tenant relation
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
}

// Marketing campaign
model Campaign {
  id               String                   @id @default(cuid())
  name             String                   // "Spring Wellness Promo"
  description      String?                  @db.Text
  campaignType     MarketingCampaignType
  status           MarketingCampaignStatus  @default(DRAFT)

  // Schedule
  startDate        DateTime?
  endDate          DateTime?

  // Budget (optional)
  budget           Decimal?       @db.Decimal(10, 2)
  actualSpend      Decimal?       @db.Decimal(10, 2)

  // Goals
  targetLeads      Int?
  targetConversions Int?
  targetRevenue    Decimal?       @db.Decimal(10, 2)

  // UTM parameters for tracking
  utmSource        String?
  utmMedium        String?
  utmCampaign      String         // Required, auto-generated if not set
  utmContent       String?

  // Targeting
  targetAudience   Json?          // { "status": "active", "lastVisit": "30d" }

  // Content
  content          Json?          // Campaign-specific content config

  // Results
  totalImpressions Int            @default(0)
  totalClicks      Int            @default(0)
  totalLeads       Int            @default(0)
  totalConversions Int            @default(0)
  totalRevenue     Decimal        @db.Decimal(10, 2) @default(0)

  // Analysis
  clickThroughRate Decimal?       @db.Decimal(5, 4) // e.g., 0.0525 = 5.25%
  conversionRate   Decimal?       @db.Decimal(5, 4)
  costPerLead      Decimal?       @db.Decimal(10, 2)
  costPerConversion Decimal?      @db.Decimal(10, 2)
  roi              Decimal?       @db.Decimal(10, 4) // Return on investment

  createdBy        String?        // User ID
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Multi-tenant relation
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Leads from this campaign
  leads            Lead[]

  @@index([organizationId])
  @@index([status])
  @@index([campaignType])
  @@index([startDate])
  @@index([utmCampaign])
}

// Landing page tracking
model LandingPage {
  id               String    @id @default(cuid())
  name             String    // "New Patient Special"
  slug             String    // URL slug: "new-patient-special"

  // Status
  isActive         Boolean   @default(true)

  // Page content (simple)
  headline         String?
  subheadline      String?
  bodyContent      String?   @db.Text
  ctaText          String?   // "Book Now"
  ctaLink          String?

  // SEO
  metaTitle        String?
  metaDescription  String?

  // Form configuration
  formEnabled      Boolean   @default(true)
  formFields       Json?     // Which fields to show
  successMessage   String?
  redirectUrl      String?

  // Campaign attribution
  defaultUtmSource String?
  defaultUtmMedium String?
  defaultCampaignId String?

  // Tracking
  totalViews       Int       @default(0)
  totalSubmissions Int       @default(0)
  conversionRate   Decimal?  @db.Decimal(5, 4)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Multi-tenant relation
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([slug, organizationId])
  @@index([organizationId])
  @@index([isActive])
  @@index([slug])
}

// Marketing consent tracking (TCPA/GDPR compliance)
model MarketingConsent {
  id               String    @id @default(cuid())

  // Who gave consent
  patientId        String?
  patient          Patient? @relation(fields: [patientId], references: [id])

  // For non-patients (leads)
  leadId           String?

  email            String?
  phone            String?

  // Consent details
  consentType      String    // "email_marketing", "sms_marketing", "phone_calls"
  consented        Boolean   @default(false)

  // How consent was given
  consentMethod    String    // "website_form", "in_office", "verbal", "text_opt_in"
  consentSource    String?   // URL or form name
  ipAddress        String?
  userAgent        String?

  // Consent text shown
  consentText      String?   @db.Text

  // Revocation
  revokedAt        DateTime?
  revocationMethod String?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Multi-tenant relation
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([patientId])
  @@index([email])
  @@index([phone])
  @@index([consentType])
}
