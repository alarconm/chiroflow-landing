# ChiroFlow Progress Log

## 2026-01-21: US-085 - Payment processor configuration schema

**Status:** COMPLETE

### What was done:
Verified existing Prisma schema already contains all required payment processing models:

1. **PaymentProcessor** (line 2310) - Stores payment processor configurations
   - name, type (STRIPE/SQUARE/AUTHORIZE_NET/MOCK)
   - apiKeyEncrypted, secretKeyEncrypted, webhookSecretEncrypted
   - testMode, supportedCardBrands, settings

2. **StoredPaymentMethod** (line 2356) - Tokenized payment methods
   - patientId, paymentToken, last4, cardBrand, cardType
   - expiryMonth, expiryYear, isDefault, cardholderName

3. **PaymentTransaction** (line 2399) - Card transaction records
   - patientId, amount, status, paymentProcessorId
   - externalTransactionId, processorResponse
   - errorCode, errorMessage, declineCode

4. **PaymentPlan** (line 2460) - Payment plans
   - patientId, totalAmount, numberOfInstallments
   - frequency (WEEKLY/BI_WEEKLY/MONTHLY/ON_STATEMENT)
   - startDate, nextDueDate, status

5. **PaymentPlanInstallment** (line 2516) - Plan installments
   - paymentPlanId, installmentNumber, amount
   - dueDate, status, transaction relation

### Supporting Enums:
- PaymentProcessorType: STRIPE, SQUARE, AUTHORIZE_NET, MOCK
- PaymentTransactionStatus: PENDING, PROCESSING, COMPLETED, FAILED, etc.
- CardBrand: VISA, MASTERCARD, AMEX, DISCOVER, OTHER
- CardType: CREDIT, DEBIT, HSA, FSA
- PaymentPlanStatus: ACTIVE, COMPLETED, CANCELLED, DEFAULTED, PAUSED
- InstallmentStatus: SCHEDULED, PENDING, PAID, FAILED, SKIPPED
- AutoPayFrequency: WEEKLY, BI_WEEKLY, MONTHLY, ON_STATEMENT

### Validation:
- Prisma schema validates successfully
- Prisma client generates successfully
--- Iteration 1 completed at 2026-01-21 21:06:14 ---
Story: US-085 - Payment processor configuration schema

## 2026-01-21: US-086 - Payment processor abstraction layer

**Status:** COMPLETE

### What was done:

Implemented the complete payment processor abstraction layer with the following components:

#### 1. PaymentProvider Interface (`app/src/lib/payment/provider.ts`)
Already existed with full interface:
- `charge` → `processPayment()` method
- `refund` → `processRefund()` method
- `createCustomer` → `createCustomer()` method
- `savePaymentMethod` → `tokenizeCard()` + `attachPaymentMethod()` methods
- Additional methods: `deletePaymentMethod`, `deleteCustomer`, `getTransactionStatus`, `cancelPayment`, `verifyWebhook`

#### 2. StripeProvider (`app/src/lib/payment/stripe-provider.ts`)
Full production implementation:
- Installed Stripe SDK v20.2.0
- `tokenizeCard()` - Creates payment methods with card details
- `processPayment()` - Creates and confirms PaymentIntents
- `processRefund()` - Creates refunds with reason mapping
- `createCustomer()` - Creates Stripe customers
- `attachPaymentMethod()` - Attaches payment methods to customers
- `verifyWebhook()` - Verifies webhook signatures and parses events
- Proper error handling with Stripe error codes and decline codes
- Card brand and card type mapping (credit/debit detection)

#### 3. MockPaymentProvider (`app/src/lib/payment/mock-provider.ts`)
Already existed with full implementation:
- Simulates Stripe-like behavior for development
- Test card numbers for various scenarios (success, declines, HSA/FSA)
- In-memory storage for customers, payment methods, transactions
- Full webhook simulation support

#### 4. Environment-based Provider Selection (`app/src/lib/payment/index.ts`)
Already existed with:
- `PAYMENT_PROVIDER` env var support ('mock' | 'stripe')
- `getPaymentProvider()` singleton factory function
- Automatic initialization with config from env vars
- `resetPaymentProvider()` for testing

#### 5. Secure Credential Handling (`app/src/lib/payment/crypto.ts`)
New file created:
- AES-256-GCM encryption for API keys
- `encryptPaymentCredential()` / `decryptPaymentCredential()` functions
- `encryptProcessorCredentials()` / `decryptProcessorCredentials()` for batch operations
- `validateStripeKeyFormat()` for key validation
- `maskCredential()` for safe display
- Version field for future-proof migrations

### Files Modified/Created:
- `app/src/lib/payment/stripe-provider.ts` - Full implementation
- `app/src/lib/payment/crypto.ts` - NEW: Credential encryption utilities
- `app/src/lib/payment/index.ts` - Added crypto exports
- `app/package.json` - Added stripe v20.2.0 dependency

### Acceptance Criteria Met:
✅ PaymentProvider interface with charge, refund, createCustomer, savePaymentMethod
✅ StripeProvider implementing the interface
✅ MockPaymentProvider for development and testing
✅ Environment-based provider selection
✅ Secure credential handling with encryption

### Validation:
- TypeScript compiles without errors
- All exports available from `@/lib/payment`

--- Iteration 2 completed at 2026-01-21 ---
Story: US-086 - Payment processor abstraction layer

--- Iteration 2 completed at 2026-01-21 21:12:06 ---
Story: US-086 - Payment processor abstraction layer

## 2026-01-21: US-087 - Card payment processing

**Status:** COMPLETE

### What was done:

Verified and enhanced the card payment processing system. The core functionality already existed in `payment-processing.ts` router; added automatic email receipt functionality.

#### 1. processPayment Procedure (Existing - `payment-processing.ts:281`)
Already implemented with full functionality:
- Accepts `patientId`, `paymentMethodId`, `amount`, `description`
- Optional `applyTo` for specific charge allocation
- Optional `autoAllocate` for oldest-first charge allocation
- `idempotencyKey` support for duplicate prevention

#### 2. Secure Card Entry (Existing)
- Cards are tokenized via Stripe Elements or similar on client-side
- Only payment tokens (not raw card numbers) are stored
- `StoredPaymentMethod` model holds tokenized card references
- `PaymentForm.tsx` component uses stored payment methods only

#### 3. Handle Declined Cards (Existing)
- Payment provider returns detailed error info: `errorCode`, `errorMessage`, `declineCode`
- Transaction record created with failure details
- TRPCError thrown with user-friendly message
- Audit log captures failure details

#### 4. Create Ledger Entry (Existing)
- On success, creates `Payment` record
- Optionally creates `PaymentAllocation` records linking to charges
- Updates charge balances and statuses
- Transaction linked to Payment for full audit trail

#### 5. Email Receipt to Patient (NEW)
Added automatic email receipt functionality:
- Fetches patient contact info with `allowEmail` preference
- Sends receipt after successful payment (non-blocking)
- Beautiful HTML email with:
  - Payment confirmation header
  - Amount, date, payment method
  - Transaction reference number
  - Allocation details
  - Credit balance if applicable
  - Organization branding
- Plain text fallback for email clients

### Files Modified:
- `app/src/server/routers/payment-processing.ts` - Added email receipt functionality
  - Line 25: Added imports for `getCardBrandDisplayName`, `maskCardNumber`, `notificationService`
  - Lines 308-324: Enhanced patient query to include contacts
  - Lines 325-328: Added organization query for branding
  - Lines 510-606: Added email receipt sending logic

### Acceptance Criteria Met:
✅ payment.processCard - Charge a card for patient balance (as `processPayment`)
✅ Secure card entry using Stripe Elements or equivalent
✅ Store payment method for future use (with patient consent)
✅ Handle declined cards gracefully with clear error messages
✅ Create ledger entry and receipt on successful payment
✅ Email receipt to patient automatically

### Validation:
- TypeScript compiles without errors
- Email sending is fire-and-forget (doesn't block payment response)
- Respects patient email preferences (`allowEmail` flag)

--- Iteration 3 completed at 2026-01-21 ---
Story: US-087 - Card payment processing

--- Iteration 3 completed at 2026-01-21 21:16:23 ---
Story: US-087 - Card payment processing

## 2026-01-21: US-088 - Refund processing

**Status:** COMPLETE

### What was done:

Enhanced the existing `processRefund` procedure in `payment-processing.ts` to fully implement all acceptance criteria for US-088.

#### 1. payment.processRefund - Refund full or partial amount (Enhanced)
Already existed, but enhanced with:
- Better transaction fetching including payment allocations
- Proportional refund calculation for partial refunds
- Support for both full and partial refunds with correct accounting

#### 2. Require reason for refund (Already existed)
- `reason: z.string().min(1, 'Refund reason is required')` validation
- Optional `reasonCategory` for categorizing refunds

#### 3. Create reversing ledger entry (NEW)
For each payment allocation:
- Calculates proportional amount to reverse based on refund ratio
- Updates charge's `payments` field (reduces by refund amount)
- Recalculates and updates charge's `balance` field
- Reverts charge status from PAID to BILLED if balance becomes positive

For the Payment record:
- Full refund: Voids the entire payment with reason
- Partial refund: Adjusts payment amount and unapplied amount, adds note

#### 4. Update patient balance (NEW)
- Reverses payment allocations proportionally
- Charge balances are recalculated: balance = fee * units - payments - adjustments
- Charges that were PAID get reverted to BILLED status when balance > 0

#### 5. Email refund confirmation to patient (NEW)
Sends automatic email notification with:
- Refund amount and reference number
- Original transaction reference
- Payment method information
- 5-10 business day processing notice
- Beautiful HTML template with refund icon
- Plain text fallback
- Respects patient email preferences (`allowEmail` flag)
- Fire-and-forget (non-blocking)

#### 6. Audit trail for all refunds (Enhanced)
Now includes comprehensive audit logging:
- Original transaction and payment IDs
- Refund amount and type (full/partial)
- Reason and reason category
- Processor refund ID
- Complete list of reversed allocations with charge IDs and CPT codes
- Failed refund attempts are also logged

### Files Modified:
- `app/src/server/routers/payment-processing.ts`
  - Lines 651-1003: Complete rewrite of `processRefund` procedure
  - Added proper payment allocation reversal logic
  - Added proportional refund calculation
  - Added email notification with HTML template
  - Enhanced audit logging

### Acceptance Criteria Met:
✅ payment.processRefund - Refund full or partial amount
✅ Require reason for refund
✅ Create reversing ledger entry
✅ Update patient balance
✅ Email refund confirmation to patient
✅ Audit trail for all refunds

### Validation:
- TypeScript compiles without errors
- Email sending is fire-and-forget (doesn't block refund response)
- Respects patient email preferences

--- Iteration 4 completed at 2026-01-21 ---
Story: US-088 - Refund processing

--- Iteration 4 completed at 2026-01-21 21:20:03 ---
Story: US-088 - Refund processing

## 2026-01-21: US-089 - Payment plans creation and management

**Status:** COMPLETE

### What was done:

Implemented the complete payment plan management system. The core `createPaymentPlan`, `listPaymentPlans`, `getPaymentPlan`, and `cancelPaymentPlan` procedures already existed. Added the missing procedures to complete all acceptance criteria.

#### 1. payment.createPlan (Already existed - `payment-processing.ts:1043`)
- Creates payment plan with installments
- Supports configurable number of installments (2-48)
- Calculates installment amounts automatically using `calculatePaymentPlanSchedule`
- Supports down payment, interest rate, and setup fee

#### 2. Support weekly, bi-weekly, monthly frequencies (Already existed)
- Uses `AutoPayFrequency` enum: WEEKLY, BI_WEEKLY, MONTHLY, ON_STATEMENT
- Frequency determines installment due date calculations

#### 3. Calculate installment amounts automatically (Already existed - `lib/payment/index.ts:122`)
- `calculatePaymentPlanSchedule()` function handles:
  - Total amount with interest calculation
  - Down payment deduction
  - Installment amount distribution
  - Last installment adjustment to avoid rounding issues

#### 4. payment.getPlanStatus (NEW - `payment-processing.ts`)
Returns comprehensive plan status including:
- Plan details (name, status, amounts, frequency, dates)
- Patient information
- Progress metrics:
  - Installments paid vs remaining
  - Progress percentage
  - Amount paid vs remaining
  - isOnTrack indicator
- Next payment due info
- Issues tracking:
  - Overdue count and details (with days past due)
  - Failed count and details (with attempt count)
- Full installment history with status

#### 5. payment.modifyPlan (NEW - `payment-processing.ts`)
Allows adjusting plan terms:
- Change frequency (recalculates all remaining installment dates)
- Extend by adding installments (redistributes remaining amount)
- Pause plan (sets status to PAUSED)
- Resume paused plan
- Add notes with timestamp
- Full audit logging of all changes

#### 6. Track missed payments (NEW - `payment-processing.ts`)
Two new procedures:

**getMissedPayments:**
- Finds all overdue or failed installments across all active plans
- Optional patient filter
- Returns detailed list with:
  - Plan and patient info
  - Installment details
  - Days past due
  - Attempt count and retry info
- Summary stats:
  - Total overdue/failed counts
  - Total at-risk amount

**resolveInstallment:**
- Manually resolve missed/failed installments
- Resolution options:
  - `paid_outside_system` - Mark as paid, update plan progress
  - `waived` - Skip the installment, reduce remaining balance
  - `rescheduled` - Set new due date, reset retry counters
- Auto-completes plan if all installments resolved
- Full audit trail

### Files Modified:
- `app/src/server/routers/payment-processing.ts`
  - Added `getPlanStatus` procedure (lines 1309-1426)
  - Added `modifyPlan` procedure (lines 1428-1603)
  - Added `getMissedPayments` procedure (lines 1605-1704)
  - Added `resolveInstallment` procedure (lines 1706-1825)

### Acceptance Criteria Met:
✅ payment.createPlan - Create payment plan with installments
✅ Support weekly, bi-weekly, monthly frequencies
✅ Calculate installment amounts automatically
✅ payment.getPlanStatus - View plan progress and remaining balance
✅ payment.modifyPlan - Adjust plan terms
✅ Track missed payments

### Validation:
- TypeScript compiles without errors
- All procedures follow existing patterns
- Proper organization scoping
- Full audit logging

--- Iteration 5 completed at 2026-01-21 ---
Story: US-089 - Payment plans creation and management

--- Iteration 5 completed at 2026-01-21 21:23:57 ---
Story: US-089 - Payment plans creation and management

## 2026-01-21: US-090 - Automated payment plan billing

**Status:** COMPLETE

### What was done:

Implemented the complete automated payment plan billing system with scheduled job processing, retry logic, notifications, and plan completion handling.

#### 1. Scheduled job to process due installments (NEW)

**Core Service (`app/src/lib/payment/plan-billing-scheduler.ts`):**
- `processDueInstallments()` - Main entry point for scheduled billing job
- `getDueInstallments()` - Fetches installments where status=SCHEDULED and dueDate <= now
- `getRetryReadyInstallments()` - Fetches failed installments ready for retry
- `processInstallmentPayment()` - Processes individual installment using payment provider
- Creates `PaymentTransaction` records for all attempts (success and failure)
- Updates installment status (SCHEDULED → PENDING → PAID/FAILED)
- Updates plan progress (amountPaid, amountRemaining, installmentsPaid)

**API Endpoint (`app/src/app/api/cron/payment-plan-billing/route.ts`):**
- GET/POST endpoint for cron job triggering
- Secret-based authentication (`CRON_SECRET` env var or `x-cron-secret` header)
- Supports config overrides via query params
- Returns detailed job results with timing
- Vercel Cron-compatible

**tRPC Procedures (`app/src/server/routers/payment-processing.ts`):**
- `runBillingJob` - Manual trigger with dry-run support
- `getUpcomingBillingItems` - Preview upcoming installments
- `getBillingStats` - Dashboard metrics (active plans, collected amounts, etc.)
- `getBillingConfig` / `updateBillingConfig` - Manage organization settings

#### 2. Retry failed payments with configurable attempts (NEW)

**Configuration (`BillingJobConfig`):**
- `maxRetryAttempts` (default: 3) - Maximum retry attempts per installment
- `retryIntervalDays` (default: 3) - Days between retry attempts

**Implementation:**
- Failed installments get `nextRetryAt` set based on retry interval
- `attemptCount` tracks number of attempts
- Retry continues until `attemptCount >= maxRetryAttempts`
- Final failure triggers patient notification and staff alert

#### 3. Send payment reminder before due date (NEW)

**Configuration:**
- `reminderDaysBeforeDue` (default: 3) - Days before due date to send reminder
- `sendReminders` (default: true) - Enable/disable reminders

**Implementation (`sendPaymentReminders()`):**
- Finds SCHEDULED installments with dueDate in reminder window
- Skips installments already reminded today
- Sends beautiful HTML email with:
  - Reminder icon and header
  - Payment amount and due date
  - Plan progress details
  - Auto-payment notice
- Respects patient `allowEmail` preference

#### 4. Send confirmation on successful payment (NEW)

**Implementation (`sendPaymentConfirmation()`):**
- Triggered after successful payment processing
- Beautiful HTML email with:
  - Success checkmark icon
  - Payment amount and date
  - Payment method (masked card number)
  - Transaction reference
  - Plan progress bar visualization
  - Remaining balance (or completion message)
- Fire-and-forget (non-blocking)
- Respects patient `allowEmail` preference

#### 5. Alert staff on failed payments (NEW)

**Configuration:**
- `alertStaffOnFailure` (default: true) - Enable/disable staff alerts
- `staffAlertEmail` - Optional override for alert destination

**Implementation (`alertStaffOnFailure()`):**
- Only triggered on final failure (after all retries exhausted)
- Fetches staff email from org settings or config
- Detailed alert email with:
  - Patient name and ID
  - Plan details
  - Failed amount
  - Error message
  - Attempt count
  - Action required notice

#### 6. Handle plan completion (NEW)

**Implementation:**
- `checkAndCompletePlan()` - Called after each successful payment
- Checks if all installments are PAID or SKIPPED
- Updates plan status to COMPLETED
- Sets endDate to current date
- Sends completion notification email with:
  - Celebration emoji and banner
  - Total paid summary
  - Plan progress (100%)
  - Congratulations message
- Audit log captures completion event

### Files Created:
- `app/src/lib/payment/plan-billing-scheduler.ts` - Complete billing scheduler service
- `app/src/app/api/cron/payment-plan-billing/route.ts` - Cron endpoint

### Files Modified:
- `app/src/lib/payment/index.ts` - Added plan-billing-scheduler exports
- `app/src/server/routers/payment-processing.ts` - Added billing management procedures

### New tRPC Procedures:
- `getBillingConfig` - Get organization billing configuration
- `updateBillingConfig` - Update billing configuration
- `runBillingJob` - Manual trigger with dry-run option
- `getUpcomingBillingItems` - Preview upcoming payments
- `getBillingStats` - Billing dashboard statistics

### Acceptance Criteria Met:
✅ Scheduled job to process due installments
✅ Retry failed payments with configurable attempts
✅ Send payment reminder before due date
✅ Send confirmation on successful payment
✅ Alert staff on failed payments
✅ Handle plan completion

### Validation:
- TypeScript compiles without errors
- All exports available from `@/lib/payment`
- Cron endpoint secured with secret authentication
- Organization-scoped configuration

--- Iteration 6 completed at 2026-01-21 ---
Story: US-090 - Automated payment plan billing

--- Iteration 6 completed at 2026-01-21 21:32:24 ---
Story: US-090 - Automated payment plan billing

## 2026-01-21: US-091 - Payment webhook handling

**Status:** COMPLETE

### What was done:

Implemented comprehensive payment webhook handling with support for Stripe events, idempotent processing, and automated notifications.

#### 1. Webhook endpoint for payment processor events (NEW)

**API Endpoint (`app/src/app/api/webhooks/payment/route.ts`):**
- POST endpoint for receiving webhook events from Stripe/Square
- Raw body handling for signature verification
- Supports multiple processor types via `?processor=` query param
- Health check GET endpoint for configuration verification
- Proper HTTP status codes (200 for success, 400 for verification failure, 500 for errors)

#### 2. Handle payment.succeeded and payment.failed events (NEW)

**payment.succeeded handler:**
- Finds transaction by external transaction ID
- Updates status to COMPLETED
- Stores processor response for audit
- Sends confirmation email to patient (if email enabled)
- Records actions taken

**payment.failed handler:**
- Updates transaction with failure details (errorCode, errorMessage, declineCode)
- Updates payment plan installment status if applicable
- Alerts staff via email with patient and error details
- Records failure actions for audit

#### 3. Handle refund events (NEW)

**charge.refunded handler:**
- Determines if full or partial refund based on amounts
- Updates transaction status to REFUNDED or PARTIALLY_REFUNDED
- Sends refund notification email to patient
- Logs refund processing details

#### 4. Handle dispute/chargeback events (NEW)

**charge.dispute.created/updated/closed handlers:**
- Extracts dispute info (ID, amount, reason, status, evidence due date)
- Updates transaction's processorResponse with dispute details
- Sends URGENT alert email to staff for new disputes
- Provides actionable next steps (gather evidence, submit before deadline)
- Tracks dispute status changes through lifecycle

#### 5. Webhook signature verification for security (NEW)

- Uses Stripe provider's `verifyWebhook()` method
- Validates webhook signature from `stripe-signature` header
- Returns 400 status for invalid signatures
- Parses and maps Stripe event types to internal types

#### 6. Idempotent webhook processing (NEW)

**New Prisma Model (`ProcessedWebhookEvent`):**
- `eventId` + `processorType` as unique composite key
- Status tracking: PENDING, PROCESSING, COMPLETED, FAILED, SKIPPED
- `retryCount` for tracking retry attempts
- `rawPayload` for debugging/replay
- `actions` array for recording what was done
- `transactionId` for linking to affected transaction

**Processing Flow:**
1. Check if event already processed (status = COMPLETED) → skip
2. Check if currently processing → skip (prevents duplicates)
3. Upsert event record with PROCESSING status
4. Process event and record actions
5. Update to COMPLETED on success, FAILED on error
6. Failed events can be retried (retryCount incremented)

### Files Created:
- `app/src/lib/payment/webhook-handler.ts` - Complete webhook handler service (966 lines)
  - `handlePaymentWebhook()` - Main entry point
  - `handlePaymentSucceeded()` - Payment success handler
  - `handlePaymentFailed()` - Payment failure handler
  - `handleRefund()` - Refund event handler
  - `handleDispute()` - Dispute/chargeback handler
  - `handlePaymentMethodChange()` - Payment method events
  - Email templates for all notification types
- `app/src/app/api/webhooks/payment/route.ts` - Webhook API endpoint

### Files Modified:
- `app/prisma/schema.prisma`
  - Added `ProcessedWebhookEvent` model for idempotency
  - Added `WebhookProcessingStatus` enum
  - Added `webhookEvents` relation to `PaymentTransaction`
  - Added `processedWebhookEvents` relation to `Organization`
- `app/src/lib/payment/types.ts`
  - Added `StripeWebhookEventType` type
  - Added `WebhookHandlerResult` interface
  - Added `WebhookAction` interface
  - Added `DisputeInfo` interface
- `app/src/lib/payment/index.ts` - Added webhook handler exports

### Supported Webhook Events:
- `payment_intent.succeeded` / `payment.succeeded`
- `payment_intent.payment_failed` / `payment.failed`
- `charge.refunded` / `payment.refunded`
- `charge.dispute.created`
- `charge.dispute.updated`
- `charge.dispute.closed`
- `payment_method.attached`
- `payment_method.detached`
- `customer.created`
- `customer.deleted`

### Acceptance Criteria Met:
✅ Webhook endpoint for payment processor events
✅ Handle payment.succeeded, payment.failed events
✅ Handle refund events
✅ Handle dispute/chargeback events
✅ Webhook signature verification for security
✅ Idempotent webhook processing

### Validation:
- TypeScript compiles without errors
- Prisma client generates successfully
- All exports available from `@/lib/payment`
- Proper error handling and logging

--- Iteration 7 completed at 2026-01-21 ---
Story: US-091 - Payment webhook handling

