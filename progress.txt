# Ralph Progress Log - Epic 39: AI Clinical Decision Support Agent

## 2026-01-22 - US-371: AI clinical decision schema

### Completed
- Created 5 new Prisma models for clinical decision support:
  - **ClinicalAlert**: Patient safety alerts with type, severity, status, acknowledgment tracking
  - **DiagnosisSuggestion**: AI-suggested diagnoses with confidence scoring and reasoning
  - **TreatmentRecommendation**: Evidence-based treatment recommendations with citations
  - **Contraindication**: Patient-specific treatment contraindications with override capability
  - **ClinicalGuideline**: Evidence-based practice guidelines reference

- Created supporting enums:
  - ClinicalAlertType (RED_FLAG, CONTRAINDICATION, DRUG_INTERACTION, PRECAUTION, GUIDELINE, OUTCOME_ALERT, REFERRAL_NEEDED)
  - ClinicalAlertSeverity (LOW, MODERATE, HIGH, CRITICAL)
  - ClinicalAlertStatus (ACTIVE, ACKNOWLEDGED, RESOLVED, DISMISSED, EXPIRED)
  - EvidenceLevel (HIGH, MODERATE, LOW, VERY_LOW, EXPERT)
  - ContraindicationType (ABSOLUTE, RELATIVE, PRECAUTION)

- Added relations to:
  - Organization model (Epic 39 relations)
  - Patient model (clinicalAlerts, treatmentRecommendations, contraindications)
  - Encounter model (clinicalAlerts, diagnosisSuggestions, treatmentRecommendations)

- Database schema pushed successfully with `prisma db push`
- Prisma client regenerated successfully

### Files Modified
- app/prisma/schema.prisma - Added 5 models, 5 enums, and relations
- prd.json - Marked US-371 as passes: true

### Notes
- Pre-existing TypeScript errors in mobile app (missing dependencies) are unrelated to this change
- Pre-existing Next.js route typing issues are unrelated to this change
- Schema compiles and generates correctly
--- Iteration 1 completed at 2026-01-22 19:25:33 ---
Story: US-371 - AI clinical decision schema

## 2026-01-22 - US-372: Diagnosis suggestion

### Completed
- Created aiClinical.ts tRPC router with comprehensive diagnosis suggestion functionality:

**Main Endpoints:**
1. `aiClinical.suggestDiagnosis` - Get AI-powered diagnosis suggestions
   - Analyzes chief complaint, subjective, and objective findings
   - Uses rule-based matching with common chiropractic ICD-10 codes
   - Integrates Claude Opus 4.5 for AI-enhanced suggestions (when API key present)
   - Returns confidence scores (0-100) for each suggestion
   - Identifies red flags with severity levels (CRITICAL, HIGH, MODERATE, LOW)
   - Creates ClinicalAlert records for detected red flags
   - Stores suggestions in DiagnosisSuggestion table for learning

2. `aiClinical.acceptSuggestion` - Accept a suggestion and add diagnosis to encounter
   - Creates Diagnosis record from suggestion
   - Marks suggestion as accepted for learning
   - Supports setting diagnosis as primary
   - Full audit logging

3. `aiClinical.rejectSuggestion` - Reject a suggestion with optional reason
   - Marks suggestion as rejected with reason for learning
   - Audit trail for improvement

4. `aiClinical.getPendingSuggestions` - Get unprocessed suggestions for encounter

5. `aiClinical.getPatientAlerts` - Get active clinical alerts for patient/encounter

6. `aiClinical.acknowledgeAlert` - Acknowledge a clinical alert

7. `aiClinical.getSuggestionStats` - Analytics for suggestion acceptance rate
   - Total/accepted/rejected counts
   - Acceptance rate calculation
   - Top accepted and rejected codes for learning

**Red Flag Detection:**
- Cauda equina syndrome (CRITICAL)
- Malignancy indicators (HIGH)
- Fracture risk (HIGH)
- Infection signs (HIGH)
- Vascular emergencies (CRITICAL)
- Cervical artery dysfunction (HIGH)

**ICD-10 Code Support:**
- 26 common chiropractic codes built-in
- M54.x (back pain categories)
- M99.0x (segmental/somatic dysfunction)
- M53.x (dorsopathies)
- M47.x (spondylosis)
- M51.x (disc disorders)
- S13.4/S33.5 (sprains)
- And more...

**Learning Capability:**
- Tracks provider acceptance/rejection of suggestions
- Stores rejection reasons for improvement
- getSuggestionStats endpoint for analyzing patterns

### Files Modified
- app/src/server/routers/aiClinical.ts - NEW: Complete AI clinical router (~900 lines)
- app/src/server/routers/index.ts - Added aiClinical router export
- app/src/lib/audit.ts - Added AI Clinical Decision Support audit actions
- prd.json - Marked US-372 as passes: true

### Technical Notes
- Follows existing tRPC patterns from other AI routers
- Uses providerProcedure for clinical endpoints
- Uses protectedProcedure for read-only endpoints
- Full Prisma type safety with proper typing
- Integrates with existing ai-service.ts pattern for Claude API
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 2 completed at 2026-01-22 ---
Story: US-372 - Diagnosis suggestion

--- Iteration 2 completed at 2026-01-22 19:32:38 ---
Story: US-372 - Diagnosis suggestion

## 2026-01-22 - US-373: Treatment recommendations

### Completed
- Added comprehensive treatment recommendation functionality to aiClinical.ts router:

**Main Endpoints:**
1. `aiClinical.recommendTreatment` - Get AI-powered treatment recommendations
   - Analyzes diagnosis code and clinical presentation
   - Matches against 11 built-in chiropractic treatment protocols
   - 20+ chiropractic technique database with evidence levels
   - Determines condition acuity (acute/subacute/chronic/wellness)
   - Frequency guidelines based on acuity phase (initial/transition/maintenance)
   - Expected outcomes and prognosis
   - Alternative treatment approaches
   - Patient preference consideration (lowForce, noManual, activeInvolvement, quickVisits)
   - Integrates Claude Opus 4.5 for AI-enhanced recommendations (when API key present)
   - Red flag detection and contraindication alerts
   - Evidence-based citations to clinical guidelines

2. `aiClinical.acceptTreatmentRecommendation` - Accept a recommendation
   - Marks recommendation as accepted
   - Supports modification notes
   - Full audit logging

3. `aiClinical.rejectTreatmentRecommendation` - Reject with reason
   - Documents rejection reason for learning
   - Audit trail for improvement

4. `aiClinical.getPendingTreatmentRecommendations` - Get unprocessed recommendations
   - Filter by patient or encounter
   - Excludes already accepted/rejected

5. `aiClinical.getTreatmentRecommendationStats` - Analytics for learning
   - Acceptance/rejection rates
   - Modification rates
   - Top techniques used
   - Top conditions treated

**Treatment Protocols (11 Built-in):**
- Acute Low Back Pain (M54.5, M54.50, M54.51)
- Chronic Low Back Pain (M54.5, M54.50, G89.29)
- Cervicalgia (M54.2)
- Thoracic Spine Pain (M54.6)
- Lumbar Disc Herniation (M51.16, M51.26, M54.41, M54.42)
- Cervicogenic Headache (R51.9, M53.0)
- Segmental Dysfunction (M99.01-M99.05)
- Muscle Spasm (M62.830, M79.1)
- Spondylosis (M47.812, M47.816)
- Cervical Sprain/Strain (S13.4XXA)
- Lumbar Sprain/Strain (S33.5XXA)

**Chiropractic Techniques (20 Supported):**
- Diversified, Gonstead, Activator Method, Thompson Drop
- Flexion-Distraction, Cox Flexion-Distraction
- SOT, Toggle Recoil, NUCCA
- ART, Graston Technique, Myofascial Release, Trigger Point Therapy
- EMS, Ultrasound, Cold Laser, Spinal Decompression
- Kinesio Taping, McKenzie Method, Stabilization Exercises

**Frequency Guidelines by Acuity:**
- Acute: 3x/week initial → 2x/week → 1x/week PRN
- Subacute: 2-3x/week initial → 1-2x/week → 1x/2 weeks
- Chronic: 2x/week initial → 1x/week → 1-2x/month ongoing
- Wellness: 1x/month to 1x/quarter

### Files Modified
- app/src/server/routers/aiClinical.ts - Added ~600 lines:
  - Treatment protocols database
  - Chiropractic technique database
  - Frequency guidelines
  - Patient preference handling
  - Helper functions (determineAcuity, findMatchingProtocol, scoreTechniqueSuitability, generateAITreatmentRecommendations)
  - 5 new tRPC endpoints
- prd.json - Marked US-373 as passes: true

### Technical Notes
- Follows existing aiClinical patterns from US-372
- Uses providerProcedure for write operations
- Uses protectedProcedure for read-only queries
- Full Prisma type safety with proper typing
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 3 completed at 2026-01-22 ---
Story: US-373 - Treatment recommendations

--- Iteration 3 completed at 2026-01-22 19:39:01 ---
Story: US-373 - Treatment recommendations

## 2026-01-22 - US-374: Contraindication alerts

### Completed
- Added comprehensive contraindication alert functionality to aiClinical.ts router:

**Contraindication Rules Database (20+ Rules):**
- **Absolute Contraindications (6 rules):**
  - Cauda equina syndrome (CRITICAL)
  - Acute spinal fracture (CRITICAL)
  - Spinal infection/osteomyelitis (CRITICAL)
  - Spinal malignancy/metastasis (CRITICAL)
  - Vascular emergency (AAA/dissection) (CRITICAL)
  - Severe cervical instability (CRITICAL)

- **Relative Contraindications - High Severity (5 rules):**
  - Anticoagulation therapy (warfarin, eliquis, etc.)
  - Severe osteoporosis
  - Vertebrobasilar insufficiency risk
  - Recent spinal surgery
  - Progressive neurological deficit

- **Moderate Severity (6 rules):**
  - Mild-moderate osteoporosis
  - Pregnancy
  - Long-term corticosteroid use
  - Recent significant trauma
  - Inflammatory arthritis (RA, AS)
  - Connective tissue disorders (Ehlers-Danlos, Marfan)

- **Age-Specific Precautions:**
  - Advanced age (>75) - MODERATE
  - Pediatric cervical (<12) - LOW

- **Medication Interactions:**
  - High-dose NSAIDs
  - Muscle relaxants

**Main Endpoints:**
1. `aiClinical.checkContraindications` - Comprehensive safety verification
   - Analyzes patient conditions, medications, age
   - Checks recent surgeries and trauma
   - Detects red flag symptoms
   - Rule-based matching against 20+ contraindication rules
   - AI-enhanced analysis using Claude Opus 4.5 (when API key present)
   - Creates ClinicalAlert records for detected contraindications
   - Stores significant contraindications in patient record
   - Returns safety status: CLEAR, PRECAUTION, RELATIVE, ABSOLUTE
   - Alert severity levels: CRITICAL, HIGH, MODERATE, LOW

2. `aiClinical.overrideContraindication` - Override with documentation
   - Only allows override of relative/precaution contraindications
   - Blocks override of absolute contraindications
   - Requires risk acknowledgment
   - Documents patient consent (optional)
   - Records alternatives considered
   - Records precautions taken
   - Full audit trail

3. `aiClinical.getPatientContraindications` - List active contraindications
   - Filter by procedure
   - Include/exclude overridden
   - Include/exclude expired

4. `aiClinical.addPatientContraindication` - Manual entry
   - Add provider-identified contraindications
   - Automatically creates clinical alerts for high severity

5. `aiClinical.deactivateContraindication` - Mark as resolved
   - Document resolution reason
   - Resolves related alerts

6. `aiClinical.getContraindicationStats` - Analytics
   - Breakdown by type (absolute/relative/precaution)
   - Override rates
   - Top procedures and sources

**Key Features:**
- Procedure-CPT code mapping for accurate matching
- Source-based detection (condition, medication, age, surgery, trauma, red_flag)
- Review date scheduling for temporary contraindications
- AI-enhanced analysis for additional safety insights
- Full audit logging for all actions

### Files Modified
- app/src/server/routers/aiClinical.ts - Added ~800 lines:
  - Contraindication rules database (20+ rules)
  - Procedure-CPT code mapping
  - checkContraindicationRules helper function
  - generateAIContraindicationAnalysis helper function
  - 6 new tRPC endpoints
- app/src/lib/audit.ts - Added audit actions:
  - CONTRAINDICATION_OVERRIDE
  - CONTRAINDICATION_ADDED
  - CONTRAINDICATION_DEACTIVATED
- prd.json - Marked US-374 as passes: true

### Technical Notes
- Follows existing aiClinical patterns from US-372 and US-373
- Uses providerProcedure for write operations
- Uses protectedProcedure for read-only queries
- Full Prisma type safety with proper typing
- Uses Contraindication model from US-371 schema
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 4 completed at 2026-01-22 ---
Story: US-374 - Contraindication alerts

--- Iteration 4 completed at 2026-01-22 19:47:52 ---
Story: US-374 - Contraindication alerts

## 2026-01-22 - US-375: Clinical guidelines integration

### Completed
- Added comprehensive clinical guidelines integration to aiClinical.ts router:

**Clinical Guidelines Database (10 Built-in Guidelines):**
- CCGPP Guidelines for Low Back Pain (2016)
- CCGPP Guidelines for Neck Pain (2014)
- CCGPP Guidelines for Headache (2011)
- AHRQ Noninvasive Treatments for Low Back Pain (2017)
- ACP Clinical Practice Guideline for Low Back Pain (2017)
- NICE Guideline on Low Back Pain and Sciatica (2016/2020)
- CCGPP Guidelines for Lumbar Disc Herniation (2014)
- CCGPP Guidelines for Spondylosis Management (2018)
- CCGPP Guidelines for Thoracic Spine Pain (2017)
- CCGPP Guidelines for Extremity Conditions (2018)

Each guideline includes:
- Condition codes (ICD-10 mapping)
- Applicable body regions
- Detailed recommendations with grade (A/B/C/D/I)
- Evidence levels (HIGH/MODERATE/LOW/VERY_LOW)
- Key implementation points
- Red flags to watch for
- Referral criteria
- Contraindications and precautions
- Publication citations with external URLs

**Main Endpoints:**
1. `aiClinical.getGuidelines` - Search and retrieve relevant guidelines
   - Supports diagnosis code, condition name, and body region search
   - Filters by evidence level and source
   - Match scoring for relevance ranking
   - Includes both built-in and custom organization guidelines
   - Pagination support

2. `aiClinical.getGuidelineById` - Get single guideline details
   - Supports both built-in (builtin-CODE) and custom IDs
   - Returns full guideline content

3. `aiClinical.addGuideline` - Create custom organization guideline
   - Full guideline data structure support
   - Duplicate detection
   - Audit logging

4. `aiClinical.updateGuideline` - Update custom guidelines
   - Cannot update built-in guidelines
   - Partial updates supported
   - Audit logging

5. `aiClinical.retireGuideline` - Soft delete custom guidelines
   - Records retirement reason
   - Audit logging

6. `aiClinical.getGuidelineBasedSuggestions` - Get suggestions for encounter
   - Analyzes encounter diagnoses
   - Finds matching guidelines
   - Returns key recommendations, red flags, and suggested actions
   - Works with both built-in and custom guidelines

7. `aiClinical.trackGuidelineAdherence` - Track adherence to recommendations
   - Records followed/not-followed recommendations
   - Calculates adherence rate
   - Links to encounter
   - Full audit trail

8. `aiClinical.getGuidelineAdherenceStats` - Adherence analytics
   - Overall adherence rate
   - Breakdown by guideline
   - Date range filtering
   - Provider filtering

9. `aiClinical.checkGuidelineUpdates` - Check for guideline updates
   - Compares custom vs built-in versions
   - Identifies recently published guidelines
   - Returns notification message

10. `aiClinical.listAllGuidelines` - List all available guidelines
    - Summary view of all guidelines
    - Filters for built-in/custom
    - Returns counts

### Files Modified
- app/src/server/routers/aiClinical.ts - Added ~1100 lines:
  - ClinicalGuidelineData interface
  - CHIROPRACTIC_GUIDELINES constant (10 comprehensive guidelines)
  - 10 new tRPC endpoints for guideline management
- prd.json - Marked US-375 as passes: true

### Technical Notes
- Follows existing aiClinical patterns from US-372, US-373, US-374
- Uses protectedProcedure for read operations
- Uses providerProcedure for write operations
- Full Prisma type safety with ClinicalGuideline model
- Utilizes TreatmentRecommendation model for adherence tracking
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 5 completed at 2026-01-22 ---
Story: US-375 - Clinical guidelines integration

--- Iteration 5 completed at 2026-01-22 19:58:47 ---
Story: US-375 - Clinical guidelines integration

## 2026-01-22 - US-376: Outcome prediction

### Completed
- Added comprehensive outcome prediction functionality to aiClinical.ts router:

**New Prisma Model:**
- **OutcomePrediction**: AI-predicted treatment outcomes with:
  - Condition and treatment context (diagnosisCode, treatmentApproach, techniquesSuggested)
  - Prediction details (predictedOutcome, confidenceScore, expectedTimeline, improvementPercent)
  - Risk assessment (riskOfChronicity, treatmentResponse, prognosticFactors)
  - Similar cases analysis (similarCasesCount, similarCasesAvgOutcome, similarCasesData)
  - Patient factors (patientAge, symptomDuration, comorbidities, riskFactors)
  - Patient communication (patientExplanation, expectationSetting)
  - Provider action tracking (isAccepted, isRejected, reviewedAt)
  - Actual outcome tracking for model improvement (actualOutcome, wasAccurate)

**Main Endpoints:**
1. `aiClinical.predictOutcome` - Forecast treatment outcome
   - Analyzes patient data, diagnosis, and treatment approach
   - Queries similar cases for outcome comparison
   - Calculates expected improvement timeline
   - Identifies prognostic factors (favorable/unfavorable)
   - Calculates risk of chronicity (0-100%)
   - Determines treatment response likelihood (EXCELLENT/GOOD/MODERATE/POOR)
   - Generates patient-friendly explanation for communication
   - Creates expectation setting points
   - Integrates Claude Opus 4.5 for AI-enhanced predictions (when API key present)
   - Creates OUTCOME_ALERT if high chronicity risk detected

2. `aiClinical.acceptOutcomePrediction` - Accept a prediction
   - Marks prediction as accepted for tracking
   - Full audit logging

3. `aiClinical.rejectOutcomePrediction` - Reject with reason
   - Documents rejection reason for learning
   - Audit trail for improvement

4. `aiClinical.recordActualOutcome` - Record actual outcome for accuracy tracking
   - Captures actual outcome and improvement percentage
   - Calculates if prediction was accurate (within 15% threshold)
   - Enables continuous model improvement

5. `aiClinical.getPatientOutcomePredictions` - List predictions for patient
   - Filter by encounter
   - Include/exclude resolved predictions

6. `aiClinical.getOutcomePredictionStats` - Analytics for prediction accuracy
   - Total predictions count
   - Acceptance/rejection rates
   - Accuracy rate for predictions with outcomes
   - Response distribution (EXCELLENT/GOOD/MODERATE/POOR)
   - Top conditions predicted

7. `aiClinical.getOutcomeCommunicationSummary` - Patient communication document
   - Generates comprehensive document for patient education
   - Includes expected outcome, timeline, treatment plan
   - Key expectation points
   - Recommendations
   - Appropriate disclaimer

**Helper Functions (~600 lines):**
- `determineSymptomDuration()` - Categorize symptom duration from clinical notes
- `identifyRiskFactors()` - Identify prognostic risk factors from patient data
- `analyzeSimilarCases()` - Query and analyze similar cases for outcome comparison
- `getBaselineOutcome()` - Get baseline outcome expectation by condition
- `adjustOutcomeForFactors()` - Adjust prediction for individual patient factors
- `calculateChronicityRisk()` - Calculate risk of condition becoming chronic
- `determineTreatmentResponse()` - Categorize expected treatment response
- `getResponseDescription()` - Get description for response category
- `generatePrognosticFactors()` - Generate prognostic factors summary
- `generatePatientExplanation()` - Create patient-friendly explanation
- `generateExpectationSetting()` - Generate expectation setting points
- `generateAIOutcomePrediction()` - AI-enhanced prediction using Claude API

**Risk Factors Detected:**
- Age-related risks (advanced age, elderly, pediatric)
- Duration-related risks (chronic symptoms)
- Lifestyle factors (sedentary, smoking, obesity)
- Psychological factors (depression, anxiety, fear avoidance)
- Work-related factors (heavy physical work, workers comp)
- Previous treatment failures
- Comorbidities
- Neurological involvement

**Baseline Outcomes by Condition:**
- M54.5 (LBP): 75% improvement, 4-8 weeks
- M54.2 (Neck): 70% improvement, 4-6 weeks
- M54.6 (Thoracic): 75% improvement, 3-6 weeks
- M99.0 (Dysfunction): 80% improvement, 2-4 weeks
- M51.1 (Disc): 60% improvement, 6-12 weeks
- M47.8 (Spondylosis): 55% improvement, 8-12 weeks
- S13.4/S33.5 (Sprains): 70-75% improvement, 4-8 weeks

### Files Modified
- app/prisma/schema.prisma - Added OutcomePrediction model with full tracking
- app/prisma/schema.prisma - Added relations to Organization, Patient, Encounter
- app/src/server/routers/aiClinical.ts - Added ~1200 lines:
  - 12 helper functions for outcome prediction
  - 7 new tRPC endpoints
  - generateAIOutcomePrediction for Claude integration
- prd.json - Marked US-376 as passes: true

### Technical Notes
- Follows existing aiClinical patterns from US-372 through US-375
- Uses providerProcedure for write operations
- Uses protectedProcedure for read-only queries
- Full Prisma type safety with OutcomePrediction model
- Similar cases analysis queries existing predictions for data-driven insights
- Integrates with existing ClinicalAlert for high-risk notifications
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 6 completed at 2026-01-22 ---
Story: US-376 - Outcome prediction

--- Iteration 6 completed at 2026-01-22 20:08:55 ---
Story: US-376 - Outcome prediction

## 2026-01-22 - US-377: Referral recommendations

### Completed
- Added comprehensive referral recommendation functionality to aiClinical.ts router:

**New Prisma Model:**
- **ReferralSuggestion**: AI-suggested specialist referrals with:
  - Reason for referral, red flags identified, clinical findings
  - Specialist type and alternative specialists
  - Urgency levels (EMERGENT, URGENT, SOON, ROUTINE, WHEN_AVAILABLE)
  - Status tracking (SUGGESTED, PENDING_REVIEW, ACCEPTED, REFERRAL_SENT, REJECTED, COMPLETED)
  - Referral letter drafts (AI-generated and final approved)
  - Outcome tracking (specialist diagnosis, recommendations, appropriateness)

- **New Enums:**
  - ReferralUrgency (EMERGENT, URGENT, SOON, ROUTINE, WHEN_AVAILABLE)
  - ClinicalReferralStatus (8 statuses for full referral lifecycle)

**Main Endpoints:**
1. `aiClinical.suggestReferral` - Evaluate if patient needs referral
   - Analyzes patient history, treatment response, and clinical findings
   - Detects red flags (cauda equina, malignancy, fracture, infection, vascular)
   - Evaluates non-response to treatment
   - Creates ClinicalAlert for urgent referrals
   - Rule-based and AI-enhanced suggestions
   - Returns urgency level and confidence score

2. `aiClinical.acceptReferralSuggestion` - Accept a referral suggestion
   - Marks suggestion as accepted
   - Resolves related clinical alerts
   - Full audit logging

3. `aiClinical.rejectReferralSuggestion` - Reject with reason
   - Documents rejection for learning
   - Audit trail

4. `aiClinical.generateReferralLetter` - AI-generated referral letter draft
   - Professional referral letter format
   - Includes patient demographics, diagnoses, treatment history
   - Red flags and clinical findings
   - Customizable recipient information
   - Urgency indication

5. `aiClinical.approveReferralLetter` - Approve and send referral
   - Finalizes letter with optional modifications
   - Records send method (FAX, EMAIL, PORTAL, MAIL, HAND_DELIVERED)
   - Updates status to REFERRAL_SENT

6. `aiClinical.recordReferralOutcome` - Track referral outcome
   - Records specialist diagnosis and recommendations
   - Tracks if referral was appropriate (for learning)
   - Completes referral lifecycle

7. `aiClinical.getPatientReferralSuggestions` - List patient's referrals
   - Filter by encounter, status, include/exclude resolved
   - Sorted by urgency

8. `aiClinical.getReferralStats` - Analytics for referral patterns
   - Acceptance/rejection rates
   - Appropriateness rate
   - Urgency distribution
   - Top specialist types
   - Average confidence scores

**AI Helper Function:**
- `generateAIReferralSuggestions()` - Claude Opus 4.5 integration for enhanced referral analysis

**Red Flag Detection (Built-in Rules):**
- Cauda equina syndrome → EMERGENT → Emergency Dept/Neurosurgery
- Vascular emergency → EMERGENT → Emergency Dept/Vascular Surgery
- Malignancy indicators → URGENT → Oncology/Internal Medicine
- Fracture risk → URGENT → Orthopedic Surgery
- Infection signs → URGENT → Infectious Disease/Primary Care
- Cervical artery dysfunction → SOON → Neurology

**Non-Response Handling:**
- Poor response after 4+ weeks → Specialist referral
- Moderate response after 8+ weeks → PM&R co-management
- Diagnosis-based specialist routing (disc → Spine Surgery, radicular → Pain Management)

### Files Modified
- app/prisma/schema.prisma - Added ReferralSuggestion model, 2 enums, relations
- app/src/server/routers/aiClinical.ts - Added ~1000 lines:
  - generateAIReferralSuggestions helper function
  - 8 new tRPC endpoints
  - Red flag detection integration
  - Referral letter generation
- prd.json - Marked US-377 as passes: true

### Technical Notes
- Follows existing aiClinical patterns from US-372 through US-376
- Uses providerProcedure for write operations
- Uses protectedProcedure for read-only queries
- Full Prisma type safety with ReferralSuggestion model
- Creates ClinicalAlert records for urgent referrals
- Integrates with existing red flag detection from diagnosis suggestion
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 7 completed at 2026-01-22 ---
Story: US-377 - Referral recommendations

--- Iteration 7 completed at 2026-01-22 20:22:57 ---
Story: US-377 - Referral recommendations

## 2026-01-22 - US-378: Clinical decision support UI

### Completed
- Created 6 comprehensive UI components for the clinical decision support system:

**1. ClinicalAlertPanel** (`ClinicalAlertPanel.tsx`)
- Displays active clinical alerts with severity-based styling (CRITICAL, HIGH, MODERATE, LOW)
- Alert types: RED_FLAG, CONTRAINDICATION, DRUG_INTERACTION, PRECAUTION, GUIDELINE, OUTCOME_ALERT, REFERRAL_NEEDED
- Acknowledge dialog with optional notes
- Compact mode for embedding in other panels
- Color-coded severity badges and icons

**2. DiagnosisSuggestionsSidebar** (`DiagnosisSuggestionsSidebar.tsx`)
- Displays AI diagnosis suggestions with confidence scores
- Progress bars for confidence visualization
- "Top Match" badge for highest-confidence suggestion
- Supporting findings and reasoning display
- Red flag indicators with details
- Accept/Reject workflow with reason capture
- Generate button for on-demand AI suggestions

**3. TreatmentRecommendationsDisplay** (`TreatmentRecommendationsDisplay.tsx`)
- Displays evidence-based treatment recommendations
- Evidence level badges (HIGH, MODERATE, LOW, VERY_LOW, EXPERT)
- Accordion sections for techniques, frequency/duration, expected outcomes
- Condition code display
- Modification notes for accepted recommendations
- Accept/Reject workflow with required rejection reason

**4. ContraindicationWarnings** (`ContraindicationWarnings.tsx`)
- Real-time procedure safety checking
- Unified contraindication display (detected + existing)
- Severity-based styling (ABSOLUTE, RELATIVE, PRECAUTION)
- Override dialog for relative/precaution types
- Override documentation (reason, patient consent, alternatives, precautions)
- Safety status badges (CLEAR, PRECAUTION, RELATIVE, ABSOLUTE)

**5. GuidelineQuickReference** (`GuidelineQuickReference.tsx`)
- Searchable clinical guidelines reference
- Guidelines list with evidence level badges
- Full guideline detail sheet with:
  - Summary and recommendations (graded A/B/C/D/I)
  - Red flags to watch for
  - Referral criteria
  - Contraindications
  - Citations with external links
- Track adherence buttons (Followed/Not Applicable)

**6. ClinicalDecisionSupportPanel** (`ClinicalDecisionSupportPanel.tsx`)
- Main wrapper component that integrates all 5 child components
- Alert panel at top with critical alerts prominently displayed
- Tab-based navigation (Diagnosis, Treatment, Contraindications, Guidelines)
- Props pass-through for encounter/patient context
- Callbacks for cross-component coordination

**7. Barrel Export** (`index.ts`)
- Clean exports for all 6 components

### TypeScript Fixes Applied
All components were updated to match the tRPC API exactly:
- ContraindicationWarnings: `procedureFilter` param, `safetyStatus` field, UnifiedContraindication interface
- GuidelineQuickReference: `guidelineId` param, `guidelines.guidelines` iteration, field name mappings
- TreatmentRecommendationsDisplay: `modifications` param, required `reason` for rejection, condition object structure

### Files Created
- app/src/components/clinical-decision-support/ClinicalAlertPanel.tsx (~295 lines)
- app/src/components/clinical-decision-support/DiagnosisSuggestionsSidebar.tsx (~353 lines)
- app/src/components/clinical-decision-support/TreatmentRecommendationsDisplay.tsx (~394 lines)
- app/src/components/clinical-decision-support/ContraindicationWarnings.tsx (~423 lines)
- app/src/components/clinical-decision-support/GuidelineQuickReference.tsx (~397 lines)
- app/src/components/clinical-decision-support/ClinicalDecisionSupportPanel.tsx (~109 lines)
- app/src/components/clinical-decision-support/index.ts (~13 lines)

### Technical Notes
- All components use shadcn/ui components
- Brand colors: Primary #053e67, Accent #c90000
- Full tRPC integration with proper typing
- TooltipProvider pattern for accessible tooltips
- ScrollArea for overflow handling
- Accordion for expandable sections
- Dialog/Sheet for modals and sidepanels
- Proper error handling with sonner toast notifications
- readOnly mode support for all components
- Pre-existing errors in mobile app and aiCare.ts are unrelated

--- Iteration 8 completed at 2026-01-22 ---
Story: US-378 - Clinical decision support UI

